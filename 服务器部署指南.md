# DropShare 服务器部署指南

## 服务器信息

- **服务器IP**: `107.174.250.34`
- **SSH用户**: `novcat` 或 `dokploy`
- **SSH端口**: `22`
- **部署路径**: `/var/www/dropshare`

## 快速部署

### 方法1: 使用部署脚本（推荐）

```bash
# 1. 给脚本添加执行权限
chmod +x deploy-to-server.sh

# 2. 运行部署脚本
./deploy-to-server.sh
```

### 方法2: 手动部署

#### 1. 连接到服务器

```bash
# 保存SSH私钥到文件
cat > ~/.ssh/dropshare_server_key << 'EOF'
-----BEGIN OPENSSH PRIVATE KEY-----
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
-----END OPENSSH PRIVATE KEY-----
EOF

chmod 600 ~/.ssh/dropshare_server_key

# 连接到服务器
ssh -i ~/.ssh/dropshare_server_key novcat@107.174.250.34
```

#### 2. 在服务器上安装依赖

```bash
# 安装Node.js (如果未安装)
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装Docker (如果未安装)
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
sudo usermod -aG docker $USER

# 安装Docker Compose (如果未安装)
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
```

#### 3. 部署应用

```bash
# 创建项目目录
sudo mkdir -p /var/www/dropshare
sudo chown $USER:$USER /var/www/dropshare
cd /var/www/dropshare

# 克隆或更新代码
git clone https://github.com/xuldqi/dropshare.git . || git pull origin main

# 创建.env文件
cat > .env << 'EOF'
PRIMARY_DOMAIN=107.174.250.34
SECONDARY_DOMAIN=107.174.250.34
NODE_ENV=production
PORT=3000
MAX_FILE_SIZE=100MB
UPLOAD_PATH=./uploads
LOG_LEVEL=info
LOG_PATH=./logs
EOF

# 创建必要目录
mkdir -p uploads logs ssl

# 启动服务
docker-compose up -d --build
```

## 配置Chrome扩展

部署完成后，在Chrome扩展中配置服务器地址：

1. **打开扩展设置**
   - 点击扩展图标
   - 点击"⚙️ 设置"按钮

2. **输入服务器地址**
   ```
   ws://107.174.250.34:3000/server/webrtc
   ```
   或如果配置了HTTPS：
   ```
   wss://107.174.250.34:3000/server/webrtc
   ```

3. **保存设置**
   - 点击"保存"按钮
   - 扩展会自动连接到服务器

## 访问地址

- **HTTP**: `http://107.174.250.34:3000`
- **WebSocket**: `ws://107.174.250.34:3000/server/webrtc`

## 配置HTTPS（可选）

如果需要HTTPS，可以配置Nginx反向代理：

```nginx
server {
    listen 443 ssl;
    server_name 107.174.250.34;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

然后Chrome扩展使用：
```
wss://107.174.250.34/server/webrtc
```

## 检查服务状态

```bash
# 查看容器状态
docker-compose ps

# 查看日志
docker-compose logs -f

# 重启服务
docker-compose restart
```

## 故障排除

### 连接被拒绝
- 检查防火墙是否开放端口3000
- 检查Docker容器是否正常运行
- 查看容器日志：`docker-compose logs`

### WebSocket连接失败
- 确认服务器地址格式正确：`ws://IP:PORT/server/webrtc`
- 检查服务器是否支持WebSocket
- 如果使用HTTPS，必须使用WSS

### 权限问题
- 确保SSH密钥文件权限为600：`chmod 600 ~/.ssh/dropshare_server_key`
- 确保项目目录权限正确：`sudo chown $USER:$USER /var/www/dropshare`

## 更新部署

```bash
# 连接到服务器
ssh -i ~/.ssh/dropshare_server_key novcat@107.174.250.34

# 进入项目目录
cd /var/www/dropshare

# 拉取最新代码
git pull origin main

# 重新构建并启动
docker-compose up -d --build
```

