<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room File Sharing Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .file-list {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            min-height: 100px;
            background-color: #f8f9fa;
        }
        .file-item {
            padding: 5px;
            margin: 5px 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        input[type="file"] {
            margin: 10px 0;
        }
        .room-info {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ Room File Sharing Test</h1>
    
    <div class="test-section">
        <h3>üì° Connection Status</h3>
        <div id="connectionStatus" class="status info">Connecting...</div>
        <button onclick="testConnection()">Test Connection</button>
    </div>

    <div class="test-section">
        <h3>üè† Room Management</h3>
        <div class="room-info">
            <strong>Room Code:</strong> <span id="roomCode">Not in room</span><br>
            <strong>Room Status:</strong> <span id="roomStatus">Not connected</span>
        </div>
        <button onclick="createTestRoom()">Create Test Room</button>
        <button onclick="joinTestRoom()">Join Test Room</button>
        <button onclick="leaveRoom()">Leave Room</button>
    </div>

    <div class="test-section">
        <h3>üìÅ File Upload Test</h3>
        <input type="file" id="fileInput" multiple>
        <button onclick="uploadFiles()">Upload Files to Room</button>
        <div id="uploadStatus" class="status info">Ready to upload</div>
    </div>

    <div class="test-section">
        <h3>üìã Shared Files List</h3>
        <div id="sharedFilesList" class="file-list">
            <div class="no-files">No shared files</div>
        </div>
        <button onclick="refreshFilesList()">Refresh Files List</button>
    </div>

    <div class="test-section">
        <h3>üìä Message Log</h3>
        <div id="messageLog" class="file-list" style="height: 200px; overflow-y: auto;"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <script src="scripts/network.js"></script>
    <script>
        let ws = null;
        let currentRoom = null;
        let messageCount = 0;

        // Initialize connection
        function initConnection() {
            try {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                ws = new WebSocket(wsUrl);
                
                ws.onopen = function() {
                    updateStatus('connectionStatus', 'Connected to server', 'success');
                    logMessage('‚úÖ WebSocket connected');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (error) {
                        logMessage('‚ùå Failed to parse message: ' + error.message);
                    }
                };
                
                ws.onclose = function() {
                    updateStatus('connectionStatus', 'Connection closed', 'error');
                    logMessage('‚ùå WebSocket disconnected');
                };
                
                ws.onerror = function(error) {
                    updateStatus('connectionStatus', 'Connection error', 'error');
                    logMessage('‚ùå WebSocket error: ' + error);
                };
            } catch (error) {
                updateStatus('connectionStatus', 'Failed to connect: ' + error.message, 'error');
                logMessage('‚ùå Connection failed: ' + error.message);
            }
        }

        // Handle incoming messages
        function handleMessage(message) {
            logMessage(`üì® Received: ${message.type}`, message);
            
            switch (message.type) {
                case 'room-created':
                    currentRoom = message.code;
                    updateRoomInfo(message.code, 'Created');
                    updateStatus('uploadStatus', 'Room created, ready to upload files', 'success');
                    break;
                    
                case 'room-joined':
                    currentRoom = message.code;
                    updateRoomInfo(message.code, 'Joined');
                    updateStatus('uploadStatus', 'Joined room, ready to upload files', 'success');
                    break;
                    
                case 'room-left':
                    currentRoom = null;
                    updateRoomInfo('Not in room', 'Left');
                    updateStatus('uploadStatus', 'Left room', 'info');
                    break;
                    
                case 'room-file-shared':
                    handleFileShared(message);
                    break;
                    
                case 'room-error':
                    updateStatus('uploadStatus', 'Room error: ' + message.error, 'error');
                    break;
                    
                default:
                    logMessage(`‚ÑπÔ∏è Unhandled message type: ${message.type}`);
            }
        }

        // Handle file shared message
        function handleFileShared(message) {
            logMessage('üìÅ File shared in room', message);
            
            if (message.fileInfo) {
                addFileToList(message.fileInfo, message.fileData);
                updateStatus('uploadStatus', `File "${message.fileInfo.name}" shared successfully`, 'success');
            } else {
                logMessage('‚ùå No file info in shared message');
            }
        }

        // Add file to shared files list
        function addFileToList(fileInfo, fileData) {
            const filesList = document.getElementById('sharedFilesList');
            const noFiles = filesList.querySelector('.no-files');
            
            if (noFiles) {
                noFiles.style.display = 'none';
            }
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            fileItem.innerHTML = `
                <strong>${fileInfo.name}</strong> (${formatFileSize(fileInfo.size)})<br>
                <small>Uploaded by: ${fileInfo.uploader || 'Unknown'} at ${new Date(fileInfo.uploadTime).toLocaleTimeString()}</small>
                ${fileData ? '<button onclick="downloadFile(\'' + fileInfo.id + '\', \'' + fileData + '\', \'' + fileInfo.name + '\')" style="float: right;">üì• Download</button>' : ''}
            `;
            
            filesList.appendChild(fileItem);
        }

        // Download file
        function downloadFile(fileId, fileData, fileName) {
            try {
                const link = document.createElement('a');
                link.href = fileData;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                logMessage(`üì• Downloaded file: ${fileName}`);
            } catch (error) {
                logMessage(`‚ùå Download failed: ${error.message}`);
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Send message to server
        function sendMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                logMessage(`üì§ Sent: ${message.type}`, message);
            } else {
                logMessage('‚ùå Cannot send message: WebSocket not connected');
            }
        }

        // Test connection
        function testConnection() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                updateStatus('connectionStatus', 'Connection is active', 'success');
                logMessage('‚úÖ Connection test passed');
            } else {
                updateStatus('connectionStatus', 'Connection is not active', 'error');
                logMessage('‚ùå Connection test failed');
                initConnection();
            }
        }

        // Create test room
        function createTestRoom() {
            const roomCode = 'TEST' + Math.random().toString(36).substr(2, 4).toUpperCase();
            sendMessage({
                type: 'room-create',
                name: 'Test Room',
                code: roomCode
            });
            logMessage(`üè† Creating room with code: ${roomCode}`);
        }

        // Join test room
        function joinTestRoom() {
            const roomCode = prompt('Enter room code to join:');
            if (roomCode) {
                sendMessage({
                    type: 'room-join',
                    code: roomCode.toUpperCase()
                });
                logMessage(`üö™ Joining room: ${roomCode}`);
            }
        }

        // Leave room
        function leaveRoom() {
            if (currentRoom) {
                sendMessage({
                    type: 'room-leave',
                    code: currentRoom
                });
                logMessage(`üö™ Leaving room: ${currentRoom}`);
            } else {
                logMessage('‚ùå Not in any room');
            }
        }

        // Upload files
        function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (!currentRoom) {
                updateStatus('uploadStatus', 'Please join a room first', 'error');
                return;
            }
            
            if (!files || files.length === 0) {
                updateStatus('uploadStatus', 'Please select files to upload', 'error');
                return;
            }
            
            updateStatus('uploadStatus', `Uploading ${files.length} file(s)...`, 'info');
            
            Array.from(files).forEach(async (file, index) => {
                try {
                    const fileData = await fileToBase64(file);
                    const fileInfo = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploader: 'Test User',
                        uploaderId: 'test_user_' + Date.now(),
                        uploadTime: Date.now()
                    };
                    
                    sendMessage({
                        type: 'room-file-shared',
                        roomCode: currentRoom,
                        fileInfo: fileInfo,
                        fileData: fileData
                    });
                    
                    logMessage(`üì§ Uploaded file: ${file.name}`);
                } catch (error) {
                    logMessage(`‚ùå Upload failed for ${file.name}: ${error.message}`);
                }
            });
            
            fileInput.value = '';
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Refresh files list
        function refreshFilesList() {
            const filesList = document.getElementById('sharedFilesList');
            filesList.innerHTML = '<div class="no-files">No shared files</div>';
            logMessage('üîÑ Files list refreshed');
        }

        // Update status display
        function updateStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = `status ${type}`;
            }
        }

        // Update room info
        function updateRoomInfo(code, status) {
            document.getElementById('roomCode').textContent = code;
            document.getElementById('roomStatus').textContent = status;
        }

        // Log message
        function logMessage(message, data = null) {
            const log = document.getElementById('messageLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (data) {
                logEntry.innerHTML += `<br><small style="color: #666;">${JSON.stringify(data, null, 2)}</small>`;
            }
            
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`, data);
        }

        // Clear log
        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
            logMessage('üìù Log cleared');
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            logMessage('üöÄ Test page loaded');
            initConnection();
        });
    </script>
</body>
</html>