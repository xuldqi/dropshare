<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>错误修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>错误修复测试页面</h1>
    
    <div class="test-section">
        <h3>测试1: Events对象可用性</h3>
        <button onclick="testEvents()">测试Events对象</button>
        <div id="events-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>测试2: 成员列表渲染</h3>
        <button onclick="testMembersList()">测试成员列表</button>
        <div id="members-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h3>测试3: 房间创建数据处理</h3>
        <button onclick="testRoomData()">测试房间数据</button>
        <div id="room-log" class="log"></div>
    </div>

    <script src="scripts/network.js"></script>
    <script>
        function log(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
        }
        
        function testEvents() {
            const logEl = 'events-log';
            document.getElementById(logEl).innerHTML = '';
            
            log(logEl, '检查window.Events: ' + (window.Events ? '✓ 可用' : '✗ 不可用'));
            log(logEl, '检查window.network: ' + (window.network ? '✓ 可用' : '✗ 不可用'));
            log(logEl, '检查window.network.Events: ' + (window.network?.Events ? '✓ 可用' : '✗ 不可用'));
            
            if (window.Events) {
                try {
                    window.Events.fire('test-event', { test: true });
                    log(logEl, '✓ Events.fire测试成功');
                } catch (e) {
                    log(logEl, '✗ Events.fire测试失败: ' + e.message);
                }
            }
        }
        
        function testMembersList() {
            const logEl = 'members-log';
            document.getElementById(logEl).innerHTML = '';
            
            // 测试不同的成员数据结构
            const testMembers = [
                { name: '用户1', isHost: true },
                { displayName: '用户2', isHost: false },
                { name: undefined, displayName: '用户3', isHost: false },
                { isHost: false }, // 没有name或displayName
                null, // null成员
                undefined // undefined成员
            ];
            
            testMembers.forEach((member, index) => {
                try {
                    if (!member) {
                        log(logEl, `成员${index + 1}: null/undefined - 跳过`);
                        return;
                    }
                    
                    const memberName = member.name || member.displayName || '未知用户';
                    const avatar = memberName.charAt(0).toUpperCase();
                    log(logEl, `成员${index + 1}: ${memberName} (头像: ${avatar}) - ✓ 成功`);
                } catch (e) {
                    log(logEl, `成员${index + 1}: ✗ 错误 - ${e.message}`);
                }
            });
        }
        
        function testRoomData() {
            const logEl = 'room-log';
            document.getElementById(logEl).innerHTML = '';
            
            // 模拟不同的房间数据结构
            const testRoomData = [
                {
                    room: { code: 'TEST1', name: '测试房间1' },
                    hostInfo: { name: '房主1', isHost: true }
                },
                {
                    room: { code: 'TEST2', name: '测试房间2' },
                    hostInfo: { displayName: '房主2', isHost: true }
                },
                {
                    room: { code: 'TEST3', name: '测试房间3' },
                    hostInfo: { isHost: true } // 没有name或displayName
                },
                {
                    room: { code: 'TEST4', name: '测试房间4' }
                    // 没有hostInfo
                }
            ];
            
            testRoomData.forEach((data, index) => {
                try {
                    const hostInfo = data.hostInfo || { displayName: '房主', name: '房主', isHost: true };
                    if (!hostInfo.name && hostInfo.displayName) {
                        hostInfo.name = hostInfo.displayName;
                    }
                    
                    const memberName = hostInfo.name || hostInfo.displayName || '未知用户';
                    log(logEl, `房间${index + 1} (${data.room.code}): 房主=${memberName} - ✓ 成功`);
                } catch (e) {
                    log(logEl, `房间${index + 1}: ✗ 错误 - ${e.message}`);
                }
            });
        }
        
        // 页面加载时自动运行测试
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                testEvents();
                testMembersList();
                testRoomData();
            }, 1000);
        });
    </script>
</body>
</html>