<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Language Sync Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        select { padding: 5px; margin: 10px; }
    </style>
</head>
<body>
    <h1>Language Sync Test</h1>
    
    <div class="test-section">
        <h2>Current Language Status</h2>
        <p>Current Language: <span id="current-lang">Loading...</span></p>
        <p>LocalStorage: <span id="localstorage-lang">Loading...</span></p>
    </div>
    
    <div class="test-section">
        <h2>Language Selector</h2>
        <select id="language-selector">
            <option value="en">English</option>
            <option value="zh-CN">简体中文</option>
            <option value="zh-TW">繁體中文</option>
            <option value="ja">日本語</option>
            <option value="ko">한국어</option>
        </select>
    </div>
    
    <div class="test-section">
        <h2>Translation Test</h2>
        <p data-i18n="rooms_title">Rooms</p>
        <p data-i18n="share_create_room">Create Room</p>
        <p data-i18n="nav_home">Home</p>
    </div>
    
    <div class="test-section">
        <h2>Navigation</h2>
        <a href="index.html">Home</a> | 
        <a href="rooms-improved.html">Rooms</a> | 
        <a href="transer.html">Share</a>
    </div>
    
    <script src="scripts/i18n/languages.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test page loaded');
            
            // Wait for DROPSHARE_I18N to load
            function waitForI18N() {
                if (window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.getCurrentLanguage === 'function') {
                    initTest();
                } else {
                    setTimeout(waitForI18N, 50);
                }
            }
            
            waitForI18N();
        });
        
        function initTest() {
            const langSelector = document.getElementById('language-selector');
            const currentLangSpan = document.getElementById('current-lang');
            const localStorageSpan = document.getElementById('localstorage-lang');
            
            // Update status
            function updateStatus() {
                const currentLang = window.DROPSHARE_I18N.getCurrentLanguage();
                const storedLang = localStorage.getItem('preferred_language');
                
                currentLangSpan.textContent = currentLang;
                localStorageSpan.textContent = storedLang;
                
                if (langSelector) {
                    langSelector.value = currentLang;
                }
                
                // Translate page
                translatePage();
            }
            
            // Initialize language selector
            if (langSelector) {
                langSelector.addEventListener('change', function(e) {
                    const newLang = e.target.value;
                    console.log('Language changed to:', newLang);
                    
                    if (window.DROPSHARE_I18N) {
                        window.DROPSHARE_I18N.changeLanguage(newLang);
                        updateStatus();
                    }
                });
            }
            
            // Initial update
            updateStatus();
        }
        
        function translatePage() {
            if (window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.t === 'function') {
                const elements = document.querySelectorAll('[data-i18n]');
                elements.forEach(element => {
                    const key = element.getAttribute('data-i18n');
                    const translation = window.DROPSHARE_I18N.t(key);
                    if (translation !== key) {
                        element.textContent = translation;
                    }
                });
            }
        }
    </script>
</body>
</html>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #f5f5f5;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        .links {
            margin: 20px 0;
        }
        .links a {
            display: inline-block;
            padding: 10px 20px;
            margin: 5px;
            background: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        .links a:hover {
            background: #218838;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
    <script src="scripts/i18n/languages.js"></script>
</head>
<body>
    <h1>语言同步测试 / Language Sync Test</h1>
    
    <div class="test-section">
        <h2>当前状态 / Current Status</h2>
        <div id="current-status"></div>
    </div>
    
    <div class="test-section">
        <h2>快速测试 / Quick Test</h2>
        <button onclick="testLanguageSync()">运行完整测试 / Run Full Test</button>
        <button onclick="setAndTest('zh-CN')">设置为中文并测试</button>
        <button onclick="setAndTest('en')">Set to English and Test</button>
        <button onclick="clearAll()">清除所有设置 / Clear All</button>
    </div>
    
    <div class="test-section">
        <h2>页面链接 / Page Links</h2>
        <div class="links">
            <a href="index.html" target="_blank">首页 / Homepage</a>
            <a href="transer.html" target="_blank">传送 / Transfer</a>
            <a href="rooms-improved.html" target="_blank">房间 / Rooms</a>
            <a href="image-tools.html" target="_blank">图片工具 / Image Tools</a>
            <a href="debug-language.html" target="_blank">调试页面 / Debug Page</a>
        </div>
    </div>
    
    <div class="test-section">
        <h2>测试结果 / Test Results</h2>
        <div id="test-results"></div>
    </div>
    
    <script>
        function updateStatus() {
            const statusDiv = document.getElementById('current-status');
            
            // Get all relevant localStorage values
            const preferred = localStorage.getItem('preferred_language');
            const dropshare = localStorage.getItem('dropshare_language');
            const snapdrop = localStorage.getItem('snapdrop-language');
            
            // Get current language from DROPSHARE_I18N
            let currentLang = 'N/A';
            let userLang = 'N/A';
            if (window.DROPSHARE_I18N) {
                currentLang = window.DROPSHARE_I18N.getCurrentLanguage ? window.DROPSHARE_I18N.getCurrentLanguage() : 'N/A';
                userLang = window.DROPSHARE_I18N.getUserLanguage ? window.DROPSHARE_I18N.getUserLanguage() : 'N/A';
            }
            
            // Browser language
            const browserLang = navigator.language || 'en';
            
            statusDiv.innerHTML = `
                <div class="status ${preferred === currentLang ? 'success' : 'warning'}">
                    <strong>localStorage['preferred_language']:</strong> ${preferred || 'null'}
                </div>
                <div class="status ${dropshare ? 'warning' : 'success'}">
                    <strong>localStorage['dropshare_language']:</strong> ${dropshare || 'null'} ${dropshare ? '(应该为空 / should be null)' : '✓'}
                </div>
                <div class="status ${snapdrop ? 'warning' : 'success'}">
                    <strong>localStorage['snapdrop-language']:</strong> ${snapdrop || 'null'} ${snapdrop ? '(应该为空 / should be null)' : '✓'}
                </div>
                <div class="status ${currentLang !== 'N/A' ? 'success' : 'error'}">
                    <strong>DROPSHARE_I18N.getCurrentLanguage():</strong> ${currentLang}
                </div>
                <div class="status ${userLang !== 'N/A' ? 'success' : 'error'}">
                    <strong>DROPSHARE_I18N.getUserLanguage():</strong> ${userLang}
                </div>
                <div class="status success">
                    <strong>浏览器语言 / Browser Language:</strong> ${browserLang}
                </div>
                <div class="status ${preferred === currentLang && currentLang === userLang ? 'success' : 'error'}">
                    <strong>同步状态 / Sync Status:</strong> ${preferred === currentLang && currentLang === userLang ? '✓ 已同步 / Synced' : '✗ 未同步 / Not Synced'}
                </div>
            `;
        }
        
        function testLanguageSync() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<h3>测试开始 / Test Started...</h3>';
            
            const tests = [];
            
            // Test 1: Check if preferred_language is the primary key
            const preferred = localStorage.getItem('preferred_language');
            tests.push({
                name: 'Primary Storage Key Test',
                passed: preferred !== null || (!localStorage.getItem('dropshare_language') && !localStorage.getItem('snapdrop-language')),
                message: preferred !== null ? `preferred_language is set: ${preferred}` : 'No language keys set (clean state)'
            });
            
            // Test 2: Check DROPSHARE_I18N existence
            tests.push({
                name: 'DROPSHARE_I18N System Test',
                passed: window.DROPSHARE_I18N !== undefined,
                message: window.DROPSHARE_I18N ? 'DROPSHARE_I18N system loaded' : 'DROPSHARE_I18N system NOT loaded'
            });
            
            // Test 3: Check if language methods work
            if (window.DROPSHARE_I18N) {
                const currentLang = window.DROPSHARE_I18N.getCurrentLanguage();
                const userLang = window.DROPSHARE_I18N.getUserLanguage();
                
                tests.push({
                    name: 'Language Methods Test',
                    passed: currentLang === userLang,
                    message: `getCurrentLanguage: ${currentLang}, getUserLanguage: ${userLang}`
                });
                
                // Test 4: Check if localStorage matches current language
                tests.push({
                    name: 'Storage Sync Test',
                    passed: !preferred || preferred === currentLang,
                    message: preferred === currentLang ? 'Storage synced with current language' : `Mismatch: storage=${preferred}, current=${currentLang}`
                });
            }
            
            // Test 5: Test language change
            if (window.DROPSHARE_I18N && window.DROPSHARE_I18N.changeLanguage) {
                const testLang = 'ja';
                window.DROPSHARE_I18N.changeLanguage(testLang);
                const newLang = window.DROPSHARE_I18N.getCurrentLanguage();
                const newStored = localStorage.getItem('preferred_language');
                
                tests.push({
                    name: 'Language Change Test',
                    passed: newLang === testLang && newStored === testLang,
                    message: `Changed to ${testLang}: current=${newLang}, stored=${newStored}`
                });
                
                // Restore original language
                if (preferred) {
                    window.DROPSHARE_I18N.changeLanguage(preferred);
                }
            }
            
            // Display results
            let html = '<h3>测试结果 / Test Results:</h3>';
            let allPassed = true;
            
            tests.forEach(test => {
                allPassed = allPassed && test.passed;
                html += `
                    <div class="status ${test.passed ? 'success' : 'error'}">
                        <strong>${test.name}:</strong> ${test.passed ? '✓ PASSED' : '✗ FAILED'}
                        <br><small>${test.message}</small>
                    </div>
                `;
            });
            
            html += `
                <div class="status ${allPassed ? 'success' : 'error'}" style="font-size: 1.2em; margin-top: 20px;">
                    <strong>总体结果 / Overall:</strong> ${allPassed ? '✓ 所有测试通过 / All Tests Passed' : '✗ 有测试失败 / Some Tests Failed'}
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            updateStatus();
        }
        
        function setAndTest(lang) {
            if (window.DROPSHARE_I18N && window.DROPSHARE_I18N.changeLanguage) {
                window.DROPSHARE_I18N.changeLanguage(lang);
                localStorage.setItem('preferred_language', lang);
                
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = `
                    <div class="status success">
                        语言已设置为 / Language set to: <strong>${lang}</strong>
                        <br>请刷新其他页面查看是否同步 / Please refresh other pages to check sync
                    </div>
                `;
                
                updateStatus();
            }
        }
        
        function clearAll() {
            localStorage.removeItem('preferred_language');
            localStorage.removeItem('dropshare_language');
            localStorage.removeItem('snapdrop-language');
            
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = `
                <div class="status success">
                    所有语言设置已清除 / All language settings cleared
                    <br>页面将使用浏览器默认语言 / Pages will use browser default language
                </div>
            `;
            
            updateStatus();
        }
        
        // Initialize on load
        window.addEventListener('DOMContentLoaded', function() {
            updateStatus();
        });
    </script>
</body>
</html>