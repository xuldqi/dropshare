<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Web App Config -->
    <title>DropShare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3367d6">
    <meta name="color-scheme" content="dark light">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-title" content="DropShare">
    <!-- Descriptions -->
    <meta name="description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="keywords" content="File, Transfer, Share, Peer2Peer">
    <meta name="author" content="RobinLinus">
    <meta property="og:title" content="DropShare">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://snapdrop.net/">
    <meta property="og:author" content="https://facebook.com/RobinLinus">
    <meta name="twitter:author" content="@RobinLinus">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="og:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <!-- Icons -->
    <link rel="icon" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="shortcut icon" href="images/favicon-96x96.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <meta name="msapplication-TileImage" content="images/mstile-150x150.png">
    <link rel="fluid-icon" type="image/png" href="images/android-chrome-192x192.png">
    <meta name="twitter:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <meta property="og:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <!-- Resources -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Override styles.css layout for centered sharing page */
        body {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
        }
        
        /* Main page container */
        .page-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            position: relative;
            padding-top: 80px;
        }
        
        /* Message area in the center */
        .center-message {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        /* User info at bottom */
        .user-info-bottom {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }
        
        /* Style the peer area */
        x-peers {
            display: flex !important;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        /* Center the no-peers message */
        x-no-peers {
            margin: 20px 0;
        }
        
        /* Center footer content */
        footer {
            position: static !important;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        
        /* Hide instructions container that interferes */
        .instructions-container {
            display: none;
        }
        
        /* Hide back to home button */
        .back-home-btn {
            display: none !important;
        }
        
        /* Room functionality styles */
        .room-container {
            display: none;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .room-container.active {
            display: flex !important;
        }
        
        /* Force show room container when URL contains #rooms */
        body:target-within(#roomContainer),
        html:has([id="roomContainer"]) .room-container,
        .room-container {
            display: flex !important;
        }
        
        /* Show room container by default for testing */
        #roomContainer {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* CSS-based mode switching */
        body[data-mode="rooms"] #roomContainer {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        body[data-mode="rooms"] #peerContainer {
            display: none !important;
        }
        
        body[data-mode="transfer"] #roomContainer {
            display: none !important;
        }
        
        body[data-mode="transfer"] #peerContainer {
            display: block !important;
        }
        
        .room-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .room-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .room-subtitle {
            font-size: 1.125rem;
            color: #64748b;
            margin: 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-options {
            display: flex !important;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .room-forms-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            width: 100%;
            padding: 0 20px; /* Add left and right padding to ensure spacing on small screens */
            box-sizing: border-box;
        }
        
        .room-btn {
            padding: 14px 28px;
            background: #3367d6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .room-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .room-btn.secondary {
            background: transparent;
            color: #3367d6;
            border: 2px solid #3367d6;
        }
        
        .room-btn.secondary:hover {
            background: #3367d6;
            color: white;
        }
        
        .room-form {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 0 auto; /* Horizontal centering */
            position: relative;
            z-index: 1050; /* Ensure above navigation bar */
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        
        .room-form.active {
            display: block;
        }
        
        .room-form h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Ensure padding and border are included in width */
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3367d6;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        
        .btn-primary {
            background: #3367d6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
        }
        
        .room-info {
            display: none;
            background: #f0f9ff;
            border-radius: 12px;
            border-left: 4px solid #3367d6;
            margin-bottom: 24px;
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .room-info.active {
            display: block;
        }
        
        .room-info-header {
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .room-info-header:hover {
            background: #f1f5f9;
        }
        
        .room-summary {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }
        
        .room-name-display {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }
        
        .room-code-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .room-code-display {
            font-family: monospace;
            color: #3367d6;
            font-weight: 600;
            font-size: 14px;
        }
        
        .copy-btn-small {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .copy-btn-small:hover {
            background: #f1f5f9;
        }
        
        .member-count {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-info {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 4px 0;
        }
        
        .current-user-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-name {
            font-size: 12px;
            color: #3367d6;
            font-weight: 600;
            background: #f0f9ff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
        }
        
        .toggle-details-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .toggle-details-btn:hover {
            background: #e2e8f0;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
            color: #64748b;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .room-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        .room-details.expanded {
            max-height: 200px;
            padding: 16px 20px;
        }
        
        .room-members-section {
            font-size: 14px;
        }
        
        .room-members-section strong {
            display: block;
            margin-bottom: 12px;
            color: #374151;
        }
        
        .room-actions {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            text-align: center;
        }
        
        .btn-leave-room {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-leave-room:hover {
            background: #dc2626;
        }
        
        /* Room warning styles */
        .room-warning {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            margin-bottom: 24px;
            padding: 16px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-warning.active {
            display: block;
        }
        
        .warning-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .warning-text {
            flex: 1;
        }
        
        .warning-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .warning-message {
            color: #92400e;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .room-members {
            margin-top: 20px;
        }
        
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .member-name {
            font-weight: 500;
        }
        
        .member-role {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .error-message {
            color: #ef4444;
            background: #fef2f2;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
        }
        
        /* Room file sharing area styles */
        .file-transfer-area {
            display: none;
            width: 100%;
            margin-top: 24px;
        }
        
        .room-file-sharing {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .file-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .file-transfer-area.active {
            display: block;
        }
        
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .shared-files-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .upload-section h3, .shared-files-section h3 {
            margin: 0 0 16px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shared-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .file-count {
            color: #6b7280;
            font-size: 14px;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .upload-hint {
            color: #6b7280;
            font-size: 14px;
            margin: 4px 0 12px 0;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3367d6;
            background: #f0f9ff;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .upload-icon {
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .drop-zone p {
            color: #6b7280;
            margin: 0;
            font-size: 16px;
        }
        
        .select-files-btn {
            background: #3367d6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .select-files-btn:hover {
            background: #2563eb;
        }
        
        .shared-files-list {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .no-shared-files {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
        }
        
        .no-shared-files p {
            margin: 8px 0;
        }
        
        .no-shared-files .hint {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shared-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fafafa;
            transition: all 0.2s;
        }
        
        .shared-file-item:hover {
            background: #f0f9ff;
            border-color: #3367d6;
        }
        
        .shared-file-info {
            flex: 1;
        }
        
        .shared-file-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            font-size: 16px;
        }
        
        .shared-file-details {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            gap: 16px;
        }
        
        .shared-file-uploader {
            color: #3367d6;
            font-weight: 500;
        }
        
        .restored-tag {
            color: #f59e0b;
            font-size: 12px;
            font-weight: normal;
        }
        
        .unavailable-hint {
            color: #ef4444;
            font-size: 12px;
            font-style: italic;
        }
        
        .action-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* File status styles */
        .shared-file-item.file-offline {
            opacity: 0.6;
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        
        .shared-file-item.file-offline .shared-file-name {
            color: #6c757d;
        }
        
        .shared-file-item.file-unavailable {
            opacity: 0.7;
            background: #fdf2f2;
            border-color: #fecaca;
        }
        
        .shared-file-item.file-unavailable .shared-file-name {
            color: #991b1b;
        }
        
        .file-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .status-online {
            background: #10b981;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        .status-unavailable {
            background: #f59e0b;
        }
        
        .shared-file-actions {
            display: flex;
            gap: 8px;
        }
        
        .transfer-item, .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fafafa;
        }
        
        .transfer-info, .file-info {
            flex: 1;
        }
        
        .transfer-name, .file-name {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .transfer-details, .file-details {
            font-size: 12px;
            color: #6b7280;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3367d6;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .transfer-actions, .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-download {
            background: #10b981;
            color: white;
        }
        
        .btn-download:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #ef4444;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #dc2626;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .room-file-sharing {
                gap: 16px;
            }
            
            .upload-section, .shared-files-section {
                padding: 20px;
            }
            
            .room-container {
                max-width: 800px;
                padding: 20px;
            }
            
            .room-info {
                max-width: 100%;
            }
        }
        
        /* Mobile adaptation */
        @media (max-width: 768px) {
            .back-home-btn {
                top: 16px;
                left: 16px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .room-container {
                max-width: 100%;
                padding: 16px;
                gap: 20px;
            }
            
            .room-options {
                flex-direction: column;
                gap: 12px;
            }
            
            .room-btn {
                width: 100%;
                padding: 16px;
            }
            
            .room-form {
                padding: 20px;
            }
            
            .shared-file-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .shared-file-actions {
                justify-content: center;
            }
            
            .drop-zone {
                padding: 30px 20px;
            }
            
            .upload-section h3, 
            .transfer-list-section h3, 
            .received-files-section h3 {
                font-size: 16px;
            }
            
            .room-title {
                font-size: 1.875rem;
            }
            
            .room-subtitle {
                font-size: 1rem;
            }
            
            .room-header {
                margin-bottom: 24px;
            }
        }
        
        /* Large screen optimization */
        @media (min-width: 1400px) {
            .room-container {
                max-width: 1400px;
            }
            
            .file-transfer-grid {
                gap: 32px;
            }
        }
        
        /* Top navigation bar styles */
        .top-navbar {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }
        
        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            padding: 0 20px;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #3367d6;
            font-size: 24px;
            font-weight: 600;
        }
        
        .navbar-brand .brand-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            fill: currentColor;
        }
        
        .navbar-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-link {
            padding: 8px 16px;
            text-decoration: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            color: #3367d6;
            background: #f3f4f6;
        }

        .nav-link.active {
            color: #3367d6;
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .language-selector select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Adjust page content to make space for fixed navigation bar */
        body {
            padding-top: 60px !important;
        }
        
        .page-container {
            padding-top: 20px; /* Reduce original top padding */
        }
        
        /* Responsive navigation bar */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 16px;
            }
            
            .navbar-brand {
                font-size: 20px;
            }
            
            .navbar-brand .brand-icon {
                width: 28px;
                height: 28px;
                margin-right: 8px;
            }
            
            .navbar-nav {
                gap: 4px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .language-selector select {
                padding: 4px 8px;
                font-size: 13px;
            }
        }
    </style>
    <link rel="stylesheet" href="share-integration.css">
    <link rel="stylesheet" href="device-selector.css">
    <script src="/locales/i18n.js"></script>
</head>

<body translate="no">
    <!-- Top navigation bar -->
    <nav class="top-navbar">
        <div class="navbar-container">
            <!-- Brand LOGO -->
            <a href="/" class="navbar-brand">
                <svg class="brand-icon" viewBox="0 0 24 24">
                    <use xlink:href="#wifi-tethering" />
                </svg>
                DropShare
            </a>
            
            <!-- Navigation menu -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="/share.html" class="nav-link active">Transfer</a>
                </li>
                <li class="nav-item">
                    <a href="/share.html#rooms" class="nav-link">Rooms</a>
                </li>
                <li class="nav-item">
                    <a href="image-tools.html" class="nav-link">Images</a>
                </li>
                <li class="nav-item">
                    <a href="audio-tools.html" class="nav-link">Audio</a>
                </li>
                <li class="nav-item">
                    <a href="video-tools.html" class="nav-link">Video</a>
                </li>
                <li class="nav-item">
                    <a href="document-tools.html" class="nav-link">Documents</a>
                </li>
                <li class="nav-item language-selector">
                    
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- Add background animation -->
    <div class="background-animation"></div>
    
    <!-- Back to home button is hidden -->
    
    <header class="row-reverse">
        <a href="#about" class="icon-button" title="About DropShare" style="display: none;">
            <svg class="icon">
                <use xlink:href="#info-outline" />
            </svg>
        </a>
        <a href="#" id="theme" class="icon-button" title="Switch Darkmode/Lightmode" >
            <svg class="icon">
                <use xlink:href="#icon-theme" />
            </svg>
        </a>
        <a href="#" id="notification" class="icon-button" title="Enable Notifications" hidden>
            <svg class="icon">
                <use xlink:href="#notifications" />
            </svg>
        </a>
        <a href="#" id="install" class="icon-button" title="Install Snapdrop" hidden>
            <svg class="icon">
                <use xlink:href="#homescreen" />
            </svg>
        </a>
        <div class="lang-selector">
            
        </div>
    </header>
    
    <!-- Main page container -->
    <div class="page-container">
        <!-- Center message area -->
        <div class="center-message">
            <!-- Room functionality container -->
            <div id="roomContainer" class="room-container">
                <div class="room-header">
                    <h1 class="room-title">Rooms</h1>
                    <p class="room-subtitle">Quickly share files with users on the same network or remote users via room codes</p>
                </div>
                
                <!-- Room option buttons -->
                <div class="room-options">
                    <button id="createRoomBtn" class="room-btn">Create Room</button>
                    <button id="joinRoomBtn" class="room-btn secondary">Join Room</button>
                </div>
                
                <!-- Form container for centering -->
                <div class="room-forms-container">
                    <!-- Create Room form -->
                    <div id="createRoomForm" class="room-form">
                        <h3>Create New Room</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label">Room Name</label>
                                <input type="text" id="roomName" name="room-name" class="form-input" placeholder="Enter Room Name" maxlength="20" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Room Password (Optional)</label>
                                <input type="password" id="roomPassword" name="room-password" class="form-input" placeholder="Set room password" maxlength="16" autocomplete="new-password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Maximum Members</label>
                                <input type="number" id="maxMembers" name="max-members" class="form-input" value="10" min="2" max="50" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmCreateRoom" class="btn-primary">Create Room</button>
                                <button type="button" id="cancelCreateRoom" class="btn-cancel">Cancel</button>
                            </div>
                        </form>
                        <div id="createRoomError" class="error-message" style="display: none;"></div>
                    </div>
                    
                    <!-- Join Room form -->
                    <div id="joinRoomForm" class="room-form">
                        <h3>Join Room</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label">Room Code</label>
                                <input type="text" id="roomCode" name="room-code" class="form-input" placeholder="Enter Room Code" maxlength="10" style="text-transform: uppercase;" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Room Password (if required)</label>
                                <input type="password" id="joinRoomPassword" name="join-password" class="form-input" placeholder="Enter room password" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmJoinRoom" class="btn-primary">Join Room</button>
                                <button type="button" id="cancelJoinRoom" class="btn-cancel">Cancel</button>
                            </div>
                        </form>
                        <div id="joinRoomError" class="error-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Room info display -->
                <div id="roomInfo" class="room-info">
                    <!-- Room info header (always visible) -->
                    <div class="room-info-header" id="roomInfoHeader">
                        <div class="room-summary">
                            <span class="room-name-display" id="roomNameDisplay"></span>
                            <div class="room-code-row">
                                <span class="room-code-display" id="roomCodeDisplay"></span>
                                <button id="copyRoomCode" class="copy-btn-small" data-i18n-title="copy_room_code" title="CopyRoom Code">📋</button>
                            </div>
                            <div class="current-user-info">
                                <span class="current-user-label">Your Name: </span>
                                <span class="current-user-name" id="currentUserName"></span>
                            </div>
                            <span class="member-count" id="memberCount"><span id="memberCountNumber">2</span><span> online</span></span>
                        </div>
                        <button class="toggle-details-btn" id="toggleDetailsBtn">
                            <svg class="toggle-icon" viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Room details (collapsible) -->
                    <div class="room-details" id="roomDetails">
                        <div class="room-members-section">
                            <strong>Room Members:</strong>
                            <div id="memberList" class="member-list"></div>
                        </div>
                    </div>
                    
                    <!-- Action buttons -->
                    <div class="room-actions">
                        <button id="leaveRoomBtn" class="btn-leave-room">Leave Room</button>
                    </div>
                </div>
                
                <!-- Room warning -->
                <div id="roomWarning" class="room-warning">
                    <div class="warning-content">
                        <div class="warning-icon">⚠️</div>
                        <div class="warning-text">
                            <div id="warningTitle" class="warning-title"></div>
                            <div id="warningMessage" class="warning-message"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Room file sharing area -->
                <div id="fileTransferArea" class="file-transfer-area">
                    <div class="room-file-sharing">
                        <!-- File upload area -->
                        <div class="upload-section">
                            <h3>📤 Upload files to room</h3>
                            <div id="dropZone" class="drop-zone">
                                <div class="drop-zone-content">
                                    <svg class="upload-icon" viewBox="0 0 24 24" width="48" height="48">
                                        <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                    </svg>
                                    <p>Drag files here or click to upload</p>
                                    <p class="upload-hint">Files will be shared with all room members</p>
                                    <input type="file" id="fileInput" multiple hidden>
                                    <button id="selectFilesBtn" class="select-files-btn">Select Files to Upload</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Shared Room Files list -->
                        <div class="shared-files-section">
                            <div class="shared-files-header">
                                <h3>📁 Shared Room Files</h3>
                                <span class="file-count" id="fileCount">0 <span> files</span></span>
                            </div>
                            <div id="sharedFilesList" class="shared-files-list">
                                <div class="no-shared-files">
                                    <p>No shared files in room</p>
                                    <p class="hint">After uploading files, all room members can download</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Original device discovery interface -->
            <div id="peerContainer">
                <x-peers class="center"></x-peers>
                <x-no-peers>
                    <h2>Open DropShare on other devices to send files</h2>
                </x-no-peers>
            </div>
        </div>
        
        <!-- User info at bottom -->
        <div class="user-info-bottom">
            <footer>
                <div class="logo-container">
                    <svg class="icon logo">
                        <use xlink:href="#wifi-tethering" />
                    </svg>
                </div>
                <div class="text-container">
                    <div id="displayName" class="text-line"></div>
                    <div class="font-body2 text-line">You can be discovered by everyone on this network</div>
                </div>
            </footer>
        </div>
    </div>
    <!-- Receive Dialog -->
    <x-dialog id="receiveDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3>File Received</h3>
                <div class="font-subheading" id="fileName"></div>
                <div class="font-body2" id="fileSize"></div>
                <div class='preview' style="visibility: hidden;">
                    <img id='img-preview' src="">
                </div>
                <div class="row">
                    <label for="autoDownload" class="grow">Ask to save each file before downloading</label>
                    <input type="checkbox" id="autoDownload" checked="">
                </div>
                <div class="row-reverse">
                    <a class="button" close id="download" title="Download File" autofocus>Save</a>
                    <button class="button" close>Ignore</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Send Text Dialog -->
    <x-dialog id="sendTextDialog">
        <form action="#">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3>Send a Message</h3>
                    <div id="textInput" class="textarea" role="textbox" data-placeholder="Send a message" autocomplete="off" autofocus contenteditable></div>
                    <div class="row-reverse">
                        <button class="button" type="submit" close>Send</button>
                        <a class="button" close>Cancel</a>
                    </div>
                </x-paper>
            </x-background>
        </form>
    </x-dialog>
    <!-- Receive Text Dialog -->
    <x-dialog id="receiveTextDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3>Message Received</h3>
                <div class="font-subheading" id="text"></div>
                <div class="row-reverse">
                    <button class="button" id="copy" close autofocus>Copy</button>
                    <button class="button" close>Close</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Toast -->
    <div class="toast-container full center">
        <x-toast class="row" shadow="1" id="toast">
            <span id="toast-text">File Transfer Completed</span>
        </x-toast>
    </div>
    <!-- About Page -->
    <x-about id="about" class="full center column" style="display: none;">
        <section class="center column fade-in">
            <header class="row-reverse">
                <a href="#" class="close icon-button">
                    <svg class="icon">
                        <use xlink:href="#close" />
                    </svg>
                </a>
            </header>
            <svg class="icon logo">
                <use xlink:href="#wifi-tethering" />
            </svg>
            <h1>DropShare</h1>
            <div class="font-subheading"><span>The easiest way to transfer files across devices</span><div style="font-size:10px;"><span>Modified version by</span> <a href="#" target="_blank">YourNameHere</a></div></div>
            <div class="row">
                <a class="icon-button" target="_blank" href="#" title="DropShare on Github" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#github" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Help cover the server costs!" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#monetarization" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Tweet about DropShare" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#twitter" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Frequently asked questions" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#help-outline" />
                    </svg>
                </a>
            </div>
        </section>
        <x-background></x-background>
    </x-about>
    <!-- SVG Icon Library -->
    <svg style="display: none;">
        <symbol id="wifi-tethering" viewBox="0 0 24 24">
            <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"></path>
        </symbol>
        <symbol id="desktop-mac" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="windows-desktop" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z M4 7h4v4H4z M10 7h4v4h-4z M4 13h4v2H4z M10 13h4v2h-4z M16 7h4v4h-4z M16 13h4v2h-4z"></path>
        </symbol>
        <symbol id="desktop-linux" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="phone-iphone" viewBox="0 0 24 24">
            <path d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"></path>
        </symbol>
        <symbol id="phone-android" viewBox="0 0 24 24">
            <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3.25-3H6.75V4h10.5v14z"></path>
        </symbol>
        <symbol id="tablet-mac" viewBox="0 0 24 24">
            <path d="M18.5 0h-14C3.12 0 2 1.12 2 2.5v19C2 22.88 3.12 24 4.5 24h14c1.38 0 2.5-1.12 2.5-2.5v-19C21 1.12 19.88 0 18.5 0zm-7 23c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm7.5-4H4V3h15v16z"></path>
        </symbol>
        <symbol id="tablet-android" viewBox="0 0 24 24">
            <path d="M18 0H6C4.34 0 3 1.34 3 3v18c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V3c0-1.66-1.34-3-3-3zm-4 22h-4v-1h4v1zm5.25-3H4.75V3h14.5v16z"></path>
        </symbol>
        <symbol id="info-outline" viewBox="0 0 24 24">
            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="close" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </symbol>
        <symbol id="help-outline" viewBox="0 0 24 24">
            <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="twitter">
            <path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z" />
        </symbol>
        <symbol id="github">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
        </symbol>
        <g id="notifications">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
        </g>
        <symbol id="homescreen" viewBox="0 0 24 24">
            <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41z" />
            <path d="M0 0h24v24H0V0z" fill="none" />
        </symbol>
        <symbol id="icon-theme" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26 c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></symbol>
        
        <!-- Add the sun icon for light mode -->
        <symbol id="icon-sun" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z" /></symbol>
    </svg>
    <!-- Scripts -->
    <!-- Load the language loader first -->
    
    <!-- Load other scripts -->
    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/private-rooms.js"></script>
    <script src="scripts/theme.js" async></script>
    <script src="scripts/clipboard.js" async></script>

    <!-- Room functionality JavaScript -->
    <script>
        // Immediate room mode detection and forced styling
        (function() {
            console.log('=== IMMEDIATE HASH CHECK ===');
            console.log('Current hash:', window.location.hash);
            
            // Function to force room mode
            function forceRoomMode() {
                console.log('Forcing room mode display');
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer) {
                    roomContainer.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    roomContainer.classList.add('active');
                    console.log('Room container forced visible');
                }
                
                if (peerContainer) {
                    peerContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                    console.log('Peer container forced hidden');
                }
            }
            
            // Function to force peer mode  
            function forcePeerMode() {
                console.log('Forcing peer mode display');
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer) {
                    roomContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                    roomContainer.classList.remove('active');
                }
                
                if (peerContainer) {
                    peerContainer.style.cssText = 'display: block !important; visibility: visible !important;';
                }
            }
            
            // Apply immediate mode based on hash
            if (window.location.hash === '#rooms') {
                console.log('Hash is #rooms - applying room mode');
                
                // Set body data-mode attribute for CSS rules
                document.documentElement.setAttribute('data-mode', 'rooms');
                if (document.body) {
                    document.body.setAttribute('data-mode', 'rooms');
                } else {
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.setAttribute('data-mode', 'rooms');
                    });
                }
                
                // Apply immediately if elements exist
                if (document.getElementById('roomContainer')) {
                    forceRoomMode();
                } else {
                    // Wait for DOM and then apply
                    document.addEventListener('DOMContentLoaded', forceRoomMode);
                }
                
                // Also apply after a short delay as backup
                setTimeout(forceRoomMode, 100);
                setTimeout(forceRoomMode, 500);
            } else {
                console.log('Hash is not #rooms - applying peer mode');
                
                // Set body data-mode attribute for CSS rules
                document.documentElement.setAttribute('data-mode', 'transfer');
                if (document.body) {
                    document.body.setAttribute('data-mode', 'transfer');
                } else {
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.setAttribute('data-mode', 'transfer');
                    });
                }
                
                if (document.getElementById('peerContainer')) {
                    forcePeerMode();
                } else {
                    document.addEventListener('DOMContentLoaded', forcePeerMode);
                }
                
                setTimeout(forcePeerMode, 100);
            }
            
            // Add simple CSS override as backup
            const style = document.createElement('style');
            style.id = 'immediate-room-mode-styles';
            if (window.location.hash === '#rooms') {
                style.textContent = `
                    #roomContainer { 
                        display: flex !important; 
                        visibility: visible !important; 
                        opacity: 1 !important;
                    }
                    #peerContainer { 
                        display: none !important;
                    }
                `;
            } else {
                style.textContent = `
                    #roomContainer { display: none !important; }
                    #peerContainer { display: block !important; visibility: visible !important; }
                `;
            }
            document.head.appendChild(style);
            
            console.log('=== IMMEDIATE SETUP COMPLETE ===');
        })();

        // Room functionality management
        class RoomManager {
            constructor() {
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members = new Map();
                this.ws = null;
                this.fileStorage = null;
                
                console.log('RoomManager constructor started');
                
                // Initialize file storage
                this.initFileStorage();
                
                // Check room mode immediately - this is most important
                this.checkForRoomsMode();
                
                // Initialize UI 
                this.initializeRoomUI();
                
                // Set up file events
                this.setupFileEvents();
                
                console.log('RoomManager constructor completed');
            }
            
            // Check if in room mode
            checkForRoomsMode() {
                console.log('checkForRoomsMode - current URL hash:', window.location.hash);
                
                // Force immediate check without waiting for elements
                this.handleHashChange();
                
                // Add event listener only once
                if (!this.hashChangeListenerAdded) {
                    window.addEventListener('hashchange', () => {
                        console.log('URL hash changed:', window.location.hash);
                        this.handleHashChange();
                        updateNavActiveState(); // Update navigation active state on hash change
                    });
                    this.hashChangeListenerAdded = true;
                }
            }
            
            // Handle hash change
            handleHashChange() {
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOM elements not found, retrying later');
                    setTimeout(() => this.handleHashChange(), 50);
                    return;
                }
                
                if (window.location.hash === '#rooms') {
                    console.log('Switching to Room mode');
                    this.showRoomContainer();
                } else {
                    console.log('Switching to Transfer mode');
                    this.showPeerContainer();
                }
            }
            
            // Show room container
            showRoomContainer() {
                console.log('showRoomContainer starting execution');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.error('Cannot find container elements');
                    return;
                }
                
                // Show room container with maximum force
                roomContainer.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                roomContainer.classList.add('active');
                
                // Hide peer container with maximum force  
                peerContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                peerContainer.classList.remove('active');
                
                // Hide bottom user info area (device discovery info)
                this.hideBottomUserInfo();
                
                console.log('Room container forced to display, peer container forced to hide');
                
                // Show room options if not in a room
                setTimeout(() => {
                    if (!this.isInRoom) {
                        console.log('Not in room, ensuring room options are visible');
                        this.ensureRoomOptionsVisible();
                    }
                }, 100);
                
                // Delayed reconnection check
                setTimeout(() => {
                    this.checkAndReconnectRoom();
                }, 2000);
            }
            
            // Show device discovery container
            showPeerContainer() {
                console.log('showPeerContainer starting execution');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.error('Cannot find container elements for peer mode');
                    return;
                }
                
                // Hide room container with maximum force
                roomContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                roomContainer.classList.remove('active');
                
                // Show peer container with maximum force
                peerContainer.style.cssText = 'display: block !important; visibility: visible !important;';
                
                // Show bottom user info area
                this.showBottomUserInfo();
                
                console.log('Peer container forced to display, room container forced to hide');
            }
            
            // Initialize room UI events
            initializeRoomUI() {
                // Wait for DOM to fully load before binding events
                const bindEvents = () => {
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    
                    if (!createBtn || !joinBtn) {
                        console.log('Room buttons not found, waiting for DOM loading...');
                        setTimeout(bindEvents, 100);
                        return;
                    }
                    
                    // Create Room button
                    createBtn.addEventListener('click', () => {
                        this.showCreateRoomForm();
                    });
                
                    // Join Room button
                    joinBtn.addEventListener('click', () => {
                        this.showJoinRoomForm();
                    });
                    
                    // Confirm Create Room
                    document.getElementById('confirmCreateRoom').addEventListener('click', () => {
                        this.createRoom();
                    });
                    
                    // CancelCreate Room
                    document.getElementById('cancelCreateRoom').addEventListener('click', () => {
                        this.hideAllForms();
                    });
                    
                    // Confirm Join Room
                    document.getElementById('confirmJoinRoom').addEventListener('click', () => {
                        this.joinRoom();
                    });
                    
                    // CancelJoin Room
                    document.getElementById('cancelJoinRoom').addEventListener('click', () => {
                        this.hideAllForms();
                    });
                    
                    // Leave Room
                    document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                        this.leaveRoom();
                    });
                    
                    // Room Code input auto-uppercase
                    document.getElementById('roomCode').addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                    });
                    
                    // Room info expand/collapse
                    document.getElementById('toggleDetailsBtn').addEventListener('click', () => {
                        this.toggleRoomDetails();
                    });
                    
                    // CopyRoom Code
                    document.getElementById('copyRoomCode').addEventListener('click', () => {
                        this.copyRoomCode();
                    });
                    
                    // File selection and drag
                    this.initializeFileTransfer();
                    
                    console.log('Room UI event binding completed');
                };
                
                bindEvents();
            }
            
            // Initialize file transfer functionality
            initializeFileTransfer() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const selectFilesBtn = document.getElementById('selectFilesBtn');
                
                if (!dropZone || !fileInput || !selectFilesBtn) {
                    console.log('File transfer elements not found, delayed initialization...');
                    setTimeout(() => this.initializeFileTransfer(), 100);
                    return;
                }
                
                // Click to select files
                selectFilesBtn.addEventListener('click', () => {
                    fileInput.click();
                });
                
                dropZone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // File selection
                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                    // Clear file input, allow repeated upload of same file
                    e.target.value = '';
                });
                
                // Drag functionality
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    this.handleFileSelection(e.dataTransfer.files);
                });
            }
            
            // Handle file selection
            handleFileSelection(files) {
                if (!this.isInRoom) {
                    alert('Please join a room first to upload files');
                    return;
                }
                
                if (files.length === 0) return;
                
                // Upload files directly to room
                this.uploadFilesToRoom(files);
            }
            
            // Upload files to room
            async uploadFilesToRoom(files) {
                console.log('Upload files to room:', files);
                
                for (const file of files) {
                    // Create file info
                    const fileInfo = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploader: this.getCurrentUserDisplayName(),
                        uploaderId: this.getCurrentUserId(),
                        uploadTime: Date.now(),
                        file: file, // Save file object for download
                        isAvailable: true // File availability status
                    };
                    
                    // Store to IndexedDB
                    await this.storeFileToIndexedDB(fileInfo);
                    
                    // Add to local shared list
                    this.addFileToSharedList(fileInfo);
                    
                    // Broadcast to other room members
                    this.broadcastFileToRoom(fileInfo);
                    
                    this.showToast(`File "${file.name}" uploaded to room`);
                }
            }
            
            // Get current user display name
            getCurrentUserDisplayName() {
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.textContent) {
                    // Extract display name (remove "You are called" prefix etc.)
                    const text = displayNameEl.textContent;
                    const match = text.match(/\s(.+)$/);
                    return match ? match[1] : 'Anonymous User';
                }
                return 'Anonymous User';
            }
            
            // Add file to shared list
            addFileToSharedList(fileInfo) {
                const sharedFilesList = document.getElementById('sharedFilesList');
                const noFiles = sharedFilesList.querySelector('.no-shared-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.dataset.fileId = fileInfo.id;
                
                // Use unified display method
                this.updateFileItemDisplay(fileItem, fileInfo);
                
                sharedFilesList.appendChild(fileItem);
                this.updateFileCount();
            }
            
            // Get file icon
            getFileIcon(fileType) {
                if (!fileType) return '📄';
                
                if (fileType.startsWith('image/')) return '🖼️';
                if (fileType.startsWith('video/')) return '🎥';
                if (fileType.startsWith('audio/')) return '🎧';
                if (fileType.includes('pdf')) return '📄';
                if (fileType.includes('word')) return '📄';
                if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '📈';
                if (fileType.includes('powerpoint') || fileType.includes('presentation')) return '📊';
                if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('archive')) return '🗄️';
                return '📁';
            }
            
            // Update file count
            updateFileCount() {
                const fileCount = document.getElementById('fileCount');
                const fileItems = document.querySelectorAll('.shared-file-item');
                const count = fileItems.length;
                
                if (fileCount) {
                    fileCount.textContent = `${count}  files`;
                }
            }
            
            // Download shared file
            downloadSharedFile(fileId) {
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (!fileItem || !fileItem._fileData) {
                    this.showToast('File does not exist');
                    return;
                }
                
                const fileData = fileItem._fileData;
                
                // Check if file is available
                if (!fileData.file) {
                    if (fileData.isRemote) {
                        this.showToast('Cannot download: uploader needs to be online');
                    } else {
                        this.showToast('File unavailable, uploader may be offline');
                    }
                    return;
                }
                
                if (fileData.isAvailable === false) {
                    this.showToast('File temporarily unavailable');
                    return;
                }
                
                try {
                    const url = URL.createObjectURL(fileData.file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast(`Downloading: ${fileData.name}`);
                } catch (error) {
                    console.error('File download failed:', error);
                    this.showToast('Download failed, please retry');
                }
            }
            
            // Remove shared file
            async removeSharedFile(fileId) {
                if (!confirm('Are you sure you want to delete this file?')) {
                    return;
                }
                
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // Delete from IndexedDB
                    await this.deleteFileFromIndexedDB(fileId);
                    
                    // Broadcasting file removal to other room members
                    this.broadcastFileRemoval(fileId);
                    
                    this.showToast('File deleted');
                }
                
                // Check if empty state needs to be shown
                const sharedFilesList = document.getElementById('sharedFilesList');
                const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                if (remainingFiles.length === 0) {
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                }
            }
            
            // Broadcasting file to other room members
            async broadcastFileToRoom(fileInfo) {
                console.log('Broadcasting file to room:', fileInfo.name);
                
                try {
                    // Convert file to transferable format
                    const fileData = await this.fileToBase64(fileInfo.file);
                    
                    // Broadcasting file info and data to other room members
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        },
                        fileData: fileData // Contains actual file data
                    });
                } catch (error) {
                    console.error('File broadcast failed:', error);
                    // If file too large, only send metadata
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        }
                    });
                }
            }
            
            // Convert file to Base64 format for transfer
            async fileToBase64(file) {
                // Limit file size to avoid transferring oversized files
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    throw new Error('File too large, cannot distribute');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // Restore file from Base64
            base64ToFile(dataUrl, fileName, fileType) {
                const arr = dataUrl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], fileName, { type: fileType });
            }
            
            // Broadcast file deletion
            broadcastFileRemoval(fileId) {
                this.sendMessage({
                    type: 'room-file-removed',
                    roomCode: this.currentRoom,
                    fileId: fileId
                });
            }
            
            // Initialize file storage（IndexedDB）
            async initFileStorage() {
                try {
                    this.fileStorage = await this.openIndexedDB();
                    console.log('IndexedDB initialization successful');
                } catch (error) {
                    console.warn('IndexedDB initialization failed, using memory storage:', error);
                    this.fileStorage = null;
                }
            }
            
            // Open IndexedDB
            openIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('DropShareRoomFiles', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('roomCode', 'roomCode', { unique: false });
                        }
                    };
                });
            }
            
            // Store file to IndexedDB
            async storeFileToIndexedDB(fileInfo) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    
                    const fileData = {
                        id: fileInfo.id,
                        roomCode: this.currentRoom,
                        name: fileInfo.name,
                        size: fileInfo.size,
                        type: fileInfo.type,
                        uploader: fileInfo.uploader,
                        uploaderId: fileInfo.uploaderId,
                        uploadTime: fileInfo.uploadTime,
                        file: fileInfo.file // Store actual file
                    };
                    
                    await store.put(fileData);
                    console.log('File stored to IndexedDB:', fileInfo.name);
                } catch (error) {
                    console.error('File storage failed:', error);
                }
            }
            
            // Load room files from IndexedDB
            async loadRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return [];
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAll(roomCode);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Failed to load room files:', error);
                    return [];
                }
            }
            
            // Delete from IndexedDBDocuments
            async deleteFileFromIndexedDB(fileId) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    await store.delete(fileId);
                    console.log('File deleted from IndexedDB:', fileId);
                } catch (error) {
                    console.error('File deletion failed:', error);
                }
            }
            
            // Clear room files (when leaving room)
            async clearRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAllKeys(roomCode);
                    
                    request.onsuccess = () => {
                        const keys = request.result;
                        keys.forEach(key => store.delete(key));
                        console.log(`Cleared all files from room`);
                    };
                } catch (error) {
                    console.error('Failed to clear room files:', error);
                }
            }
            
            // Format file size
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Get current user ID
            getCurrentUserId() {
                // Get current user ID from display name element, this ID is set during network connection
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.dataset.peerId) {
                    return displayNameEl.dataset.peerId;
                }
                // Backup method: get from network connection
                if (window.currentPeerId) {
                    return window.currentPeerId;
                }
                return null;
            }
            
            // Toggle room details display
            toggleRoomDetails() {
                const roomDetails = document.getElementById('roomDetails');
                const toggleIcon = document.querySelector('.toggle-icon');
                
                if (roomDetails.classList.contains('expanded')) {
                    roomDetails.classList.remove('expanded');
                    toggleIcon.classList.remove('rotated');
                } else {
                    roomDetails.classList.add('expanded');
                    toggleIcon.classList.add('rotated');
                }
            }
            
            // CopyRoom Code
            copyRoomCode() {
                const roomCodeText = document.getElementById('roomCodeDisplay').textContent;
                // Extract Room Code part (remove "Room Code: " prefix)
                const roomCode = roomCodeText.replace('Room Code: ', '');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(roomCode).then(() => {
                        this.showToast('Room Code copied to clipboard');
                    }).catch(err => {
                        console.error('Copy failed:', err);
                        this.fallbackCopyRoomCode(roomCode);
                    });
                } else {
                    this.fallbackCopyRoomCode(roomCode);
                }
            }
            
            // Backup copy method
            fallbackCopyRoomCode(roomCode) {
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('Room Code copied to clipboard');
                } catch (err) {
                    console.error('Copy failed:', err);
                    alert('Copy failed, Room Code: ' + roomCode);
                }
                document.body.removeChild(textArea);
            }
            
            // Show notification
            showToast(message) {
                // Create temporary notification element
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #374151;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 2000);
            }
            
            // Show Create Room form
            showCreateRoomForm() {
                this.hideAllForms();
                document.getElementById('createRoomForm').classList.add('active');
            }
            
            // Show Join Room form
            showJoinRoomForm() {
                this.hideAllForms();
                document.getElementById('joinRoomForm').classList.add('active');
            }
            
            // Hide all forms
            hideAllForms() {
                document.getElementById('createRoomForm').classList.remove('active');
                document.getElementById('joinRoomForm').classList.remove('active');
                document.getElementById('createRoomError').style.display = 'none';
                document.getElementById('joinRoomError').style.display = 'none';
                
                // Clear form content to prevent browser auto-fill
                this.clearFormFields();
            }
            
            // Clear form fields
            clearFormFields() {
                document.getElementById('roomName').value = '';
                document.getElementById('roomPassword').value = '';
                document.getElementById('maxMembers').value = '10';
                document.getElementById('roomCode').value = '';
                document.getElementById('joinRoomPassword').value = '';
            }
            
            // Generate Room Code
            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            // Create Room
            createRoom() {
                const roomName = document.getElementById('roomName').value.trim();
                const roomPassword = document.getElementById('roomPassword').value;
                const maxMembers = parseInt(document.getElementById('maxMembers').value);
                
                if (!roomName) {
                                         this.showError('createRoomError', 'Please enter Room Name');
                    return;
                }
                
                const roomCode = this.generateRoomCode();
                const roomSettings = {
                    code: roomCode,
                    name: roomName,
                    password: roomPassword,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                };
                
                // Send Create Room request to backend
                this.sendMessage({
                    type: 'create-room',
                    roomSettings: roomSettings
                });
            }
            
            // Join Room
            joinRoom() {
                const roomCode = document.getElementById('roomCode').value.trim();
                const password = document.getElementById('joinRoomPassword').value;
                
                if (!roomCode) {
                                         this.showError('joinRoomError', 'Please enter Room Code');
                    return;
                }
                
                // Send Join Room request to backend
                this.sendMessage({
                    type: 'join-room',
                    roomCode: roomCode,
                    password: password
                });
            }
            
            // Leave Room
            leaveRoom() {
                if (this.currentRoom) {
                    this.sendMessage({
                        type: 'leave-room',
                        roomCode: this.currentRoom
                    });
                }
            }
            
            // Show error message
            showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            // Send message to WebSocket
            sendMessage(message) {
                // Check if network connection is available
                if (window.network && window.network.send && window.network.isConnected()) {
                    window.network.send(message);
                } else {
                    console.warn('Network connection unavailable, message send failed:', message);
                    // Can add retry logic or error notification here
                    this.showError('createRoomError', 'Network connection unavailable, please try again later');
                }
            }
            
            // Handle room-related WebSocket messages
            handleRoomMessage(message) {
                switch (message.type) {
                    case 'room-created':
                        this.onRoomCreated(message);
                        break;
                    case 'room-joined':
                        this.onRoomJoined(message);
                        break;
                    case 'room-left':
                        this.onRoomLeft(message);
                        break;
                    case 'room-error':
                        this.onRoomError(message);
                        break;
                    case 'room-member-joined':
                        this.onMemberJoined(message);
                        break;
                    case 'room-member-left':
                        this.onMemberLeft(message);
                        break;
                    case 'room-disbanded':
                        this.onRoomDisbanded(message);
                        break;
                    case 'room-file-shared':
                        this.onFileSharedToRoom(message);
                        break;
                    case 'room-file-removed':
                        this.onFileRemovedFromRoom(message);
                        break;
                }
            }
            
            // Room created successfully
            async onRoomCreated(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = true;
                
                // Save room state to local storage
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: true,
                    password: message.room.password || ''
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // Initialize member list
                this.members.clear();
                this.members.set(message.hostInfo.id, message.hostInfo);
                this.updateMemberList([message.hostInfo]);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // Load previous files (if any)
                await this.loadPreviousRoomFiles();
                
                // Redistribute my files to other members (wait a bit after Create Room)
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // Join Room successful
            async onRoomJoined(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = false;
                
                // Save room state to local storage
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: false,
                    password: '' // Do not save password when joining
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // Initialize member list
                this.members.clear();
                message.members.forEach(member => {
                    this.members.set(member.id, member);
                });
                this.updateMemberList(message.members);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // Load previous files (if any)
                await this.loadPreviousRoomFiles();
                
                // Redistribute my files to other members (wait a bit after Join Room)
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // Leave room
            async onRoomLeft(message) {
                const roomCode = this.currentRoom;
                
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members.clear();
                
                // Clear room state from local storage
                this.clearRoomState();
                
                // Clear shared files list
                this.clearSharedFilesList();
                
                // Clear room files from IndexedDB
                if (roomCode) {
                    await this.clearRoomFilesFromIndexedDB(roomCode);
                }
                
                document.getElementById('roomInfo').classList.remove('active');
                this.hideAllForms();
                this.showRoomOptions();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                this.showBottomUserInfo();
                this.removeBeforeUnloadHandler();
            }
            
            // Hide bottom user info area
            hideBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'none';
                }
            }
            
            // Show bottom user info area
            showBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'block';
                }
            }
            
            // Room error
            onRoomError(message) {
                const activeForm = document.querySelector('.room-form.active');
                if (activeForm) {
                    const errorId = activeForm.id === 'createRoomForm' ? 'createRoomError' : 'joinRoomError';
                    this.showError(errorId, message.error);
                } else {
                    // If reconnection failed, show room options
                    console.log('Room reconnection failed:', message.error);
                        this.showToast('Room connection failed: ' + message.error);
                    this.showRoomOptions();
                    this.hideRoomInfo();
                    this.hideFileTransferArea();
                    this.hideRoomWarning();
                    this.showBottomUserInfo();
                    // Clear invalid room state
                    this.clearRoomState();
                }
            }
            
            // New member joined
            async onMemberJoined(message) {
                const memberId = message.member.id;
                const isMyself = memberId === this.getCurrentUserId();
                const isReconnect = message.isReconnect || false;
                
                // Check if already exists to avoid duplicate addition
                const wasAlreadyMember = this.members.has(memberId);
                
                // If duplicate member join event and not reconnection, ignore directly
                if (wasAlreadyMember && !isReconnect) {
                    console.log(`Ignore duplicate member join event: ${message.member.displayName} (${memberId})`);
                    return;
                }
                
                if (isReconnect) {
                    console.log(`Member reconnected: ${message.member.displayName} (${memberId})`);
                } else {
                    console.log(`New member joined: ${message.member.displayName} (${memberId})`);
                }
                
                this.members.set(memberId, message.member);
                this.updateMemberList(Array.from(this.members.values()));
                
                // Update the uploaded files status of this member to online and available
                this.updateUploaderStatus(memberId, true);
                
                // If I rejoined or reconnected, redistribute files
                if (isMyself) {
                    console.log('Detected self rejoin/reconnect room, redistributing files');
                    await this.redistributeMyFiles();
                }
            }
            
            // Redistribute my files to other room members
            async redistributeMyFiles() {
                try {
                    const myFiles = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    const myUploads = myFiles.filter(file => file.uploaderId === this.getCurrentUserId());
                    
                    for (const fileData of myUploads) {
                        if (fileData.file) {
                            console.log('Redistributing file:', fileData.name);
                            
                            // Re-broadcast file
                            const fileInfo = {
                                id: fileData.id,
                                name: fileData.name,
                                size: fileData.size,
                                type: fileData.type,
                                uploader: fileData.uploader,
                                uploaderId: fileData.uploaderId,
                                uploadTime: fileData.uploadTime,
                                file: fileData.file
                            };
                            
                            await this.broadcastFileToRoom(fileInfo);
                        }
                    }
                    
                    if (myUploads.length > 0) {
                        this.showToast(`Redistributed files to room members`);
                    }
                } catch (error) {
                    console.error('File redistribution failed:', error);
                }
            }
            
            // Member left
            onMemberLeft(message) {
                console.log(`Member left: ${message.memberId}, Reason: ${message.reason || 'unknown'}`);
                
                this.members.delete(message.memberId);
                this.updateMemberList(Array.from(this.members.values()));
                
                // If due to connection loss, set files to offline but keep them recoverable
                // If explicit exit, set as unavailable
                const isDisconnected = message.reason === 'disconnected';
                this.updateUploaderStatus(message.memberId, false, isDisconnected);
            }
            
            // Update uploader status
            updateUploaderStatus(uploaderId, isOnline, isDisconnected = false) {
                const fileItems = document.querySelectorAll('.shared-file-item');
                fileItems.forEach(item => {
                    const fileData = item._fileData;
                    if (fileData && fileData.uploaderId === uploaderId) {
                        // Update file data
                        fileData.uploaderOnline = isOnline;
                        
                        if (!isOnline) {
                            if (fileData.isRemote) {
                                fileData.isAvailable = false;
                                // If disconnected (not explicit exit), keep reconnectable status
                                fileData.canReconnect = isDisconnected;
                            }
                        } else if (isOnline && fileData.isRemote && fileData.file) {
                            fileData.isAvailable = true;
                            fileData.canReconnect = false;
                        }
                        
                        // Re-render this file item
                        this.updateFileItemDisplay(item, fileData);
                    }
                });
            }
            
            // Update single file item display
            updateFileItemDisplay(fileItem, fileData) {
                const fileIcon = this.getFileIcon(fileData.type);
                const uploadTime = new Date(fileData.uploadTime).toLocaleString();
                const isRestored = fileData.isRestored ? ' <span class="restored-tag">(Restored)</span>' : '';
                const canDownload = fileData.file && fileData.isAvailable !== false;
                const isOwner = fileData.uploaderId === this.getCurrentUserId();
                
                // Determine file status display
                let statusHint = '';
                let itemClass = 'shared-file-item';
                
                if (!canDownload && !isOwner) {
                    if (fileData.isRemote) {
                        if (fileData.uploaderOnline === false) {
                            statusHint = '<span class="unavailable-hint">Uploader offline, cannot download</span>';
                            itemClass += ' file-offline';
                        } else if (!fileData.file) {
                            statusHint = '<span class="unavailable-hint">File too large, cannot download</span>';
                            itemClass += ' file-unavailable';
                        }
                    } else {
                        statusHint = '<span class="unavailable-hint">File unavailable</span>';
                        itemClass += ' file-unavailable';
                    }
                }
                
                fileItem.className = itemClass;
                fileItem.innerHTML = `
                    <div class="shared-file-info">
                        <div class="shared-file-name">
                            <span class="file-icon">${fileIcon}</span>
                            ${fileData.name}${isRestored}
                        </div>
                        <div class="shared-file-details">
                            <span>${this.formatFileSize(fileData.size)}</span>
                            <span>Uploader: <span class="shared-file-uploader">${fileData.uploader}</span></span>
                            <span>${uploadTime}</span>
                            ${statusHint}
                        </div>
                    </div>
                    <div class="shared-file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadSharedFile('${fileData.id}')" ${!canDownload ? 'disabled' : ''}>Download</button>
                        ${isOwner ? `<button class="action-btn btn-cancel" onclick="roomManager.removeSharedFile('${fileData.id}')">Delete</button>` : ''}
                    </div>
                `;
                
                // Update file data reference
                fileItem._fileData = fileData;
            }
            
            // Room disbanded
            onRoomDisbanded(message) {
                // Clear room state from local storage
                this.clearRoomState();
                // Clear shared files list
                this.clearSharedFilesList();
                alert('Room disbanded:  ' + message.reason);
                this.onRoomLeft();
            }
            
            // Show room info
            showRoomInfo(room) {
                // Update room info header
                document.getElementById('roomNameDisplay').textContent = room.name;
                document.getElementById('roomCodeDisplay').textContent = `Room Code: ${room.code}`;
                
                // Update current user name
                const currentUserName = this.getCurrentUserDisplayName();
                const currentUserNameEl = document.getElementById('currentUserName');
                if (currentUserNameEl) {
                    currentUserNameEl.textContent = currentUserName;
                }
                
                document.getElementById('roomInfo').classList.add('active');
            }
            
            // Update member list
            updateMemberList(members) {
                const memberList = document.getElementById('memberList');
                const memberCount = document.getElementById('memberCount');
                
                memberList.innerHTML = '';
                
                members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.innerHTML = `
                        <span class="member-name">${member.displayName}</span>
                        <span class="member-role">${member.isHost ? 'Host' : 'Member'}</span>
                    `;
                    memberList.appendChild(memberItem);
                    this.members.set(member.id, member);
                });
                
                // Update member count
                memberCount.textContent = `${members.length} online`;
            }
            
            // Hide room option buttons
            hideRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.display = 'none';
                }
            }
            
            // Hide room info
            hideRoomInfo() {
                const roomInfo = document.getElementById('roomInfo');
                if (roomInfo) {
                    roomInfo.classList.remove('active');
                }
            }
            
            // Show room option buttons
            showRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.display = 'flex';
                }
            }
            
            // Ensure room options visible (only when not in room)
            ensureRoomOptionsVisible() {
                console.log('=== Ensure room options visible ===');
                
                // If already in room, should not show Create/Join buttons
                if (this.isInRoom) {
                    console.log('Already in room, not showing Create/Join buttons');
                    return;
                }
                
                // Hide all forms
                this.hideAllForms();
                
                // Hide room info and transfer area
                this.hideRoomInfo();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                
                // Clear shared files list
                this.clearSharedFilesList();
                
                // Show Create/Join buttons
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    console.log('Room option buttons displayed');
                    
                    // Check if buttons exist
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    console.log('Create button exists:', !!createBtn, 'Join button exists:', !!joinBtn);
                } else {
                    console.error('Cannot find .room-options element');
                }
                
                // Show bottom user info area
                this.showBottomUserInfo();
            }
            
            // Show file transfer area
            showFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.add('active');
                }
            }
            
            // Hide file transfer area
            hideFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.remove('active');
                }
            }
            
            // Handle room file sharing messages
            async onFileSharedToRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileInfo = message.fileInfo;
                // Only add files not uploaded by myself
                if (fileInfo.uploaderId !== this.getCurrentUserId()) {
                    try {
                        // If file data exists, restore file
                        if (message.fileData) {
                            fileInfo.file = this.base64ToFile(message.fileData, fileInfo.name, fileInfo.type);
                            fileInfo.isAvailable = true;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true;
                            
                            // Store received files to IndexedDB
                            await this.storeFileToIndexedDB(fileInfo);
                            
                            this.showToast(`${fileInfo.uploader} shared file: ${fileInfo.name}`);
                        } else {
                            // No file data, may be too large or uploader offline
                            fileInfo.file = null;
                            fileInfo.isAvailable = false;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true; // Assume online but file unavailable
                            
                            this.showToast(`${fileInfo.uploader} shared file: ${fileInfo.name} (File too large or unavailable)`);
                        }
                        
                        this.addFileToSharedList(fileInfo);
                    } catch (error) {
                        console.error('Failed to process received file:', error);
                        // If processing fails, at least show file info
                        fileInfo.file = null;
                        fileInfo.isAvailable = false;
                        fileInfo.isRemote = true;
                        fileInfo.uploaderOnline = true;
                        
                        this.addFileToSharedList(fileInfo);
                        this.showToast(`Error receiving file from ${fileInfo.uploader}`);
                    }
                }
            }
            
            // Handle room file deletion messages
            onFileRemovedFromRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileItem = document.querySelector(`[data-file-id="${message.fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // Check if empty state needs to be shown
                    const sharedFilesList = document.getElementById('sharedFilesList');
                    const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                    if (remainingFiles.length === 0) {
                        const noFiles = sharedFilesList.querySelector('.no-shared-files');
                        if (noFiles) {
                            noFiles.style.display = 'block';
                        }
                    }
                }
            }
            
            // Clear shared files list
            clearSharedFilesList() {
                const sharedFilesList = document.getElementById('sharedFilesList');
                if (sharedFilesList) {
                    // Remove all file items
                    const fileItems = sharedFilesList.querySelectorAll('.shared-file-item');
                    fileItems.forEach(item => item.remove());
                    
                    // Show empty state
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                    
                    this.updateFileCount();
                }
            }
            
            // Load previous room files
            async loadPreviousRoomFiles() {
                if (!this.currentRoom) return;
                
                try {
                    const files = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    console.log(`Loaded ${files.length} files from IndexedDB`);
                    
                    files.forEach(fileData => {
                        const fileInfo = {
                            id: fileData.id,
                            name: fileData.name,
                            size: fileData.size,
                            type: fileData.type,
                            uploader: fileData.uploader,
                            uploaderId: fileData.uploaderId,
                            uploadTime: fileData.uploadTime,
                            file: fileData.file,
                            isRestored: true, // Mark as restored file
                            isAvailable: fileData.file ? true : false // Set availability based on file existence
                        };
                        
                        this.addFileToSharedList(fileInfo);
                    });
                    
                    if (files.length > 0) {
                        this.showToast(`Restored ${files.length} previous files`);
                    }
                } catch (error) {
                    console.error('Failed to load previous files:', error);
                }
            }
            
            // Show room warning
            showRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                const warningTitle = document.getElementById('warningTitle');
                const warningMessage = document.getElementById('warningMessage');
                
                if (!roomWarning || !warningTitle || !warningMessage) return;
                
                if (this.isHost) {
                    warningTitle.textContent = 'Host Notice';
                    warningMessage.textContent = 'You are the host. Refreshing will auto-reconnect to the room. Only clicking "Leave Room" or closing the browser tab will disband the room.';
                } else {
                    warningTitle.textContent = 'Member Notice';
                    warningMessage.textContent = 'Refreshing will auto-reconnect to the room. Only clicking "Leave Room" or closing the browser tab will leave the room.';
                }
                
                roomWarning.classList.add('active');
            }
            
            // Hide room warning
            hideRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                if (roomWarning) {
                    roomWarning.classList.remove('active');
                }
            }
            
            // Setup before unload confirmation
            setupBeforeUnloadHandler() {
                this.beforeUnloadHandler = (e) => {
                    if (this.isInRoom) {
                        // Check if it's a refresh operation (not 100% accurate but can try)
                        // If user explicitly wants to close tab/window, still warn
                        const message = this.isHost 
                            ? 'Closing tab will disband the room! Are you sure you want to leave?' 
                            : 'Closing tab will leave the room! Are you sure you want to leave?';
                        
                        e.preventDefault();
                        e.returnValue = message;
                        return message;
                    }
                };
                
                window.addEventListener('beforeunload', this.beforeUnloadHandler);
            }
            
            // Remove before unload confirmation
            removeBeforeUnloadHandler() {
                if (this.beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', this.beforeUnloadHandler);
                    this.beforeUnloadHandler = null;
                }
            }
            
            // Save room state to local storage
            saveRoomState(roomData) {
                try {
                    const roomState = {
                        ...roomData,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('dropshare_room_state', JSON.stringify(roomState));
                    console.log('Room state saved:', roomState);
                } catch (error) {
                    console.error('Failed to save room state:', error);
                }
            }
            
            // Load room state
            loadRoomState() {
                try {
                    const saved = localStorage.getItem('dropshare_room_state');
                    if (saved) {
                        const roomState = JSON.parse(saved);
                        // 检查状态是否过期（24小时）
                        const now = Date.now();
                        const maxAge = 24 * 60 * 60 * 1000; // 24小时
                        
                        if (now - roomState.timestamp < maxAge) {
                            console.log('Found saved room state:', roomState);
                            return roomState;
                        } else {
                            console.log('Room state expired, clearing');
                            this.clearRoomState();
                        }
                    }
                } catch (error) {
                    console.error('Failed to load room state:', error);
                    this.clearRoomState();
                }
                return null;
            }
            
            // Clear room state
            clearRoomState() {
                try {
                    localStorage.removeItem('dropshare_room_state');
                    console.log('Room state cleared');
                } catch (error) {
                    console.error('Failed to clear room state:', error);
                }
            }
            
            // Setup file transfer event listeners
            setupFileEvents() {
                // 等待Events系统就绪
                const setupEvents = () => {
                    if (!window.Events) {
                        setTimeout(setupEvents, 100);
                        return;
                    }
                    
                    // Listen for file received events
                    window.Events.on('file-received', (e) => {
                        this.handleFileReceived(e.detail);
                    });
                    
                    // Listen for file transfer progress events
                    window.Events.on('file-progress', (e) => {
                        this.handleFileProgress(e.detail);
                    });
                    
                    console.log('Room file transfer event listeners setup');
                };
                
                setupEvents();
            }
            
            // Handle file received
            handleFileReceived(fileData) {
                if (!this.isInRoom) return;
                
                console.log('File received in room:', fileData);
                
                // Add to received files list
                this.addToReceivedFilesList(fileData);
                
                // Show notification
                this.showToast(`Received file: ${fileData.name}`);
            }
            
            // Handle file transfer progress
            handleFileProgress(progressData) {
                if (!this.isInRoom) return;
                
                // Update progress bar in transfer list
                this.updateTransferProgress(progressData.sender, progressData.progress);
            }
            
            // Add to received files list
            addToReceivedFilesList(fileData) {
                const receivedFilesList = document.getElementById('receivedFilesList');
                const noFiles = receivedFilesList.querySelector('.no-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-details">
                            ${this.formatFileSize(fileData.size)} • ${fileData.mime || 'Unknown type'}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadFile('${fileData.name}', this)">Download</button>
                    </div>
                `;
                
                // Store file data for download
                fileItem._fileData = fileData;
                
                receivedFilesList.appendChild(fileItem);
            }
            
            // Download file
            downloadFile(fileName, buttonElement) {
                const fileItem = buttonElement.closest('.file-item');
                const fileData = fileItem._fileData;
                
                if (fileData && fileData.blob) {
                    const url = URL.createObjectURL(fileData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('File download started');
                } else {
                    this.showToast('File download failed');
                }
            }
            
            // Update transfer progress
            updateTransferProgress(senderId, progress) {
                const transferItems = document.querySelectorAll('.transfer-item');
                transferItems.forEach(item => {
                    const progressBar = item.querySelector('.progress-fill');
                    if (progressBar) {
                        progressBar.style.width = `${Math.round(progress * 100)}%`;
                    }
                });
            }
            
            // Check and reconnect room
            checkAndReconnectRoom() {
                // Only try to reconnect in room mode
                if (window.location.hash !== '#rooms') {
                    return;
                }
                
                const roomState = this.loadRoomState();
                if (!roomState) {
                    console.log('No saved room state, keep showing room options');
                    return; // Do nothing, keep current state
                }
                
                console.log('Found saved room state, attempting reconnect:', roomState.roomCode);
                
                // Wait for network connection ready
                const attemptReconnect = () => {
                    if (!window.network || !window.network.isConnected()) {
                        console.log('Waiting for network connection...');
                        setTimeout(attemptReconnect, 300);
                        return;
                    }
                    
                    console.log('Network ready, starting room reconnection:', roomState.roomCode);
                    this.showToast('Reconnecting to room...');
                    
                    if (roomState.isHost) {
                        this.sendMessage({
                            type: 'create-room',
                            roomSettings: {
                                code: roomState.roomCode,
                                name: roomState.roomName,
                                password: roomState.password,
                                maxMembers: 50,
                                isPrivate: !!roomState.password
                            }
                        });
                    } else {
                        this.sendMessage({
                            type: 'join-room',
                            roomCode: roomState.roomCode,
                            password: roomState.password
                        });
                    }
                };
                
                setTimeout(attemptReconnect, 500);
            }
        }
        
        // Initialize room manager
        let roomManager;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize multilingual support
            
            
            // Initialize room manager immediately...wait for network
            const initRoomManager = () => {
                console.log('Initializing room manager...');
                
                // Check if DOM elements exist
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOM elements not ready, waiting to retry...');
                    setTimeout(initRoomManager, 50);
                    return;
                }
                
                console.log('DOM elements ready, creating room manager');
                roomManager = new RoomManager();
                window.roomManager = roomManager;
                console.log('Room manager initialization completed');
            };
            
            // Initialize immediately
            initRoomManager();
        });
        
        // 页面完全加载后的补充检查
        window.addEventListener('load', function() {
            console.log('Page fully loaded, checking room status');
            console.log('Current hash:', window.location.hash);
            
            // Initialize navigation bar function links
            initNavbarFunctionLinks();
            
            // Ensure room mode is properly activated
            if (window.location.hash === '#rooms') {
                console.log('Hash is #rooms, ensuring room container is visible');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer && peerContainer) {
                    // Force show room container
                    roomContainer.style.display = 'flex';
                    roomContainer.classList.add('active');
                    
                    // Force hide peer container
                    peerContainer.style.display = 'none';
                    
                    console.log('Room container display forced to flex, peer container hidden');
                    
                    // If room manager exists, trigger room options
                    if (window.roomManager) {
                        setTimeout(() => {
                            if (!window.roomManager.isInRoom) {
                                window.roomManager.ensureRoomOptionsVisible();
                            }
                        }, 100);
                    }
                }
            }
            
            // Initialize top navigation bar language selector
            initNavbarLanguageSelector();
        });
        
        // Initialize top navigation bar language selector
        function initNavbarLanguageSelector() {
            const navbarLangSelector = document.getElementById('navbar-language-selector');
            const headerLangSelector = document.getElementById('language-selector');
            
            if (navbarLangSelector && headerLangSelector) {
                // Sync values of both selectors
                const savedLang = localStorage.getItem('preferred_language') || 'en';
                navbarLangSelector.value = savedLang;
                headerLangSelector.value = savedLang;
                
                // Listen for top navigation bar language selection changes
                navbarLangSelector.addEventListener('change', function() {
                    const selectedLang = this.value;
                    // Sync to header language selector
                    headerLangSelector.value = selectedLang;
                    
                    // Save language preference
                    localStorage.setItem('preferred_language', selectedLang);
                    
                    // Trigger language switch
                    if (window.DROPSHARE_I18N && typeof 
                        console.log('Language changed to:', selectedLang);
                    }
                });
                
                // Listen for header language selector changes, sync to top navigation bar
                headerLangSelector.addEventListener('change', function() {
                    navbarLangSelector.value = this.value;
                });
            }
            
            // Initialize navigation bar function links
            initNavbarFunctionLinks();
        }
        
        // Update navigation active state
        function updateNavActiveState() {
            const transferLink = document.querySelector('a[href="/share.html"]');
            const roomsLink = document.querySelector('a[href="/share.html#rooms"]');
            
            if (transferLink && roomsLink) {
                transferLink.classList.remove('active');
                roomsLink.classList.remove('active');
                
                if (window.location.hash === '#rooms') {
                    roomsLink.classList.add('active');
                } else {
                    transferLink.classList.add('active');
                }
            }
        }

        // Initialize navigation bar function links
        function initNavbarFunctionLinks() {
            // Multi-user Rooms link
            const roomsLink = document.querySelector('a[href="/share.html#rooms"]');
            if (roomsLink) {
                roomsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '#rooms';
                    console.log('Switching to Rooms mode');
                    updateNavActiveState();
                });
            }

            // Transfer link  
            const transferLink = document.querySelector('a[href="/share.html"]');
            if (transferLink) {
                transferLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    console.log('Switching to Transfer mode');
                    updateNavActiveState();
                });
            }

            // Initial state
            updateNavActiveState();
        }
            
            // Transfer link (back to main page)
            const transferLink = document.querySelector('a[href="/"]');
            if (transferLink) {
                transferLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    console.log('Switching to Transfer mode');
                });
            }
            
            // Add file type filter function entry
            const imageLink = document.querySelector('a[href="#images"]');
            const audioLink = document.querySelector('a[href="#audio"]'); 
            const videoLink = document.querySelector('a[href="#video"]');
            const filesLink = document.querySelector('a[href="#files"]');
            
            [imageLink, audioLink, videoLink, filesLink].forEach(link => {
                if (link) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const type = this.getAttribute('href').substring(1);
                        showFileTypeFilter(type);
                    });
                }
            });
        }
        
        // Show file type filter (temporary notification, can expand functionality later)
        function showFileTypeFilter(type) {
            const typeNames = {
                'images': 'Images',
                'audio': 'Audio', 
                'video': 'Video',
                'files': 'Documents'
            };
            
            if (window.roomManager) {
                window.roomManager.showToast(`${typeNames[type]} functionality is in development`);
            } else {
                alert(`${typeNames[type]} functionality is in development`);
            }
            
            console.log(`Switching to ${typeNames[type]} mode`);
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="scripts/firebase-analytics.js"></script>
    
    <!-- Sounds -->
    <audio id="blop" autobuffer="true">
        <source src="/sounds/blop.mp3" type="audio/mpeg">
        <source src="/sounds/blop.ogg" type="audio/ogg">
    </audio>
    <!-- no script -->
    <noscript>
        <x-noscript class="full center column">
            <h1>Enable JavaScript</h1>
            <h3>DropShare works only with JavaScript</h3>
        </x-noscript>
        <style>
        x-noscript {
            background: #599cfc;
            color: white;
            z-index: 2;
        }

        a[href="#info"] {
            color: white;
        }
        </style>
    </noscript>
    <!-- Share Integration -->
    <script src="device-selector.js"></script>
    <script src="add-share-integration.js"></script>
</body>

</html>