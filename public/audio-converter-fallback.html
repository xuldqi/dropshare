<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="audio_converter_fallback_title">Audio Format Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: bold;
            color: #3367d6;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 16px;
        }

        .nav-links a {
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .nav-links a:hover {
            color: #3367d6;
            background: #f3f4f6;
        }

        .nav-links a.active {
            color: #3367d6;
            background: #e3f2fd;
            font-weight: 600;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            text-align: center;
        }

        .page-subtitle {
            font-size: 16px;
            color: #6b7280;
            text-align: center;
            margin-bottom: 40px;
        }

        .converter-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .upload-area {
            border: 3px dashed #d1d5db;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
            margin-bottom: 30px;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: #3367d6;
            background: #eff6ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: #9ca3af;
        }

        .upload-text {
            font-size: 18px;
            color: #374151;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-hint {
            font-size: 14px;
            color: #6b7280;
        }

        #fileInput {
            display: none;
        }

        .conversion-controls {
            background: #f9fafb;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            display: none;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
            margin-bottom: 16px;
        }

        .format-btn {
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            text-align: center;
        }

        .format-btn:hover {
            border-color: #3367d6;
        }

        .format-btn.active {
            border-color: #3367d6;
            background: #3367d6;
            color: white;
        }

        .audio-preview {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            display: none;
        }

        .audio-preview.active {
            display: block;
        }

        .audio-player {
            width: 100%;
            margin-bottom: 12px;
        }

        .audio-info {
            font-size: 14px;
            color: #6b7280;
            text-align: center;
        }

        .convert-button {
            background: #3367d6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            margin-top: 20px;
        }

        .convert-button:hover {
            background: #2563eb;
        }

        .convert-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .progress-section {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f3f4f6;
            border-radius: 4px;
            overflow: hidden;
            margin: 16px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3367d6;
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .note {
            background: #fef3c7;
            color: #92400e;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .note strong {
            display: block;
            margin-bottom: 8px;
        }
    </style>
    <link rel="stylesheet" href="share-integration.css">
    <link rel="stylesheet" href="device-selector.css">
    <script src="/locales/i18n.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-container">
            <a href="index.html" class="logo">
                ðŸŽµ DropShare
            </a>
            <nav class="nav-links">
                <a href="index.html" data-i18n="nav_home">Home</a>
                    <a href="transer.html" data-i18n="nav_transfer">Transfer</a>
                    <a href="rooms-improved.html" data-i18n="nav_rooms">Rooms</a>
                <a href="image-tools.html" data-i18n="nav_images">Images</a>
                <a href="audio-tools.html" class="active" data-i18n="nav_audio">Audio</a>
                <a href="video-tools.html" data-i18n="nav_video">Video</a>
                <a href="document-tools.html" data-i18n="nav_files">Files</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <h1 class="page-title" data-i18n="audio_converter_fallback_heading">Audio Format Converter</h1>
        <p class="page-subtitle" data-i18n="audio_converter_fallback_subtitle">Convert between different audio formats - Browser Native Processing</p><p class="page-subtitle" data-i18n="audio_converter_fallback_subtitle">Convert between different audio formats - Browser Native Processing</p>
        
        <div class="converter-card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ðŸ”„</div>
                <div class="upload-text" data-i18n="audio_converter_fallback_upload_text">Click or drag to upload audio file</div>
                <div class="upload-hint" data-i18n="audio_converter_fallback_upload_hint">Supports MP3, WAV, OGG, AAC, M4A formats</div>
                <input type="file" id="fileInput" accept="audio/*">
            </div>
            
            <div class="audio-preview" id="audioPreview">
                <audio id="audioPlayer" class="audio-player" controls>
                    <span data-i18n="audio_browser_not_support">Your browser does not support the audio element.</span>
                </audio>
                <div class="audio-info" id="audioInfo">
                    <span data-i18n="audio_file_label">File:</span> <span id="fileName">-</span> | 
                    <span data-i18n="audio_duration_label">Duration:</span> <span id="fileDuration">-</span>
                </div>
            </div>
            
            <div class="conversion-controls" id="conversionControls">
                <div class="control-section">
                    <div class="section-title" data-i18n="convert_to_label">Convert To</div>
                    <div class="format-options">
                        <div class="format-btn active" data-format="wav" data-mime="audio/wav">WAV</div>
                        <div class="format-btn" data-format="webm" data-mime="audio/webm">WebM</div>
                        <div class="format-btn" data-format="mp4" data-mime="audio/mp4">MP4</div>
                    </div>
                </div>
                
                <button class="convert-button" id="convertBtn" data-i18n="start_conversion_btn">Start Conversion</button>
            </div>
            
            <div class="progress-section" id="progressSection">
                <div id="progressText">Preparing conversion...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="note">
                <strong data-i18n="browser_conversion_note_title">Note about Browser-based Audio Conversion:</strong>
                <span data-i18n="browser_conversion_note_desc">This tool uses your browser's native audio processing capabilities. Some format conversions may have limitations compared to professional tools. For best results, we recommend converting to MP3 or WAV formats which have the widest browser support.</span>
            </div>
        </div>
    </div>

    <script>
        let audioFile = null;
        let audioContext = null;

        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // File upload handlers
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const audioPreview = document.getElementById('audioPreview');
        const conversionControls = document.getElementById('conversionControls');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('audio/')) {
                alert('Please select an audio file.');
                return;
            }

            audioFile = file;
            
            // Show audio preview
            const audioPlayer = document.getElementById('audioPlayer');
            const url = URL.createObjectURL(file);
            audioPlayer.src = url;
            audioPreview.classList.add('active');
            conversionControls.style.display = 'block';

            // Update file info
            document.getElementById('fileName').textContent = file.name;
            
            audioPlayer.addEventListener('loadedmetadata', () => {
                const duration = Math.round(audioPlayer.duration);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                document.getElementById('fileDuration').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            });
        }

        // Format selection
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Convert button
        document.getElementById('convertBtn').addEventListener('click', async function() {
            if (!audioFile) return;
            
            const activeFormat = document.querySelector('.format-btn.active');
            const targetFormat = activeFormat.dataset.format;
            const targetMime = activeFormat.dataset.mime;
            
            // Get original file extension
            const originalFormat = audioFile.name.split('.').pop().toLowerCase();
            
            // Check if already in target format
            if (originalFormat === targetFormat) {
                alert('File is already in the target format!');
                return;
            }
            
            this.disabled = true;
            const progressSection = document.getElementById('progressSection');
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            progressSection.style.display = 'block';
            progressText.textContent = 'Initializing conversion...';
            progressFill.style.width = '10%';
            
            try {
                // Check browser support for the target format first
                if (targetFormat === 'ogg' || targetFormat === 'webm' || targetFormat === 'mp4') {
                    if (!MediaRecorder.isTypeSupported(targetMime)) {
                        throw new Error(`Your browser doesn't support ${targetFormat.toUpperCase()} recording. Try WAV format instead.`);
                    }
                }
                
                // Method selection based on format and browser support
                if (targetFormat === 'wav') {
                    await convertToWAV(audioFile);
                } else if (targetFormat === 'webm' || targetFormat === 'ogg' || targetFormat === 'mp4') {
                    await convertWithMediaRecorder(audioFile, targetFormat, targetMime);
                } else if (targetFormat === 'mp3') {
                    throw new Error('MP3 encoding requires additional libraries. Please try WAV format or use a dedicated audio converter.');
                } else {
                    throw new Error('Unsupported format conversion');
                }
                
            } catch (error) {
                console.error('Conversion failed:', error);
                progressText.textContent = `Conversion failed: ${error.message}`;
                
                // Offer alternative suggestions
                setTimeout(() => {
                    let message = 'Conversion failed. ';
                    if (targetFormat === 'ogg') {
                        message += 'Try converting to WAV format instead, which has better browser support.';
                    } else if (targetFormat === 'mp3') {
                        message += 'For MP3 conversion, we recommend using a dedicated online MP3 converter.';
                    } else {
                        message += 'Would you like to download the original file?';
                    }
                    
                    if (confirm(message + ' Click OK to proceed or Cancel to try a different format.')) {
                        if (targetFormat === 'mp3') {
                            window.open('https://cloudconvert.com/audio-converter', '_blank');
                        } else {
                            // Download original file with current name
                            const originalName = audioFile.name;
                            downloadFile(audioFile, originalName);
                        }
                    }
                }, 2000);
            } finally {
                this.disabled = false;
            }
        });

        async function convertWithMediaRecorder(file, format, mimeType) {
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            progressText.textContent = 'Loading audio data...';
            progressFill.style.width = '25%';
            
            // Create audio element
            const audio = new Audio();
            const audioURL = URL.createObjectURL(file);
            audio.src = audioURL;
            
            // Wait for audio to load
            await new Promise((resolve) => {
                audio.addEventListener('canplaythrough', resolve);
                audio.load();
            });
            
            progressText.textContent = 'Setting up recording...';
            progressFill.style.width = '50%';
            
            // Create MediaStream from audio
            const audioContext = initAudioContext();
            const source = audioContext.createMediaElementSource(audio);
            const destination = audioContext.createMediaStreamDestination();
            source.connect(destination);
            source.connect(audioContext.destination);
            
            // Create MediaRecorder
            const mediaRecorder = new MediaRecorder(destination.stream, {
                mimeType: mimeType
            });
            
            const chunks = [];
            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) {
                    chunks.push(e.data);
                }
            };
            
            progressText.textContent = 'Converting...';
            progressFill.style.width = '75%';
            
            // Start recording and play audio
            mediaRecorder.start();
            audio.play();
            
            // Wait for audio to finish
            await new Promise((resolve) => {
                audio.addEventListener('ended', () => {
                    mediaRecorder.stop();
                    resolve();
                });
            });
            
            // Wait for recording to complete
            await new Promise((resolve) => {
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: mimeType });
                    progressText.textContent = 'Download ready!';
                    progressFill.style.width = '100%';
                    
                    // Create proper filename with new extension
                    const originalName = file.name;
                    const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
                    const convertedFileName = `${nameWithoutExt}_converted.${format}`;
                    
                    downloadFile(blob, convertedFileName);
                    resolve();
                };
            });
            
            URL.revokeObjectURL(audioURL);
        }

        async function convertToWAV(file) {
            const progressText = document.getElementById('progressText');
            const progressFill = document.getElementById('progressFill');
            
            progressText.textContent = 'Decoding audio...';
            progressFill.style.width = '25%';
            
            const audioContext = initAudioContext();
            const arrayBuffer = await file.arrayBuffer();
            
            progressText.textContent = 'Processing audio data...';
            progressFill.style.width = '50%';
            
            const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            
            progressText.textContent = 'Encoding WAV...';
            progressFill.style.width = '75%';
            
            const wavBlob = audioBufferToWav(audioBuffer);
            
            progressText.textContent = 'Download ready!';
            progressFill.style.width = '100%';
            
            // Create proper filename with new extension  
            const originalName = file.name;
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.')) || originalName;
            const convertedFileName = `${nameWithoutExt}_converted.wav`;
            
            downloadFile(wavBlob, convertedFileName);
        }

        function audioBufferToWav(buffer) {
            const length = buffer.length;
            const numberOfChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            
            const arrayBuffer = new ArrayBuffer(44 + length * numberOfChannels * 2);
            const view = new DataView(arrayBuffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * numberOfChannels * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numberOfChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numberOfChannels * 2, true);
            view.setUint16(32, numberOfChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * numberOfChannels * 2, true);
            
            // Convert audio data
            let offset = 44;
            for (let i = 0; i < length; i++) {
                for (let channel = 0; channel < numberOfChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, buffer.getChannelData(channel)[i]));
                    view.setInt16(offset, sample * 0x7FFF, true);
                    offset += 2;
                }
            }
            
            return new Blob([arrayBuffer], { type: 'audio/wav' });
        }

        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
    <!-- Share Integration -->
    <script src="device-selector.js"></script>
    <script src="add-share-integration.js"></script>
</body>
</html>