<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropShare - Rooms</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- æ·»åŠ i18næ”¯æŒ -->
    <script src="locales/i18n.js"></script>
    
    <script>
        // ç”Ÿæˆå¹¶è®¾ç½®peerid cookie
        function generatePeerId() {
            const cookies = document.cookie.split(';');
            let hasPeerId = false;
            for (let cookie of cookies) {
                if (cookie.trim().startsWith('peerid=')) {
                    hasPeerId = true;
                    const peerId = cookie.trim().split('=')[1];
                    console.log('ğŸ”‘ æ‰¾åˆ°ç°æœ‰peerid:', peerId);
                    return peerId;
                }
            }
            
            if (!hasPeerId) {
                const peerId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                document.cookie = `peerid=${peerId}; path=/`;
                console.log('ğŸ”‘ ç”Ÿæˆæ–°peerid:', peerId);
                return peerId;
            }
        }
        
        generatePeerId();
    </script>

    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3367d6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            
            --red-500: #ef4444;
            --green-500: #10b981;
            --purple-500: #8b5cf6;
            --blue-500: #06b6d4;
            --orange-500: #f59e0b;
            --pink-500: #ec4899;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        /* Ensure page is scrollable on small screens */
        html, body {
            min-height: 100%;
            overflow-y: auto;
        }

        /* ç»Ÿä¸€å¯¼èˆªæ ·å¼ */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--gray-200);
            z-index: 1000;
            padding: 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 64px;
        }

        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .nav-links a:hover {
            color: var(--primary-600);
            background: var(--primary-50);
        }

        .nav-links a.active {
            color: var(--primary-600);
            background: var(--primary-50);
            font-weight: 600;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-600);
        }

        .logo svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-600);
        }

        .language-selector select {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: white;
            color: var(--gray-700);
            font-size: 14px;
            cursor: pointer;
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            margin-top: 80px;
            min-height: calc(100vh - 80px);
            padding: 40px 20px;
            background: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 60px;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* æˆ¿é—´é€‰é¡¹å¡ç‰‡ */
        .room-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .room-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .room-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .room-card-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .room-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .room-card p {
            color: var(--gray-600);
            margin-bottom: 24px;
            line-height: 1.6;
            flex-grow: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-700);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-success {
            background: var(--green-500);
            color: white;
        }

        .btn-danger {
            background: var(--red-500);
            color: white;
        }

        /* æ¨¡æ€çª—å£æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
            padding: 4px;
        }

        .close-btn:hover {
            color: var(--gray-700);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(51, 103, 214, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* æˆ¿é—´çŠ¶æ€åŒºåŸŸ */
        .room-status {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            margin-bottom: 30px;
        }

        .room-status.show {
            display: block;
        }

        .room-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .room-info-item {
            text-align: center;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .room-info-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .room-info-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        /* æ–‡ä»¶ç®¡ç†åŒºåŸŸ */
        .file-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .file-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
        }

        .file-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .file-upload-area.dragover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 8px;
            background: transparent;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .file-size {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* æˆå‘˜åˆ—è¡¨ */
        .members-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            margin-bottom: 30px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: transparent;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .member-status {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        /* è¿æ¥çŠ¶æ€æ ·å¼ */
        .connection-status {
            background: white;
            border-radius: 12px;
            padding: 16px 24px;
            margin: 24px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid var(--gray-300);
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            border-left-color: var(--green-500);
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }

        .connection-status.disconnected {
            border-left-color: var(--red-500);
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }

        .connection-status.connecting {
            border-left-color: var(--blue-500);
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }

        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-400);
            transition: all 0.3s ease;
        }

        .connection-status.connected .connection-indicator {
            background: var(--green-500);
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected .connection-indicator {
            background: var(--red-500);
        }

        .connection-status.connecting .connection-indicator {
            background: var(--blue-500);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .connection-text {
            font-weight: 500;
            color: var(--gray-700);
        }

        .connection-status.connected .connection-text {
            color: var(--green-700);
        }

        .connection-status.disconnected .connection-text {
            color: var(--red-700);
        }

        .connection-status.connecting .connection-text {
            color: var(--blue-700);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }

            .room-options {
                grid-template-columns: 1fr;
            }

            .file-management {
                grid-template-columns: 1fr;
            }

            .room-info {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 24px;
                margin: 20px;
            }

            .connection-status {
                padding: 12px 16px;
                margin: 16px 0;
            }
        }
    </style>
</head>

<body>
    <!-- DropShare ç»Ÿä¸€å¯¼èˆª -->
    <header class="header">
        <div class="header-container">
            <div class="header-controls">
                <div class="logo">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"/>
                    </svg>
                    <a href="index.html" style="text-decoration: none; color: inherit;" data-i18n="site_name">DropShare</a>
                </div>
                <nav class="nav-links">
                    <a href="transer.html" data-i18n="nav_transfer">Transfer</a>
                    <a href="rooms-improved.html" class="active" data-i18n="nav_rooms">Rooms</a>
                    <a href="image-tools.html" data-i18n="nav_images">Images</a>
                    <a href="audio-tools.html" data-i18n="nav_audio">Audio</a>
                    <a href="video-tools.html" data-i18n="nav_video">Video</a>
                    <a href="document-tools.html" data-i18n="nav_files">Files</a>
                </nav>
                <div class="language-selector">
                    <select id="language-selector">
                        <option value="en">English</option>
                        <option value="zh-CN">ä¸­æ–‡ç®€ä½“</option>
                        <option value="zh-TW">ä¸­æ–‡ç¹é«”</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="ko">í•œêµ­ì–´</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="es">EspaÃ±ol</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">
        <div class="container">
            <!-- è‹±é›„åŒºåŸŸ -->
            <div class="hero-section">
                <h1 class="hero-title" data-i18n="rooms_title">Rooms</h1>
                <p class="hero-subtitle" data-i18n="rooms_subtitle">å¿«é€Ÿä¸åŒä¸€ç½‘ç»œæˆ–è¿œç¨‹ç”¨æˆ·é€šè¿‡æˆ¿é—´ä»£ç å…±äº«æ–‡ä»¶</p>
            </div>

            <!-- è¿æ¥çŠ¶æ€ -->
            <div class="connection-status" id="connectionStatus">
                <div class="connection-indicator"></div>
                <div class="connection-text" id="connectionText" data-i18n="connection_disconnected">æœªè¿æ¥</div>
            </div>

            <!-- æˆ¿é—´é€‰é¡¹ -->
            <div class="room-options" id="roomOptions">
                <div class="room-card">
                    <div class="room-card-icon">ğŸ </div>
                    <h3 data-i18n="create_room_title">åˆ›å»ºæˆ¿é—´</h3>
                    <p data-i18n="create_room_desc">åˆ›å»ºä¸€ä¸ªæ–°çš„æˆ¿é—´ï¼Œé‚€è¯·å…¶ä»–ç”¨æˆ·åŠ å…¥å¹¶å…±äº«æ–‡ä»¶</p>
                    <button class="btn btn-primary" onclick="showCreateRoomModal()" data-i18n="create_room_btn">åˆ›å»ºæˆ¿é—´</button>
                </div>
                
                <div class="room-card">
                    <div class="room-card-icon">ğŸšª</div>
                    <h3 data-i18n="join_room_title">åŠ å…¥æˆ¿é—´</h3>
                    <p data-i18n="join_room_desc">ä½¿ç”¨æˆ¿é—´ä»£ç åŠ å…¥å·²å­˜åœ¨çš„æˆ¿é—´</p>
                    <button class="btn btn-secondary" onclick="showJoinRoomModal()" data-i18n="join_room_btn">åŠ å…¥æˆ¿é—´</button>
                </div>
            </div>

            <!-- æˆ¿é—´çŠ¶æ€åŒºåŸŸ -->
            <div class="room-status" id="roomStatus">
                <div class="room-info">
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="room_name">æˆ¿é—´åç§°</div>
                        <div class="room-info-value" id="currentRoomName">-</div>
                    </div>
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="room_code">æˆ¿é—´ä»£ç </div>
                        <div class="room-info-value" id="currentRoomCode">-</div>
                    </div>
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="member_count">æˆå‘˜æ•°é‡</div>
                        <div class="room-info-value" id="currentMemberCount">0</div>
                    </div>
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="your_role">æ‚¨çš„è§’è‰²</div>
                        <div class="room-info-value" id="currentUserRole">-</div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-danger" onclick="leaveRoom()" data-i18n="leave_room">ç¦»å¼€æˆ¿é—´</button>
                </div>
            </div>

            <!-- æˆå‘˜åˆ—è¡¨ -->
            <div class="members-section" id="membersSection" style="display: none;">
                <h3>ğŸ‘¥ <span data-i18n="room_members">æˆ¿é—´æˆå‘˜</span> (<span id="memberCount">0</span>)</h3>
                <div id="membersList"></div>
            </div>

            <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
            <div class="file-management" id="fileManagement" style="display: none;">
                <!-- æ–‡ä»¶ä¸Šä¼  -->
                <div class="file-section">
                    <h3>ğŸ“¤ <span data-i18n="upload_files">ä¸Šä¼ æ–‡ä»¶</span></h3>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 12px;">ğŸ“</div>
                        <div style="font-weight: 500; margin-bottom: 8px;" data-i18n="drag_drop_files">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;" data-i18n="supported_formats">æ”¯æŒæ‰€æœ‰æ–‡ä»¶æ ¼å¼</div>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    
                    <div id="uploadProgress" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 8px; font-weight: 500;">ä¸Šä¼ è¿›åº¦</div>
                        <div style="background: var(--gray-200); border-radius: 4px; height: 8px;">
                            <div id="progressBar" style="background: var(--primary-500); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="margin-top: 4px; font-size: 0.875rem; color: var(--gray-600);">0%</div>
                    </div>
                </div>

                <!-- æ–‡ä»¶åˆ—è¡¨ -->
                <div class="file-section">
                    <h3>ğŸ“‹ <span data-i18n="shared_files">å…±äº«æ–‡ä»¶</span> (<span id="fileCount">0</span>)</h3>
                    <div class="file-list" id="fileList">
                        <div style="text-align: center; color: var(--gray-500); padding: 20px;" data-i18n="no_files">æš‚æ— æ–‡ä»¶</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åˆ›å»ºæˆ¿é—´æ¨¡æ€çª—å£ -->
    <div class="modal" id="createRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="create_new_room">åˆ›å»ºæ–°æˆ¿é—´</h2>
                <button class="close-btn" onclick="hideCreateRoomModal()">&times;</button>
            </div>
            
            <form id="createRoomForm">
                <div class="form-group">
                    <label for="roomPassword" data-i18n="room_password_optional">æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="password" id="roomPassword" placeholder="" data-i18n-placeholder="room_password_optional_placeholder">
                </div>
                
                <div class="form-group">
                    <label for="maxMembers" data-i18n="maximum_members">æœ€å¤§æˆå‘˜æ•°</label>
                    <select id="maxMembers">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateRoomModal()" data-i18n="cancel">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" data-i18n="create_room">åˆ›å»ºæˆ¿é—´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åŠ å…¥æˆ¿é—´æ¨¡æ€çª—å£ -->
    <div class="modal" id="joinRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="join_room">åŠ å…¥æˆ¿é—´</h2>
                <button class="close-btn" onclick="hideJoinRoomModal()">&times;</button>
            </div>
            
            <form id="joinRoomForm">
                <div class="form-group">
                    <label for="roomCode" data-i18n="room_code">æˆ¿é—´ä»£ç </label>
                    <input type="text" id="roomCode" placeholder="" data-i18n-placeholder="room_code_placeholder" required style="text-transform: uppercase;">
                </div>
                
                <div class="form-group">
                    <label for="joinPassword" data-i18n="room_password_if_required">æˆ¿é—´å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰</label>
                    <input type="password" id="joinPassword" placeholder="" data-i18n-placeholder="room_password_placeholder">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideJoinRoomModal()" data-i18n="cancel">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary" data-i18n="join_room">åŠ å…¥æˆ¿é—´</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¿…éœ€çš„Dialogå…ƒç´  -->
    <x-dialog id="receiveDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="file_received">File Received</h3>
                <div class="font-subheading" id="fileName" data-i18n=""></div>
                <div class="font-body2" id="fileSize"></div>
                <div class='preview' style="visibility: hidden;">
                    <img id='img-preview' src="">
                </div>
                <div class="row">
                    <label for="autoDownload" class="grow" data-i18n="ask_save_files">Ask to save each file before downloading</label>
                    <input type="checkbox" id="autoDownload" checked="">
                </div>
                <div class="row-reverse">
                    <a class="button" close id="download" title="Download File" autofocus data-i18n="save">Save</a>
                    <button class="button" close data-i18n="ignore">Ignore</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    
    <!-- Send Text Dialog -->
    <x-dialog id="sendTextDialog">
        <form action="#">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="send_message">Send a Message</h3>
                    <div id="textInput" class="textarea" role="textbox" data-placeholder="Send a message" autocomplete="off" autofocus contenteditable></div>
                    <div class="row-reverse">
                        <button class="button" type="submit" close data-i18n="send">Send</button>
                        <a class="button" close data-i18n="cancel">Cancel</a>
                    </div>
                </x-paper>
            </x-background>
        </form>
    </x-dialog>
    
    <!-- Receive Text Dialog -->
    <x-dialog id="receiveTextDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="message_received">Message Received</h3>
                <div class="font-subheading" id="text"></div>
                <div class="row-reverse">
                    <button class="button" id="copy" close autofocus data-i18n="copy">Copy</button>
                    <button class="button" close data-i18n="close">Close</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    
    <!-- Toast -->
    <div class="toast-container full center">
        <x-toast class="row" shadow="1" id="toast">
            <div class="grow">
                <span id="toast-text"></span>
            </div>
        </x-toast>
    </div>

    <!-- è„šæœ¬ -->
    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let currentRoom = null;
        let isInRoom = false;
        let roomMembers = [];
        let sharedFiles = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeI18n();
            initializeEventListeners();
            initializeNetworkConnection();
        });

        // è·å–é¦–é€‰æ˜¾ç¤ºåç§°ï¼ˆè®¾å¤‡å/ç”¨æˆ·ç”Ÿæˆåï¼‰
        function getPreferredDisplayName() {
            try {
                const stored = localStorage.getItem('displayName');
                if (stored && stored.trim()) return stored.trim();
            } catch (e) {}

            const el = document.getElementById('displayName');
            if (el && el.textContent && el.textContent.trim()) {
                return el.textContent.trim();
            }

            const adjectives = ['Blue','Red','Green','Orange','Purple','Yellow','Silver','Golden'];
            const animals = ['Bear','Wolf','Eagle','Lion','Tiger','Fox','Hawk','Shark'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const animal = animals[Math.floor(Math.random() * animals.length)];
            return `${adj} ${animal}`;
        }

        function initializeI18n() {
            // ç®€åŒ–çš„å›½é™…åŒ–å¤„ç†ï¼Œé¿å…ä¾èµ–å¤–éƒ¨i18næ–‡ä»¶
            const languageSelector = document.getElementById('language-selector');
            if (languageSelector) {
                // è®¾ç½®é»˜è®¤è¯­è¨€
                const savedLang = localStorage.getItem('dropshare-language') || 'zh-CN';
                languageSelector.value = savedLang;
                
                languageSelector.addEventListener('change', function() {
                    const selectedLanguage = this.value;
                    localStorage.setItem('dropshare-language', selectedLanguage);
                    // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„è¯­è¨€åˆ‡æ¢é€»è¾‘
                    console.log('è¯­è¨€åˆ‡æ¢åˆ°:', selectedLanguage);
                });
            }
        }

        function initializeEventListeners() {
            // åˆ›å»ºæˆ¿é—´è¡¨å•
            document.getElementById('createRoomForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createRoom();
            });

            // åŠ å…¥æˆ¿é—´è¡¨å•
            document.getElementById('joinRoomForm').addEventListener('submit', function(e) {
                e.preventDefault();
                joinRoom();
            });
            
            // ç«‹å³è®¾ç½®æˆ¿é—´äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸ç­‰å¾…ç½‘ç»œè¿æ¥
            setupRoomEventHandlers();

            // æ–‡ä»¶ä¸Šä¼ 
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');

            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ 
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            // æ¨¡æ€çª—å£ç‚¹å‡»å¤–éƒ¨å…³é—­
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    hideAllModals();
                }
            });
        }

        // æ¨¡æ€çª—å£æ§åˆ¶
        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('show');
        }

        function hideCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('show');
            document.getElementById('createRoomForm').reset();
        }

        function showJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.add('show');
        }

        function hideJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.remove('show');
            document.getElementById('joinRoomForm').reset();
        }

        function hideAllModals() {
            hideCreateRoomModal();
            hideJoinRoomModal();
        }

        // æˆ¿é—´åŠŸèƒ½
        function createRoom() {
            const roomPassword = document.getElementById('roomPassword').value;
            const maxMembers = parseInt(document.getElementById('maxMembers').value);
            const roomCode = generateRoomCode();
            
            if (!window.network || !window.network.send) {
                alert(window.i18n ? window.i18n.t('network_unavailable') : 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            const roomData = {
                type: 'create-room',
                roomSettings: {
                    code: roomCode,
                    name: roomCode, // ä½¿ç”¨æˆ¿é—´ç ä½œä¸ºæˆ¿é—´åç§°
                    password: roomPassword || undefined,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                },
                userInfo: {
                    displayName: getPreferredDisplayName(),
                    deviceName: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Computer'
                }
            };

            console.log('åˆ›å»ºæˆ¿é—´:', roomData);
            window.network.send(roomData);
            hideCreateRoomModal();
        }

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const password = document.getElementById('joinPassword').value;

            if (!roomCode) {
                alert(window.i18n ? window.i18n.t('please_enter_room_code') : 'è¯·è¾“å…¥æˆ¿é—´ä»£ç ');
                return;
            }
            
            if (!window.network || !window.network.send) {
                alert(window.i18n ? window.i18n.t('network_unavailable') : 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            const joinData = {
                type: 'join-room',
                roomCode: roomCode,
                password: password || undefined,
                userInfo: {
                    displayName: getPreferredDisplayName(),
                    deviceName: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Computer'
                }
            };

            console.log('åŠ å…¥æˆ¿é—´:', joinData);
            window.network.send(joinData);
            hideJoinRoomModal();
        }

        function leaveRoom() {
            if (!isInRoom) return;

            if (confirm(window.i18n ? window.i18n.t('confirm_leave_room') : 'ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ')) {
                const leaveData = {
                    type: 'leave-room'
                };

                console.log('ç¦»å¼€æˆ¿é—´:', leaveData);
                
                if (window.network && window.network.send) {
                    window.network.send(leaveData);
                }
                
                // é‡ç½®UI
                handleRoomLeft();
            }
        }

        // æˆ¿é—´çŠ¶æ€å¤„ç†
        function handleRoomCreated(event) {
            const data = event.detail;
            console.log('æˆ¿é—´åˆ›å»ºæˆåŠŸ:', data);
            const hostInfo = data.hostInfo || { displayName: 'æˆ¿ä¸»', name: 'æˆ¿ä¸»', isHost: true };
            // ç¡®ä¿hostInfoæœ‰nameå±æ€§
            if (!hostInfo.name && hostInfo.displayName) {
                hostInfo.name = hostInfo.displayName;
            }
            currentRoom = {
                roomCode: data.room.code,
                roomName: data.room.name,
                isHost: true,
                members: [hostInfo]
            };
            isInRoom = true;
            updateRoomUI();
            showRoomInterface();
        }

        function handleRoomJoined(event) {
            const data = event.detail;
            console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
            // ç¡®ä¿æ‰€æœ‰æˆå‘˜éƒ½æœ‰nameå±æ€§
            const members = (data.members || []).map(member => {
                if (!member.name && member.displayName) {
                    member.name = member.displayName;
                }
                return member;
            });
            currentRoom = {
                roomCode: data.room.code,
                roomName: data.room.name,
                isHost: false,
                members: members
            };
            isInRoom = true;
            updateRoomUI();
            showRoomInterface();
        }

        function handleRoomLeft() {
            currentRoom = null;
            isInRoom = false;
            hideRoomInterface();
        }

        function updateRoomUI() {
            if (!currentRoom) return;

            document.getElementById('currentRoomName').textContent = currentRoom.roomName;
            document.getElementById('currentRoomCode').textContent = currentRoom.roomCode;
            document.getElementById('currentMemberCount').textContent = currentRoom.members.length;
            document.getElementById('currentUserRole').textContent = currentRoom.isHost ? (window.i18n ? window.i18n.t('role_host') : 'Host') : (window.i18n ? window.i18n.t('role_member') : 'Member');
            
            updateMembersList();
        }

        function showRoomInterface() {
            document.getElementById('roomOptions').style.display = 'none';
            document.getElementById('roomStatus').classList.add('show');
            document.getElementById('membersSection').style.display = 'block';
            document.getElementById('fileManagement').style.display = 'grid';
        }

        function hideRoomInterface() {
            document.getElementById('roomOptions').style.display = 'grid';
            document.getElementById('roomStatus').classList.remove('show');
            document.getElementById('membersSection').style.display = 'none';
            document.getElementById('fileManagement').style.display = 'none';
            
            // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
            sharedFiles = [];
            updateFilesList();
        }

        function updateMembersList() {
            if (!currentRoom) return;

            const membersList = document.getElementById('membersList');
            const memberCount = document.getElementById('memberCount');
            
            memberCount.textContent = currentRoom.members.length;
            membersList.innerHTML = '';

            currentRoom.members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                const memberName = member.displayName || member.deviceName || member.name || (window.i18n ? window.i18n.t('unknown_user') : 'Unknown');
                memberElement.innerHTML = `
                    <div class="member-avatar">${memberName.charAt(0).toUpperCase()}</div>
                    <div class="member-info">
                        <div class="member-name">${memberName}${member.isHost ? ' ğŸ‘‘' : ''}</div>
                        <div class="member-status">${member.isHost ? (window.i18n ? window.i18n.t('role_host') : 'Host') : (window.i18n ? window.i18n.t('role_member') : 'Member')}</div>
                    </div>
                `;
                membersList.appendChild(memberElement);
            });
        }

        // æ–‡ä»¶å¤„ç†
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (!isInRoom) {
                alert(window.i18n ? window.i18n.t('please_create_or_join_room') : 'è¯·å…ˆåˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´');
                return;
            }

            for (let file of files) {
                uploadFile(file);
            }
        }

        function uploadFile(file) {
            console.log('ä¸Šä¼ æ–‡ä»¶:', file.name);
            
            if (!currentRoom || !currentRoom.roomCode) {
                alert(window.i18n ? window.i18n.t('please_join_room_first') : 'è¯·å…ˆåŠ å…¥æˆ¿é—´');
                return;
            }
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            showUploadProgress();
            
            // åˆ›å»ºæ–‡ä»¶ä¿¡æ¯å¯¹è±¡
            const fileInfo = {
                id: Date.now(),
                name: file.name,
                size: file.size,
                type: file.type,
                uploadTime: new Date()
            };
            
            // è¯»å–æ–‡ä»¶å†…å®¹å¹¶å‘é€åˆ°æˆ¿é—´
            const reader = new FileReader();
            reader.onload = function(e) {
                if (window.network && window.network.send) {
                    const shareMessage = {
                        type: 'room-file-shared',
                        roomCode: currentRoom.roomCode,
                        fileInfo: {
                            ...fileInfo,
                            uploader: (function(){
                                try { const s = window.localStorage.getItem('displayName'); if (s && s.trim()) return s.trim(); } catch(e) {}
                                return getPreferredDisplayName();
                            })(),
                            uploaderId: window.network.peerId || 'unknown'
                        },
                        fileData: e.target.result // base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
                    };
                    
                    console.log('å‘é€æ–‡ä»¶å…±äº«æ¶ˆæ¯:', shareMessage.fileInfo.name);
                    window.network.send(shareMessage);
                }
            };
            reader.readAsDataURL(file);
            
            // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    hideUploadProgress();
                    addFileToList(file);
                }
                updateUploadProgress(progress);
            }, 200);
        }

        function showUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'block';
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function updateUploadProgress(progress) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
        }

        function addFileToList(file) {
            const fileInfo = {
                id: Date.now(),
                name: file.name,
                size: file.size,
                type: file.type,
                uploadTime: new Date()
            };
            
            sharedFiles.push(fileInfo);
            updateFilesList();
        }

        function updateFilesList() {
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            
            fileCount.textContent = sharedFiles.length;
            
            if (sharedFiles.length === 0) {
                fileList.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 20px;">æš‚æ— æ–‡ä»¶</div>';
                return;
            }
            
            fileList.innerHTML = '';
            
            sharedFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                fileElement.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary btn-small" onclick="downloadFile('${file.id}')">ä¸‹è½½</button>
                        <button class="btn btn-danger btn-small" onclick="deleteFile('${file.id}')">åˆ é™¤</button>
                    </div>
                `;
                fileList.appendChild(fileElement);
            });
        }

        function downloadFile(fileId) {
            const file = sharedFiles.find(f => f.id == fileId);
            if (file && file.fileData) {
                console.log('ä¸‹è½½æ–‡ä»¶:', file.name);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const link = document.createElement('a');
                link.href = file.fileData; // base64æ•°æ®URL
                link.download = file.name;
                link.style.display = 'none';
                
                // è§¦å‘ä¸‹è½½
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`ä¸‹è½½å®Œæˆ: ${file.name}`, 'success');
            } else {
                showNotification('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨', 'error');
            }
        }

        function deleteFile(fileId) {
            if (confirm(window.i18n ? window.i18n.t('confirm_delete_file') : 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                sharedFiles = sharedFiles.filter(f => f.id != fileId);
                updateFilesList();
            }
        }

        // å·¥å…·å‡½æ•°
        function generateRoomCode() {
            // ç”Ÿæˆ4ä½æ•°å­—æˆ¿é—´ç 
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function initializeNetworkConnection() {
            // åˆå§‹åŒ–ç½‘ç»œè¿æ¥
            console.log('åˆå§‹åŒ–ç½‘ç»œè¿æ¥...');
            setConnectionStatus('connecting');
            
            // ç­‰å¾…ç½‘ç»œè„šæœ¬åŠ è½½å®Œæˆå¹¶å»ºç«‹è¿æ¥
            let attempts = 0;
            const maxAttempts = 10;
            
            function checkConnection() {
                attempts++;
                
                if (window.network && window.network.isConnected && window.network.isConnected()) {
                    console.log('âœ… ç½‘ç»œè¿æ¥å·²å»ºç«‹');
                    setConnectionStatus('connected');
                    setupRoomEventHandlers();
                } else if (window.network && window.network.serverConnection) {
                    console.log('ğŸ”„ ç½‘ç»œå¯¹è±¡å­˜åœ¨ï¼Œç­‰å¾…è¿æ¥å»ºç«‹...');
                    setConnectionStatus('connecting');
                    if (attempts < maxAttempts) {
                        setTimeout(checkConnection, 500);
                    } else {
                        console.error('âŒ ç½‘ç»œè¿æ¥è¶…æ—¶');
                        setConnectionStatus('disconnected');
                    }
                } else {
                    console.log('â³ ç­‰å¾…ç½‘ç»œå¯¹è±¡åˆå§‹åŒ–...');
                    setConnectionStatus('connecting');
                    if (attempts < maxAttempts) {
                        setTimeout(checkConnection, 500);
                    } else {
                        console.error('âŒ ç½‘ç»œè¿æ¥å¤±è´¥');
                        setConnectionStatus('disconnected');
                    }
                }
            }
            
            // å¼€å§‹æ£€æŸ¥è¿æ¥
            setTimeout(checkConnection, 100);
        }
        
        function setupRoomEventHandlers() {
            // ç›‘å¬æˆ¿é—´ç›¸å…³äº‹ä»¶
            const Events = window.network?.Events || window.Events;
            
            if (Events) {
                // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                Events.off('room-created', handleRoomCreated);
                Events.off('room-joined', handleRoomJoined);
                Events.off('room-left', handleRoomLeft);
                Events.off('room-error', handleRoomError);
                Events.off('room-member-joined', handleMemberJoined);
                Events.off('room-member-left', handleMemberLeft);
                Events.off('room-file-shared', handleFileShared);
                Events.off('peer-connected', handleConnectionEstablished);
                Events.off('peer-disconnected', handleConnectionLost);
                
                // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                Events.on('room-created', handleRoomCreated);
                Events.on('room-joined', handleRoomJoined);
                Events.on('room-left', handleRoomLeft);
                Events.on('room-error', handleRoomError);
                Events.on('room-member-joined', handleMemberJoined);
                Events.on('room-member-left', handleMemberLeft);
                Events.on('room-file-shared', handleFileShared);
                
                // ç›‘å¬è¿æ¥çŠ¶æ€äº‹ä»¶
                Events.on('peer-connected', handleConnectionEstablished);
                Events.on('peer-disconnected', handleConnectionLost);
                
                console.log('âœ… æˆ¿é—´äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
            } else {
                console.log('â³ Eventså¯¹è±¡å°šæœªåŠ è½½ï¼Œ1ç§’åé‡è¯•...');
                setTimeout(setupRoomEventHandlers, 1000);
            }
            
            // åˆå§‹åŒ–è¿æ¥çŠ¶æ€æ˜¾ç¤º
            updateConnectionStatus();
        }
        
        function handleRoomError(event) {
            const error = event.detail;
            console.error('æˆ¿é—´é”™è¯¯:', error);
            alert((window.i18n ? window.i18n.t('room_operation_failed') : 'æˆ¿é—´æ“ä½œå¤±è´¥') + ': ' + (error.error || error.message || error));
        }
        
        function handleMemberJoined(event) {
            const data = event.detail;
            console.log('æ–°æˆå‘˜åŠ å…¥:', data);
            if (currentRoom && data.member) {
                currentRoom.members.push(data.member);
                updateRoomUI();
            }
            // å¦‚æœæ¶ˆæ¯åŒ…å«å®Œæ•´çš„æˆå‘˜åˆ—è¡¨ï¼Œä½¿ç”¨å®ƒ
            if (currentRoom && data.room && data.room.members) {
                currentRoom.members = data.room.members;
                updateRoomUI();
            }
        }
        
        function handleMemberLeft(event) {
            const data = event.detail;
            console.log('æˆå‘˜ç¦»å¼€:', data);
            if (currentRoom && data.memberId) {
                currentRoom.members = currentRoom.members.filter(m => m.id !== data.memberId);
                updateRoomUI();
            }
            // å¦‚æœæ¶ˆæ¯åŒ…å«å®Œæ•´çš„æˆå‘˜åˆ—è¡¨ï¼Œä½¿ç”¨å®ƒ
            if (currentRoom && data.room && data.room.members) {
                currentRoom.members = data.room.members;
                updateRoomUI();
            }
        }
        
        function handleFileShared(event) {
            const data = event.detail;
            console.log('æ”¶åˆ°å…±äº«æ–‡ä»¶:', data);
            if (data.fileInfo && data.fileData) {
                // ä¿å­˜æ–‡ä»¶ä¿¡æ¯å’Œæ•°æ®
                const fileWithData = {
                    ...data.fileInfo,
                    fileData: data.fileData // base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
                };
                sharedFiles.push(fileWithData);
                updateFilesList();
                
                // æ˜¾ç¤ºé€šçŸ¥
                showNotification((window.i18n ? window.i18n.t('received_file') : 'æ”¶åˆ°æ–‡ä»¶') + `: ${data.fileInfo.name}`, 'success');
            }
        }
        
        // è¿æ¥çŠ¶æ€å¤„ç†å‡½æ•°
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (!statusElement || !textElement) return;
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusElement.classList.remove('connected', 'disconnected', 'connecting');
            
            if (window.network && window.network.isConnected && window.network.isConnected()) {
                statusElement.classList.add('connected');
                textElement.textContent = window.i18n ? window.i18n.t('connection_connected') : 'Connected';
                textElement.setAttribute('data-i18n', 'connection_connected');
            } else {
                statusElement.classList.add('disconnected');
                textElement.textContent = window.i18n ? window.i18n.t('connection_disconnected') : 'Disconnected';
                textElement.setAttribute('data-i18n', 'connection_disconnected');
            }
        }
        
        function handleConnectionEstablished(event) {
            console.log('âœ… è¿æ¥å·²å»ºç«‹');
            updateConnectionStatus();
        }
        
        function handleConnectionLost(event) {
            console.log('âŒ è¿æ¥å·²æ–­å¼€');
            updateConnectionStatus();
        }
        
        function setConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (!statusElement || !textElement) return;
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusElement.classList.remove('connected', 'disconnected', 'connecting');
            
            switch (status) {
                case 'connected':
                    statusElement.classList.add('connected');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_connected') : 'Connected';
                    textElement.setAttribute('data-i18n', 'connection_connected');
                    break;
                case 'connecting':
                    statusElement.classList.add('connecting');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_connecting') : 'Connecting...';
                    textElement.setAttribute('data-i18n', 'connection_connecting');
                    break;
                case 'disconnected':
                default:
                    statusElement.classList.add('disconnected');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_disconnected') : 'Disconnected';
                    textElement.setAttribute('data-i18n', 'connection_disconnected');
                    break;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨
            initializeLanguageSelector();
            
            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>