<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropShare - Rooms</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- Ê∑ªÂä†i18nÊîØÊåÅ -->
    <script src="locales/i18n.js"></script>
    
    <script>
        // ÁîüÊàêÂπ∂ËÆæÁΩÆpeerid cookie
        function generatePeerId() {
            const cookies = document.cookie.split(';');
            let hasPeerId = false;
            for (let cookie of cookies) {
                if (cookie.trim().startsWith('peerid=')) {
                    hasPeerId = true;
                    const peerId = cookie.trim().split('=')[1];
                    console.log('üîë ÊâæÂà∞Áé∞Êúâpeerid:', peerId);
                    return peerId;
                }
            }
            
            if (!hasPeerId) {
                const peerId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                document.cookie = `peerid=${peerId}; path=/`;
                console.log('üîë ÁîüÊàêÊñ∞peerid:', peerId);
                return peerId;
            }
        }
        
        generatePeerId();
    </script>

    <style>
        :root {
            --primary-50: #eff6ff;
            --primary-100: #dbeafe;
            --primary-500: #3367d6;
            --primary-600: #2563eb;
            --primary-700: #1d4ed8;
            --primary-800: #1e40af;
            --primary-900: #1e3a8a;
            
            --red-500: #ef4444;
            --green-500: #10b981;
            --purple-500: #8b5cf6;
            --blue-500: #06b6d4;
            --orange-500: #f59e0b;
            --pink-500: #ec4899;
            
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        /* Ensure page is scrollable on small screens */
        html, body {
            min-height: 100%;
            overflow-y: auto;
        }

        /* Áªü‰∏ÄÂØºËà™Ê†∑Âºè */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--gray-200);
            z-index: 1000;
            padding: 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 64px;
        }

        .nav-links {
            display: flex;
            gap: 24px;
            align-items: center;
            flex: 1;
            justify-content: center;
        }

        .nav-links a {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .nav-links a:hover {
            color: var(--primary-600);
            background: var(--primary-50);
        }

        .nav-links a.active {
            color: var(--primary-600);
            background: var(--primary-50);
            font-weight: 600;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-600);
        }

        .logo svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-600);
        }

        .language-selector select {
            padding: 6px 12px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            background: white;
            color: var(--gray-700);
            font-size: 14px;
            cursor: pointer;
        }

        /* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            margin-top: 80px;
            min-height: calc(100vh - 80px);
            padding: 40px 20px;
            background: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .hero-section {
            text-align: center;
            margin-bottom: 60px;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
        }

        .hero-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        /* ÊàøÈó¥ÈÄâÈ°πÂç°Áâá */
        .room-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .room-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            min-height: 300px;
        }

        .room-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .room-card-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .room-card h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .room-card p {
            color: var(--gray-600);
            margin-bottom: 24px;
            line-height: 1.6;
            flex-grow: 1;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary-600);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-700);
        }

        .btn-secondary {
            background: var(--gray-100);
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-secondary:hover {
            background: var(--gray-200);
        }

        .btn-success {
            background: var(--green-500);
            color: white;
        }

        .btn-danger {
            background: var(--red-500);
            color: white;
        }

        /* Ê®°ÊÄÅÁ™óÂè£Ê†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray-500);
            padding: 4px;
        }

        .close-btn:hover {
            color: var(--gray-700);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(51, 103, 214, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* ÊàøÈó¥Áä∂ÊÄÅÂå∫Âüü */
        .room-status {
            display: none;
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            margin-bottom: 30px;
        }

        .room-status.show {
            display: block;
        }

        .room-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .room-info-item {
            text-align: center;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
        }

        .room-info-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            margin-bottom: 4px;
        }

        .room-info-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        /* Êñá‰ª∂ÁÆ°ÁêÜÂå∫Âüü */
        .file-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .file-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
        }

        .file-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .file-upload-area.dragover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .file-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 8px;
            background: transparent;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .file-size {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* ÊàêÂëòÂàóË°® */
        .members-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--gray-200);
            margin-bottom: 30px;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: transparent;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-500);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 500;
            color: var(--gray-800);
        }

        .member-status {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        /* ËøûÊé•Áä∂ÊÄÅÊ†∑Âºè */
        .connection-status {
            background: white;
            border-radius: 12px;
            padding: 16px 24px;
            margin: 24px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid var(--gray-300);
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            border-left-color: var(--green-500);
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }

        .connection-status.disconnected {
            border-left-color: var(--red-500);
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }

        .connection-status.connecting {
            border-left-color: var(--blue-500);
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }

        .connection-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--gray-400);
            transition: all 0.3s ease;
        }

        .connection-status.connected .connection-indicator {
            background: var(--green-500);
            animation: pulse 2s infinite;
        }

        .connection-status.disconnected .connection-indicator {
            background: var(--red-500);
        }

        .connection-status.connecting .connection-indicator {
            background: var(--blue-500);
            animation: spin 1s linear infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .connection-text {
            font-weight: 500;
            color: var(--gray-700);
        }

        .connection-status.connected .connection-text {
            color: var(--green-700);
        }

        .connection-status.disconnected .connection-text {
            color: var(--red-700);
        }

        .connection-status.connecting .connection-text {
            color: var(--blue-700);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 2rem;
            }

            .room-options {
                grid-template-columns: 1fr;
            }

            .file-management {
                grid-template-columns: 1fr;
            }

            .room-info {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 24px;
                margin: 20px;
            }

            .connection-status {
                padding: 12px 16px;
                margin: 16px 0;
            }
        }
    </style>
</head>

<body>
    <!-- DropShare Áªü‰∏ÄÂØºËà™ -->
    <header class="header">
        <div class="header-container">
            <div class="header-controls">
                <div class="logo">
                    <svg viewBox="0 0 24 24">
                        <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"/>
                    </svg>
                    <a href="index.html" style="text-decoration: none; color: inherit;" data-i18n="site_name">DropShare</a>
                </div>
                <nav class="nav-links">
                    <a href="transer.html" data-i18n="nav_transfer">Transfer</a>
                    <a href="rooms-improved.html" class="active" data-i18n="nav_rooms">Rooms</a>
                    <a href="image-tools.html" data-i18n="nav_images">Images</a>
                    <a href="audio-tools.html" data-i18n="nav_audio">Audio</a>
                    <a href="video-tools.html" data-i18n="nav_video">Video</a>
                    <a href="document-tools.html" data-i18n="nav_files">Files</a>
                </nav>
                <div class="language-selector">
                    <select id="language-selector">
                        <option value="en">English</option>
                        <option value="zh-CN">‰∏≠ÊñáÁÆÄ‰Ωì</option>
                        <option value="zh-TW">‰∏≠ÊñáÁπÅÈ´î</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">Portugu√™s</option>
                        <option value="es">Espa√±ol</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
    <main class="main-content">
        <div class="container">
            <!-- Ëã±ÈõÑÂå∫Âüü -->
            <div class="hero-section">
                <h1 class="hero-title" data-i18n="rooms_title">Rooms</h1>
                <p class="hero-subtitle" data-i18n="rooms_subtitle">Âø´ÈÄü‰∏éÂêå‰∏ÄÁΩëÁªúÊàñËøúÁ®ãÁî®Êà∑ÈÄöËøáÊàøÈó¥‰ª£Á†ÅÂÖ±‰∫´Êñá‰ª∂</p>
            </div>

            <!-- ËøûÊé•Áä∂ÊÄÅ -->
            <div class="connection-status" id="connectionStatus">
                <div class="connection-indicator"></div>
                <div class="connection-text" id="connectionText" data-i18n="connection_disconnected">Êú™ËøûÊé•</div>
            </div>

            <!-- ÊàøÈó¥ÈÄâÈ°π -->
            <div class="room-options" id="roomOptions">
                <div class="room-card">
                    <div class="room-card-icon">üè†</div>
                    <h3 data-i18n="create_room_title">ÂàõÂª∫ÊàøÈó¥</h3>
                    <p data-i18n="create_room_desc">ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑÊàøÈó¥ÔºåÈÇÄËØ∑ÂÖ∂‰ªñÁî®Êà∑Âä†ÂÖ•Âπ∂ÂÖ±‰∫´Êñá‰ª∂</p>
                    <button class="btn btn-primary" onclick="showCreateRoomModal()" data-i18n="create_room_btn">ÂàõÂª∫ÊàøÈó¥</button>
                </div>
                
                <div class="room-card">
                    <div class="room-card-icon">üö™</div>
                    <h3 data-i18n="join_room_title">Âä†ÂÖ•ÊàøÈó¥</h3>
                    <p data-i18n="join_room_desc">‰ΩøÁî®ÊàøÈó¥‰ª£Á†ÅÂä†ÂÖ•Â∑≤Â≠òÂú®ÁöÑÊàøÈó¥</p>
                    <button class="btn btn-secondary" onclick="showJoinRoomModal()" data-i18n="join_room_btn">Âä†ÂÖ•ÊàøÈó¥</button>
                </div>
            </div>

            <!-- ÊàøÈó¥Áä∂ÊÄÅÂå∫Âüü -->
            <div class="room-status" id="roomStatus">
                <div class="room-info">
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="room_name">ÊàøÈó¥ÂêçÁß∞</div>
                        <div class="room-info-value" id="currentRoomName">-</div>
                    </div>
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="room_code">ÊàøÈó¥‰ª£Á†Å</div>
                        <div class="room-info-value" id="currentRoomCode">-</div>
                    </div>
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="member_count">ÊàêÂëòÊï∞Èáè</div>
                        <div class="room-info-value" id="currentMemberCount">0</div>
                    </div>
                    <div class="room-info-item">
                        <div class="room-info-label" data-i18n="your_role">ÊÇ®ÁöÑËßíËâ≤</div>
                        <div class="room-info-value" id="currentUserRole">-</div>
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn btn-danger" onclick="leaveRoom()" data-i18n="leave_room">Á¶ªÂºÄÊàøÈó¥</button>
                </div>
            </div>

            <!-- ÊàêÂëòÂàóË°® -->
            <div class="members-section" id="membersSection" style="display: none;">
                <h3>üë• <span data-i18n="room_members">ÊàøÈó¥ÊàêÂëò</span> (<span id="memberCount">0</span>)</h3>
                <div id="membersList"></div>
            </div>

            <!-- Êñá‰ª∂ÁÆ°ÁêÜÂå∫Âüü -->
            <div class="file-management" id="fileManagement" style="display: none;">
                <!-- Êñá‰ª∂‰∏ä‰º† -->
                <div class="file-section">
                    <h3>üì§ <span data-i18n="upload_files">‰∏ä‰º†Êñá‰ª∂</span></h3>
                    <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                        <div style="font-size: 2rem; margin-bottom: 12px;">üìÅ</div>
                        <div style="font-weight: 500; margin-bottom: 8px;" data-i18n="drag_drop_files">ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©</div>
                        <div style="color: var(--gray-500); font-size: 0.875rem;" data-i18n="supported_formats">ÊîØÊåÅÊâÄÊúâÊñá‰ª∂Ê†ºÂºè</div>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    
                    <div id="uploadProgress" style="display: none; margin-top: 16px;">
                        <div style="margin-bottom: 8px; font-weight: 500;">‰∏ä‰º†ËøõÂ∫¶</div>
                        <div style="background: var(--gray-200); border-radius: 4px; height: 8px;">
                            <div id="progressBar" style="background: var(--primary-500); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div id="progressText" style="margin-top: 4px; font-size: 0.875rem; color: var(--gray-600);">0%</div>
                    </div>
                </div>

                <!-- Êñá‰ª∂ÂàóË°® -->
                <div class="file-section">
                    <h3>üìã <span data-i18n="shared_files">ÂÖ±‰∫´Êñá‰ª∂</span> (<span id="fileCount">0</span>)</h3>
                    <div class="file-list" id="fileList">
                        <div style="text-align: center; color: var(--gray-500); padding: 20px;" data-i18n="no_files">ÊöÇÊó†Êñá‰ª∂</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ÂàõÂª∫ÊàøÈó¥Ê®°ÊÄÅÁ™óÂè£ -->
    <div class="modal" id="createRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="create_new_room">ÂàõÂª∫Êñ∞ÊàøÈó¥</h2>
                <button class="close-btn" onclick="hideCreateRoomModal()">&times;</button>
            </div>
            
            <form id="createRoomForm">
                <div class="form-group">
                    <label for="roomPassword" data-i18n="room_password_optional">ÊàøÈó¥ÂØÜÁ†ÅÔºàÂèØÈÄâÔºâ</label>
                    <input type="password" id="roomPassword" placeholder="" data-i18n-placeholder="room_password_optional_placeholder">
                </div>
                
                <div class="form-group">
                    <label for="maxMembers" data-i18n="maximum_members">ÊúÄÂ§ßÊàêÂëòÊï∞</label>
                    <select id="maxMembers">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateRoomModal()" data-i18n="cancel">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary" data-i18n="create_room">ÂàõÂª∫ÊàøÈó¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Âä†ÂÖ•ÊàøÈó¥Ê®°ÊÄÅÁ™óÂè£ -->
    <div class="modal" id="joinRoomModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" data-i18n="join_room">Âä†ÂÖ•ÊàøÈó¥</h2>
                <button class="close-btn" onclick="hideJoinRoomModal()">&times;</button>
            </div>
            
            <form id="joinRoomForm">
                <div class="form-group">
                    <label for="roomCode" data-i18n="room_code">ÊàøÈó¥‰ª£Á†Å</label>
                    <input type="text" id="roomCode" placeholder="" data-i18n-placeholder="room_code_placeholder" required style="text-transform: uppercase;">
                </div>
                
                <div class="form-group">
                    <label for="joinPassword" data-i18n="room_password_if_required">ÊàøÈó¥ÂØÜÁ†ÅÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ</label>
                    <input type="password" id="joinPassword" placeholder="" data-i18n-placeholder="room_password_placeholder">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideJoinRoomModal()" data-i18n="cancel">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-primary" data-i18n="join_room">Âä†ÂÖ•ÊàøÈó¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÂøÖÈúÄÁöÑDialogÂÖÉÁ¥† -->
    <x-dialog id="receiveDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="file_received">File Received</h3>
                <div class="font-subheading" id="fileName" data-i18n=""></div>
                <div class="font-body2" id="fileSize"></div>
                <div class='preview' style="visibility: hidden;">
                    <img id='img-preview' src="">
                </div>
                <div class="row">
                    <label for="autoDownload" class="grow" data-i18n="ask_save_files">Ask to save each file before downloading</label>
                    <input type="checkbox" id="autoDownload" checked="">
                </div>
                <div class="row-reverse">
                    <a class="button" close id="download" title="Download File" autofocus data-i18n="save">Save</a>
                    <button class="button" close data-i18n="ignore">Ignore</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    
    <!-- Send Text Dialog -->
    <x-dialog id="sendTextDialog">
        <form action="#">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="send_message">Send a Message</h3>
                    <div id="textInput" class="textarea" role="textbox" data-placeholder="Send a message" autocomplete="off" autofocus contenteditable></div>
                    <div class="row-reverse">
                        <button class="button" type="submit" close data-i18n="send">Send</button>
                        <a class="button" close data-i18n="cancel">Cancel</a>
                    </div>
                </x-paper>
            </x-background>
        </form>
    </x-dialog>
    
    <!-- Receive Text Dialog -->
    <x-dialog id="receiveTextDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="message_received">Message Received</h3>
                <div class="font-subheading" id="text"></div>
                <div class="row-reverse">
                    <button class="button" id="copy" close autofocus data-i18n="copy">Copy</button>
                    <button class="button" close data-i18n="close">Close</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    
    <!-- Toast -->
    <div class="toast-container full center">
        <x-toast class="row" shadow="1" id="toast">
            <div class="grow">
                <span id="toast-text"></span>
            </div>
        </x-toast>
    </div>

    <!-- ËÑöÊú¨ -->
    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    
    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let currentRoom = null;
        let isInRoom = false;
        let roomMembers = [];
        let sharedFiles = [];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            initializeI18n();
            initializeEventListeners();
            initializeNetworkConnection();
        });

        // Ëé∑ÂèñÈ¶ñÈÄâÊòæÁ§∫ÂêçÁß∞ÔºàËÆæÂ§áÂêç/Áî®Êà∑ÁîüÊàêÂêçÔºâ
        function getPreferredDisplayName() {
            try {
                const stored = localStorage.getItem('displayName');
                if (stored && stored.trim()) return stored.trim();
            } catch (e) {}

            const el = document.getElementById('displayName');
            if (el && el.textContent && el.textContent.trim()) {
                return el.textContent.trim();
            }

            const adjectives = ['Blue','Red','Green','Orange','Purple','Yellow','Silver','Golden'];
            const animals = ['Bear','Wolf','Eagle','Lion','Tiger','Fox','Hawk','Shark'];
            const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
            const animal = animals[Math.floor(Math.random() * animals.length)];
            return `${adj} ${animal}`;
        }

        function initializeI18n() {
            // ÁÆÄÂåñÁöÑÂõΩÈôÖÂåñÂ§ÑÁêÜÔºåÈÅøÂÖç‰æùËµñÂ§ñÈÉ®i18nÊñá‰ª∂
            const languageSelector = document.getElementById('language-selector');
            if (languageSelector) {
                // ËÆæÁΩÆÈªòËÆ§ËØ≠Ë®Ä
                const savedLang = localStorage.getItem('dropshare-language') || 'zh-CN';
                languageSelector.value = savedLang;
                
                languageSelector.addEventListener('change', function() {
                    const selectedLanguage = this.value;
                    localStorage.setItem('dropshare-language', selectedLanguage);
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†ÂÆûÈôÖÁöÑËØ≠Ë®ÄÂàáÊç¢ÈÄªËæë
                    console.log('ËØ≠Ë®ÄÂàáÊç¢Âà∞:', selectedLanguage);
                });
            }
        }

        function initializeEventListeners() {
            // ÂàõÂª∫ÊàøÈó¥Ë°®Âçï
            document.getElementById('createRoomForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createRoom();
            });

            // Âä†ÂÖ•ÊàøÈó¥Ë°®Âçï
            document.getElementById('joinRoomForm').addEventListener('submit', function(e) {
                e.preventDefault();
                joinRoom();
            });
            
            // Á´ãÂç≥ËÆæÁΩÆÊàøÈó¥‰∫ã‰ª∂ÁõëÂê¨Âô®Ôºå‰∏çÁ≠âÂæÖÁΩëÁªúËøûÊé•
            setupRoomEventHandlers();

            // Êñá‰ª∂‰∏ä‰º†
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');

            fileInput.addEventListener('change', handleFileSelect);
            
            // ÊãñÊãΩ‰∏ä‰º†
            fileUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });

            fileUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFiles(files);
            });

            // Ê®°ÊÄÅÁ™óÂè£ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('modal')) {
                    hideAllModals();
                }
            });
        }

        // Ê®°ÊÄÅÁ™óÂè£ÊéßÂà∂
        function showCreateRoomModal() {
            document.getElementById('createRoomModal').classList.add('show');
        }

        function hideCreateRoomModal() {
            document.getElementById('createRoomModal').classList.remove('show');
            document.getElementById('createRoomForm').reset();
        }

        function showJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.add('show');
        }

        function hideJoinRoomModal() {
            document.getElementById('joinRoomModal').classList.remove('show');
            document.getElementById('joinRoomForm').reset();
        }

        function hideAllModals() {
            hideCreateRoomModal();
            hideJoinRoomModal();
        }

        // ÊàøÈó¥ÂäüËÉΩ
        function createRoom() {
            const roomPassword = document.getElementById('roomPassword').value;
            const maxMembers = parseInt(document.getElementById('maxMembers').value);
            const roomCode = generateRoomCode();
            
            if (!window.network || !window.network.send) {
                alert(window.i18n ? window.i18n.t('network_unavailable') : 'ÁΩëÁªúËøûÊé•‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            const roomData = {
                type: 'create-room',
                roomSettings: {
                    code: roomCode,
                    name: roomCode, // ‰ΩøÁî®ÊàøÈó¥Á†Å‰Ωú‰∏∫ÊàøÈó¥ÂêçÁß∞
                    password: roomPassword || undefined,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                },
                userInfo: {
                    displayName: getPreferredDisplayName(),
                    deviceName: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Computer'
                }
            };

            console.log('ÂàõÂª∫ÊàøÈó¥:', roomData);
            window.network.send(roomData);
            hideCreateRoomModal();
        }

        function joinRoom() {
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            const password = document.getElementById('joinPassword').value;

            if (!roomCode) {
                alert(window.i18n ? window.i18n.t('please_enter_room_code') : 'ËØ∑ËæìÂÖ•ÊàøÈó¥‰ª£Á†Å');
                return;
            }
            
            if (!window.network || !window.network.send) {
                alert(window.i18n ? window.i18n.t('network_unavailable') : 'ÁΩëÁªúËøûÊé•‰∏çÂèØÁî®ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }

            const joinData = {
                type: 'join-room',
                roomCode: roomCode,
                password: password || undefined,
                userInfo: {
                    displayName: getPreferredDisplayName(),
                    deviceName: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Computer'
                }
            };

            console.log('Âä†ÂÖ•ÊàøÈó¥:', joinData);
            window.network.send(joinData);
            hideJoinRoomModal();
        }

        function leaveRoom() {
            if (!isInRoom) return;

            if (confirm(window.i18n ? window.i18n.t('confirm_leave_room') : 'Á°ÆÂÆöË¶ÅÁ¶ªÂºÄÊàøÈó¥ÂêóÔºü')) {
                const leaveData = {
                    type: 'leave-room'
                };

                console.log('Á¶ªÂºÄÊàøÈó¥:', leaveData);
                
                if (window.network && window.network.send) {
                    window.network.send(leaveData);
                }
                
                // ÈáçÁΩÆUI
                handleRoomLeft();
            }
        }

        // ÊàøÈó¥Áä∂ÊÄÅÂ§ÑÁêÜ
        function handleRoomCreated(event) {
            const data = event.detail;
            console.log('ÊàøÈó¥ÂàõÂª∫ÊàêÂäü:', data);
            const hostInfo = data.hostInfo || { displayName: 'Êàø‰∏ª', name: 'Êàø‰∏ª', isHost: true };
            // Á°Æ‰øùhostInfoÊúânameÂ±ûÊÄß
            if (!hostInfo.name && hostInfo.displayName) {
                hostInfo.name = hostInfo.displayName;
            }
            currentRoom = {
                roomCode: data.room.code,
                roomName: data.room.name,
                isHost: true,
                members: [hostInfo]
            };
            isInRoom = true;
            updateRoomUI();
            showRoomInterface();
        }

        function handleRoomJoined(event) {
            const data = event.detail;
            console.log('Âä†ÂÖ•ÊàøÈó¥ÊàêÂäü:', data);
            // Á°Æ‰øùÊâÄÊúâÊàêÂëòÈÉΩÊúânameÂ±ûÊÄß
            const members = (data.members || []).map(member => {
                if (!member.name && member.displayName) {
                    member.name = member.displayName;
                }
                return member;
            });
            currentRoom = {
                roomCode: data.room.code,
                roomName: data.room.name,
                isHost: false,
                members: members
            };
            isInRoom = true;
            updateRoomUI();
            showRoomInterface();
        }

        function handleRoomLeft() {
            currentRoom = null;
            isInRoom = false;
            hideRoomInterface();
        }

        function updateRoomUI() {
            if (!currentRoom) return;

            document.getElementById('currentRoomName').textContent = currentRoom.roomName;
            document.getElementById('currentRoomCode').textContent = currentRoom.roomCode;
            document.getElementById('currentMemberCount').textContent = currentRoom.members.length;
            document.getElementById('currentUserRole').textContent = currentRoom.isHost ? (window.i18n ? window.i18n.t('role_host') : 'Host') : (window.i18n ? window.i18n.t('role_member') : 'Member');
            
            updateMembersList();
        }

        function showRoomInterface() {
            document.getElementById('roomOptions').style.display = 'none';
            document.getElementById('roomStatus').classList.add('show');
            document.getElementById('membersSection').style.display = 'block';
            document.getElementById('fileManagement').style.display = 'grid';
        }

        function hideRoomInterface() {
            document.getElementById('roomOptions').style.display = 'grid';
            document.getElementById('roomStatus').classList.remove('show');
            document.getElementById('membersSection').style.display = 'none';
            document.getElementById('fileManagement').style.display = 'none';
            
            // Ê∏ÖÁ©∫Êñá‰ª∂ÂàóË°®
            sharedFiles = [];
            updateFilesList();
        }

        function updateMembersList() {
            if (!currentRoom) return;

            const membersList = document.getElementById('membersList');
            const memberCount = document.getElementById('memberCount');
            
            memberCount.textContent = currentRoom.members.length;
            membersList.innerHTML = '';

            currentRoom.members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                const memberName = member.displayName || member.deviceName || member.name || (window.i18n ? window.i18n.t('unknown_user') : 'Unknown');
                memberElement.innerHTML = `
                    <div class="member-avatar">${memberName.charAt(0).toUpperCase()}</div>
                    <div class="member-info">
                        <div class="member-name">${memberName}${member.isHost ? ' üëë' : ''}</div>
                        <div class="member-status">${member.isHost ? (window.i18n ? window.i18n.t('role_host') : 'Host') : (window.i18n ? window.i18n.t('role_member') : 'Member')}</div>
                    </div>
                `;
                membersList.appendChild(memberElement);
            });
        }

        // Êñá‰ª∂Â§ÑÁêÜ
        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (!isInRoom) {
                alert(window.i18n ? window.i18n.t('please_create_or_join_room') : 'ËØ∑ÂÖàÂàõÂª∫ÊàñÂä†ÂÖ•ÊàøÈó¥');
                return;
            }

            for (let file of files) {
                uploadFile(file);
            }
        }

        function uploadFile(file) {
            console.log('‰∏ä‰º†Êñá‰ª∂:', file.name);
            
            if (!currentRoom || !currentRoom.roomCode) {
                alert(window.i18n ? window.i18n.t('please_join_room_first') : 'ËØ∑ÂÖàÂä†ÂÖ•ÊàøÈó¥');
                return;
            }
            
            // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
            showUploadProgress();
            
            // ÂàõÂª∫Êñá‰ª∂‰ø°ÊÅØÂØπË±°
            const fileInfo = {
                id: Date.now(),
                name: file.name,
                size: file.size,
                type: file.type,
                uploadTime: new Date()
            };
            
            // ËØªÂèñÊñá‰ª∂ÂÜÖÂÆπÂπ∂ÂèëÈÄÅÂà∞ÊàøÈó¥
            const reader = new FileReader();
            reader.onload = function(e) {
                if (window.network && window.network.send) {
                    const shareMessage = {
                        type: 'room-file-shared',
                        roomCode: currentRoom.roomCode,
                        fileInfo: {
                            ...fileInfo,
                            uploader: (function(){
                                try { const s = window.localStorage.getItem('displayName'); if (s && s.trim()) return s.trim(); } catch(e) {}
                                return getPreferredDisplayName();
                            })(),
                            uploaderId: window.network.peerId || 'unknown'
                        },
                        fileData: e.target.result // base64ÁºñÁ†ÅÁöÑÊñá‰ª∂Êï∞ÊçÆ
                    };
                    
                    console.log('ÂèëÈÄÅÊñá‰ª∂ÂÖ±‰∫´Ê∂àÊÅØ:', shareMessage.fileInfo.name);
                    window.network.send(shareMessage);
                }
            };
            reader.readAsDataURL(file);
            
            // Ê®°Êãü‰∏ä‰º†ËøõÂ∫¶
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 20;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                    hideUploadProgress();
                    addFileToList(file);
                }
                updateUploadProgress(progress);
            }, 200);
        }

        function showUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'block';
        }

        function hideUploadProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function updateUploadProgress(progress) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = progress + '%';
            progressText.textContent = Math.round(progress) + '%';
        }

        function addFileToList(file) {
            const fileInfo = {
                id: Date.now(),
                name: file.name,
                size: file.size,
                type: file.type,
                uploadTime: new Date()
            };
            
            sharedFiles.push(fileInfo);
            updateFilesList();
        }

        function updateFilesList() {
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');
            
            fileCount.textContent = sharedFiles.length;
            
            if (sharedFiles.length === 0) {
                fileList.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 20px;">ÊöÇÊó†Êñá‰ª∂</div>';
                return;
            }
            
            fileList.innerHTML = '';
            
            sharedFiles.forEach(file => {
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                fileElement.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary btn-small" onclick="downloadFile('${file.id}')">‰∏ãËΩΩ</button>
                        <button class="btn btn-danger btn-small" onclick="deleteFile('${file.id}')">Âà†Èô§</button>
                    </div>
                `;
                fileList.appendChild(fileElement);
            });
        }

        function downloadFile(fileId) {
            const file = sharedFiles.find(f => f.id == fileId);
            if (file && file.fileData) {
                console.log('‰∏ãËΩΩÊñá‰ª∂:', file.name);
                
                // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                const link = document.createElement('a');
                link.href = file.fileData; // base64Êï∞ÊçÆURL
                link.download = file.name;
                link.style.display = 'none';
                
                // Ëß¶Âèë‰∏ãËΩΩ
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`‰∏ãËΩΩÂÆåÊàê: ${file.name}`, 'success');
            } else {
                showNotification('Êñá‰ª∂Êï∞ÊçÆ‰∏çÂèØÁî®', 'error');
            }
        }

        function deleteFile(fileId) {
            if (confirm(window.i18n ? window.i18n.t('confirm_delete_file') : 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Êñá‰ª∂ÂêóÔºü')) {
                sharedFiles = sharedFiles.filter(f => f.id != fileId);
                updateFilesList();
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function generateRoomCode() {
            // ÁîüÊàê4‰ΩçÊï∞Â≠óÊàøÈó¥Á†Å
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function initializeNetworkConnection() {
            // ÂàùÂßãÂåñÁΩëÁªúËøûÊé•
            console.log('ÂàùÂßãÂåñÁΩëÁªúËøûÊé•...');
            setConnectionStatus('connecting');
            
            // Á≠âÂæÖÁΩëÁªúËÑöÊú¨Âä†ËΩΩÂÆåÊàêÂπ∂Âª∫Á´ãËøûÊé•
            let attempts = 0;
            const maxAttempts = 10;
            
            function checkConnection() {
                attempts++;
                
                if (window.network && window.network.isConnected && window.network.isConnected()) {
                    console.log('‚úÖ ÁΩëÁªúËøûÊé•Â∑≤Âª∫Á´ã');
                    setConnectionStatus('connected');
                    setupRoomEventHandlers();
                } else if (window.network && window.network.serverConnection) {
                    console.log('üîÑ ÁΩëÁªúÂØπË±°Â≠òÂú®ÔºåÁ≠âÂæÖËøûÊé•Âª∫Á´ã...');
                    setConnectionStatus('connecting');
                    if (attempts < maxAttempts) {
                        setTimeout(checkConnection, 500);
                    } else {
                        console.error('‚ùå ÁΩëÁªúËøûÊé•Ë∂ÖÊó∂');
                        setConnectionStatus('disconnected');
                    }
                } else {
                    console.log('‚è≥ Á≠âÂæÖÁΩëÁªúÂØπË±°ÂàùÂßãÂåñ...');
                    setConnectionStatus('connecting');
                    if (attempts < maxAttempts) {
                        setTimeout(checkConnection, 500);
                    } else {
                        console.error('‚ùå ÁΩëÁªúËøûÊé•Â§±Ë¥•');
                        setConnectionStatus('disconnected');
                    }
                }
            }
            
            // ÂºÄÂßãÊ£ÄÊü•ËøûÊé•
            setTimeout(checkConnection, 100);
        }
        
        function setupRoomEventHandlers() {
            // ÁõëÂê¨ÊàøÈó¥Áõ∏ÂÖ≥‰∫ã‰ª∂
            const Events = window.network?.Events || window.Events;
            
            if (Events) {
                // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÁõëÂê¨Âô®
                Events.off('room-created', handleRoomCreated);
                Events.off('room-joined', handleRoomJoined);
                Events.off('room-left', handleRoomLeft);
                Events.off('room-error', handleRoomError);
                Events.off('room-member-joined', handleMemberJoined);
                Events.off('room-member-left', handleMemberLeft);
                Events.off('room-file-shared', handleFileShared);
                Events.off('peer-connected', handleConnectionEstablished);
                Events.off('peer-disconnected', handleConnectionLost);
                
                // Ê∑ªÂä†Êñ∞ÁöÑÁõëÂê¨Âô®
                Events.on('room-created', handleRoomCreated);
                Events.on('room-joined', handleRoomJoined);
                Events.on('room-left', handleRoomLeft);
                Events.on('room-error', handleRoomError);
                Events.on('room-member-joined', handleMemberJoined);
                Events.on('room-member-left', handleMemberLeft);
                Events.on('room-file-shared', handleFileShared);
                
                // ÁõëÂê¨ËøûÊé•Áä∂ÊÄÅ‰∫ã‰ª∂
                Events.on('peer-connected', handleConnectionEstablished);
                Events.on('peer-disconnected', handleConnectionLost);
                
                console.log('‚úÖ ÊàøÈó¥‰∫ã‰ª∂ÁõëÂê¨Âô®Â∑≤ËÆæÁΩÆ');
            } else {
                console.log('‚è≥ EventsÂØπË±°Â∞öÊú™Âä†ËΩΩÔºå1ÁßíÂêéÈáçËØï...');
                setTimeout(setupRoomEventHandlers, 1000);
            }
            
            // ÂàùÂßãÂåñËøûÊé•Áä∂ÊÄÅÊòæÁ§∫
            updateConnectionStatus();
        }
        
        function handleRoomError(event) {
            const error = event.detail;
            console.error('ÊàøÈó¥ÈîôËØØ:', error);
            alert((window.i18n ? window.i18n.t('room_operation_failed') : 'ÊàøÈó¥Êìç‰ΩúÂ§±Ë¥•') + ': ' + (error.error || error.message || error));
        }
        
        function handleMemberJoined(event) {
            const data = event.detail;
            console.log('Êñ∞ÊàêÂëòÂä†ÂÖ•:', data);
            if (currentRoom && data.member) {
                currentRoom.members.push(data.member);
                updateRoomUI();
            }
            // Â¶ÇÊûúÊ∂àÊÅØÂåÖÂê´ÂÆåÊï¥ÁöÑÊàêÂëòÂàóË°®Ôºå‰ΩøÁî®ÂÆÉ
            if (currentRoom && data.room && data.room.members) {
                currentRoom.members = data.room.members;
                updateRoomUI();
            }
        }
        
        function handleMemberLeft(event) {
            const data = event.detail;
            console.log('ÊàêÂëòÁ¶ªÂºÄ:', data);
            if (currentRoom && data.memberId) {
                currentRoom.members = currentRoom.members.filter(m => m.id !== data.memberId);
                updateRoomUI();
            }
            // Â¶ÇÊûúÊ∂àÊÅØÂåÖÂê´ÂÆåÊï¥ÁöÑÊàêÂëòÂàóË°®Ôºå‰ΩøÁî®ÂÆÉ
            if (currentRoom && data.room && data.room.members) {
                currentRoom.members = data.room.members;
                updateRoomUI();
            }
        }
        
        function handleFileShared(event) {
            const data = event.detail;
            console.log('Êî∂Âà∞ÂÖ±‰∫´Êñá‰ª∂:', data);
            if (data.fileInfo && data.fileData) {
                // ‰øùÂ≠òÊñá‰ª∂‰ø°ÊÅØÂíåÊï∞ÊçÆ
                const fileWithData = {
                    ...data.fileInfo,
                    fileData: data.fileData // base64ÁºñÁ†ÅÁöÑÊñá‰ª∂Êï∞ÊçÆ
                };
                sharedFiles.push(fileWithData);
                updateFilesList();
                
                // ÊòæÁ§∫ÈÄöÁü•
                showNotification((window.i18n ? window.i18n.t('received_file') : 'Êî∂Âà∞Êñá‰ª∂') + `: ${data.fileInfo.name}`, 'success');
            }
        }
        
        // ËøûÊé•Áä∂ÊÄÅÂ§ÑÁêÜÂáΩÊï∞
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (!statusElement || !textElement) return;
            
            // ÁßªÈô§ÊâÄÊúâÁä∂ÊÄÅÁ±ª
            statusElement.classList.remove('connected', 'disconnected', 'connecting');
            
            if (window.network && window.network.isConnected && window.network.isConnected()) {
                statusElement.classList.add('connected');
                textElement.textContent = window.i18n ? window.i18n.t('connection_connected') : 'Connected';
                textElement.setAttribute('data-i18n', 'connection_connected');
            } else {
                statusElement.classList.add('disconnected');
                textElement.textContent = window.i18n ? window.i18n.t('connection_disconnected') : 'Disconnected';
                textElement.setAttribute('data-i18n', 'connection_disconnected');
            }
        }
        
        function handleConnectionEstablished(event) {
            console.log('‚úÖ ËøûÊé•Â∑≤Âª∫Á´ã');
            updateConnectionStatus();
        }
        
        function handleConnectionLost(event) {
            console.log('‚ùå ËøûÊé•Â∑≤Êñ≠ÂºÄ');
            updateConnectionStatus();
        }
        
        function setConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');
            
            if (!statusElement || !textElement) return;
            
            // ÁßªÈô§ÊâÄÊúâÁä∂ÊÄÅÁ±ª
            statusElement.classList.remove('connected', 'disconnected', 'connecting');
            
            switch (status) {
                case 'connected':
                    statusElement.classList.add('connected');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_connected') : 'Connected';
                    textElement.setAttribute('data-i18n', 'connection_connected');
                    break;
                case 'connecting':
                    statusElement.classList.add('connecting');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_connecting') : 'Connecting...';
                    textElement.setAttribute('data-i18n', 'connection_connecting');
                    break;
                case 'disconnected':
                default:
                    statusElement.classList.add('disconnected');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_disconnected') : 'Disconnected';
                    textElement.setAttribute('data-i18n', 'connection_disconnected');
                    break;
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÂàùÂßãÂåñ...');
            
            // ÂàùÂßãÂåñËØ≠Ë®ÄÈÄâÊã©Âô®
            initializeLanguageSelector();
            
            console.log('‚úÖ È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê');
        });
    </script>
</body>
</html>