<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropShare - Rooms</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="share-premium.css">
    <style>
        /* Specific overrides for Rooms page that might not be in share-premium.css */
        .room-card {
            border: 1px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow-lg);
        }

        .room-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            background: rgba(255, 255, 255, 0.9);
        }

        /* Adjust page top padding for fixed header */
        html,
        body {
            padding-top: 80px;
            background: #ffffff !important;
            /* Ensure no ripple/gradient background */
            background-image: none !important;
        }
    </style>
    <link rel="stylesheet" href="unified-navigation.css">

    <!-- æ·»åŠ i18næ”¯æŒ -->
    <script src="locales/i18n.js"></script>

    <script>
        // ç”Ÿæˆå¹¶è®¾ç½®peerid cookie
        function generatePeerId() {
            const cookies = document.cookie.split(';');
            let hasPeerId = false;
            for (let cookie of cookies) {
                if (cookie.trim().startsWith('peerid=')) {
                    hasPeerId = true;
                    const peerId = cookie.trim().split('=')[1];
                    console.log('ğŸ”‘ æ‰¾åˆ°ç°æœ‰peerid:', peerId);
                    return peerId;
                }
            }

            if (!hasPeerId) {
                const peerId = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                document.cookie = `peerid=${peerId}; path=/`;
                console.log('ğŸ”‘ ç”Ÿæˆæ–°peerid:', peerId);
                return peerId;
            }
        }

        generatePeerId();
    </script>

</head>

<body>
    <div class="page-container">

        <header class="header">
            <div class="header-container">
                <div class="brand-left">
                    <a href="/" class="logo" style="text-decoration: none; cursor: pointer;">
                        <img src="images/logo_blue_512x512.png" alt="DropShare Logo" style="width: 32px; height: 32px;">
                        <span data-i18n="site_name">DropShare</span>
                    </a>
                </div>

                <div class="control-buttons">
                    <div class="language-selector">
                        <button id="langToggle" aria-expanded="false">
                            <span>English</span>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        <div id="langMenu" class="lang-menu">
                            <!-- Options will be populated by JS -->
                        </div>
                        <!-- Hidden selector for form submission and mobile fallback -->
                        <select id="language-selector" style="display:none;">
                            <option value="en">English</option>
                            <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
                            <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
                            <option value="ja">æ—¥æœ¬èª</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="fr">FranÃ§ais</option>
                            <option value="de">Deutsch</option>
                            <option value="pt">PortuguÃªs</option>
                            <option value="es">EspaÃ±ol</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <!-- ä¸»è¦å†…å®¹ -->
        <main class="main-content">
            <div class="container">
                <!-- è‹±é›„åŒºåŸŸ -->
                <div class="hero-section">
                    <h1 class="hero-title" data-i18n="rooms_title">Rooms</h1>
                    <p class="hero-subtitle" data-i18n="rooms_subtitle">å¿«é€Ÿä¸åŒä¸€ç½‘ç»œæˆ–è¿œç¨‹ç”¨æˆ·é€šè¿‡æˆ¿é—´ä»£ç å…±äº«æ–‡ä»¶</p>
                </div>

                <!-- è¿æ¥çŠ¶æ€ -->
                <div class="connection-status" id="connectionStatus">
                    <div class="connection-indicator"></div>
                    <div class="connection-text" id="connectionText" data-i18n="connection_disconnected">æœªè¿æ¥</div>
                </div>

                <!-- æˆ¿é—´é€‰é¡¹ -->
                <div class="room-options" id="roomOptions">
                    <div class="room-card">
                        <div class="room-card-icon">ğŸ </div>
                        <h3 data-i18n="create_room_title">åˆ›å»ºæˆ¿é—´</h3>
                        <p data-i18n="create_room_desc">åˆ›å»ºä¸€ä¸ªæ–°çš„æˆ¿é—´ï¼Œé‚€è¯·å…¶ä»–ç”¨æˆ·åŠ å…¥å¹¶å…±äº«æ–‡ä»¶</p>
                        <button class="btn btn-primary" onclick="showCreateRoomModal()"
                            data-i18n="create_room_btn">åˆ›å»ºæˆ¿é—´</button>
                    </div>

                    <div class="room-card">
                        <div class="room-card-icon">ğŸšª</div>
                        <h3 data-i18n="join_room_title">åŠ å…¥æˆ¿é—´</h3>
                        <p data-i18n="join_room_desc">ä½¿ç”¨æˆ¿é—´ä»£ç åŠ å…¥å·²å­˜åœ¨çš„æˆ¿é—´</p>
                        <button class="btn btn-secondary" onclick="showJoinRoomModal()"
                            data-i18n="join_room_btn">åŠ å…¥æˆ¿é—´</button>
                    </div>
                </div>

                <!-- æˆ¿é—´çŠ¶æ€åŒºåŸŸ -->
                <div class="room-status" id="roomStatus">
                    <div class="room-info">
                        <div class="room-info-item">
                            <div class="room-info-label" data-i18n="room_name">æˆ¿é—´åç§°</div>
                            <div class="room-info-value" id="currentRoomName">-</div>
                        </div>
                        <div class="room-info-item">
                            <div class="room-info-label" data-i18n="room_code">æˆ¿é—´ä»£ç </div>
                            <div class="room-info-value" id="currentRoomCode">-</div>
                        </div>
                        <div class="room-info-item">
                            <div class="room-info-label" data-i18n="member_count">æˆå‘˜æ•°é‡</div>
                            <div class="room-info-value" id="currentMemberCount">0</div>
                        </div>
                        <div class="room-info-item">
                            <div class="room-info-label" data-i18n="your_role">æ‚¨çš„è§’è‰²</div>
                            <div class="room-info-value" id="currentUserRole">-</div>
                        </div>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn btn-danger" onclick="leaveRoom()" data-i18n="leave_room">ç¦»å¼€æˆ¿é—´</button>
                    </div>
                </div>

                <!-- æˆå‘˜åˆ—è¡¨ -->
                <div class="members-section" id="membersSection" style="display: none;">
                    <h3>ğŸ‘¥ <span data-i18n="room_members">æˆ¿é—´æˆå‘˜</span> (<span id="memberCount">0</span>)</h3>
                    <div id="membersList"></div>
                </div>

                <!-- æ–‡ä»¶ç®¡ç†åŒºåŸŸ -->
                <div class="file-management" id="fileManagement" style="display: none;">
                    <!-- æ–‡ä»¶ä¸Šä¼  -->
                    <div class="file-section">
                        <h3>ğŸ“¤ <span data-i18n="upload_files">ä¸Šä¼ æ–‡ä»¶</span></h3>
                        <div class="file-upload-area" id="fileUploadArea"
                            onclick="document.getElementById('fileInput').click()">
                            <div style="font-size: 2rem; margin-bottom: 12px;">ğŸ“</div>
                            <div style="font-weight: 500; margin-bottom: 8px;" data-i18n="drag_drop_files">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©
                            </div>
                            <div style="color: var(--gray-500); font-size: 0.875rem;" data-i18n="supported_formats">
                                æ”¯æŒæ‰€æœ‰æ–‡ä»¶æ ¼å¼
                            </div>
                        </div>
                        <input type="file" id="fileInput" multiple style="display: none;">

                        <div id="uploadProgress" style="display: none; margin-top: 16px;">
                            <div style="margin-bottom: 8px; font-weight: 500;">ä¸Šä¼ è¿›åº¦</div>
                            <div style="background: var(--gray-200); border-radius: 4px; height: 8px;">
                                <div id="progressBar"
                                    style="background: var(--primary-500); height: 100%; border-radius: 4px; width: 0%; transition: width 0.3s;">
                                </div>
                            </div>
                            <div id="progressText"
                                style="margin-top: 4px; font-size: 0.875rem; color: var(--gray-600);">0%
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡ä»¶åˆ—è¡¨ -->
                    <div class="file-section">
                        <h3>ğŸ“‹ <span data-i18n="shared_files">å…±äº«æ–‡ä»¶</span> (<span id="fileCount">0</span>)</h3>
                        <div class="file-list" id="fileList">
                            <div style="text-align: center; color: var(--gray-500); padding: 20px;"
                                data-i18n="no_files">
                                æš‚æ— æ–‡ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- åˆ›å»ºæˆ¿é—´æ¨¡æ€çª—å£ -->
        <div class="modal" id="createRoomModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" data-i18n="create_new_room">åˆ›å»ºæ–°æˆ¿é—´</h2>
                    <button class="close-btn" onclick="hideCreateRoomModal()">&times;</button>
                </div>

                <form id="createRoomForm">
                    <div class="form-group">
                        <label for="roomPassword" data-i18n="room_password_optional">æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="password" id="roomPassword" placeholder=""
                            data-i18n-placeholder="room_password_optional_placeholder">
                    </div>

                    <div class="form-group">
                        <label for="maxMembers" data-i18n="maximum_members">æœ€å¤§æˆå‘˜æ•°</label>
                        <select id="maxMembers">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideCreateRoomModal()"
                            data-i18n="cancel">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" data-i18n="create_room">åˆ›å»ºæˆ¿é—´</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- åŠ å…¥æˆ¿é—´æ¨¡æ€çª—å£ -->
        <div class="modal" id="joinRoomModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" data-i18n="join_room">åŠ å…¥æˆ¿é—´</h2>
                    <button class="close-btn" onclick="hideJoinRoomModal()">&times;</button>
                </div>

                <form id="joinRoomForm">
                    <div class="form-group">
                        <label for="roomCode" data-i18n="room_code">æˆ¿é—´ä»£ç </label>
                        <input type="text" id="roomCode" placeholder="" data-i18n-placeholder="room_code_placeholder"
                            required style="text-transform: uppercase;">
                    </div>

                    <div class="form-group">
                        <label for="joinPassword" data-i18n="room_password_if_required">æˆ¿é—´å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰</label>
                        <input type="password" id="joinPassword" placeholder=""
                            data-i18n-placeholder="room_password_placeholder">
                    </div>

                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="hideJoinRoomModal()"
                            data-i18n="cancel">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary" data-i18n="join_room">åŠ å…¥æˆ¿é—´</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- å¿…éœ€çš„Dialogå…ƒç´  -->
        <x-dialog id="receiveDialog">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="file_received">File Received</h3>
                    <div class="font-subheading" id="fileName" data-i18n=""></div>
                    <div class="font-body2" id="fileSize"></div>
                    <div class='preview' style="visibility: hidden;">
                        <img id='img-preview' src="">
                    </div>
                    <div class="row">
                        <label for="autoDownload" class="grow" data-i18n="ask_save_files">Ask to save each file before
                            downloading</label>
                        <input type="checkbox" id="autoDownload" checked="">
                    </div>
                    <div class="row-reverse">
                        <a class="button" close id="download" title="Download File" autofocus data-i18n="save">Save</a>
                        <button class="button" close data-i18n="ignore">Ignore</button>
                    </div>
                </x-paper>
            </x-background>
        </x-dialog>

        <!-- Send Text Dialog -->
        <x-dialog id="sendTextDialog">
            <form action="#">
                <x-background class="full center">
                    <x-paper shadow="2">
                        <h3 data-i18n="send_message">Send a Message</h3>
                        <div id="textInput" class="textarea" role="textbox" data-placeholder="Send a message"
                            autocomplete="off" autofocus contenteditable></div>
                        <div class="row-reverse">
                            <button class="button" type="submit" close data-i18n="send">Send</button>
                            <a class="button" close data-i18n="cancel">Cancel</a>
                        </div>
                    </x-paper>
                </x-background>
            </form>
        </x-dialog>

        <!-- Receive Text Dialog -->
        <x-dialog id="receiveTextDialog">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="message_received">Message Received</h3>
                    <div class="font-subheading" id="text"></div>
                    <div class="row-reverse">
                        <button class="button" id="copy" close autofocus data-i18n="copy">Copy</button>
                        <button class="button" close data-i18n="close">Close</button>
                    </div>
                </x-paper>
            </x-background>
        </x-dialog>

        <!-- Toast -->
        <div class="toast-container full center">
            <x-toast class="row" shadow="1" id="toast">
                <div class="grow">
                    <span id="toast-text"></span>
                </div>
            </x-toast>
        </div>

        <!-- è„šæœ¬ -->
        <script src="scripts/network.js"></script>
        <script src="scripts/ui.js"></script>
        <script src="unified-navigation.js"></script>

        <script>
            // å…¨å±€å˜é‡
            let currentRoom = null;
            let isInRoom = false;
            let roomMembers = [];
            let sharedFiles = [];

            // åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', function () {
                initializeI18n();
                initializeEventListeners();
                initializeNetworkConnection();
            });

            // è·å–é¦–é€‰æ˜¾ç¤ºåç§°ï¼ˆè®¾å¤‡å/ç”¨æˆ·ç”Ÿæˆåï¼‰
            function getPreferredDisplayName() {
                try {
                    const stored = localStorage.getItem('displayName');
                    if (stored && stored.trim()) return stored.trim();
                } catch (e) { }

                const el = document.getElementById('displayName');
                if (el && el.textContent && el.textContent.trim()) {
                    return el.textContent.trim();
                }

                const adjectives = ['Blue', 'Red', 'Green', 'Orange', 'Purple', 'Yellow', 'Silver', 'Golden'];
                const animals = ['Bear', 'Wolf', 'Eagle', 'Lion', 'Tiger', 'Fox', 'Hawk', 'Shark'];
                const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const animal = animals[Math.floor(Math.random() * animals.length)];
                return `${adj} ${animal}`;
            }

            function initializeI18n() {
                const languageSelector = document.getElementById('language-selector');
                const savedLang = localStorage.getItem('dropshare-language') || 'en';
                if (languageSelector) languageSelector.value = savedLang;

                // åˆå§‹åŒ–é€šç”¨ i18n å¹¶ç¿»è¯‘æ•´é¡µ
                if (window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.init === 'function') {
                    window.DROPSHARE_I18N.init(savedLang).then(() => {
                        if (typeof window.DROPSHARE_I18N.translatePage === 'function') {
                            window.DROPSHARE_I18N.translatePage();
                        }
                    });
                }

                // åˆ‡æ¢è¯­è¨€æ—¶å®æ—¶ç¿»è¯‘
                if (languageSelector) {
                    languageSelector.addEventListener('change', function () {
                        const lang = this.value;
                        localStorage.setItem('dropshare-language', lang);
                        if (window.DROPSHARE_I18N) {
                            if (typeof window.DROPSHARE_I18N.changeLanguage === 'function') {
                                window.DROPSHARE_I18N.changeLanguage(lang).then(() => {
                                    if (typeof window.DROPSHARE_I18N.translatePage === 'function') {
                                        window.DROPSHARE_I18N.translatePage();
                                    }
                                });
                            } else if (typeof window.DROPSHARE_I18N.setLanguage === 'function') {
                                window.DROPSHARE_I18N.setLanguage(lang);
                                if (typeof window.DROPSHARE_I18N.translatePage === 'function') {
                                    window.DROPSHARE_I18N.translatePage();
                                }
                            }
                        }
                    });
                }
            }

            function initializeEventListeners() {
                // åˆ›å»ºæˆ¿é—´è¡¨å•
                document.getElementById('createRoomForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    createRoom();
                });

                // åŠ å…¥æˆ¿é—´è¡¨å•
                document.getElementById('joinRoomForm').addEventListener('submit', function (e) {
                    e.preventDefault();
                    joinRoom();
                });

                // ç«‹å³è®¾ç½®æˆ¿é—´äº‹ä»¶ç›‘å¬å™¨ï¼Œä¸ç­‰å¾…ç½‘ç»œè¿æ¥
                setupRoomEventHandlers();

                // æ–‡ä»¶ä¸Šä¼ 
                const fileInput = document.getElementById('fileInput');
                const fileUploadArea = document.getElementById('fileUploadArea');

                fileInput.addEventListener('change', handleFileSelect);

                // æ‹–æ‹½ä¸Šä¼ 
                fileUploadArea.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                fileUploadArea.addEventListener('dragleave', function (e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                fileUploadArea.addEventListener('drop', function (e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    handleFiles(files);
                });

                // æ¨¡æ€çª—å£ç‚¹å‡»å¤–éƒ¨å…³é—­
                document.addEventListener('click', function (e) {
                    if (e.target.classList.contains('modal')) {
                        hideAllModals();
                    }
                });
            }

            // æ¨¡æ€çª—å£æ§åˆ¶
            function showCreateRoomModal() {
                document.getElementById('createRoomModal').classList.add('show');
            }

            function hideCreateRoomModal() {
                document.getElementById('createRoomModal').classList.remove('show');
                document.getElementById('createRoomForm').reset();
            }

            function showJoinRoomModal() {
                document.getElementById('joinRoomModal').classList.add('show');
            }

            function hideJoinRoomModal() {
                document.getElementById('joinRoomModal').classList.remove('show');
                document.getElementById('joinRoomForm').reset();
            }

            function hideAllModals() {
                hideCreateRoomModal();
                hideJoinRoomModal();
            }

            // æˆ¿é—´åŠŸèƒ½
            function createRoom() {
                const roomPassword = document.getElementById('roomPassword').value;
                const maxMembers = parseInt(document.getElementById('maxMembers').value);
                const roomCode = generateRoomCode();

                if (!window.network || !window.network.send) {
                    alert(window.i18n ? window.i18n.t('network_unavailable') : 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }

                const roomData = {
                    type: 'create-room',
                    roomSettings: {
                        code: roomCode,
                        name: roomCode, // ä½¿ç”¨æˆ¿é—´ç ä½œä¸ºæˆ¿é—´åç§°
                        password: roomPassword || undefined,
                        maxMembers: maxMembers,
                        isPrivate: !!roomPassword
                    },
                    userInfo: {
                        displayName: getPreferredDisplayName(),
                        deviceName: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Computer'
                    }
                };

                console.log('åˆ›å»ºæˆ¿é—´:', roomData);
                window.network.send(roomData);
                hideCreateRoomModal();
            }

            function joinRoom() {
                const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
                const password = document.getElementById('joinPassword').value;

                if (!roomCode) {
                    alert(window.i18n ? window.i18n.t('please_enter_room_code') : 'è¯·è¾“å…¥æˆ¿é—´ä»£ç ');
                    return;
                }

                if (!window.network || !window.network.send) {
                    alert(window.i18n ? window.i18n.t('network_unavailable') : 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }

                const joinData = {
                    type: 'join-room',
                    roomCode: roomCode,
                    password: password || undefined,
                    userInfo: {
                        displayName: getPreferredDisplayName(),
                        deviceName: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Computer'
                    }
                };

                console.log('åŠ å…¥æˆ¿é—´:', joinData);
                window.network.send(joinData);
                hideJoinRoomModal();
            }

            function leaveRoom() {
                if (!isInRoom) return;

                if (confirm(window.i18n ? window.i18n.t('confirm_leave_room') : 'ç¡®å®šè¦ç¦»å¼€æˆ¿é—´å—ï¼Ÿ')) {
                    const leaveData = {
                        type: 'leave-room'
                    };

                    console.log('ç¦»å¼€æˆ¿é—´:', leaveData);

                    if (window.network && window.network.send) {
                        window.network.send(leaveData);
                    }

                    // é‡ç½®UI
                    handleRoomLeft();
                }
            }

            // æˆ¿é—´çŠ¶æ€å¤„ç†
            function handleRoomCreated(event) {
                const data = event.detail;
                console.log('æˆ¿é—´åˆ›å»ºæˆåŠŸ:', data);
                const hostInfo = data.hostInfo || { displayName: 'æˆ¿ä¸»', name: 'æˆ¿ä¸»', isHost: true };
                // ç¡®ä¿hostInfoæœ‰nameå±æ€§
                if (!hostInfo.name && hostInfo.displayName) {
                    hostInfo.name = hostInfo.displayName;
                }
                currentRoom = {
                    roomCode: data.room.code,
                    roomName: data.room.name,
                    isHost: true,
                    members: [hostInfo]
                };
                isInRoom = true;
                updateRoomUI();
                showRoomInterface();
            }

            function handleRoomJoined(event) {
                const data = event.detail;
                console.log('åŠ å…¥æˆ¿é—´æˆåŠŸ:', data);
                // ç¡®ä¿æ‰€æœ‰æˆå‘˜éƒ½æœ‰nameå±æ€§
                const members = (data.members || []).map(member => {
                    if (!member.name && member.displayName) {
                        member.name = member.displayName;
                    }
                    return member;
                });
                currentRoom = {
                    roomCode: data.room.code,
                    roomName: data.room.name,
                    isHost: false,
                    members: members
                };
                isInRoom = true;
                updateRoomUI();
                showRoomInterface();
            }

            function handleRoomLeft() {
                currentRoom = null;
                isInRoom = false;
                hideRoomInterface();
            }

            function updateRoomUI() {
                if (!currentRoom) return;

                document.getElementById('currentRoomName').textContent = currentRoom.roomName;
                document.getElementById('currentRoomCode').textContent = currentRoom.roomCode;
                document.getElementById('currentMemberCount').textContent = currentRoom.members.length;
                document.getElementById('currentUserRole').textContent = currentRoom.isHost ? (window.i18n ? window.i18n.t('role_host') : 'Host') : (window.i18n ? window.i18n.t('role_member') : 'Member');

                updateMembersList();
            }

            function showRoomInterface() {
                document.getElementById('roomOptions').style.display = 'none';
                document.getElementById('roomStatus').classList.add('show');
                document.getElementById('membersSection').style.display = 'block';
                document.getElementById('fileManagement').style.display = 'grid';
            }

            function hideRoomInterface() {
                document.getElementById('roomOptions').style.display = 'grid';
                document.getElementById('roomStatus').classList.remove('show');
                document.getElementById('membersSection').style.display = 'none';
                document.getElementById('fileManagement').style.display = 'none';

                // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
                sharedFiles = [];
                updateFilesList();
            }

            function updateMembersList() {
                if (!currentRoom) return;

                const membersList = document.getElementById('membersList');
                const memberCount = document.getElementById('memberCount');

                memberCount.textContent = currentRoom.members.length;
                membersList.innerHTML = '';

                currentRoom.members.forEach(member => {
                    const memberElement = document.createElement('div');
                    memberElement.className = 'member-item';
                    const memberName = member.displayName || member.deviceName || member.name || (window.i18n ? window.i18n.t('unknown_user') : 'Unknown');
                    memberElement.innerHTML = `
                    <div class="member-avatar">${memberName.charAt(0).toUpperCase()}</div>
                    <div class="member-info">
                        <div class="member-name">${memberName}${member.isHost ? ' ğŸ‘‘' : ''}</div>
                        <div class="member-status">${member.isHost ? (window.i18n ? window.i18n.t('role_host') : 'Host') : (window.i18n ? window.i18n.t('role_member') : 'Member')}</div>
                    </div>
                `;
                    membersList.appendChild(memberElement);
                });
            }

            // æ–‡ä»¶å¤„ç†
            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }

            function handleFiles(files) {
                if (!isInRoom) {
                    alert(window.i18n ? window.i18n.t('please_create_or_join_room') : 'è¯·å…ˆåˆ›å»ºæˆ–åŠ å…¥æˆ¿é—´');
                    return;
                }

                for (let file of files) {
                    uploadFile(file);
                }
            }

            function uploadFile(file) {
                console.log('ä¸Šä¼ æ–‡ä»¶:', file.name);

                if (!currentRoom || !currentRoom.roomCode) {
                    alert(window.i18n ? window.i18n.t('please_join_room_first') : 'è¯·å…ˆåŠ å…¥æˆ¿é—´');
                    return;
                }

                // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
                showUploadProgress();

                // åˆ›å»ºæ–‡ä»¶ä¿¡æ¯å¯¹è±¡
                const fileInfo = {
                    id: Date.now(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadTime: new Date()
                };

                // è¯»å–æ–‡ä»¶å†…å®¹å¹¶å‘é€åˆ°æˆ¿é—´
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (window.network && window.network.send) {
                        const shareMessage = {
                            type: 'room-file-shared',
                            roomCode: currentRoom.roomCode,
                            fileInfo: {
                                ...fileInfo,
                                uploader: (function () {
                                    try { const s = window.localStorage.getItem('displayName'); if (s && s.trim()) return s.trim(); } catch (e) { }
                                    return getPreferredDisplayName();
                                })(),
                                uploaderId: window.network.peerId || 'unknown'
                            },
                            fileData: e.target.result // base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
                        };

                        console.log('å‘é€æ–‡ä»¶å…±äº«æ¶ˆæ¯:', shareMessage.fileInfo.name);
                        window.network.send(shareMessage);
                    }
                };
                reader.readAsDataURL(file);

                // æ¨¡æ‹Ÿä¸Šä¼ è¿›åº¦
                let progress = 0;
                const interval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(interval);
                        hideUploadProgress();
                        addFileToList(file);
                    }
                    updateUploadProgress(progress);
                }, 200);
            }

            function showUploadProgress() {
                document.getElementById('uploadProgress').style.display = 'block';
            }

            function hideUploadProgress() {
                document.getElementById('uploadProgress').style.display = 'none';
            }

            function updateUploadProgress(progress) {
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');

                progressBar.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '%';
            }

            function addFileToList(file) {
                const fileInfo = {
                    id: Date.now(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploadTime: new Date()
                };

                sharedFiles.push(fileInfo);
                updateFilesList();
            }

            function updateFilesList() {
                const fileList = document.getElementById('fileList');
                const fileCount = document.getElementById('fileCount');

                fileCount.textContent = sharedFiles.length;

                if (sharedFiles.length === 0) {
                    fileList.innerHTML = '<div style="text-align: center; color: var(--gray-500); padding: 20px;">æš‚æ— æ–‡ä»¶</div>';
                    return;
                }

                fileList.innerHTML = '';

                sharedFiles.forEach(file => {
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    fileElement.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary btn-small" onclick="downloadFile('${file.id}')">ä¸‹è½½</button>
                        <button class="btn btn-danger btn-small" onclick="deleteFile('${file.id}')">åˆ é™¤</button>
                    </div>
                `;
                    fileList.appendChild(fileElement);
                });
            }

            function downloadFile(fileId) {
                const file = sharedFiles.find(f => f.id == fileId);
                if (file && file.fileData) {
                    console.log('ä¸‹è½½æ–‡ä»¶:', file.name);

                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = file.fileData; // base64æ•°æ®URL
                    link.download = file.name;
                    link.style.display = 'none';

                    // è§¦å‘ä¸‹è½½
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    showNotification(`ä¸‹è½½å®Œæˆ: ${file.name}`, 'success');
                } else {
                    showNotification('æ–‡ä»¶æ•°æ®ä¸å¯ç”¨', 'error');
                }
            }

            function deleteFile(fileId) {
                if (confirm(window.i18n ? window.i18n.t('confirm_delete_file') : 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    sharedFiles = sharedFiles.filter(f => f.id != fileId);
                    updateFilesList();
                }
            }

            // å·¥å…·å‡½æ•°
            function generateRoomCode() {
                // ç”Ÿæˆ4ä½æ•°å­—æˆ¿é—´ç 
                return Math.floor(1000 + Math.random() * 9000).toString();
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function initializeNetworkConnection() {
                // åˆå§‹åŒ–ç½‘ç»œè¿æ¥
                console.log('åˆå§‹åŒ–ç½‘ç»œè¿æ¥...');
                setConnectionStatus('connecting');

                // ç­‰å¾…ç½‘ç»œè„šæœ¬åŠ è½½å®Œæˆå¹¶å»ºç«‹è¿æ¥
                let attempts = 0;
                const maxAttempts = 10;

                function checkConnection() {
                    attempts++;

                    if (window.network && window.network.isConnected && window.network.isConnected()) {
                        console.log('âœ… ç½‘ç»œè¿æ¥å·²å»ºç«‹');
                        setConnectionStatus('connected');
                        setupRoomEventHandlers();
                    } else if (window.network && window.network.serverConnection) {
                        console.log('ğŸ”„ ç½‘ç»œå¯¹è±¡å­˜åœ¨ï¼Œç­‰å¾…è¿æ¥å»ºç«‹...');
                        setConnectionStatus('connecting');
                        if (attempts < maxAttempts) {
                            setTimeout(checkConnection, 500);
                        } else {
                            console.error('âŒ ç½‘ç»œè¿æ¥è¶…æ—¶');
                            setConnectionStatus('disconnected');
                        }
                    } else {
                        console.log('â³ ç­‰å¾…ç½‘ç»œå¯¹è±¡åˆå§‹åŒ–...');
                        setConnectionStatus('connecting');
                        if (attempts < maxAttempts) {
                            setTimeout(checkConnection, 500);
                        } else {
                            console.error('âŒ ç½‘ç»œè¿æ¥å¤±è´¥');
                            setConnectionStatus('disconnected');
                        }
                    }
                }

                // å¼€å§‹æ£€æŸ¥è¿æ¥
                setTimeout(checkConnection, 100);
            }

            function setupRoomEventHandlers() {
                // ç›‘å¬æˆ¿é—´ç›¸å…³äº‹ä»¶
                const Events = window.network?.Events || window.Events;

                if (Events) {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                    Events.off('room-created', handleRoomCreated);
                    Events.off('room-joined', handleRoomJoined);
                    Events.off('room-left', handleRoomLeft);
                    Events.off('room-error', handleRoomError);
                    Events.off('room-member-joined', handleMemberJoined);
                    Events.off('room-member-left', handleMemberLeft);
                    Events.off('room-file-shared', handleFileShared);
                    Events.off('peer-connected', handleConnectionEstablished);
                    Events.off('peer-disconnected', handleConnectionLost);

                    // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                    Events.on('room-created', handleRoomCreated);
                    Events.on('room-joined', handleRoomJoined);
                    Events.on('room-left', handleRoomLeft);
                    Events.on('room-error', handleRoomError);
                    Events.on('room-member-joined', handleMemberJoined);
                    Events.on('room-member-left', handleMemberLeft);
                    Events.on('room-file-shared', handleFileShared);

                    // ç›‘å¬è¿æ¥çŠ¶æ€äº‹ä»¶
                    Events.on('peer-connected', handleConnectionEstablished);
                    Events.on('peer-disconnected', handleConnectionLost);

                    console.log('âœ… æˆ¿é—´äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
                } else {
                    console.log('â³ Eventså¯¹è±¡å°šæœªåŠ è½½ï¼Œ1ç§’åé‡è¯•...');
                    setTimeout(setupRoomEventHandlers, 1000);
                }

                // åˆå§‹åŒ–è¿æ¥çŠ¶æ€æ˜¾ç¤º
                updateConnectionStatus();
            }

            function handleRoomError(event) {
                const error = event.detail;
                console.error('æˆ¿é—´é”™è¯¯:', error);
                alert((window.i18n ? window.i18n.t('room_operation_failed') : 'æˆ¿é—´æ“ä½œå¤±è´¥') + ': ' + (error.error || error.message || error));
            }

            function handleMemberJoined(event) {
                const data = event.detail;
                console.log('æ–°æˆå‘˜åŠ å…¥:', data);
                if (currentRoom && data.member) {
                    currentRoom.members.push(data.member);
                    updateRoomUI();
                }
                // å¦‚æœæ¶ˆæ¯åŒ…å«å®Œæ•´çš„æˆå‘˜åˆ—è¡¨ï¼Œä½¿ç”¨å®ƒ
                if (currentRoom && data.room && data.room.members) {
                    currentRoom.members = data.room.members;
                    updateRoomUI();
                }
            }

            function handleMemberLeft(event) {
                const data = event.detail;
                console.log('æˆå‘˜ç¦»å¼€:', data);
                if (currentRoom && data.memberId) {
                    currentRoom.members = currentRoom.members.filter(m => m.id !== data.memberId);
                    updateRoomUI();
                }
                // å¦‚æœæ¶ˆæ¯åŒ…å«å®Œæ•´çš„æˆå‘˜åˆ—è¡¨ï¼Œä½¿ç”¨å®ƒ
                if (currentRoom && data.room && data.room.members) {
                    currentRoom.members = data.room.members;
                    updateRoomUI();
                }
            }

            function handleFileShared(event) {
                const data = event.detail;
                console.log('æ”¶åˆ°å…±äº«æ–‡ä»¶:', data);
                if (data.fileInfo && data.fileData) {
                    // ä¿å­˜æ–‡ä»¶ä¿¡æ¯å’Œæ•°æ®
                    const fileWithData = {
                        ...data.fileInfo,
                        fileData: data.fileData // base64ç¼–ç çš„æ–‡ä»¶æ•°æ®
                    };
                    sharedFiles.push(fileWithData);
                    updateFilesList();

                    // æ˜¾ç¤ºé€šçŸ¥
                    showNotification((window.i18n ? window.i18n.t('received_file') : 'æ”¶åˆ°æ–‡ä»¶') + `: ${data.fileInfo.name}`, 'success');
                }
            }

            // è¿æ¥çŠ¶æ€å¤„ç†å‡½æ•°
            function updateConnectionStatus() {
                const statusElement = document.getElementById('connectionStatus');
                const textElement = document.getElementById('connectionText');

                if (!statusElement || !textElement) return;

                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                statusElement.classList.remove('connected', 'disconnected', 'connecting');

                if (window.network && window.network.isConnected && window.network.isConnected()) {
                    statusElement.classList.add('connected');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_connected') : 'Connected';
                    textElement.setAttribute('data-i18n', 'connection_connected');
                } else {
                    statusElement.classList.add('disconnected');
                    textElement.textContent = window.i18n ? window.i18n.t('connection_disconnected') : 'Disconnected';
                    textElement.setAttribute('data-i18n', 'connection_disconnected');
                }
            }

            function handleConnectionEstablished(event) {
                console.log('âœ… è¿æ¥å·²å»ºç«‹');
                updateConnectionStatus();
            }

            function handleConnectionLost(event) {
                console.log('âŒ è¿æ¥å·²æ–­å¼€');
                updateConnectionStatus();
            }

            function setConnectionStatus(status) {
                const statusElement = document.getElementById('connectionStatus');
                const textElement = document.getElementById('connectionText');

                if (!statusElement || !textElement) return;

                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                statusElement.classList.remove('connected', 'disconnected', 'connecting');

                switch (status) {
                    case 'connected':
                        statusElement.classList.add('connected');
                        textElement.textContent = window.i18n ? window.i18n.t('connection_connected') : 'Connected';
                        textElement.setAttribute('data-i18n', 'connection_connected');
                        break;
                    case 'connecting':
                        statusElement.classList.add('connecting');
                        textElement.textContent = window.i18n ? window.i18n.t('connection_connecting') : 'Connecting...';
                        textElement.setAttribute('data-i18n', 'connection_connecting');
                        break;
                    case 'disconnected':
                    default:
                        statusElement.classList.add('disconnected');
                        textElement.textContent = window.i18n ? window.i18n.t('connection_disconnected') : 'Disconnected';
                        textElement.setAttribute('data-i18n', 'connection_disconnected');
                        break;
                }
            }

            // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', function () {
                console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

                // åˆå§‹åŒ–è¯­è¨€é€‰æ‹©å™¨
                initializeLanguageSelector();

                console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            });
        </script>

</body>

</html>