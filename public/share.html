<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Web App Config -->
    <title>DropShare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3367d6">
    <meta name="color-scheme" content="dark light">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-title" content="DropShare">
    <!-- Descriptions -->
    <meta name="description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="keywords" content="File, Transfer, Share, Peer2Peer">
    <meta name="author" content="RobinLinus">
    <meta property="og:title" content="DropShare">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://snapdrop.net/">
    <meta property="og:author" content="https://facebook.com/RobinLinus">
    <meta name="twitter:author" content="@RobinLinus">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="og:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <!-- Icons -->
    <link rel="icon" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="shortcut icon" href="images/favicon-96x96.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <meta name="msapplication-TileImage" content="images/mstile-150x150.png">
    <link rel="fluid-icon" type="image/png" href="images/android-chrome-192x192.png">
    <meta name="twitter:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <meta property="og:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <!-- Resources -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Override styles.css layout for centered sharing page */
        body {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
        }
        
        /* Main page container */
        .page-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            position: relative;
            padding-top: 80px;
        }
        
        /* Message area in the center */
        .center-message {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        /* User info at bottom */
        .user-info-bottom {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }
        
        /* Style the peer area */
        x-peers {
            display: flex !important;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        /* Center the no-peers message */
        x-no-peers {
            margin: 20px 0;
        }
        
        /* Center footer content */
        footer {
            position: static !important;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        
        /* Hide instructions container that interferes */
        .instructions-container {
            display: none;
        }
        
        /* 隐藏返回首页按钮 */
        .back-home-btn {
            display: none !important;
        }
        
        /* 房间功能样式 */
        .room-container {
            display: none;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .room-container.active {
            display: flex !important;
        }
        
        .room-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .room-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .room-subtitle {
            font-size: 1.125rem;
            color: #64748b;
            margin: 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-options {
            display: flex !important;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .room-forms-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            width: 100%;
            padding: 0 20px; /* 增加左右内边距，确保在小屏幕上也有间距 */
            box-sizing: border-box;
        }
        
        .room-btn {
            padding: 14px 28px;
            background: #3367d6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .room-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .room-btn.secondary {
            background: transparent;
            color: #3367d6;
            border: 2px solid #3367d6;
        }
        
        .room-btn.secondary:hover {
            background: #3367d6;
            color: white;
        }
        
        .room-form {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 0 auto; /* 水平居中 */
            position: relative;
            z-index: 1050; /* 确保在导航栏之上 */
            box-sizing: border-box; /* 确保padding包含在width内 */
        }
        
        .room-form.active {
            display: block;
        }
        
        .room-form h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* 确保padding和border包含在width内 */
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3367d6;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* 确保padding包含在width内 */
        }
        
        .btn-primary {
            background: #3367d6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
        }
        
        .room-info {
            display: none;
            background: #f0f9ff;
            border-radius: 12px;
            border-left: 4px solid #3367d6;
            margin-bottom: 24px;
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .room-info.active {
            display: block;
        }
        
        .room-info-header {
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .room-info-header:hover {
            background: #f1f5f9;
        }
        
        .room-summary {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }
        
        .room-name-display {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }
        
        .room-code-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .room-code-display {
            font-family: monospace;
            color: #3367d6;
            font-weight: 600;
            font-size: 14px;
        }
        
        .copy-btn-small {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .copy-btn-small:hover {
            background: #f1f5f9;
        }
        
        .member-count {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-info {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 4px 0;
        }
        
        .current-user-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-name {
            font-size: 12px;
            color: #3367d6;
            font-weight: 600;
            background: #f0f9ff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
        }
        
        .toggle-details-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .toggle-details-btn:hover {
            background: #e2e8f0;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
            color: #64748b;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .room-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        .room-details.expanded {
            max-height: 200px;
            padding: 16px 20px;
        }
        
        .room-members-section {
            font-size: 14px;
        }
        
        .room-members-section strong {
            display: block;
            margin-bottom: 12px;
            color: #374151;
        }
        
        .room-actions {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            text-align: center;
        }
        
        .btn-leave-room {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-leave-room:hover {
            background: #dc2626;
        }
        
        /* 房间警告提示样式 */
        .room-warning {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            margin-bottom: 24px;
            padding: 16px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-warning.active {
            display: block;
        }
        
        .warning-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .warning-text {
            flex: 1;
        }
        
        .warning-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .warning-message {
            color: #92400e;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .room-members {
            margin-top: 20px;
        }
        
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .member-name {
            font-weight: 500;
        }
        
        .member-role {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .error-message {
            color: #ef4444;
            background: #fef2f2;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
        }
        
        /* 房间文件共享区域样式 */
        .file-transfer-area {
            display: none;
            width: 100%;
            margin-top: 24px;
        }
        
        .room-file-sharing {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .file-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .file-transfer-area.active {
            display: block;
        }
        
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .shared-files-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .upload-section h3, .shared-files-section h3 {
            margin: 0 0 16px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shared-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .file-count {
            color: #6b7280;
            font-size: 14px;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .upload-hint {
            color: #6b7280;
            font-size: 14px;
            margin: 4px 0 12px 0;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3367d6;
            background: #f0f9ff;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .upload-icon {
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .drop-zone p {
            color: #6b7280;
            margin: 0;
            font-size: 16px;
        }
        
        .select-files-btn {
            background: #3367d6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .select-files-btn:hover {
            background: #2563eb;
        }
        
        .shared-files-list {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .no-shared-files {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
        }
        
        .no-shared-files p {
            margin: 8px 0;
        }
        
        .no-shared-files .hint {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shared-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fafafa;
            transition: all 0.2s;
        }
        
        .shared-file-item:hover {
            background: #f0f9ff;
            border-color: #3367d6;
        }
        
        .shared-file-info {
            flex: 1;
        }
        
        .shared-file-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            font-size: 16px;
        }
        
        .shared-file-details {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            gap: 16px;
        }
        
        .shared-file-uploader {
            color: #3367d6;
            font-weight: 500;
        }
        
        .restored-tag {
            color: #f59e0b;
            font-size: 12px;
            font-weight: normal;
        }
        
        .unavailable-hint {
            color: #ef4444;
            font-size: 12px;
            font-style: italic;
        }
        
        .action-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* 文件状态样式 */
        .shared-file-item.file-offline {
            opacity: 0.6;
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        
        .shared-file-item.file-offline .shared-file-name {
            color: #6c757d;
        }
        
        .shared-file-item.file-unavailable {
            opacity: 0.7;
            background: #fdf2f2;
            border-color: #fecaca;
        }
        
        .shared-file-item.file-unavailable .shared-file-name {
            color: #991b1b;
        }
        
        .file-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .status-online {
            background: #10b981;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        .status-unavailable {
            background: #f59e0b;
        }
        
        .shared-file-actions {
            display: flex;
            gap: 8px;
        }
        
        .transfer-item, .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fafafa;
        }
        
        .transfer-info, .file-info {
            flex: 1;
        }
        
        .transfer-name, .file-name {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .transfer-details, .file-details {
            font-size: 12px;
            color: #6b7280;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3367d6;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .transfer-actions, .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-download {
            background: #10b981;
            color: white;
        }
        
        .btn-download:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #ef4444;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #dc2626;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .room-file-sharing {
                gap: 16px;
            }
            
            .upload-section, .shared-files-section {
                padding: 20px;
            }
            
            .room-container {
                max-width: 800px;
                padding: 20px;
            }
            
            .room-info {
                max-width: 100%;
            }
        }
        
        /* 移动端适配 */
        @media (max-width: 768px) {
            .back-home-btn {
                top: 16px;
                left: 16px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .room-container {
                max-width: 100%;
                padding: 16px;
                gap: 20px;
            }
            
            .room-options {
                flex-direction: column;
                gap: 12px;
            }
            
            .room-btn {
                width: 100%;
                padding: 16px;
            }
            
            .room-form {
                padding: 20px;
            }
            
            .shared-file-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .shared-file-actions {
                justify-content: center;
            }
            
            .drop-zone {
                padding: 30px 20px;
            }
            
            .upload-section h3, 
            .transfer-list-section h3, 
            .received-files-section h3 {
                font-size: 16px;
            }
            
            .room-title {
                font-size: 1.875rem;
            }
            
            .room-subtitle {
                font-size: 1rem;
            }
            
            .room-header {
                margin-bottom: 24px;
            }
        }
        
        /* 大屏幕优化 */
        @media (min-width: 1400px) {
            .room-container {
                max-width: 1400px;
            }
            
            .file-transfer-grid {
                gap: 32px;
            }
        }
        
        /* 顶部导航栏样式 */
        .top-navbar {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }
        
        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            padding: 0 20px;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #3367d6;
            font-size: 24px;
            font-weight: 600;
        }
        
        .navbar-brand .brand-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            fill: currentColor;
        }
        
        .navbar-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-link {
            padding: 8px 16px;
            text-decoration: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            color: #3367d6;
            background: #f3f4f6;
        }

        .nav-link.active {
            color: #3367d6;
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .language-selector select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* 调整页面内容，为固定导航栏留出空间 */
        body {
            padding-top: 60px !important;
        }
        
        .page-container {
            padding-top: 20px; /* 减少原有的top padding */
        }
        
        /* 响应式导航栏 */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 16px;
            }
            
            .navbar-brand {
                font-size: 20px;
            }
            
            .navbar-brand .brand-icon {
                width: 28px;
                height: 28px;
                margin-right: 8px;
            }
            
            .navbar-nav {
                gap: 4px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .language-selector select {
                padding: 4px 8px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body translate="no">
    <!-- 顶部导航栏 -->
    <nav class="top-navbar">
        <div class="navbar-container">
            <!-- 品牌LOGO -->
            <a href="/" class="navbar-brand">
                <svg class="brand-icon" viewBox="0 0 24 24">
                    <use xlink:href="#wifi-tethering" />
                </svg>
                DropShare
            </a>
            
            <!-- 导航菜单 -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="/share.html" class="nav-link active" data-i18n="nav_transfer">传送</a>
                </li>
                <li class="nav-item">
                    <a href="/share.html#rooms" class="nav-link" data-i18n="nav_rooms">多人房间</a>
                </li>
                <li class="nav-item">
                    <a href="image-tools.html" class="nav-link" data-i18n="nav_images">图片</a>
                </li>
                <li class="nav-item">
                    <a href="audio-tools.html" class="nav-link" data-i18n="nav_audio">音频</a>
                </li>
                <li class="nav-item">
                    <a href="video-tools.html" class="nav-link" data-i18n="nav_video">视频</a>
                </li>
                <li class="nav-item">
                    <a href="document-tools.html" class="nav-link" data-i18n="nav_files">文件</a>
                </li>
                <li class="nav-item language-selector">
                    <select id="navbar-language-selector" title="Select Language">
                        <option value="en">English</option>
                        <option value="zh">中文简体</option>
                        <option value="zh-tw">中文繁體</option>
                        <option value="ja">日本語</option>
                        <option value="fr">Français</option>
                        <option value="es">Español</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">Português</option>
                        <option value="ru">Русский</option>
                        <option value="ar">العربية</option>
                        <option value="ko">한국어</option>
                    </select>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- 添加背景动画 -->
    <div class="background-animation"></div>
    
    <!-- 返回首页按钮已隐藏 -->
    
    <header class="row-reverse">
        <a href="#about" class="icon-button" title="About DropShare" style="display: none;">
            <svg class="icon">
                <use xlink:href="#info-outline" />
            </svg>
        </a>
        <a href="#" id="theme" class="icon-button" title="Switch Darkmode/Lightmode" >
            <svg class="icon">
                <use xlink:href="#icon-theme" />
            </svg>
        </a>
        <a href="#" id="notification" class="icon-button" title="Enable Notifications" hidden>
            <svg class="icon">
                <use xlink:href="#notifications" />
            </svg>
        </a>
        <a href="#" id="install" class="icon-button" title="Install Snapdrop" hidden>
            <svg class="icon">
                <use xlink:href="#homescreen" />
            </svg>
        </a>
        <div class="lang-selector">
            <select id="language-selector" title="Select Language">
                <option value="en">English</option>
                <option value="zh">中文简体</option>
                <option value="zh-tw">中文繁體</option>
                <option value="ja">日本語</option>
                <option value="fr">Français</option>
                <option value="es">Español</option>
                <option value="de">Deutsch</option>
                <option value="pt">Português</option>
                <option value="ru">Русский</option>
                <option value="ar">العربية</option>
                <option value="ko">한국어</option>
            </select>
        </div>
    </header>
    
    <!-- Main page container -->
    <div class="page-container">
        <!-- Center message area -->
        <div class="center-message">
            <!-- 房间功能容器 -->
            <div id="roomContainer" class="room-container">
                <div class="room-header">
                    <h1 class="room-title" data-i18n="room_title">多人共享房间</h1>
                    <p class="room-subtitle" data-i18n="room_subtitle">与同网络用户或通过房间码与远程用户快速共享文件</p>
                </div>
                
                <!-- 房间选项按钮 -->
                <div class="room-options">
                    <button id="createRoomBtn" class="room-btn" data-i18n="create_room_btn">创建房间</button>
                    <button id="joinRoomBtn" class="room-btn secondary" data-i18n="join_room_btn">加入房间</button>
                </div>
                
                <!-- 表单容器，用于居中 -->
                <div class="room-forms-container">
                    <!-- 创建房间表单 -->
                    <div id="createRoomForm" class="room-form">
                        <h3 data-i18n="create_new_room">创建新房间</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label" data-i18n="room_name_label">房间名称</label>
                                <input type="text" id="roomName" name="room-name" class="form-input" data-i18n-placeholder="room_name_placeholder" placeholder="输入房间名称" maxlength="20" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="room_password_label">房间密码 (可选)</label>
                                <input type="password" id="roomPassword" name="room-password" class="form-input" placeholder="设置房间密码" maxlength="16" autocomplete="new-password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大成员数</label>
                                <input type="number" id="maxMembers" name="max-members" class="form-input" value="10" min="2" max="50" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmCreateRoom" class="btn-primary">创建房间</button>
                                <button type="button" id="cancelCreateRoom" class="btn-cancel">取消</button>
                            </div>
                        </form>
                        <div id="createRoomError" class="error-message" style="display: none;"></div>
                    </div>
                    
                    <!-- 加入房间表单 -->
                    <div id="joinRoomForm" class="room-form">
                        <h3>加入房间</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label">房间码</label>
                                <input type="text" id="roomCode" name="room-code" class="form-input" placeholder="输入房间码" maxlength="10" style="text-transform: uppercase;" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label">房间密码 (如果需要)</label>
                                <input type="password" id="joinRoomPassword" name="join-password" class="form-input" placeholder="输入房间密码" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmJoinRoom" class="btn-primary">加入房间</button>
                                <button type="button" id="cancelJoinRoom" class="btn-cancel">取消</button>
                            </div>
                        </form>
                        <div id="joinRoomError" class="error-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- 房间信息显示 -->
                <div id="roomInfo" class="room-info">
                    <!-- 房间信息头部（始终显示） -->
                    <div class="room-info-header" id="roomInfoHeader">
                        <div class="room-summary">
                            <span class="room-name-display" id="roomNameDisplay"></span>
                            <div class="room-code-row">
                                <span class="room-code-display" id="roomCodeDisplay"></span>
                                <button id="copyRoomCode" class="copy-btn-small" title="复制房间码">📋</button>
                            </div>
                            <div class="current-user-info">
                                <span class="current-user-label">您的名称：</span>
                                <span class="current-user-name" id="currentUserName"></span>
                            </div>
                            <span class="member-count" id="memberCount">2人在线</span>
                        </div>
                        <button class="toggle-details-btn" id="toggleDetailsBtn">
                            <svg class="toggle-icon" viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- 房间详细信息（可折叠） -->
                    <div class="room-details" id="roomDetails">
                        <div class="room-members-section">
                            <strong>房间成员:</strong>
                            <div id="memberList" class="member-list"></div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="room-actions">
                        <button id="leaveRoomBtn" class="btn-leave-room">退出房间</button>
                    </div>
                </div>
                
                <!-- 房间警告提示 -->
                <div id="roomWarning" class="room-warning">
                    <div class="warning-content">
                        <div class="warning-icon">⚠️</div>
                        <div class="warning-text">
                            <div id="warningTitle" class="warning-title"></div>
                            <div id="warningMessage" class="warning-message"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 房间文件共享区域 -->
                <div id="fileTransferArea" class="file-transfer-area">
                    <div class="room-file-sharing">
                        <!-- 文件上传区域 -->
                        <div class="upload-section">
                            <h3>📤 上传文件到房间</h3>
                            <div id="dropZone" class="drop-zone">
                                <div class="drop-zone-content">
                                    <svg class="upload-icon" viewBox="0 0 24 24" width="48" height="48">
                                        <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                    </svg>
                                    <p>拖拽文件到这里或点击上传</p>
                                    <p class="upload-hint">文件将共享给房间内的所有成员</p>
                                    <input type="file" id="fileInput" multiple hidden>
                                    <button id="selectFilesBtn" class="select-files-btn">选择文件上传</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 房间共享文件列表 -->
                        <div class="shared-files-section">
                            <div class="shared-files-header">
                                <h3>📁 房间共享文件</h3>
                                <span class="file-count" id="fileCount">0 个文件</span>
                            </div>
                            <div id="sharedFilesList" class="shared-files-list">
                                <div class="no-shared-files">
                                    <p>房间内暂无共享文件</p>
                                    <p class="hint">上传文件后，房间内所有成员都可以下载</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 原有的设备发现界面 -->
            <div id="peerContainer" style="display: block;">
                <x-peers class="center"></x-peers>
                <x-no-peers>
                    <h2 data-i18n="open_snapdrop">在其他设备上打开DropShare以发送文件</h2>
                </x-no-peers>
            </div>
        </div>
        
        <!-- User info at bottom -->
        <div class="user-info-bottom">
            <footer>
                <div class="logo-container">
                    <svg class="icon logo">
                        <use xlink:href="#wifi-tethering" />
                    </svg>
                </div>
                <div class="text-container">
                    <div id="displayName" class="text-line"></div>
                    <div class="font-body2 text-line" data-i18n="you_discovered">您可被此网络上的所有人发现</div>
                </div>
            </footer>
        </div>
    </div>
    <!-- Receive Dialog -->
    <x-dialog id="receiveDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="file_received">File Received</h3>
                <div class="font-subheading" id="fileName" data-i18n=""></div>
                <div class="font-body2" id="fileSize"></div>
                <div class='preview' style="visibility: hidden;">
                    <img id='img-preview' src="">
                </div>
                <div class="row">
                    <label for="autoDownload" class="grow" data-i18n="ask_save_files">Ask to save each file before downloading</label>
                    <input type="checkbox" id="autoDownload" checked="">
                </div>
                <div class="row-reverse">
                    <a class="button" close id="download" title="Download File" autofocus data-i18n="save">Save</a>
                    <button class="button" close data-i18n="ignore">Ignore</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Send Text Dialog -->
    <x-dialog id="sendTextDialog">
        <form action="#">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="send_message">Send a Message</h3>
                    <div id="textInput" class="textarea" role="textbox" data-placeholder="Send a message" autocomplete="off" autofocus contenteditable></div>
                    <div class="row-reverse">
                        <button class="button" type="submit" close data-i18n="send">Send</button>
                        <a class="button" close data-i18n="cancel">Cancel</a>
                    </div>
                </x-paper>
            </x-background>
        </form>
    </x-dialog>
    <!-- Receive Text Dialog -->
    <x-dialog id="receiveTextDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="message_received">Message Received</h3>
                <div class="font-subheading" id="text"></div>
                <div class="row-reverse">
                    <button class="button" id="copy" close autofocus data-i18n="copy">Copy</button>
                    <button class="button" close data-i18n="close">Close</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Toast -->
    <div class="toast-container full center">
        <x-toast class="row" shadow="1" id="toast">
            <span id="toast-text" data-i18n="file_transfer_completed">File Transfer Completed</span>
        </x-toast>
    </div>
    <!-- About Page -->
    <x-about id="about" class="full center column" style="display: none;">
        <section class="center column fade-in">
            <header class="row-reverse">
                <a href="#" class="close icon-button">
                    <svg class="icon">
                        <use xlink:href="#close" />
                    </svg>
                </a>
            </header>
            <svg class="icon logo">
                <use xlink:href="#wifi-tethering" />
            </svg>
            <h1>DropShare</h1>
            <div class="font-subheading"><span data-i18n="easiest_way">The easiest way to transfer files across devices</span><div style="font-size:10px;"><span data-i18n="modified_by">Modified version by</span> <a href="#" target="_blank">YourNameHere</a></div></div>
            <div class="row">
                <a class="icon-button" target="_blank" href="#" title="DropShare on Github" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#github" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Help cover the server costs!" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#monetarization" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Tweet about DropShare" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#twitter" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Frequently asked questions" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#help-outline" />
                    </svg>
                </a>
            </div>
        </section>
        <x-background></x-background>
    </x-about>
    <!-- SVG Icon Library -->
    <svg style="display: none;">
        <symbol id="wifi-tethering" viewBox="0 0 24 24">
            <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"></path>
        </symbol>
        <symbol id="desktop-mac" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="windows-desktop" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z M4 7h4v4H4z M10 7h4v4h-4z M4 13h4v2H4z M10 13h4v2h-4z M16 7h4v4h-4z M16 13h4v2h-4z"></path>
        </symbol>
        <symbol id="desktop-linux" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="phone-iphone" viewBox="0 0 24 24">
            <path d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"></path>
        </symbol>
        <symbol id="phone-android" viewBox="0 0 24 24">
            <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3.25-3H6.75V4h10.5v14z"></path>
        </symbol>
        <symbol id="tablet-mac" viewBox="0 0 24 24">
            <path d="M18.5 0h-14C3.12 0 2 1.12 2 2.5v19C2 22.88 3.12 24 4.5 24h14c1.38 0 2.5-1.12 2.5-2.5v-19C21 1.12 19.88 0 18.5 0zm-7 23c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm7.5-4H4V3h15v16z"></path>
        </symbol>
        <symbol id="tablet-android" viewBox="0 0 24 24">
            <path d="M18 0H6C4.34 0 3 1.34 3 3v18c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V3c0-1.66-1.34-3-3-3zm-4 22h-4v-1h4v1zm5.25-3H4.75V3h14.5v16z"></path>
        </symbol>
        <symbol id="info-outline" viewBox="0 0 24 24">
            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="close" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </symbol>
        <symbol id="help-outline" viewBox="0 0 24 24">
            <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="twitter">
            <path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z" />
        </symbol>
        <symbol id="github">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
        </symbol>
        <g id="notifications">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
        </g>
        <symbol id="homescreen" viewBox="0 0 24 24">
            <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41z" />
            <path d="M0 0h24v24H0V0z" fill="none" />
        </symbol>
        <symbol id="icon-theme" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26 c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></symbol>
        
        <!-- Add the sun icon for light mode -->
        <symbol id="icon-sun" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z" /></symbol>
    </svg>
    <!-- Scripts -->
    <!-- Load the language loader first -->
    <script src="scripts/i18n/languages.js"></script>
    <!-- Load other scripts -->
    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/theme.js" async></script>
    <script src="scripts/clipboard.js" async></script>

    <!-- 房间功能JavaScript -->
    <script>
        // 房间功能管理
        class RoomManager {
            constructor() {
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members = new Map();
                this.ws = null;
                this.fileStorage = null;
                
                console.log('RoomManager构造函数开始');
                
                // 初始化文件存储
                this.initFileStorage();
                
                // 立即初始化UI
                this.initializeRoomUI();
                
                // 立即检查房间模式
                this.checkForRoomsMode();
                
                // 设置文件事件
                this.setupFileEvents();
                
                console.log('RoomManager构造函数完成');
            }
            
            // 检查是否是房间模式
            checkForRoomsMode() {
                console.log('checkForRoomsMode - 当前URL hash:', window.location.hash);
                
                // 立即检查并显示
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOM元素未找到，稍后重试');
                    setTimeout(() => this.checkForRoomsMode(), 100);
                    return;
                }
                
                if (window.location.hash === '#rooms') {
                    console.log('房间模式 - 立即显示房间容器');
                    this.showRoomContainer();
                } else {
                    console.log('普通模式 - 显示设备发现容器');
                    this.showPeerContainer();
                }
                
                // 只添加一次事件监听器
                if (!this.hashChangeListenerAdded) {
                    window.addEventListener('hashchange', () => {
                        console.log('URL hash改变:', window.location.hash);
                        if (window.location.hash === '#rooms') {
                            this.showRoomContainer();
                        } else {
                            this.showPeerContainer();
                        }
                    });
                    this.hashChangeListenerAdded = true;
                }
            }
            
            // 显示房间容器
            showRoomContainer() {
                console.log('showRoomContainer 开始执行');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.error('找不到容器元素');
                    return;
                }
                
                // 立即显示房间容器
                roomContainer.classList.add('active');
                roomContainer.style.display = 'flex';
                roomContainer.style.visibility = 'visible';
                roomContainer.style.opacity = '1';
                
                // 隐藏设备容器
                peerContainer.style.display = 'none';
                
                // 隐藏底部用户信息区域（设备发现信息）
                this.hideBottomUserInfo();
                
                console.log('房间容器已设置为显示');
                
                // 根据房间状态决定显示什么
                setTimeout(() => {
                    if (!this.isInRoom) {
                        this.ensureRoomOptionsVisible();
                    }
                }, 10);
                
                // 延迟检查重连
                setTimeout(() => {
                    this.checkAndReconnectRoom();
                }, 2000);
            }
            
            // 显示设备发现容器
            showPeerContainer() {
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer && peerContainer) {
                    roomContainer.classList.remove('active');
                    roomContainer.style.display = 'none';
                    roomContainer.style.visibility = 'hidden';
                    roomContainer.style.opacity = '0';
                    peerContainer.style.display = 'block';
                    
                    // 显示底部用户信息区域
                    this.showBottomUserInfo();
                    
                    console.log('切换到设备发现模式 - 设备容器显示');
                } else {
                    console.error('找不到房间容器或设备容器');
                }
            }
            
            // 初始化房间UI事件
            initializeRoomUI() {
                // 等待DOM完全加载后再绑定事件
                const bindEvents = () => {
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    
                    if (!createBtn || !joinBtn) {
                        console.log('房间按钮未找到，等待DOM加载...');
                        setTimeout(bindEvents, 100);
                        return;
                    }
                    
                    // 创建房间按钮
                    createBtn.addEventListener('click', () => {
                        this.showCreateRoomForm();
                    });
                
                    // 加入房间按钮
                    joinBtn.addEventListener('click', () => {
                        this.showJoinRoomForm();
                    });
                    
                    // 确认创建房间
                    document.getElementById('confirmCreateRoom').addEventListener('click', () => {
                        this.createRoom();
                    });
                    
                    // 取消创建房间
                    document.getElementById('cancelCreateRoom').addEventListener('click', () => {
                        this.hideAllForms();
                    });
                    
                    // 确认加入房间
                    document.getElementById('confirmJoinRoom').addEventListener('click', () => {
                        this.joinRoom();
                    });
                    
                    // 取消加入房间
                    document.getElementById('cancelJoinRoom').addEventListener('click', () => {
                        this.hideAllForms();
                    });
                    
                    // 退出房间
                    document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                        this.leaveRoom();
                    });
                    
                    // 房间码输入自动转大写
                    document.getElementById('roomCode').addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                    });
                    
                    // 房间信息展开/收起
                    document.getElementById('toggleDetailsBtn').addEventListener('click', () => {
                        this.toggleRoomDetails();
                    });
                    
                    // 复制房间码
                    document.getElementById('copyRoomCode').addEventListener('click', () => {
                        this.copyRoomCode();
                    });
                    
                    // 文件选择和拖拽
                    this.initializeFileTransfer();
                    
                    console.log('房间UI事件绑定完成');
                };
                
                bindEvents();
            }
            
            // 初始化文件传输功能
            initializeFileTransfer() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const selectFilesBtn = document.getElementById('selectFilesBtn');
                
                if (!dropZone || !fileInput || !selectFilesBtn) {
                    console.log('文件传输元素未找到，延迟初始化...');
                    setTimeout(() => this.initializeFileTransfer(), 100);
                    return;
                }
                
                // 点击选择文件
                selectFilesBtn.addEventListener('click', () => {
                    fileInput.click();
                });
                
                dropZone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // 文件选择
                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                    // 清空文件输入，允许重复上传同一文件
                    e.target.value = '';
                });
                
                // 拖拽功能
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    this.handleFileSelection(e.dataTransfer.files);
                });
            }
            
            // 处理文件选择
            handleFileSelection(files) {
                if (!this.isInRoom) {
                    alert('请先加入房间才能上传文件');
                    return;
                }
                
                if (files.length === 0) return;
                
                // 直接上传文件到房间
                this.uploadFilesToRoom(files);
            }
            
            // 上传文件到房间
            async uploadFilesToRoom(files) {
                console.log('上传文件到房间:', files);
                
                for (const file of files) {
                    // 创建文件信息
                    const fileInfo = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploader: this.getCurrentUserDisplayName(),
                        uploaderId: this.getCurrentUserId(),
                        uploadTime: Date.now(),
                        file: file, // 保存文件对象用于下载
                        isAvailable: true // 文件可用状态
                    };
                    
                    // 存储到 IndexedDB
                    await this.storeFileToIndexedDB(fileInfo);
                    
                    // 添加到本地共享列表
                    this.addFileToSharedList(fileInfo);
                    
                    // 广播给房间内其他成员
                    this.broadcastFileToRoom(fileInfo);
                    
                    this.showToast(`文件 "${file.name}" 已上传到房间`);
                }
            }
            
            // 获取当前用户显示名称
            getCurrentUserDisplayName() {
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.textContent) {
                    // 提取显示名称（移除"您被称为"等前缀）
                    const text = displayNameEl.textContent;
                    const match = text.match(/\s(.+)$/);
                    return match ? match[1] : '匠名用户';
                }
                return '匠名用户';
            }
            
            // 添加文件到共享列表
            addFileToSharedList(fileInfo) {
                const sharedFilesList = document.getElementById('sharedFilesList');
                const noFiles = sharedFilesList.querySelector('.no-shared-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.dataset.fileId = fileInfo.id;
                
                // 使用统一的显示方法
                this.updateFileItemDisplay(fileItem, fileInfo);
                
                sharedFilesList.appendChild(fileItem);
                this.updateFileCount();
            }
            
            // 获取文件图标
            getFileIcon(fileType) {
                if (!fileType) return '📄';
                
                if (fileType.startsWith('image/')) return '🖼️';
                if (fileType.startsWith('video/')) return '🎥';
                if (fileType.startsWith('audio/')) return '🎧';
                if (fileType.includes('pdf')) return '📄';
                if (fileType.includes('word')) return '📄';
                if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '📈';
                if (fileType.includes('powerpoint') || fileType.includes('presentation')) return '📊';
                if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('archive')) return '🗄️';
                return '📁';
            }
            
            // 更新文件计数
            updateFileCount() {
                const fileCount = document.getElementById('fileCount');
                const fileItems = document.querySelectorAll('.shared-file-item');
                const count = fileItems.length;
                
                if (fileCount) {
                    fileCount.textContent = `${count} 个文件`;
                }
            }
            
            // 下载共享文件
            downloadSharedFile(fileId) {
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (!fileItem || !fileItem._fileData) {
                    this.showToast('文件不存在');
                    return;
                }
                
                const fileData = fileItem._fileData;
                
                // 检查文件是否可用
                if (!fileData.file) {
                    if (fileData.isRemote) {
                        this.showToast('无法下载：需要上传者在线');
                    } else {
                        this.showToast('文件不可用，上传者可能已离线');
                    }
                    return;
                }
                
                if (fileData.isAvailable === false) {
                    this.showToast('文件暂时不可用');
                    return;
                }
                
                try {
                    const url = URL.createObjectURL(fileData.file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast(`正在下载: ${fileData.name}`);
                } catch (error) {
                    console.error('下载文件失败:', error);
                    this.showToast('下载失败，请重试');
                }
            }
            
            // 移除共享文件
            async removeSharedFile(fileId) {
                if (!confirm('确认要删除这个文件吗？')) {
                    return;
                }
                
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // 从 IndexedDB 删除
                    await this.deleteFileFromIndexedDB(fileId);
                    
                    // 广播删除消息给房间内其他成员
                    this.broadcastFileRemoval(fileId);
                    
                    this.showToast('文件已删除');
                }
                
                // 检查是否需要显示空状态
                const sharedFilesList = document.getElementById('sharedFilesList');
                const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                if (remainingFiles.length === 0) {
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                }
            }
            
            // 广播文件到房间内其他成员
            async broadcastFileToRoom(fileInfo) {
                console.log('广播文件到房间:', fileInfo.name);
                
                try {
                    // 将文件转换为可传输的格式
                    const fileData = await this.fileToBase64(fileInfo.file);
                    
                    // 广播文件信息和数据给房间内其他成员
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        },
                        fileData: fileData // 包含实际文件数据
                    });
                } catch (error) {
                    console.error('文件广播失败:', error);
                    // 如果文件太大，只发送元信息
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        }
                    });
                }
            }
            
            // 将文件转换为Base64格式用于传输
            async fileToBase64(file) {
                // 限制文件大小，避免传输过大的文件
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    throw new Error('文件太大，无法分发');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // 从Base64恢复文件
            base64ToFile(dataUrl, fileName, fileType) {
                const arr = dataUrl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], fileName, { type: fileType });
            }
            
            // 广播文件删除
            broadcastFileRemoval(fileId) {
                this.sendMessage({
                    type: 'room-file-removed',
                    roomCode: this.currentRoom,
                    fileId: fileId
                });
            }
            
            // 初始化文件存储（IndexedDB）
            async initFileStorage() {
                try {
                    this.fileStorage = await this.openIndexedDB();
                    console.log('IndexedDB 初始化成功');
                } catch (error) {
                    console.warn('IndexedDB 初始化失败，使用内存存储:', error);
                    this.fileStorage = null;
                }
            }
            
            // 打开IndexedDB
            openIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('DropShareRoomFiles', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('roomCode', 'roomCode', { unique: false });
                        }
                    };
                });
            }
            
            // 存储文件到IndexedDB
            async storeFileToIndexedDB(fileInfo) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    
                    const fileData = {
                        id: fileInfo.id,
                        roomCode: this.currentRoom,
                        name: fileInfo.name,
                        size: fileInfo.size,
                        type: fileInfo.type,
                        uploader: fileInfo.uploader,
                        uploaderId: fileInfo.uploaderId,
                        uploadTime: fileInfo.uploadTime,
                        file: fileInfo.file // 存储实际文件
                    };
                    
                    await store.put(fileData);
                    console.log('文件已存储到IndexedDB:', fileInfo.name);
                } catch (error) {
                    console.error('存储文件失败:', error);
                }
            }
            
            // 从 IndexedDB 加载房间文件
            async loadRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return [];
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAll(roomCode);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('加载房间文件失败:', error);
                    return [];
                }
            }
            
            // 从 IndexedDB 删除文件
            async deleteFileFromIndexedDB(fileId) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    await store.delete(fileId);
                    console.log('文件已从 IndexedDB 删除:', fileId);
                } catch (error) {
                    console.error('删除文件失败:', error);
                }
            }
            
            // 清空房间文件（离开房间时）
            async clearRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAllKeys(roomCode);
                    
                    request.onsuccess = () => {
                        const keys = request.result;
                        keys.forEach(key => store.delete(key));
                        console.log(`已清空房间 ${roomCode} 的所有文件`);
                    };
                } catch (error) {
                    console.error('清空房间文件失败:', error);
                }
            }
            
            // 格式化文件大小
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // 获取当前用户ID
            getCurrentUserId() {
                // 从显示名称元素获取当前用户ID，这个ID是在网络连接时设置的
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.dataset.peerId) {
                    return displayNameEl.dataset.peerId;
                }
                // 备用方法：从网络连接获取
                if (window.currentPeerId) {
                    return window.currentPeerId;
                }
                return null;
            }
            
            // 切换房间详情显示
            toggleRoomDetails() {
                const roomDetails = document.getElementById('roomDetails');
                const toggleIcon = document.querySelector('.toggle-icon');
                
                if (roomDetails.classList.contains('expanded')) {
                    roomDetails.classList.remove('expanded');
                    toggleIcon.classList.remove('rotated');
                } else {
                    roomDetails.classList.add('expanded');
                    toggleIcon.classList.add('rotated');
                }
            }
            
            // 复制房间码
            copyRoomCode() {
                const roomCodeText = document.getElementById('roomCodeDisplay').textContent;
                // 提取房间码部分（去掉"房间码: "前缀）
                const roomCode = roomCodeText.replace('房间码: ', '');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(roomCode).then(() => {
                        this.showToast('房间码已复制到剪贴板');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        this.fallbackCopyRoomCode(roomCode);
                    });
                } else {
                    this.fallbackCopyRoomCode(roomCode);
                }
            }
            
            // 备用复制方法
            fallbackCopyRoomCode(roomCode) {
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('房间码已复制到剪贴板');
                } catch (err) {
                    console.error('复制失败:', err);
                    alert('复制失败，房间码：' + roomCode);
                }
                document.body.removeChild(textArea);
            }
            
            // 显示提示信息
            showToast(message) {
                // 创建临时提示元素
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #374151;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 2000);
            }
            
            // 显示创建房间表单
            showCreateRoomForm() {
                this.hideAllForms();
                document.getElementById('createRoomForm').classList.add('active');
            }
            
            // 显示加入房间表单
            showJoinRoomForm() {
                this.hideAllForms();
                document.getElementById('joinRoomForm').classList.add('active');
            }
            
            // 隐藏所有表单
            hideAllForms() {
                document.getElementById('createRoomForm').classList.remove('active');
                document.getElementById('joinRoomForm').classList.remove('active');
                document.getElementById('createRoomError').style.display = 'none';
                document.getElementById('joinRoomError').style.display = 'none';
                
                // 清空表单内容，防止浏览器自动填充
                this.clearFormFields();
            }
            
            // 清空表单字段
            clearFormFields() {
                document.getElementById('roomName').value = '';
                document.getElementById('roomPassword').value = '';
                document.getElementById('maxMembers').value = '10';
                document.getElementById('roomCode').value = '';
                document.getElementById('joinRoomPassword').value = '';
            }
            
            // 生成房间码
            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            // 创建房间
            createRoom() {
                const roomName = document.getElementById('roomName').value.trim();
                const roomPassword = document.getElementById('roomPassword').value;
                const maxMembers = parseInt(document.getElementById('maxMembers').value);
                
                if (!roomName) {
                    this.showError('createRoomError', '请输入房间名称');
                    return;
                }
                
                const roomCode = this.generateRoomCode();
                const roomSettings = {
                    code: roomCode,
                    name: roomName,
                    password: roomPassword,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                };
                
                // 发送创建房间请求到后端
                this.sendMessage({
                    type: 'create-room',
                    roomSettings: roomSettings
                });
            }
            
            // 加入房间
            joinRoom() {
                const roomCode = document.getElementById('roomCode').value.trim();
                const password = document.getElementById('joinRoomPassword').value;
                
                if (!roomCode) {
                    this.showError('joinRoomError', '请输入房间码');
                    return;
                }
                
                // 发送加入房间请求到后端
                this.sendMessage({
                    type: 'join-room',
                    roomCode: roomCode,
                    password: password
                });
            }
            
            // 退出房间
            leaveRoom() {
                if (this.currentRoom) {
                    this.sendMessage({
                        type: 'leave-room',
                        roomCode: this.currentRoom
                    });
                }
            }
            
            // 显示错误信息
            showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            // 发送消息到WebSocket
            sendMessage(message) {
                // 检查网络连接是否可用
                if (window.network && window.network.send && window.network.isConnected()) {
                    window.network.send(message);
                } else {
                    console.warn('网络连接不可用，消息发送失败:', message);
                    // 可以在这里添加重试逻辑或者错误提示
                    this.showError('createRoomError', '网络连接不可用，请稍后重试');
                }
            }
            
            // 处理房间相关的WebSocket消息
            handleRoomMessage(message) {
                switch (message.type) {
                    case 'room-created':
                        this.onRoomCreated(message);
                        break;
                    case 'room-joined':
                        this.onRoomJoined(message);
                        break;
                    case 'room-left':
                        this.onRoomLeft(message);
                        break;
                    case 'room-error':
                        this.onRoomError(message);
                        break;
                    case 'room-member-joined':
                        this.onMemberJoined(message);
                        break;
                    case 'room-member-left':
                        this.onMemberLeft(message);
                        break;
                    case 'room-disbanded':
                        this.onRoomDisbanded(message);
                        break;
                    case 'room-file-shared':
                        this.onFileSharedToRoom(message);
                        break;
                    case 'room-file-removed':
                        this.onFileRemovedFromRoom(message);
                        break;
                }
            }
            
            // 房间创建成功
            async onRoomCreated(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = true;
                
                // 保存房间状态到本地存储
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: true,
                    password: message.room.password || ''
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // 初始化成员列表
                this.members.clear();
                this.members.set(message.hostInfo.id, message.hostInfo);
                this.updateMemberList([message.hostInfo]);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // 加载之前的文件（如果有）
                await this.loadPreviousRoomFiles();
                
                // 重新分发我的文件给其他成员（创建房间后稍等一下）
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // 加入房间成功
            async onRoomJoined(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = false;
                
                // 保存房间状态到本地存储
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: false,
                    password: '' // 加入时不保存密码
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // 初始化成员列表
                this.members.clear();
                message.members.forEach(member => {
                    this.members.set(member.id, member);
                });
                this.updateMemberList(message.members);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // 加载之前的文件（如果有）
                await this.loadPreviousRoomFiles();
                
                // 重新分发我的文件给其他成员（加入房间后稍等一下）
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // 离开房间
            async onRoomLeft(message) {
                const roomCode = this.currentRoom;
                
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members.clear();
                
                // 清除本地存储的房间状态
                this.clearRoomState();
                
                // 清空共享文件列表
                this.clearSharedFilesList();
                
                // 清空 IndexedDB 中的房间文件
                if (roomCode) {
                    await this.clearRoomFilesFromIndexedDB(roomCode);
                }
                
                document.getElementById('roomInfo').classList.remove('active');
                this.hideAllForms();
                this.showRoomOptions();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                this.showBottomUserInfo();
                this.removeBeforeUnloadHandler();
            }
            
            // 隐藏底部用户信息区域
            hideBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'none';
                }
            }
            
            // 显示底部用户信息区域
            showBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'block';
                }
            }
            
            // 房间错误
            onRoomError(message) {
                const activeForm = document.querySelector('.room-form.active');
                if (activeForm) {
                    const errorId = activeForm.id === 'createRoomForm' ? 'createRoomError' : 'joinRoomError';
                    this.showError(errorId, message.error);
                } else {
                    // 如果是重连失败，显示房间选项
                    console.log('房间重连失败:', message.error);
                    this.showToast('房间连接失败: ' + message.error);
                    this.showRoomOptions();
                    this.hideRoomInfo();
                    this.hideFileTransferArea();
                    this.hideRoomWarning();
                    this.showBottomUserInfo();
                    // 清除无效的房间状态
                    this.clearRoomState();
                }
            }
            
            // 新成员加入
            async onMemberJoined(message) {
                const memberId = message.member.id;
                const isMyself = memberId === this.getCurrentUserId();
                const isReconnect = message.isReconnect || false;
                
                // 检查是否已经存在，避免重复添加
                const wasAlreadyMember = this.members.has(memberId);
                
                // 如果是重复的成员加入事件且不是重连，直接忽略
                if (wasAlreadyMember && !isReconnect) {
                    console.log(`忽略重复的成员加入事件: ${message.member.displayName} (${memberId})`);
                    return;
                }
                
                if (isReconnect) {
                    console.log(`成员重连: ${message.member.displayName} (${memberId})`);
                } else {
                    console.log(`新成员加入: ${message.member.displayName} (${memberId})`);
                }
                
                this.members.set(memberId, message.member);
                this.updateMemberList(Array.from(this.members.values()));
                
                // 更新该成员上传的文件状态为在线可用
                this.updateUploaderStatus(memberId, true);
                
                // 如果是我自己重新加入或重连，重新分发文件
                if (isMyself) {
                    console.log('检测到自己重新加入/重连房间，重新分发文件');
                    await this.redistributeMyFiles();
                }
            }
            
            // 重新分发我的文件给房间内其他成员
            async redistributeMyFiles() {
                try {
                    const myFiles = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    const myUploads = myFiles.filter(file => file.uploaderId === this.getCurrentUserId());
                    
                    for (const fileData of myUploads) {
                        if (fileData.file) {
                            console.log('重新分发文件:', fileData.name);
                            
                            // 重新广播文件
                            const fileInfo = {
                                id: fileData.id,
                                name: fileData.name,
                                size: fileData.size,
                                type: fileData.type,
                                uploader: fileData.uploader,
                                uploaderId: fileData.uploaderId,
                                uploadTime: fileData.uploadTime,
                                file: fileData.file
                            };
                            
                            await this.broadcastFileToRoom(fileInfo);
                        }
                    }
                    
                    if (myUploads.length > 0) {
                        this.showToast(`已重新分发 ${myUploads.length} 个文件给房间成员`);
                    }
                } catch (error) {
                    console.error('重新分发文件失败:', error);
                }
            }
            
            // 成员离开
            onMemberLeft(message) {
                console.log(`成员离开: ${message.memberId}, 原因: ${message.reason || 'unknown'}`);
                
                this.members.delete(message.memberId);
                this.updateMemberList(Array.from(this.members.values()));
                
                // 如果是因为连接断开，我们设置文件为离线状态但保持其可恢复性
                // 如果是明确退出，则设置为不可用
                const isDisconnected = message.reason === 'disconnected';
                this.updateUploaderStatus(message.memberId, false, isDisconnected);
            }
            
            // 更新上传者状态
            updateUploaderStatus(uploaderId, isOnline, isDisconnected = false) {
                const fileItems = document.querySelectorAll('.shared-file-item');
                fileItems.forEach(item => {
                    const fileData = item._fileData;
                    if (fileData && fileData.uploaderId === uploaderId) {
                        // 更新文件数据
                        fileData.uploaderOnline = isOnline;
                        
                        if (!isOnline) {
                            if (fileData.isRemote) {
                                fileData.isAvailable = false;
                                // 如果是断开连接（而不是明确退出），保持reconnectable状态
                                fileData.canReconnect = isDisconnected;
                            }
                        } else if (isOnline && fileData.isRemote && fileData.file) {
                            fileData.isAvailable = true;
                            fileData.canReconnect = false;
                        }
                        
                        // 重新渲染这个文件项
                        this.updateFileItemDisplay(item, fileData);
                    }
                });
            }
            
            // 更新单个文件项的显示
            updateFileItemDisplay(fileItem, fileData) {
                const fileIcon = this.getFileIcon(fileData.type);
                const uploadTime = new Date(fileData.uploadTime).toLocaleString();
                const isRestored = fileData.isRestored ? ' <span class="restored-tag">(恢复)</span>' : '';
                const canDownload = fileData.file && fileData.isAvailable !== false;
                const isOwner = fileData.uploaderId === this.getCurrentUserId();
                
                // 确定文件状态显示
                let statusHint = '';
                let itemClass = 'shared-file-item';
                
                if (!canDownload && !isOwner) {
                    if (fileData.isRemote) {
                        if (fileData.uploaderOnline === false) {
                            statusHint = '<span class="unavailable-hint">上传者离线，无法下载</span>';
                            itemClass += ' file-offline';
                        } else if (!fileData.file) {
                            statusHint = '<span class="unavailable-hint">文件太大，无法下载</span>';
                            itemClass += ' file-unavailable';
                        }
                    } else {
                        statusHint = '<span class="unavailable-hint">文件不可用</span>';
                        itemClass += ' file-unavailable';
                    }
                }
                
                fileItem.className = itemClass;
                fileItem.innerHTML = `
                    <div class="shared-file-info">
                        <div class="shared-file-name">
                            <span class="file-icon">${fileIcon}</span>
                            ${fileData.name}${isRestored}
                        </div>
                        <div class="shared-file-details">
                            <span>${this.formatFileSize(fileData.size)}</span>
                            <span>上传者: <span class="shared-file-uploader">${fileData.uploader}</span></span>
                            <span>${uploadTime}</span>
                            ${statusHint}
                        </div>
                    </div>
                    <div class="shared-file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadSharedFile('${fileData.id}')" ${!canDownload ? 'disabled' : ''}>下载</button>
                        ${isOwner ? `<button class="action-btn btn-cancel" onclick="roomManager.removeSharedFile('${fileData.id}')">删除</button>` : ''}
                    </div>
                `;
                
                // 更新文件数据引用
                fileItem._fileData = fileData;
            }
            
            // 房间解散
            onRoomDisbanded(message) {
                // 清除本地存储的房间状态
                this.clearRoomState();
                // 清空共享文件列表
                this.clearSharedFilesList();
                alert('房间已解散: ' + message.reason);
                this.onRoomLeft();
            }
            
            // 显示房间信息
            showRoomInfo(room) {
                // 更新房间信息头部
                document.getElementById('roomNameDisplay').textContent = room.name;
                document.getElementById('roomCodeDisplay').textContent = `房间码: ${room.code}`;
                
                // 更新当前用户名称
                const currentUserName = this.getCurrentUserDisplayName();
                const currentUserNameEl = document.getElementById('currentUserName');
                if (currentUserNameEl) {
                    currentUserNameEl.textContent = currentUserName;
                }
                
                document.getElementById('roomInfo').classList.add('active');
            }
            
            // 更新成员列表
            updateMemberList(members) {
                const memberList = document.getElementById('memberList');
                const memberCount = document.getElementById('memberCount');
                
                memberList.innerHTML = '';
                
                members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.innerHTML = `
                        <span class="member-name">${member.displayName}</span>
                        <span class="member-role">${member.isHost ? '房主' : '成员'}</span>
                    `;
                    memberList.appendChild(memberItem);
                    this.members.set(member.id, member);
                });
                
                // 更新成员计数
                memberCount.textContent = `${members.length}人在线`;
            }
            
            // 隐藏房间选项按钮
            hideRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.display = 'none';
                }
            }
            
            // 隐藏房间信息
            hideRoomInfo() {
                const roomInfo = document.getElementById('roomInfo');
                if (roomInfo) {
                    roomInfo.classList.remove('active');
                }
            }
            
            // 显示房间选项按钮
            showRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.display = 'flex';
                }
            }
            
            // 确保房间选项可见（仅在不在房间时）
            ensureRoomOptionsVisible() {
                console.log('=== 确保房间选项可见 ===');
                
                // 如果已经在房间中，不应该显示创建/加入按钮
                if (this.isInRoom) {
                    console.log('已在房间中，不显示创建/加入按钮');
                    return;
                }
                
                // 隐藏所有表单
                this.hideAllForms();
                
                // 隐藏房间信息和传输区域
                this.hideRoomInfo();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                
                // 清空共享文件列表
                this.clearSharedFilesList();
                
                // 显示创建/加入按钮
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    console.log('房间选项按钮已显示');
                    
                    // 检查按钮是否存在
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    console.log('创建按钮存在:', !!createBtn, '加入按钮存在:', !!joinBtn);
                } else {
                    console.error('找不到.room-options元素');
                }
                
                // 显示底部用户信息区域
                this.showBottomUserInfo();
            }
            
            // 显示文件传输区域
            showFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.add('active');
                }
            }
            
            // 隐藏文件传输区域
            hideFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.remove('active');
                }
            }
            
            // 处理房间文件共享消息
            async onFileSharedToRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileInfo = message.fileInfo;
                // 只添加不是自己上传的文件
                if (fileInfo.uploaderId !== this.getCurrentUserId()) {
                    try {
                        // 如果有文件数据，恢复文件
                        if (message.fileData) {
                            fileInfo.file = this.base64ToFile(message.fileData, fileInfo.name, fileInfo.type);
                            fileInfo.isAvailable = true;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true;
                            
                            // 将接收到的文件也存储到IndexedDB
                            await this.storeFileToIndexedDB(fileInfo);
                            
                            this.showToast(`${fileInfo.uploader} 分享了文件: ${fileInfo.name}`);
                        } else {
                            // 没有文件数据，可能文件太大或上传者离线
                            fileInfo.file = null;
                            fileInfo.isAvailable = false;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true; // 假设在线，但文件不可用
                            
                            this.showToast(`${fileInfo.uploader} 分享了文件: ${fileInfo.name} (文件太大或暂不可下载)`);
                        }
                        
                        this.addFileToSharedList(fileInfo);
                    } catch (error) {
                        console.error('处理接收文件失败:', error);
                        // 如果处理失败，至少显示文件信息
                        fileInfo.file = null;
                        fileInfo.isAvailable = false;
                        fileInfo.isRemote = true;
                        fileInfo.uploaderOnline = true;
                        
                        this.addFileToSharedList(fileInfo);
                        this.showToast(`接收 ${fileInfo.uploader} 的文件时出错`);
                    }
                }
            }
            
            // 处理房间文件删除消息
            onFileRemovedFromRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileItem = document.querySelector(`[data-file-id="${message.fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // 检查是否需要显示空状态
                    const sharedFilesList = document.getElementById('sharedFilesList');
                    const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                    if (remainingFiles.length === 0) {
                        const noFiles = sharedFilesList.querySelector('.no-shared-files');
                        if (noFiles) {
                            noFiles.style.display = 'block';
                        }
                    }
                }
            }
            
            // 清空共享文件列表
            clearSharedFilesList() {
                const sharedFilesList = document.getElementById('sharedFilesList');
                if (sharedFilesList) {
                    // 移除所有文件项
                    const fileItems = sharedFilesList.querySelectorAll('.shared-file-item');
                    fileItems.forEach(item => item.remove());
                    
                    // 显示空状态
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                    
                    this.updateFileCount();
                }
            }
            
            // 加载之前的房间文件
            async loadPreviousRoomFiles() {
                if (!this.currentRoom) return;
                
                try {
                    const files = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    console.log(`从 IndexedDB 加载到 ${files.length} 个文件`);
                    
                    files.forEach(fileData => {
                        const fileInfo = {
                            id: fileData.id,
                            name: fileData.name,
                            size: fileData.size,
                            type: fileData.type,
                            uploader: fileData.uploader,
                            uploaderId: fileData.uploaderId,
                            uploadTime: fileData.uploadTime,
                            file: fileData.file,
                            isRestored: true, // 标记为恢复的文件
                            isAvailable: fileData.file ? true : false // 根据文件是否存在设置可用性
                        };
                        
                        this.addFileToSharedList(fileInfo);
                    });
                    
                    if (files.length > 0) {
                        this.showToast(`已恢复 ${files.length} 个之前的文件`);
                    }
                } catch (error) {
                    console.error('加载之前的文件失败:', error);
                }
            }
            
            // 显示房间警告提示
            showRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                const warningTitle = document.getElementById('warningTitle');
                const warningMessage = document.getElementById('warningMessage');
                
                if (!roomWarning || !warningTitle || !warningMessage) return;
                
                if (this.isHost) {
                    warningTitle.textContent = '房主提醒';
                    warningMessage.textContent = '您是房主，刷新页面会自动重新连接房间。只有点击"退出房间"或关闭浏览器标签页才会解散房间。';
                } else {
                    warningTitle.textContent = '成员提醒';
                    warningMessage.textContent = '刷新页面会自动重新连接房间。只有点击"退出房间"或关闭浏览器标签页才会退出房间。';
                }
                
                roomWarning.classList.add('active');
            }
            
            // 隐藏房间警告提示
            hideRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                if (roomWarning) {
                    roomWarning.classList.remove('active');
                }
            }
            
            // 设置页面刷新前确认
            setupBeforeUnloadHandler() {
                this.beforeUnloadHandler = (e) => {
                    if (this.isInRoom) {
                        // 检查是否是刷新操作（这个检查不是100%准确，但可以尝试）
                        // 如果用户明确要关闭标签页/窗口，还是应该警告
                        const message = this.isHost 
                            ? '关闭标签页将解散房间！确定要离开吗？' 
                            : '关闭标签页将退出房间！确定要离开吗？';
                        
                        e.preventDefault();
                        e.returnValue = message;
                        return message;
                    }
                };
                
                window.addEventListener('beforeunload', this.beforeUnloadHandler);
            }
            
            // 移除页面刷新前确认
            removeBeforeUnloadHandler() {
                if (this.beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', this.beforeUnloadHandler);
                    this.beforeUnloadHandler = null;
                }
            }
            
            // 保存房间状态到本地存储
            saveRoomState(roomData) {
                try {
                    const roomState = {
                        ...roomData,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('dropshare_room_state', JSON.stringify(roomState));
                    console.log('房间状态已保存:', roomState);
                } catch (error) {
                    console.error('保存房间状态失败:', error);
                }
            }
            
            // 加载房间状态
            loadRoomState() {
                try {
                    const saved = localStorage.getItem('dropshare_room_state');
                    if (saved) {
                        const roomState = JSON.parse(saved);
                        // 检查状态是否过期（24小时）
                        const now = Date.now();
                        const maxAge = 24 * 60 * 60 * 1000; // 24小时
                        
                        if (now - roomState.timestamp < maxAge) {
                            console.log('找到保存的房间状态:', roomState);
                            return roomState;
                        } else {
                            console.log('房间状态已过期，清除');
                            this.clearRoomState();
                        }
                    }
                } catch (error) {
                    console.error('加载房间状态失败:', error);
                    this.clearRoomState();
                }
                return null;
            }
            
            // 清除房间状态
            clearRoomState() {
                try {
                    localStorage.removeItem('dropshare_room_state');
                    console.log('房间状态已清除');
                } catch (error) {
                    console.error('清除房间状态失败:', error);
                }
            }
            
            // 设置文件传输事件监听
            setupFileEvents() {
                // 等待Events系统就绪
                const setupEvents = () => {
                    if (!window.Events) {
                        setTimeout(setupEvents, 100);
                        return;
                    }
                    
                    // 监听文件接收事件
                    window.Events.on('file-received', (e) => {
                        this.handleFileReceived(e.detail);
                    });
                    
                    // 监听文件传输进度事件
                    window.Events.on('file-progress', (e) => {
                        this.handleFileProgress(e.detail);
                    });
                    
                    console.log('房间文件传输事件监听器已设置');
                };
                
                setupEvents();
            }
            
            // 处理文件接收
            handleFileReceived(fileData) {
                if (!this.isInRoom) return;
                
                console.log('房间内接收到文件:', fileData);
                
                // 添加到接收文件列表
                this.addToReceivedFilesList(fileData);
                
                // 显示通知
                this.showToast(`接收到文件: ${fileData.name}`);
            }
            
            // 处理文件传输进度
            handleFileProgress(progressData) {
                if (!this.isInRoom) return;
                
                // 更新传输列表中的进度条
                this.updateTransferProgress(progressData.sender, progressData.progress);
            }
            
            // 添加到接收文件列表
            addToReceivedFilesList(fileData) {
                const receivedFilesList = document.getElementById('receivedFilesList');
                const noFiles = receivedFilesList.querySelector('.no-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-details">
                            ${this.formatFileSize(fileData.size)} • ${fileData.mime || 'Unknown type'}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadFile('${fileData.name}', this)">下载</button>
                    </div>
                `;
                
                // 存储文件数据用于下载
                fileItem._fileData = fileData;
                
                receivedFilesList.appendChild(fileItem);
            }
            
            // 下载文件
            downloadFile(fileName, buttonElement) {
                const fileItem = buttonElement.closest('.file-item');
                const fileData = fileItem._fileData;
                
                if (fileData && fileData.blob) {
                    const url = URL.createObjectURL(fileData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('文件下载已开始');
                } else {
                    this.showToast('文件下载失败');
                }
            }
            
            // 更新传输进度
            updateTransferProgress(senderId, progress) {
                const transferItems = document.querySelectorAll('.transfer-item');
                transferItems.forEach(item => {
                    const progressBar = item.querySelector('.progress-fill');
                    if (progressBar) {
                        progressBar.style.width = `${Math.round(progress * 100)}%`;
                    }
                });
            }
            
            // 检查并重新连接房间
            checkAndReconnectRoom() {
                // 只有在房间模式下才尝试重连
                if (window.location.hash !== '#rooms') {
                    return;
                }
                
                const roomState = this.loadRoomState();
                if (!roomState) {
                    console.log('没有保存的房间状态，保持显示房间选项');
                    return; // 不做任何操作，保持当前状态
                }
                
                console.log('找到保存的房间状态，尝试重连:', roomState.roomCode);
                
                // 等待网络连接就绪
                const attemptReconnect = () => {
                    if (!window.network || !window.network.isConnected()) {
                        console.log('等待网络连接...');
                        setTimeout(attemptReconnect, 300);
                        return;
                    }
                    
                    console.log('网络就绪，开始重连房间:', roomState.roomCode);
                    this.showToast('正在重新连接房间...');
                    
                    if (roomState.isHost) {
                        this.sendMessage({
                            type: 'create-room',
                            roomSettings: {
                                code: roomState.roomCode,
                                name: roomState.roomName,
                                password: roomState.password,
                                maxMembers: 50,
                                isPrivate: !!roomState.password
                            }
                        });
                    } else {
                        this.sendMessage({
                            type: 'join-room',
                            roomCode: roomState.roomCode,
                            password: roomState.password
                        });
                    }
                };
                
                setTimeout(attemptReconnect, 500);
            }
        }
        
        // 初始化房间管理器
        let roomManager;
        
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化多语言支持
            if (window.DROPSHARE_I18N) {
                window.DROPSHARE_I18N.init();
            }
            
            // 立即初始化房间管理器，不等待网络
            const initRoomManager = () => {
                console.log('初始化房间管理器...');
                
                // 检查DOM元素是否存在
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOM元素未就绪，等待重试...');
                    setTimeout(initRoomManager, 50);
                    return;
                }
                
                console.log('DOM元素就绪，创建房间管理器');
                roomManager = new RoomManager();
                window.roomManager = roomManager;
                console.log('房间管理器初始化完成');
            };
            
            // 立即初始化
            initRoomManager();
        });
        
        // 页面完全加载后的补充检查
        window.addEventListener('load', function() {
            console.log('页面完全加载，检查房间状态');
            if (window.roomManager && window.location.hash === '#rooms') {
                // 只在不在房间时才显示选项按钮
                setTimeout(() => {
                    if (!window.roomManager.isInRoom) {
                        window.roomManager.ensureRoomOptionsVisible();
                    }
                }, 100);
            }
            
            // 初始化顶部导航栏语言选择器
            initNavbarLanguageSelector();
        });
        
        // 初始化顶部导航栏语言选择器
        function initNavbarLanguageSelector() {
            const navbarLangSelector = document.getElementById('navbar-language-selector');
            const headerLangSelector = document.getElementById('language-selector');
            
            if (navbarLangSelector && headerLangSelector) {
                // 同步两个选择器的值
                const savedLang = localStorage.getItem('preferred_language') || 'en';
                navbarLangSelector.value = savedLang;
                headerLangSelector.value = savedLang;
                
                // 监听顶部导航栏的语言选择变化
                navbarLangSelector.addEventListener('change', function() {
                    const selectedLang = this.value;
                    // 同步到header的语言选择器
                    headerLangSelector.value = selectedLang;
                    
                    // 保存语言偏好
                    localStorage.setItem('preferred_language', selectedLang);
                    
                    // 触发语言切换
                    if (window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.changeLanguage === 'function') {
                        window.DROPSHARE_I18N.changeLanguage(selectedLang);
                        console.log('Language changed to:', selectedLang);
                    }
                });
                
                // 监听header语言选择器的变化，同步到顶部导航栏
                headerLangSelector.addEventListener('change', function() {
                    navbarLangSelector.value = this.value;
                });
            }
            
            // 初始化导航栏功能链接
            initNavbarFunctionLinks();
        }
        
        // 初始化导航栏功能链接
        function initNavbarFunctionLinks() {
            // 多人房间链接
            const roomsLink = document.querySelector('a[href="/share.html#rooms"]');
            if (roomsLink) {
                roomsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '#rooms';
                    console.log('切换到多人房间模式');
                });
            }
            
            // 传送链接（回到主页）
            const transferLink = document.querySelector('a[href="/"]');
            if (transferLink) {
                transferLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    console.log('切换到传送模式');
                });
            }
            
            // 添加文件类型过滤功能入口
            const imageLink = document.querySelector('a[href="#images"]');
            const audioLink = document.querySelector('a[href="#audio"]'); 
            const videoLink = document.querySelector('a[href="#video"]');
            const filesLink = document.querySelector('a[href="#files"]');
            
            [imageLink, audioLink, videoLink, filesLink].forEach(link => {
                if (link) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const type = this.getAttribute('href').substring(1);
                        showFileTypeFilter(type);
                    });
                }
            });
        }
        
        // 显示文件类型过滤（暂时显示提示，以后可以扩展功能）
        function showFileTypeFilter(type) {
            const typeNames = {
                'images': '图片',
                'audio': '音频', 
                'video': '视频',
                'files': '文件'
            };
            
            if (window.roomManager) {
                window.roomManager.showToast(`${typeNames[type]}功能正在开发中`);
            } else {
                alert(`${typeNames[type]}功能正在开发中`);
            }
            
            console.log(`切换到${typeNames[type]}模式`);
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="scripts/firebase-analytics.js"></script>
    
    <!-- Sounds -->
    <audio id="blop" autobuffer="true">
        <source src="/sounds/blop.mp3" type="audio/mpeg">
        <source src="/sounds/blop.ogg" type="audio/ogg">
    </audio>
    <!-- no script -->
    <noscript>
        <x-noscript class="full center column">
            <h1 data-i18n="enable_js">Enable JavaScript</h1>
            <h3 data-i18n="snapdrop_js_only">DropShare works only with JavaScript</h3>
        </x-noscript>
        <style>
        x-noscript {
            background: #599cfc;
            color: white;
            z-index: 2;
        }

        a[href="#info"] {
            color: white;
        }
        </style>
    </noscript>
</body>

</html>