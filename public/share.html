<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        // CRITICAL: Define all room functions immediately to prevent undefined errors
        console.log('=== DEFINING CRITICAL FUNCTIONS IN HEAD ===');
        
        window.handleCreateRoom = function() {
            console.log('üîµ handleCreateRoom called');
            const roomName = document.getElementById('roomName')?.value?.trim();
            const roomPassword = document.getElementById('roomPassword')?.value;
            const maxMembers = parseInt(document.getElementById('maxMembers')?.value) || 10;
            
            if (!roomName) {
                alert('Please enter Room Name');
                return;
            }
            
            const message = {
                type: 'create-room',
                roomSettings: {
                    code: Math.random().toString(36).substr(2, 8).toUpperCase(),
                    name: roomName,
                    password: roomPassword,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                }
            };
            
            console.log('üì§ Sending room creation message:', message);
            
            if (window.network?.send) {
                window.network.send(message);
            } else if (window.serverConnection?.send) {
                window.serverConnection.send(message);
            } else {
                console.error('‚ùå No network connection available');
            }
        };
        
        window.handleCancelRoom = function() {
            console.log('üî¥ handleCancelRoom called');
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            
            if (createForm) createForm.classList.remove('active');
            if (joinForm) joinForm.classList.remove('active');
            
            // Clear form fields
            const roomName = document.getElementById('roomName');
            const roomPassword = document.getElementById('roomPassword');
            const maxMembers = document.getElementById('maxMembers');
            const roomCode = document.getElementById('roomCode');
            const joinPassword = document.getElementById('joinRoomPassword');
            
            if (roomName) roomName.value = '';
            if (roomPassword) roomPassword.value = '';
            if (maxMembers) maxMembers.value = '10';
            if (roomCode) roomCode.value = '';
            if (joinPassword) joinPassword.value = '';
        };
        
        window.showCreateForm = function() {
            console.log('üìù showCreateForm called');
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            
            if (createForm) createForm.classList.add('active');
            if (joinForm) joinForm.classList.remove('active');
        };
        
        window.showJoinForm = function() {
            console.log('üö™ showJoinForm called');
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            
            if (createForm) createForm.classList.remove('active');
            if (joinForm) joinForm.classList.add('active');
        };
        
        // Add room creation success handler
        window.handleRoomCreated = function(roomData) {
            console.log('‚úÖ Room created successfully!', roomData);
            
            // Hide forms
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            if (createForm) createForm.classList.remove('active');
            if (joinForm) joinForm.classList.remove('active');
            
            // Show room info
            const roomInfo = document.getElementById('roomInfo');
            if (roomInfo) {
                roomInfo.style.display = 'block';
                roomInfo.classList.add('active');
                
                // Fill room details
                const roomNameDisplay = document.getElementById('roomNameDisplay');
                const roomCodeDisplay = document.getElementById('roomCodeDisplay');
                if (roomNameDisplay) roomNameDisplay.textContent = roomData.name || 'Untitled Room';
                if (roomCodeDisplay) roomCodeDisplay.textContent = `Room Code: ${roomData.code || 'Unknown'}`;
            }
            
            // Force room container to show
            const roomContainer = document.getElementById('roomContainer');
            if (roomContainer) {
                roomContainer.style.display = 'flex';
                roomContainer.classList.add('active');
            }
            
            console.log('üè† Room interface should now be visible');
        };
        
        console.log('‚úÖ All critical functions defined in HEAD');
    </script>
    
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Web App Config -->
    <title>DropShare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3367d6">
    <meta name="color-scheme" content="dark light">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-title" content="DropShare">
    <!-- Descriptions -->
    <meta name="description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="keywords" content="File, Transfer, Share, Peer2Peer">
    <meta name="author" content="RobinLinus">
    <meta property="og:title" content="DropShare">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://snapdrop.net/">
    <meta property="og:author" content="https://facebook.com/RobinLinus">
    <meta name="twitter:author" content="@RobinLinus">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="og:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <!-- Icons -->
    <link rel="icon" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="shortcut icon" href="images/favicon-96x96.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <meta name="msapplication-TileImage" content="images/mstile-150x150.png">
    <link rel="fluid-icon" type="image/png" href="images/android-chrome-192x192.png">
    <meta name="twitter:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <meta property="og:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <!-- Resources -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4803558716082981" 
            crossorigin="anonymous"></script>
    
    <link rel="manifest" href="manifest.json">
    
    <script>
        // Emergency function definitions to prevent undefined errors
        window.handleCreateRoom = window.handleCreateRoom || function() {
            console.log('Emergency handleCreateRoom called - page still loading');
            // Don't show alert, just return silently
            return;
        };
        
        window.handleCancelRoom = window.handleCancelRoom || function() {
            console.log('Emergency handleCancelRoom called - page still loading');
            return;
        };
        
        window.showCreateForm = window.showCreateForm || function() {
            console.log('Emergency showCreateForm called - page still loading');
            return;
        };
        
        window.showJoinForm = window.showJoinForm || function() {
            console.log('Emergency showJoinForm called - page still loading');
            return;
        };
        
        // Immediate hash check and mode setting - runs before DOM is ready
        (function() {
            console.log('=== IMMEDIATE MODE SETUP ===');
            console.log('Current hash:', window.location.hash);
            
            // Set data-mode on both html and body immediately
            const mode = window.location.hash === '#rooms' ? 'rooms' : 'transfer';
            document.documentElement.setAttribute('data-mode', mode);
            
            // Also set it when body becomes available
            if (document.body) {
                document.body.setAttribute('data-mode', mode);
            } else {
                document.addEventListener('DOMContentLoaded', function() {
                    document.body.setAttribute('data-mode', mode);
                });
            }
            
            // Force immediate mode switch when DOM is ready
            document.addEventListener('DOMContentLoaded', function() {
                if (mode === 'rooms') {
                    switchToRoomsMode();
                } else {
                    switchToTransferMode();
                }
                
                // Initialize global file upload functionality
                setTimeout(() => {
                    initGlobalFileUpload();
                }, 500);
            });
            
            console.log('Mode set to:', mode);
        })();
        
        // Force switch to rooms mode
        function switchToRoomsMode() {
            console.log('Switching to Rooms mode...');
            document.documentElement.setAttribute('data-mode', 'rooms');
            if (document.body) {
                document.body.setAttribute('data-mode', 'rooms');
            }
            
            const roomContainer = document.getElementById('roomContainer');
            const peerContainer = document.getElementById('peerContainer');
            
            if (roomContainer) {
                roomContainer.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
            }
            
            if (peerContainer) {
                peerContainer.style.cssText = 'display: none !important;';
            }
            
            console.log('Switched to Rooms mode');
        }
        
        // Force switch to transfer mode
        function switchToTransferMode() {
            console.log('Switching to Transfer mode...');
            document.documentElement.setAttribute('data-mode', 'transfer');
            if (document.body) {
                document.body.setAttribute('data-mode', 'transfer');
            }
            
            const roomContainer = document.getElementById('roomContainer');
            const peerContainer = document.getElementById('peerContainer');
            
            if (roomContainer) {
                roomContainer.style.cssText = 'display: none !important;';
            }
            
            if (peerContainer) {
                peerContainer.style.cssText = 'display: block !important; visibility: visible !important;';
            }
            
            console.log('Switched to Transfer mode');
        }
        
        // Listen for hash changes
        window.addEventListener('hashchange', function() {
            console.log('Hash changed to:', window.location.hash);
            if (window.location.hash === '#rooms') {
                switchToRoomsMode();
            } else {
                switchToTransferMode();
            }
        });
    </script>
    
    <script>
        // Immediately hide user info if in room mode
        (function() {
            function hideUserInfoIfInRoomMode() {
                if (window.location.hash === '#rooms' || window.location.hash === '#room') {
                    setTimeout(() => {
                        const selectors = ['.user-info-bottom', '#userInfoBottom'];
                        selectors.forEach(selector => {
                            const element = document.querySelector(selector);
                            if (element) {
                                element.style.display = 'none';
                                console.log('üöÄ User info hidden:', selector);
                            }
                        });
                    }, 100);
                }
            }
            
            // Call immediately and on events
            hideUserInfoIfInRoomMode();
            document.addEventListener('DOMContentLoaded', hideUserInfoIfInRoomMode);
            window.addEventListener('hashchange', hideUserInfoIfInRoomMode);
        })();
        
        // Global functions for room buttons - must be in global scope
        function showCreateForm() {
            console.log('Create Room button clicked!');
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            
            if (createForm && joinForm) {
                // Hide all forms first
                createForm.classList.remove('active');
                joinForm.classList.remove('active');
                
                // Show create form
                createForm.classList.add('active');
                console.log('Create form shown');
            } else {
                console.error('Forms not found');
            }
        }
        
        function showJoinForm() {
            console.log('Join Room button clicked!');
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            
            if (createForm && joinForm) {
                // Hide all forms first
                createForm.classList.remove('active');
                joinForm.classList.remove('active');
                
                // Show join form  
                joinForm.classList.add('active');
                console.log('Join form shown');
            } else {
                console.error('Forms not found');
            }
        }
    </script>
    
    <style>
        /* Unified Header Styles */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e5e7eb;
            z-index: 1000;
            padding: 12px 0;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
        }

        .logo svg {
            width: 32px;
            height: 32px;
            fill: #2563eb;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-links {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .nav-links a {
            color: #6b7280;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .nav-links a:hover {
            color: #3367d6;
            background: #f3f4f6;
        }

        .nav-links a.active {
            color: #3367d6;
            background: #e3f2fd;
            font-weight: 600;
        }

        .control-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .icon-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .icon-button:hover {
            background: #f3f4f6;
            color: #3367d6;
            border-color: #d1d5db;
        }

        .icon-button .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Override styles.css layout for centered sharing page */
        body {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
        }
        
        /* Main page container */
        .page-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            position: relative;
            padding-top: 80px;
        }
        
        /* Message area in the center */
        .center-message {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        /* User info at bottom */
        .user-info-bottom {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .user-info-bottom footer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .user-info-bottom .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .user-info-bottom .text-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        /* Style the peer area */
        x-peers {
            display: flex !important;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        /* Center the no-peers message */
        x-no-peers {
            margin: 20px 0;
        }
        
        /* Center footer content */
        footer {
            position: static !important;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        
        /* Hide instructions container that interferes */
        .instructions-container {
            display: none;
        }
        
        /* Hide back to home button */
        .back-home-btn {
            display: none !important;
        }
        
        /* Room functionality styles */
        .room-container {
            display: none;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .room-container.active {
            display: flex !important;
        }
        
        /* Force show room container when URL contains #rooms */
        body:target-within(#roomContainer),
        html:has([id="roomContainer"]) .room-container,
        .room-container {
            display: flex !important;
        }
        
        /* Default state - show transfer, hide rooms */
        #roomContainer {
            display: none !important;
        }
        
        #peerContainer {
            display: block !important;
        }
        
        /* Rooms mode - show rooms, hide transfer */
        body[data-mode="rooms"] #roomContainer {
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        body[data-mode="rooms"] #peerContainer {
            display: none !important;
        }
        
        /* Transfer mode - explicitly show transfer, hide rooms */
        body[data-mode="transfer"] #roomContainer {
            display: none !important;
        }
        
        body[data-mode="transfer"] #peerContainer {
            display: block !important;
        }
        
        /* Backup CSS based on hash */
        body:not([data-mode]) #roomContainer {
            display: none !important;
        }
        
        /* Force rooms visibility when hash is present */
        body:target-within(#roomContainer) #roomContainer,
        html:has([data-mode="rooms"]) #roomContainer {
            display: flex !important;
        }
        
        html:has([data-mode="rooms"]) #peerContainer {
            display: none !important;
        }
        
        /* Hide the "Open DropShare" message in rooms mode */
        body[data-mode="rooms"] x-no-peers,
        body[data-mode="rooms"] x-no-peers h2 {
            display: none !important;
        }
        
        .room-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .room-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .room-subtitle {
            font-size: 1.125rem;
            color: #64748b;
            margin: 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-options {
            display: flex !important;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .room-forms-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            width: 100%;
            padding: 0 20px; /* Add left and right padding to ensure spacing on small screens */
            box-sizing: border-box;
        }
        
        .room-btn {
            padding: 14px 28px;
            background: #3367d6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .room-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .room-btn.secondary {
            background: transparent;
            color: #3367d6;
            border: 2px solid #3367d6;
        }
        
        .room-btn.secondary:hover {
            background: #3367d6;
            color: white;
        }
        
        .room-form {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 0 auto; /* Horizontal centering */
            position: relative;
            z-index: 1050; /* Ensure above navigation bar */
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        
        .room-form.active {
            display: block;
        }
        
        .room-form h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* Ensure padding and border are included in width */
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3367d6;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* Ensure padding is included in width */
        }
        
        .btn-primary {
            background: #3367d6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
        }
        
        .room-info {
            display: none;
            background: #f0f9ff;
            border-radius: 12px;
            border-left: 4px solid #3367d6;
            margin-bottom: 24px;
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .room-info.active {
            display: block;
        }
        
        .room-info-header {
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .room-info-header:hover {
            background: #f1f5f9;
        }
        
        .room-summary {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }
        
        .room-name-display {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }
        
        .room-code-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .room-code-display {
            font-family: monospace;
            color: #3367d6;
            font-weight: 600;
            font-size: 14px;
        }
        
        .copy-btn-small {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .copy-btn-small:hover {
            background: #f1f5f9;
        }
        
        .member-count {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-info {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 4px 0;
        }
        
        .current-user-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-name {
            font-size: 12px;
            color: #3367d6;
            font-weight: 600;
            background: #f0f9ff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
        }
        
        .toggle-details-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .toggle-details-btn:hover {
            background: #e2e8f0;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
            color: #64748b;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .room-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        .room-details.expanded {
            max-height: 200px;
            padding: 16px 20px;
        }
        
        .room-members-section {
            font-size: 14px;
        }
        
        .room-members-section strong {
            display: block;
            margin-bottom: 12px;
            color: #374151;
        }
        
        .room-actions {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            text-align: center;
        }
        
        .btn-leave-room {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-leave-room:hover {
            background: #dc2626;
        }
        
        /* Room warning styles */
        .room-warning {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            margin-bottom: 24px;
            padding: 16px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-warning.active {
            display: block;
        }
        
        .warning-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .warning-text {
            flex: 1;
        }
        
        .warning-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .warning-message {
            color: #92400e;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .room-members {
            margin-top: 20px;
        }

        .member-count-section {
            font-size: 14px;
            color: #6b7280;
        }

        .member-names {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .member-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background: #f3f4f6;
            border-radius: 12px;
            font-size: 12px;
            color: #374151;
            border: 1px solid #e5e7eb;
        }

        .member-tag.host {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .member-tag .host-crown {
            margin-right: 4px;
            font-size: 10px;
        }
        
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .member-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        
        .member-name {
            font-weight: 500;
        }
        
        .member-device {
            font-size: 11px;
            color: #9ca3af;
        }
        
        .member-role {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .error-message {
            color: #ef4444;
            background: #fef2f2;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
        }
        
        /* Room file sharing area styles */
        .file-transfer-area {
            display: none;
            width: 100%;
            margin-top: 24px;
        }
        
        .room-file-sharing {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .file-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .file-transfer-area.active {
            display: block;
        }
        
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .shared-files-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .upload-section h3, .shared-files-section h3 {
            margin: 0 0 16px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shared-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .file-count {
            color: #6b7280;
            font-size: 14px;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .upload-hint {
            color: #6b7280;
            font-size: 14px;
            margin: 4px 0 12px 0;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3367d6;
            background: #f0f9ff;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .upload-icon {
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .drop-zone p {
            color: #6b7280;
            margin: 0;
            font-size: 16px;
        }
        
        .select-files-btn {
            background: #3367d6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .select-files-btn:hover {
            background: #2563eb;
        }
        
        .shared-files-list {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .no-shared-files {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
        }
        
        .no-shared-files p {
            margin: 8px 0;
        }
        
        .no-shared-files .hint {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shared-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fafafa;
            transition: all 0.2s;
        }
        
        .shared-file-item:hover {
            background: #f0f9ff;
            border-color: #3367d6;
        }
        
        .shared-file-info {
            flex: 1;
        }
        
        .shared-file-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            font-size: 16px;
        }
        
        .shared-file-details {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            gap: 16px;
        }
        
        .shared-file-uploader {
            color: #3367d6;
            font-weight: 500;
        }
        
        .restored-tag {
            color: #f59e0b;
            font-size: 12px;
            font-weight: normal;
        }
        
        .unavailable-hint {
            color: #ef4444;
            font-size: 12px;
            font-style: italic;
        }
        
        .action-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* File status styles */
        .shared-file-item.file-offline {
            opacity: 0.6;
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        
        .shared-file-item.file-offline .shared-file-name {
            color: #6c757d;
        }
        
        .shared-file-item.file-unavailable {
            opacity: 0.7;
            background: #fdf2f2;
            border-color: #fecaca;
        }
        
        .shared-file-item.file-unavailable .shared-file-name {
            color: #991b1b;
        }
        
        .file-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .status-online {
            background: #10b981;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        .status-unavailable {
            background: #f59e0b;
        }
        
        .shared-file-actions {
            display: flex;
            gap: 8px;
        }
        
        .transfer-item, .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fafafa;
        }
        
        .transfer-info, .file-info {
            flex: 1;
        }
        
        .transfer-name, .file-name {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .transfer-details, .file-details {
            font-size: 12px;
            color: #6b7280;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3367d6;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .transfer-actions, .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-download {
            background: #10b981;
            color: white;
        }
        
        .btn-download:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #ef4444;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #dc2626;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .room-file-sharing {
                gap: 16px;
            }
            
            .upload-section, .shared-files-section {
                padding: 20px;
            }
            
            .room-container {
                max-width: 800px;
                padding: 20px;
            }
            
            .room-info {
                max-width: 100%;
            }
        }
        
        /* Mobile adaptation */
        @media (max-width: 768px) {
            .back-home-btn {
                top: 16px;
                left: 16px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .room-container {
                max-width: 100%;
                padding: 16px;
                gap: 20px;
            }
            
            .room-options {
                flex-direction: column;
                gap: 12px;
            }
            
            .room-btn {
                width: 100%;
                padding: 16px;
            }
            
            .room-form {
                padding: 20px;
            }
            
            .shared-file-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .shared-file-actions {
                justify-content: center;
            }
            
            .drop-zone {
                padding: 30px 20px;
            }
            
            .upload-section h3, 
            .transfer-list-section h3, 
            .received-files-section h3 {
                font-size: 16px;
            }
            
            .room-title {
                font-size: 1.875rem;
            }
            
            .room-subtitle {
                font-size: 1rem;
            }
            
            .room-header {
                margin-bottom: 24px;
            }
        }
        
        /* Large screen optimization */
        @media (min-width: 1400px) {
            .room-container {
                max-width: 1400px;
            }
            
            .file-transfer-grid {
                gap: 32px;
            }
        }
        
        
        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            padding: 0 20px;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #3367d6;
            font-size: 24px;
            font-weight: 600;
        }
        
        .navbar-brand .brand-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            fill: currentColor;
        }
        
        .navbar-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-link {
            padding: 8px 16px;
            text-decoration: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            color: #3367d6;
            background: #f3f4f6;
        }

        .nav-link.active {
            color: #3367d6;
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .language-selector select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Adjust page content to make space for fixed navigation bar */
        .page-container {
            padding-top: 80px; /* Space for fixed header */
        }
        
        /* Responsive navigation bar */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 16px;
            }
            
            .navbar-brand {
                font-size: 20px;
            }
            
            .navbar-brand .brand-icon {
                width: 28px;
                height: 28px;
                margin-right: 8px;
            }
            
            .navbar-nav {
                gap: 4px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .language-selector select {
                padding: 4px 8px;
                font-size: 13px;
            }
        }
    </style>
    <link rel="stylesheet" href="share-integration.css">
    <link rel="stylesheet" href="device-selector.css">
    <script src="/locales/i18n.js"></script>
    
    <script>
        // Toast notification function
        window.showToast = function(message) {
            const toastElement = document.getElementById('toast');
            const toastText = document.getElementById('toast-text');
            
            if (toastElement && toastText) {
                toastText.textContent = message;
                toastElement.setAttribute('class', 'row');
                toastElement.style.display = 'block';
                
                // Hide after 2 seconds
                setTimeout(() => {
                    toastElement.style.display = 'none';
                }, 2000);
            } else {
                // Fallback to custom toast if x-toast not working
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #323232;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 2000);
            }
        };
        
        // Simple copy room code function
        window.copyRoomCodeSimple = function() {
            console.log('üìã Copying room code...');
            
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            if (roomCodeDisplay) {
                const roomCodeText = roomCodeDisplay.textContent;
                // Extract just the room code (remove "Room Code: " prefix)
                const roomCode = roomCodeText.replace('Room Code: ', '').trim();
                
                console.log('üìã Room code to copy:', roomCode);
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(roomCode).then(() => {
                        console.log('‚úÖ Room code copied to clipboard');
                        showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_copy_success') : 'Copy successful');
                    }).catch(err => {
                        console.error('‚ùå Copy failed:', err);
                        prompt('Copy this room code:', roomCode);
                    });
                } else {
                    prompt('Copy this room code:', roomCode);
                }
            } else {
                console.error('‚ùå Room code display not found');
            }
        };
        
        // Test function to manually display room info
        window.testRoomDisplay = function() {
            console.log('üß™ Testing room info display...');
            
            // Test with sample room data
            const sampleRoom = {
                name: 'ÊµãËØïÊàøÈó¥',
                code: 'TESTXOYLJ4', 
                memberCount: 1,
                maxMembers: 10,
                isPrivate: false
            };
            
            console.log('Sample room data:', sampleRoom);
            displayRoomInfo(sampleRoom);
        };
        
        // Simple room creation handlers
        function handleLeaveRoom() {
            console.log('üö™ === LEAVE ROOM BUTTON CLICKED ===');
            
            // Send leave room message to server
            const message = { type: 'leave-room' };
            console.log('üì§ Sending leave room message:', message);
            
            if (window.network && window.network.send) {
                window.network.send(message);
                console.log('‚úÖ Leave message sent via window.network');
            } else if (window.serverConnection && window.serverConnection.send) {
                window.serverConnection.send(message);
                console.log('‚úÖ Leave message sent via serverConnection');
            } else {
                console.error('‚ùå No network connection available');
            }
            
            // Immediately update UI (don't wait for server response)
            leaveRoomUI();
        }
        
        // Global handler for file input change
        function handleFileInputChange(event) {
            console.log('üöÄ === handleFileInputChange STARTED ===');
            console.log('üìÅ handleFileInputChange called, files:', event.target.files.length);
            console.log('üåç Current hash:', window.location.hash);
            
            // Prevent multiple rapid calls
            if (handleFileInputChange.processing) {
                console.log('‚è≥ Already processing files, ignoring...');
                return;
            }
            handleFileInputChange.processing = true;
            
            const files = event.target.files;
            if (!files || files.length === 0) {
                console.log('‚ùå No files selected');
                handleFileInputChange.processing = false;
                return;
            }
            
            // Use room debugger if available
            if (window.roomDebugger) {
                console.log('üîß Using room debugger for file handling');
                window.roomDebugger.handleFileSelection(files)
                    .finally(() => {
                        handleFileInputChange.processing = false;
                        event.target.value = ''; // Clear input
                    });
                return;
            }
            
            // Fallback to original logic
            
            // üîí Âü∫Êú¨ÂÆâÂÖ®È™åËØÅÔºà‰øùÁïôÊñá‰ª∂ÂêçÈ™åËØÅÔºåÁßªÈô§Â§ßÂ∞èÈôêÂà∂Ôºâ
            let totalSize = 0;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                // È™åËØÅÊñá‰ª∂ÂêçÔºà‰ªÖÊ£ÄÊü•ÊòéÊòæÁöÑÂÆâÂÖ®ÈóÆÈ¢òÔºâ
                if (window.SecurityUtils && !SecurityUtils.validateFileName(file.name)) {
                    alert(`‚ùå Invalid file name: ${SecurityUtils.escapeHtml(file.name)}`);
                    event.target.value = '';
                    handleFileInputChange.processing = false;
                    return;
                }
                
                totalSize += file.size;
            }
            
            console.log('üîç Debug - current URL hash:', window.location.hash);
            
            // Enhanced check - also consider URL hash for room mode
            const isInRoomMode = window.location.hash === '#rooms' || window.location.hash === '#room';
            const roomInfo = document.getElementById('roomInfo');
            const isInRoom = roomInfo && roomInfo.classList.contains('active');
            
            console.log('Room status check:', { isInRoomMode, isInRoom });
            
            if (isInRoomMode) {
                if (!isInRoom) {
                    alert(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_join_room_first') : 'Please join a room first to upload files');
                    console.log('‚ùå Not in room, cannot upload');
                    handleFileInputChange.processing = false;
                    event.target.value = '';
                    return;
                }
                
                console.log('‚úÖ Room mode detected, uploading', files.length, 'files (total:', Math.round(totalSize / 1024 / 1024), 'MB)');
                console.log('üéØ Calling uploadFilesToRoom...');
                try {
                    uploadFilesToRoom(files);
                    console.log('‚úÖ uploadFilesToRoom call completed');
                } catch (error) {
                    console.error('‚ùå Upload error:', error);
                    alert('‚ùå Upload failed: ' + error.message);
                }
                    alert('‚ùå Upload failed: ' + error.message);
                }
            } else {
                console.log('‚ùå Not in room mode - hash:', window.location.hash);
                alert('Please join a room first to upload files');
            }
            
            // Clear file input and reset processing flag
            setTimeout(() => {
            event.target.value = '';
                handleFileInputChange.processing = false;
                console.log('‚úÖ File input reset, ready for next selection');
            }, 500);
        }
        
        // Progress display functions
        function showUploadProgress(fileName, progress) {
            let progressContainer = document.getElementById('uploadProgressContainer');
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.id = 'uploadProgressContainer';
                progressContainer.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    padding: 16px;
                    min-width: 300px;
                    z-index: 10001;
                    font-family: system-ui, -apple-system, sans-serif;
                `;
                document.body.appendChild(progressContainer);
            }
            
            // ‰ΩøÁî®ÂÆâÂÖ®ÁöÑIDÁîüÊàêÊñπÊ≥ïÔºåÈÅøÂÖç‰∏≠ÊñáÊñá‰ª∂ÂêçÁºñÁ†ÅÈóÆÈ¢ò
            const safeId = 'progress-' + fileName.replace(/[^a-zA-Z0-9]/g, '_') + '_' + Date.now();
            let progressItem = document.getElementById(safeId);
            if (!progressItem) {
                progressItem = document.createElement('div');
                progressItem.id = safeId;
                progressItem.style.cssText = `
                    margin-bottom: 12px;
                    padding: 8px 0;
                    border-bottom: 1px solid #f0f0f0;
                `;
                progressItem.setAttribute('data-filename', fileName);
                progressItem.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 8px; font-size: 14px;">${SecurityUtils.escapeHtml(fileName)}</div>
                    <div style="background: #f3f4f6; height: 6px; border-radius: 3px; overflow: hidden;">
                        <div class="progress-bar" style="background: #4285f4; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div class="progress-text" style="font-size: 12px; color: #6b7280; margin-top: 4px;">Starting...</div>
                `;
                progressContainer.appendChild(progressItem);
            }
            
            const progressBar = progressItem.querySelector('.progress-bar');
            const progressText = progressItem.querySelector('.progress-text');
            
            if (progressBar) {
                progressBar.style.width = `${Math.round(progress * 100)}%`;
            }
        }
        
        function updateUploadProgress(fileName, progress, statusText) {
            // Êü•ÊâæÂØπÂ∫îÁöÑËøõÂ∫¶È°πÔºà‰ΩøÁî®dataÂ±ûÊÄßÂåπÈÖçÔºâ
            const progressItems = document.querySelectorAll('[data-filename]');
            let progressItem = null;
            
            for (let item of progressItems) {
                if (item.getAttribute('data-filename') === fileName) {
                    progressItem = item;
                    break;
                }
            }
            
            if (!progressItem) return;
            
            const progressBar = progressItem.querySelector('.progress-bar');
            const progressText = progressItem.querySelector('.progress-text');
            
            if (progressBar) {
                progressBar.style.width = `${Math.round(progress * 100)}%`;
            }
            
            if (progressText) {
                progressText.textContent = statusText || `${Math.round(progress * 100)}%`;
            }
        }
        
        function hideUploadProgress(fileName) {
            // Êü•ÊâæÂØπÂ∫îÁöÑËøõÂ∫¶È°πÔºà‰ΩøÁî®dataÂ±ûÊÄßÂåπÈÖçÔºâ
            const progressItems = document.querySelectorAll('[data-filename]');
            let progressItem = null;
            
            for (let item of progressItems) {
                if (item.getAttribute('data-filename') === fileName) {
                    progressItem = item;
                    break;
                }
            }
            
            if (progressItem) {
                progressItem.style.transition = 'opacity 0.3s ease';
                progressItem.style.opacity = '0';
                setTimeout(() => {
                    if (progressItem.parentNode) {
                        progressItem.parentNode.removeChild(progressItem);
                    }
                    
                    // Remove container if empty
                    const container = document.getElementById('uploadProgressContainer');
                    if (container && container.children.length === 0) {
                        container.remove();
                    }
                }, 300);
            }
        }
        
        // Manual function to add file to shared list
        function addFileToSharedListManual(fileInfo) {
            console.log('üìÅ Adding file to shared list manually:', fileInfo.name);
            
            const sharedFilesList = document.getElementById('sharedFilesList');
            const noFiles = sharedFilesList.querySelector('.no-shared-files');
            
            if (noFiles) {
                noFiles.style.display = 'none';
            }
            
            // Create file item
            const fileItem = document.createElement('div');
            fileItem.className = 'shared-file-item';
            fileItem.setAttribute('data-file-id', fileInfo.id);
            
            const uploadTime = new Date(fileInfo.uploadTime || Date.now()).toLocaleString();
            const fileSize = formatFileSize(fileInfo.size || 0);
            
            fileItem.innerHTML = `
                <div class="shared-file-info">
                    <div class="shared-file-name">${SecurityUtils.escapeHtml(fileInfo.name)}</div>
                    <div class="shared-file-details">
                        <span class="file-size">${fileSize}</span>
                        <span class="file-uploader">by ${SecurityUtils.escapeHtml(fileInfo.uploader || 'You')}</span>
                        <span class="upload-time">${uploadTime}</span>
                    </div>
                </div>
                <div class="shared-file-actions">
                    <button class="action-btn btn-download" onclick="downloadFileManual('${fileInfo.id}')">Download</button>
                    <button class="action-btn btn-cancel" onclick="removeFileManual('${fileInfo.id}')">Delete</button>
                </div>
            `;
            
            // Store file data
            fileItem._fileData = fileInfo;
            
            sharedFilesList.appendChild(fileItem);
            
            // Update file count
            updateFileCount();
        }
        
        // Format file size helper
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Update file count
        function updateFileCount() {
            const sharedFilesList = document.getElementById('sharedFilesList');
            const fileItems = sharedFilesList.querySelectorAll('.shared-file-item');
            const fileCount = document.getElementById('fileCount');
            if (fileCount) {
                const count = fileItems.length;
                fileCount.innerHTML = `${count} <span data-i18n="share_files"> files</span>`;
            }
        }
        
        // Download file manually
        function downloadFileManual(fileId) {
            const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
            if (fileItem && fileItem._fileData && fileItem._fileData.file) {
                const fileData = fileItem._fileData;
                const url = URL.createObjectURL(fileData.file);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileData.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('‚úÖ File download started:', fileData.name);
            } else {
                alert('File not available for download');
            }
        }
        
        // Remove file manually
        function removeFileManual(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    updateFileCount();
                    console.log('‚úÖ File removed:', fileId);
                }
            }
        }
        
        // Global file upload initialization - simplified
        function initGlobalFileUpload() {
            console.log('üîß Initializing global file upload functionality...');
            
            // Prevent multiple initialization
            if (window.globalFileUploadInitialized) {
                console.log('‚úÖ Global file upload already initialized');
                return;
            }
            
            const fileInput = document.getElementById('fileInput');
            if (!fileInput) {
                console.log('‚ùå File input not found, retrying in 200ms...');
                setTimeout(initGlobalFileUpload, 200);
                return;
            }
            
            // Add only the necessary drag functionality
            const dropZone = document.getElementById('dropZone');
            if (dropZone) {
                dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                    dropZone.classList.add('dragover');
            });
            
                dropZone.addEventListener('dragleave', function() {
                    dropZone.classList.remove('dragover');
            });
            
                dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                    dropZone.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files && files.length > 0) {
                        console.log('üìÅ Files dropped:', files.length, 'files');
                        // Create fake event for handleFileInputChange
                        const fakeEvent = { target: { files: files, value: '' } };
                        handleFileInputChange(fakeEvent);
                    }
                });
            }
            
            window.globalFileUploadInitialized = true;
            console.log('‚úÖ Global file upload initialized successfully');
            console.log('‚úÖ Global file upload functionality initialized successfully');
        }
        
        // Global file selection handler
        function handleGlobalFileSelection(files) {
            console.log('üìÅ Global - Handling file selection:', files.length, 'files');
            
            if (!files || files.length === 0) {
                console.log('No files selected');
                return;
            }
            
            // Check if in room mode
            const isInRoom = document.getElementById('roomInfo') && 
                           document.getElementById('roomInfo').classList.contains('active');
            
            if (!isInRoom) {
                alert('Please join a room first to upload files');
                return;
            }
            
            // Try to use RoomManager if available, or create it if in room mode
            const isInRoomMode = window.location.hash === '#rooms' || window.location.hash === '#room';
            
            if (isInRoomMode) {
                console.log('‚úÖ Room mode detected, uploading files...');
                // Áõ¥Êé•‰ΩøÁî®ÊâãÂä®‰∏ä‰º†ÔºåÈÅøÂÖçRoomManager‰æùËµñÈóÆÈ¢ò
                uploadFilesToRoomManual(files);
            } else {
                console.log('‚ùå Not in room mode, cannot upload files');
                alert('Please join a room first to upload files');
            }
        }
        
        // Simplified file upload function for room mode
        function uploadFilesToRoom(files) {
            console.log('üì§ Upload files to room:', files.length, 'files');
            
            if (!files || files.length === 0) {
                console.log('‚ùå No files to upload');
                return;
            }
            
            // Use the manual upload function
            uploadFilesToRoomManual(files);
        }
        
        // Manual file upload function with progress
        async function uploadFilesToRoomManual(files) {
            console.log('üì§ Manual upload files to room:', files.length, 'files');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log(`Uploading file ${i + 1}:`, file.name, file.size, 'bytes');
                
                // Show initial progress
                showUploadProgress(file.name, 0);
                
                try {
                // Create file info
                const fileInfo = {
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    uploader: 'You',
                    uploadTime: Date.now()
                };
                    
                    updateUploadProgress(file.name, 0.1, 'Preparing upload...');
                    
                    // For large files, show processing progress
                    let fileData = file;
                    if (file.size > 1024 * 1024) { // Files larger than 1MB
                        updateUploadProgress(file.name, 0.2, 'Processing large file...');
                        
                        // Simulate processing time for large files
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    updateUploadProgress(file.name, 0.8, 'Sending to room...');
                
                // Send to server
                if (window.network && window.network.send) {
                    const message = {
                        type: 'room-file-upload',
                        fileInfo: fileInfo,
                            fileData: fileData
                    };
                    
                        console.log('üì§ Sending file upload message for:', file.name);
                    window.network.send(message);
                        
                        // Á´ãÂç≥Ê∑ªÂä†Âà∞Êú¨Âú∞Êñá‰ª∂ÂàóË°®
                        if (window.roomManager && typeof window.roomManager.addFileToSharedList === 'function') {
                            window.roomManager.addFileToSharedList(fileInfo);
                            console.log('‚úÖ File added to local shared list:', file.name);
                        } else {
                            // ÊâãÂä®Ê∑ªÂä†Âà∞Êñá‰ª∂ÂàóË°®
                            addFileToSharedListManual(fileInfo);
                            console.log('‚úÖ File added to shared list manually:', file.name);
                        }
                        
                        updateUploadProgress(file.name, 1, 'Upload complete!');
                        
                        // Hide progress after 2 seconds
                        setTimeout(() => hideUploadProgress(file.name), 2000);
                        
                } else {
                    console.error('‚ùå No network connection available for file upload');
                        hideUploadProgress(file.name);
                        alert('‚ùå Network connection not available');
                    }
                    
                } catch (error) {
                    console.error('‚ùå File upload failed:', error);
                    hideUploadProgress(file.name);
                    alert(`‚ùå Upload failed: ${file.name} - ${error.message}`);
                }
            }
        }
        
        function leaveRoomUI() {
            console.log('üö™ Updating UI for leaving room...');
            
            // Hide existing room info panel
            const roomInfo = document.getElementById('roomInfo');
            if (roomInfo) {
                roomInfo.classList.remove('active');
                console.log('‚úÖ Room info panel hidden');
            }
            
            // Hide fallback info if it exists
            const fallbackInfo = document.getElementById('fallbackRoomInfo');
            if (fallbackInfo) {
                fallbackInfo.style.display = 'none';
            }
            
            // Show the Create/Join Room buttons again since user left the room
            const roomOptions = document.querySelector('.room-options');
            if (roomOptions) {
                roomOptions.style.cssText = 'display: flex !important;';
                console.log('‚úÖ Room options shown again with !important');
            }
            
            // Hide file transfer area since user left the room
            const fileTransferArea = document.getElementById('fileTransferArea');
            if (fileTransferArea) {
                fileTransferArea.classList.remove('active');
                console.log('‚úÖ File transfer area hidden');
            }
            
            // Show bottom user info again when leaving room
            if (window.roomManager && typeof window.roomManager.showBottomUserInfo === 'function') {
                window.roomManager.showBottomUserInfo();
                console.log('‚úÖ Bottom user info shown again');
            }
            
            // Show room controls (Create Room / Join Room buttons)
            const roomControls = document.querySelector('.room-controls');
            if (roomControls) {
                roomControls.style.display = 'block';
                console.log('‚úÖ Room controls shown');
            }
            
            // Clear any room-related data
            console.log('‚úÖ Room UI updated for leaving');
        }
        
        function handleJoinRoom() {
            console.log('üîµ === JOIN ROOM BUTTON CLICKED ===');
            
            const roomCode = document.getElementById('roomCode').value.trim();
            const password = document.getElementById('joinRoomPassword').value;
            
            console.log('Form values:', { roomCode, password });
            
            if (!roomCode) {
                alert('Please enter Room Code');
                return;
            }
            
            const message = {
                type: 'join-room',
                roomCode: roomCode.toUpperCase(), // Á°Æ‰øùÊàøÈó¥‰ª£Á†ÅÊòØÂ§ßÂÜô
                password: password
            };
            
            console.log('üì§ Sending join room message:', message);
            
            if (window.network && window.network.send) {
                window.network.send(message);
                console.log('‚úÖ Message sent via window.network');
            } else if (window.serverConnection && window.serverConnection.send) {
                window.serverConnection.send(message);
                console.log('‚úÖ Message sent via serverConnection');
            } else {
                console.error('‚ùå No network connection available');
                console.log('Network status:', {
                    network: !!window.network,
                    serverConnection: !!window.serverConnection
                });
            }
        }
        
        window.handleCancelRoom = function() {
            console.log('üî¥ === CANCEL ROOM BUTTON CLICKED ===');
            
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            
            if (createForm) {
                createForm.classList.remove('active');
                console.log('‚úÖ Create form hidden');
            }
            if (joinForm) {
                joinForm.classList.remove('active');
                console.log('‚úÖ Join form hidden');
            }
            
            // Clear form fields
            const roomCodeInput = document.getElementById('roomCode');
            const joinPasswordInput = document.getElementById('joinRoomPassword');
            
            if (roomCodeInput) roomCodeInput.value = '';
            if (joinPasswordInput) joinPasswordInput.value = '';
            
            // Also clear create form fields
            const roomNameInput = document.getElementById('roomName');
            const roomPasswordInput = document.getElementById('roomPassword'); 
            const maxMembersInput = document.getElementById('maxMembers');
            if (roomNameInput) roomNameInput.value = '';
            if (roomPasswordInput) roomPasswordInput.value = '';
            if (maxMembersInput) maxMembersInput.value = '10';
            
            console.log('‚úÖ Join form fields cleared');
        };
        
        window.handleCreateRoom = function() {
            console.log('üîµ === CREATE ROOM BUTTON CLICKED ===');
            
            const roomName = document.getElementById('roomName').value.trim();
            const roomPassword = document.getElementById('roomPassword').value;
            const maxMembers = parseInt(document.getElementById('maxMembers').value);
            
            console.log('Form values:', { roomName, roomPassword, maxMembers });
            
            if (!roomName) {
                alert('Please enter Room Name');
                return;
            }
            
            const message = {
                type: 'create-room',
                roomSettings: {
                    code: Math.random().toString(36).substr(2, 8).toUpperCase(),
                    name: roomName,
                    password: roomPassword,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                }
            };
            
            console.log('üì§ Sending room creation message:', message);
            
            if (window.network && window.network.send) {
                window.network.send(message);
                console.log('‚úÖ Message sent via window.network');
            } else if (window.serverConnection && window.serverConnection.send) {
                window.serverConnection.send(message);
                console.log('‚úÖ Message sent via serverConnection');
            } else {
                console.error('‚ùå No network connection available');
                console.log('Network status:', {
                    network: !!window.network,
                    serverConnection: !!window.serverConnection
                });
            }
        };
        
        // Handle room creation response
        function handleRoomResponse(message) {
            console.log('üè† === ROOM RESPONSE RECEIVED ===', message);
            
            if (message.type === 'room-created') {
                console.log('‚úÖ Room created successfully!', message.room);
                
                // Hide the create form
                const createForm = document.getElementById('createRoomForm');
                if (createForm) {
                    createForm.classList.remove('active');
                }
                
                // Show room info
                displayRoomInfo(message.room);
                
                // Switch to room mode
                switchToRoomMode(message.room);
            } else if (message.type === 'room-joined') {
                console.log('‚úÖ Room joined successfully!', message.room || message);
                
                // Hide the join form
                const joinForm = document.getElementById('joinRoomForm');
                if (joinForm) {
                    joinForm.classList.remove('active');
                }
                
                // Show room info
                displayRoomInfo(message.room || { 
                    name: message.roomName || 'Joined Room',
                    code: message.roomCode || 'Unknown',
                    memberCount: message.memberCount || 1
                });
                
                // Switch to room mode
                switchToRoomMode(message.room || { code: message.roomCode });
            } else if (message.type === 'room-left') {
                console.log('‚úÖ Successfully left room');
                leaveRoomUI();
            } else if (message.type === 'room-error') {
                console.error('‚ùå Room operation failed:', message.error);
                alert('Room operation failed: ' + message.error);
            }
        }
        
        function displayRoomInfo(room) {
            console.log('üìã Displaying room info using existing UI:', room);
            
            // Use existing room info elements
            const roomInfo = document.getElementById('roomInfo');
            const roomNameDisplay = document.getElementById('roomNameDisplay');
            const roomCodeDisplay = document.getElementById('roomCodeDisplay');
            const memberCount = document.getElementById('memberCountNumber');
            const currentUserName = document.getElementById('currentUserName');
            
            if (roomInfo && roomNameDisplay && roomCodeDisplay) {
                // Fill in room information
                roomNameDisplay.textContent = room.name || room.roomName || room.settings?.name || 'Untitled Room';
                roomCodeDisplay.textContent = `Room Code: ${room.code || room.roomCode || 'Unknown'}`;
                
                if (memberCount) {
                    memberCount.textContent = room.memberCount || 1;
                }
                
                if (currentUserName) {
                    // Get the real user display name instead of hardcoding "Host (You)"
                    const displayNameEl = document.getElementById('displayName');
                    if (displayNameEl && displayNameEl.textContent) {
                        const text = displayNameEl.textContent.trim();
                        console.log('Display name text for room:', text);
                        
                        // Extract the actual name from different possible formats:
                        // "You are called Orange Firefly" -> "Orange Firefly"  
                        // "You are known as Orange Firefly" -> "Orange Firefly"
                        const calledMatch = text.match(/You are called (.+)$/i);
                        const knownMatch = text.match(/You are known as (.+)$/i);
                        
                        if (calledMatch) {
                            currentUserName.textContent = calledMatch[1].trim();
                        } else if (knownMatch) {
                            currentUserName.textContent = knownMatch[1].trim();
                        } else {
                            // Fallback: try to extract last two words (e.g., "Orange Firefly")
                            const words = text.split(/\s+/);
                            if (words.length >= 2) {
                                const lastName = words[words.length - 1];
                                const secondLastName = words[words.length - 2];
                                currentUserName.textContent = `${secondLastName} ${lastName}`;
                            } else {
                                currentUserName.textContent = 'Anonymous User';
                            }
                        }
                    } else {
                        currentUserName.textContent = 'Anonymous User';
                    }
                }
                
                // Show the room info panel
                roomInfo.classList.add('active');
                console.log('‚úÖ Room info panel activated');
                
                // Hide the Create/Join Room buttons since user is now in a room
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: none !important;';
                    console.log('‚úÖ Room options hidden with !important');
                }
                
                // Show file transfer area for file sharing
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.add('active');
                    console.log('‚úÖ File transfer area shown');
                }
                
                // Initialize file transfer functionality if not already done
                if (window.roomManager && typeof window.roomManager.initializeFileTransfer === 'function') {
                    window.roomManager.initializeFileTransfer();
                    console.log('‚úÖ File transfer functionality initialized');
                }
                
                // Also initialize global file upload as backup
                setTimeout(() => {
                    initGlobalFileUpload();
                }, 200);
                
                // Hide bottom user info when in room
                if (window.roomManager && typeof window.roomManager.hideBottomUserInfo === 'function') {
                    window.roomManager.hideBottomUserInfo();
                    console.log('‚úÖ Bottom user info hidden');
                }
                
            } else {
                console.warn('‚ùå Could not find existing room info elements, creating fallback');
                // Fallback: create simple display
                let fallbackInfo = document.getElementById('fallbackRoomInfo');
                if (!fallbackInfo) {
                    fallbackInfo = document.createElement('div');
                    fallbackInfo.id = 'fallbackRoomInfo';
                    fallbackInfo.style.cssText = `
                        background: #4CAF50;
                        color: white;
                        padding: 15px;
                        margin: 10px;
                        border-radius: 8px;
                        font-family: Arial, sans-serif;
                    `;
                    
                    const roomControls = document.querySelector('.room-controls');
                    if (roomControls) {
                        roomControls.parentNode.insertBefore(fallbackInfo, roomControls.nextSibling);
                    }
                }
                
                fallbackInfo.innerHTML = `
                    <h3>üéâ Room Created Successfully!</h3>
                    <p><strong>Room Name:</strong> ${room.name}</p>
                    <p><strong>Room Code:</strong> <span style="font-size: 18px; font-weight: bold;">${room.code}</span></p>
                    <p><strong>Members:</strong> ${room.memberCount || 1}/${room.maxMembers}</p>
                `;
                fallbackInfo.style.display = 'block';
            }
        }
        
        function switchToRoomMode(room) {
            console.log('üîÑ Switching to room mode for:', room.code);
            
            // Hide room selection controls
            const roomControls = document.querySelector('.room-controls');
            if (roomControls) {
                roomControls.style.display = 'none';
            }
            
            // Show room info section
            const roomInfo = document.getElementById('roomInfo');
            if (roomInfo) {
                roomInfo.style.display = 'block';
                roomInfo.classList.add('active');
                console.log('Room info section shown');
            }
            
            // Hide create/join forms
            const createForm = document.getElementById('createRoomForm');
            const joinForm = document.getElementById('joinRoomForm');
            if (createForm) createForm.classList.remove('active');
            if (joinForm) joinForm.classList.remove('active');
            
            // Make sure room container is visible
            const roomContainer = document.getElementById('roomContainer');
            if (roomContainer) {
                roomContainer.style.display = 'flex';
                roomContainer.classList.add('active');
            }
            
            console.log('‚úÖ Room mode activated for room:', room.code);
        }
        
        function leaveRoom() {
            console.log('üö™ Leaving room...');
            
            // Hide existing room info panel
            const roomInfo = document.getElementById('roomInfo');
            if (roomInfo) {
                roomInfo.classList.remove('active');
                console.log('‚úÖ Room info panel hidden');
            }
            
            // Hide fallback info if it exists
            const fallbackInfo = document.getElementById('fallbackRoomInfo');
            if (fallbackInfo) {
                fallbackInfo.style.display = 'none';
            }
            
            // Show room controls
            const roomControls = document.querySelector('.room-controls');
            if (roomControls) {
                roomControls.style.display = 'block';
            }
            
            // Send leave message if network available
            if (window.network && window.network.send) {
                window.network.send({ type: 'leave-room' });
            }
        }
        
        // Set up message listener when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Setting up room message listener...');
            
            // Wait for network system to be available
            setTimeout(() => {
                console.log('Checking for network systems...');
                console.log('Available objects:', {
                    Events: !!window.Events,
                    network: !!window.network,
                    serverConnection: !!window.serverConnection
                });
                
                if (window.network && window.network.serverConnection) {
                    console.log('‚úÖ Found network.serverConnection, setting up message interceptor');
                    
                    // Store original message handler
                    const serverConnection = window.network.serverConnection;
                    const originalOnMessage = serverConnection._onMessage;
                    
                    // Override message handler
                    serverConnection._onMessage = function(msg) {
                        // Parse the message
                        let message;
                        try {
                            message = JSON.parse(msg);
                        } catch (e) {
                            // Call original handler if parsing fails
                            return originalOnMessage.call(this, msg);
                        }
                        
                        console.log('üì® Intercepted WebSocket message:', message);
                        
                        // Handle room messages before calling original handler
                        if (message.type && message.type.startsWith('room-')) {
                            console.log('üè† Room message detected:', message.type);
                            handleRoomResponse(message);
                        }
                        
                        // Call original handler
                        return originalOnMessage.call(this, msg);
                    };
                    
                    console.log('‚úÖ WebSocket message interceptor installed successfully');
                } else {
                    console.log('‚ùå Network system not found, will retry...');
                    setTimeout(arguments.callee, 500);
                }
            }, 1000);
        });
    </script>
    
</head>

<body translate="no">
    <!-- Top navigation bar -->
    <nav class="top-navbar">
        <div class="navbar-container">
            <!-- Brand LOGO -->
            <a href="/" class="navbar-brand">
                <svg class="brand-icon" viewBox="0 0 24 24">
                    <use xlink:href="#wifi-tethering" />
                </svg>
                DropShare
            </a>
            
            <!-- Navigation menu -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="/share.html" class="nav-link active" data-i18n="nav_transfer">Transfer</a>
                </li>
                <li class="nav-item">
                    <a href="/share.html#rooms" class="nav-link" data-i18n="nav_rooms">Rooms</a>
                </li>
                <li class="nav-item">
                    <a href="image-tools.html" class="nav-link" data-i18n="nav_images">Images</a>
                </li>
                <li class="nav-item">
                    <a href="audio-tools.html" class="nav-link" data-i18n="nav_audio">Audio</a>
                </li>
                <li class="nav-item">
                    <a href="video-tools.html" class="nav-link" data-i18n="nav_video">Video</a>
                </li>
                <li class="nav-item">
                    <a href="document-tools.html" class="nav-link" data-i18n="nav_files">Documents</a>
                </li>
                <li class="nav-item language-selector">
                    <select id="navbar-language-selector" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; font-size: 14px;">
                        <option value="en">English</option>
                        <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                        <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                        <option value="ja">Êó•Êú¨Ë™û</option>
                        <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">Portugu√™s</option>
                        <option value="es">Espa√±ol</option>
                    </select>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- Background animation is handled by JavaScript canvas in ui.js -->
    
    <!-- Back to home button is hidden -->
    
    <!-- Unified Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <svg viewBox="0 0 24 24">
                    <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"/>
            </svg>
                <a href="index.html" style="text-decoration: none; color: inherit;" data-i18n="site_name">DropShare</a>
            </div>

            <div class="header-controls">
                <nav class="nav-links">
                    <a href="share.html" class="active" data-i18n="nav_transfer">Transfer</a>
                    <a href="share.html#rooms" data-i18n="nav_rooms">Rooms</a>
                    <a href="image-tools.html" data-i18n="nav_images">Images</a>
                    <a href="audio-tools.html" data-i18n="nav_audio">Audio</a>
                    <a href="video-tools.html" data-i18n="nav_video">Video</a>
                    <a href="document-tools.html" data-i18n="nav_files">Files</a>
                </nav>

                <div class="control-buttons">
                    <!-- Language Selector -->
                    <div class="language-selector">
                        <select id="language-selector" style="padding: 6px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; color: #374151; font-size: 14px;">
                            <option value="en">English</option>
                            <option value="zh-CN">ÁÆÄ‰Ωì‰∏≠Êñá</option>
                            <option value="zh-TW">ÁπÅÈ´î‰∏≠Êñá</option>
                            <option value="ja">Êó•Êú¨Ë™û</option>
                            <option value="ko">ÌïúÍµ≠Ïñ¥</option>
                            <option value="fr">Fran√ßais</option>
                            <option value="de">Deutsch</option>
                            <option value="pt">Portugu√™s</option>
                            <option value="es">Espa√±ol</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main page container -->
    <div class="page-container">
        <!-- Center message area -->
        <div class="center-message">
            <!-- Room functionality container -->
            <div id="roomContainer" class="room-container">
                <div class="room-header">
                    <h1 class="room-title" data-i18n="share_rooms_title">Rooms</h1>
                    <p class="room-subtitle" data-i18n="share_rooms_subtitle">Quickly share files with users on the same network or remote users via room codes</p>
                </div>
                
                <!-- Room option buttons -->
                <div class="room-options">
                    <button id="createRoomBtn" class="room-btn" onclick="showCreateForm()" data-i18n="share_create_room">Create Room</button>
                    <button id="joinRoomBtn" class="room-btn secondary" onclick="showJoinForm()" data-i18n="share_join_room">Join Room</button>
                </div>
                
                <!-- Form container for centering -->
                <div class="room-forms-container">
                    <!-- Create Room form -->
                    <div id="createRoomForm" class="room-form">
                        <h3 data-i18n="share_create_new_room">Create New Room</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label" data-i18n="share_room_name">Room Name</label>
                                <input type="text" id="roomName" name="room-name" class="form-input" data-i18n-placeholder="share_enter_room_name" placeholder="Enter Room Name" maxlength="20" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="share_room_password_optional">Room Password (Optional)</label>
                                <input type="password" id="roomPassword" name="room-password" class="form-input" data-i18n-placeholder="share_set_room_password" placeholder="Set room password" maxlength="16" autocomplete="new-password">
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="share_maximum_members">Maximum Members</label>
                                <input type="number" id="maxMembers" name="max-members" class="form-input" value="10" min="2" max="50" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmCreateRoom" class="btn-primary" data-i18n="share_create_room" onclick="handleCreateRoom()">Create Room</button>
                                <button type="button" id="cancelCreateRoom" class="btn-cancel" data-i18n="share_cancel" onclick="handleCancelRoom()">Cancel</button>
                            </div>
                        </form>
                        <div id="createRoomError" class="error-message" style="display: none;"></div>
                    </div>
                    
                    <!-- Join Room form -->
                    <div id="joinRoomForm" class="room-form">
                        <h3 data-i18n="share_join_room">Join Room</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label" data-i18n="share_room_code">Room Code</label>
                                <input type="text" id="roomCode" name="room-code" class="form-input" data-i18n-placeholder="share_enter_room_code" placeholder="Enter Room Code" maxlength="10" style="text-transform: uppercase;" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="share_room_password_if_required">Room Password (if required)</label>
                                <input type="password" id="joinRoomPassword" name="join-password" class="form-input" data-i18n-placeholder="share_enter_room_password" placeholder="Enter room password" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmJoinRoom" class="btn-primary" data-i18n="share_join_room" onclick="handleJoinRoom()">Join Room</button>
                                <button type="button" id="cancelJoinRoom" class="btn-cancel" data-i18n="share_cancel" onclick="handleCancelRoom()">Cancel</button>
                            </div>
                        </form>
                        <div id="joinRoomError" class="error-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- Room info display -->
                <div id="roomInfo" class="room-info">
                    <!-- Room info header (always visible) -->
                    <div class="room-info-header" id="roomInfoHeader">
                        <div class="room-summary">
                            <span class="room-name-display" id="roomNameDisplay"></span>
                            <div class="room-code-row">
                                <span class="room-code-display" id="roomCodeDisplay"></span>
                                <button id="copyRoomCode" class="copy-btn-small" data-i18n-title="copy_room_code" title="Copy Room Code" onclick="copyRoomCodeSimple()">üìã</button>
                            </div>
                            <div class="current-user-info">
                                <span class="current-user-label" data-i18n="share_your_name">Your Name: </span>
                                <span class="current-user-name" id="currentUserName"></span>
                            </div>
                            <div class="member-count-section" id="memberCount">
                                <span id="memberCountNumber">1</span><span data-i18n="share_online"> online</span>
                                <div class="member-names" id="memberNames"></div>
                            </div>
                        </div>
                        <button class="toggle-details-btn" id="toggleDetailsBtn">
                            <svg class="toggle-icon" viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Room details (collapsible) -->
                    <div class="room-details" id="roomDetails">
                        <div class="room-members-section">
                            <strong data-i18n="share_room_members">Room Members:</strong>
                            <div id="memberList" class="member-list"></div>
                        </div>
                    </div>
                    
                    <!-- Action buttons -->
                    <div class="room-actions">
                        <button id="leaveRoomBtn" class="btn-leave-room" data-i18n="share_leave_room" onclick="handleLeaveRoom()">Leave Room</button>
                    </div>
                </div>
                
                <!-- Room warning -->
                <div id="roomWarning" class="room-warning">
                    <div class="warning-content">
                        <div class="warning-icon">‚ö†Ô∏è</div>
                        <div class="warning-text">
                            <div id="warningTitle" class="warning-title"></div>
                            <div id="warningMessage" class="warning-message"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Room file sharing area -->
                <div id="fileTransferArea" class="file-transfer-area">
                    <div class="room-file-sharing">
                        <!-- File upload area -->
                        <div class="upload-section">
                            <h3 data-i18n="share_upload_files_to_room">üì§ Upload files to room</h3>
                            <label for="fileInput" id="dropZone" class="drop-zone" style="cursor: pointer;">
                                <div class="drop-zone-content">
                                    <svg class="upload-icon" viewBox="0 0 24 24" width="48" height="48">
                                        <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                    </svg>
                                    <p data-i18n="share_drag_files_here">Drag files here or click to upload</p>
                                    <p class="upload-hint" data-i18n="share_files_shared_with_members">Files will be shared with all room members</p>
                                    <button type="button" id="selectFilesBtn" style="cursor: pointer; display: inline-block; padding: 8px 16px; background: #4285f4; color: white; border-radius: 4px; text-align: center; user-select: none; border: none; font-family: inherit;" data-i18n="share_select_files_to_upload">Select Files to Upload</button>
                                    <input type="file" id="fileInput" multiple style="display: none;">
                                </div>
                            </label>
                        </div>
                        
                        <!-- Shared Room Files list -->
                        <div class="shared-files-section">
                            <div class="shared-files-header">
                                <h3 data-i18n="share_shared_room_files">üìÅ Shared Room Files</h3>
                                <span class="file-count" id="fileCount">0 <span data-i18n="share_files"> files</span></span>
                            </div>
                            <div id="sharedFilesList" class="shared-files-list">
                                <div class="no-shared-files">
                                    <p data-i18n="share_no_shared_files">No shared files in room</p>
                                    <p class="hint" data-i18n="share_after_upload_hint">After uploading files, all room members can download</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Original device discovery interface -->
            <div id="peerContainer">
                <x-peers class="center"></x-peers>
                <x-no-peers>
                    <h2 data-i18n="share_open_dropshare_other_devices">Open DropShare on other devices to send files</h2>
                </x-no-peers>
            </div>
        </div>
        
        <!-- User info at bottom -->
        <div class="user-info-bottom" id="userInfoBottom">
            <footer>
                <div class="logo-container">
                    <svg class="icon logo">
                        <use xlink:href="#wifi-tethering" />
                    </svg>
                </div>
                <div class="text-container">
                    <div id="displayName" class="text-line"></div>
                    <div class="font-body2 text-line" data-i18n="share_discoverable_network">You can be discovered by everyone on this network</div>
                </div>
            </footer>
        </div>
    </div>
    <!-- Receive Dialog -->
    <x-dialog id="receiveDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="share_file_received">File Received</h3>
                <div class="font-subheading" id="fileName"></div>
                <div class="font-body2" id="fileSize"></div>
                <div class='preview' style="visibility: hidden;">
                    <img id='img-preview' src="">
                </div>
                <div class="row">
                    <label for="autoDownload" class="grow" data-i18n="share_ask_save_before_download">Ask to save each file before downloading</label>
                    <input type="checkbox" id="autoDownload" checked="">
                </div>
                <div class="row-reverse">
                    <a class="button" close id="download" title="Download File" autofocus data-i18n="share_save">Save</a>
                    <button class="button" close data-i18n="share_ignore">Ignore</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Send Text Dialog -->
    <x-dialog id="sendTextDialog">
        <form action="#">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="share_send_message">Send a Message</h3>
                    <div id="textInput" class="textarea" role="textbox" data-i18n-placeholder="share_send_message_placeholder" data-placeholder="Send a message" autocomplete="off" autofocus contenteditable></div>
                    <div class="row-reverse">
                        <button class="button" type="submit" close data-i18n="share_send">Send</button>
                        <a class="button" close data-i18n="share_cancel">Cancel</a>
                    </div>
                </x-paper>
            </x-background>
        </form>
    </x-dialog>
    <!-- Receive Text Dialog -->
    <x-dialog id="receiveTextDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="share_message_received">Message Received</h3>
                <div class="font-subheading" id="text"></div>
                <div class="row-reverse">
                    <button class="button" id="copy" close autofocus data-i18n="share_copy">Copy</button>
                    <button class="button" close data-i18n="share_close">Close</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Toast -->
    <div class="toast-container full center">
        <x-toast class="row" shadow="1" id="toast">
            <span id="toast-text">Notification</span>
        </x-toast>
    </div>
    <!-- About Page -->
    <x-about id="about" class="full center column" style="display: none;">
        <section class="center column fade-in">
            <header class="row-reverse">
                <a href="#" class="close icon-button">
                    <svg class="icon">
                        <use xlink:href="#close" />
                    </svg>
                </a>
            </header>
            <svg class="icon logo">
                <use xlink:href="#wifi-tethering" />
            </svg>
            <h1>DropShare</h1>
            <div class="font-subheading"><span data-i18n="share_easiest_way_transfer">The easiest way to transfer files across devices</span><div style="font-size:10px;"><span data-i18n="share_modified_version_by">Modified version by</span> <a href="#" target="_blank">YourNameHere</a></div></div>
            <div class="row">
                <a class="icon-button" target="_blank" href="#" title="DropShare on Github" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#github" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Help cover the server costs!" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#monetarization" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Tweet about DropShare" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#twitter" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Frequently asked questions" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#help-outline" />
                    </svg>
                </a>
            </div>
        </section>
        <x-background></x-background>
    </x-about>
    <!-- SVG Icon Library -->
    <svg style="display: none;">
        <symbol id="wifi-tethering" viewBox="0 0 24 24">
            <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"></path>
        </symbol>
        <symbol id="desktop-mac" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="windows-desktop" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z M4 7h4v4H4z M10 7h4v4h-4z M4 13h4v2H4z M10 13h4v2h-4z M16 7h4v4h-4z M16 13h4v2h-4z"></path>
        </symbol>
        <symbol id="desktop-linux" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="phone-iphone" viewBox="0 0 24 24">
            <path d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"></path>
        </symbol>
        <symbol id="phone-android" viewBox="0 0 24 24">
            <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3.25-3H6.75V4h10.5v14z"></path>
        </symbol>
        <symbol id="tablet-mac" viewBox="0 0 24 24">
            <path d="M18.5 0h-14C3.12 0 2 1.12 2 2.5v19C2 22.88 3.12 24 4.5 24h14c1.38 0 2.5-1.12 2.5-2.5v-19C21 1.12 19.88 0 18.5 0zm-7 23c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm7.5-4H4V3h15v16z"></path>
        </symbol>
        <symbol id="tablet-android" viewBox="0 0 24 24">
            <path d="M18 0H6C4.34 0 3 1.34 3 3v18c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V3c0-1.66-1.34-3-3-3zm-4 22h-4v-1h4v1zm5.25-3H4.75V3h14.5v16z"></path>
        </symbol>
        <symbol id="info-outline" viewBox="0 0 24 24">
            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="close" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </symbol>
        <symbol id="help-outline" viewBox="0 0 24 24">
            <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="twitter">
            <path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z" />
        </symbol>
        <symbol id="github">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
        </symbol>
        <g id="notifications">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
        </g>
        <symbol id="homescreen" viewBox="0 0 24 24">
            <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41z" />
            <path d="M0 0h24v24H0V0z" fill="none" />
        </symbol>
        <symbol id="icon-theme" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26 c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></symbol>
        
        <!-- Add the sun icon for light mode -->
        <symbol id="icon-sun" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z" /></symbol>
    </svg>
    <!-- Scripts -->
    <!-- Load the language loader first -->
    
    <!-- Load other scripts -->
    <script src="../security_utils.js"></script>
    <script src="room-debugger.js"></script>
    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/private-rooms.js"></script>
    <script src="scripts/clipboard.js" async></script>

    <!-- Room functionality JavaScript -->
    <script>
        // Immediate room mode detection and forced styling
        (function() {
            console.log('=== IMMEDIATE HASH CHECK ===');
            console.log('Current hash:', window.location.hash);
            
            // Function to force room mode
            function forceRoomMode() {
                console.log('Forcing room mode display');
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer) {
                    roomContainer.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    roomContainer.classList.add('active');
                    console.log('Room container forced visible');
                }
                
                if (peerContainer) {
                    peerContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                    console.log('Peer container forced hidden');
                }
            }
            
            // Function to force peer mode  
            function forcePeerMode() {
                console.log('Forcing peer mode display');
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer) {
                    roomContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                    roomContainer.classList.remove('active');
                }
                
                if (peerContainer) {
                    peerContainer.style.cssText = 'display: block !important; visibility: visible !important;';
                }
            }
            
            // Apply immediate mode based on hash
            if (window.location.hash === '#rooms') {
                console.log('Hash is #rooms - applying room mode');
                
                // Set body data-mode attribute for CSS rules
                document.documentElement.setAttribute('data-mode', 'rooms');
                if (document.body) {
                    document.body.setAttribute('data-mode', 'rooms');
                } else {
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.setAttribute('data-mode', 'rooms');
                    });
                }
                
                // Apply immediately if elements exist
                if (document.getElementById('roomContainer')) {
                    forceRoomMode();
                } else {
                    // Wait for DOM and then apply
                    document.addEventListener('DOMContentLoaded', forceRoomMode);
                }
                
                // Also apply after a short delay as backup
                setTimeout(forceRoomMode, 100);
                setTimeout(forceRoomMode, 500);
            } else {
                console.log('Hash is not #rooms - applying peer mode');
                
                // Set body data-mode attribute for CSS rules
                document.documentElement.setAttribute('data-mode', 'transfer');
                if (document.body) {
                    document.body.setAttribute('data-mode', 'transfer');
                } else {
                    document.addEventListener('DOMContentLoaded', () => {
                        document.body.setAttribute('data-mode', 'transfer');
                    });
                }
                
                if (document.getElementById('peerContainer')) {
                    forcePeerMode();
                } else {
                    document.addEventListener('DOMContentLoaded', forcePeerMode);
                }
                
                setTimeout(forcePeerMode, 100);
            }
            
            // Add simple CSS override as backup
            const style = document.createElement('style');
            style.id = 'immediate-room-mode-styles';
            if (window.location.hash === '#rooms') {
                style.textContent = `
                    #roomContainer { 
                        display: flex !important; 
                        visibility: visible !important; 
                        opacity: 1 !important;
                    }
                    #peerContainer { 
                        display: none !important;
                    }
                `;
            } else {
                style.textContent = `
                    #roomContainer { display: none !important; }
                    #peerContainer { display: block !important; visibility: visible !important; }
                `;
            }
            document.head.appendChild(style);
            
            console.log('=== IMMEDIATE SETUP COMPLETE ===');
        })();

        // Room functionality management
        class RoomManager {
            constructor() {
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members = new Map();
                this.ws = null;
                this.fileStorage = null;
                
                console.log('RoomManager constructor started');
                
                // Initialize file storage
                this.initFileStorage();
                
                // Check room mode immediately - this is most important
                this.checkForRoomsMode();
                
                // Initialize UI 
                this.initializeRoomUI();
                
                // Set up file events
                this.setupFileEvents();
                
                // Check for saved room state and auto-reconnect
                this.checkAndReconnectRoom();
                
                console.log('RoomManager constructor completed');
            }
            
            // Check if in room mode
            checkForRoomsMode() {
                console.log('checkForRoomsMode - current URL hash:', window.location.hash);
                
                // Force immediate check without waiting for elements
                this.handleHashChange();
                
                // Add event listener only once
                if (!this.hashChangeListenerAdded) {
                    window.addEventListener('hashchange', () => {
                        console.log('URL hash changed:', window.location.hash);
                        this.handleHashChange();
                        updateNavActiveState(); // Update navigation active state on hash change
                    });
                    this.hashChangeListenerAdded = true;
                }
            }
            
            // Handle hash change
            handleHashChange() {
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOM elements not found, retrying later');
                    setTimeout(() => this.handleHashChange(), 50);
                    return;
                }
                
                if (window.location.hash === '#rooms') {
                    console.log('Switching to Room mode');
                    this.showRoomContainer();
                } else {
                    console.log('Switching to Transfer mode');
                    this.showPeerContainer();
                }
            }
            
            // Show room container
            showRoomContainer() {
                console.log('showRoomContainer starting execution');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.error('Cannot find container elements');
                    return;
                }
                
                // Show room container with maximum force
                roomContainer.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                roomContainer.classList.add('active');
                
                // Hide peer container with maximum force  
                peerContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                peerContainer.classList.remove('active');
                
                // Hide bottom user info area (device discovery info)
                this.hideBottomUserInfo();
                
                console.log('Room container forced to display, peer container forced to hide');
                
                // Show room options if not in a room
                setTimeout(() => {
                    if (!this.isInRoom) {
                        console.log('Not in room, ensuring room options are visible');
                        this.ensureRoomOptionsVisible();
                    }
                }, 100);
                
                // Delayed reconnection check
                setTimeout(() => {
                    this.checkAndReconnectRoom();
                }, 2000);
            }
            
            // Show device discovery container
            showPeerContainer() {
                console.log('showPeerContainer starting execution');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.error('Cannot find container elements for peer mode');
                    return;
                }
                
                // Hide room container with maximum force
                roomContainer.style.cssText = 'display: none !important; visibility: hidden !important;';
                roomContainer.classList.remove('active');
                
                // Show peer container with maximum force
                peerContainer.style.cssText = 'display: block !important; visibility: visible !important;';
                
                // Show bottom user info area
                this.showBottomUserInfo();
                
                console.log('Peer container forced to display, room container forced to hide');
            }
            
            // Initialize room UI events
            initializeRoomUI() {
                console.log('=== INITIALIZING ROOM UI ===');
                console.log('Current DOM state:', document.readyState);
                console.log('Window location hash:', window.location.hash);
                
                // Wait for DOM to fully load before binding events
                const bindEvents = () => {
                    console.log('=== ATTEMPTING TO BIND ROOM UI EVENTS ===');
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    const confirmCreateBtn = document.getElementById('confirmCreateRoom');
                    const cancelCreateBtn = document.getElementById('cancelCreateRoom');
                    const confirmJoinBtn = document.getElementById('confirmJoinRoom');
                    const cancelJoinBtn = document.getElementById('cancelJoinRoom');
                    
                    console.log('Button existence check:', {
                        createBtn: !!createBtn,
                        joinBtn: !!joinBtn,
                        confirmCreateBtn: !!confirmCreateBtn,
                        cancelCreateBtn: !!cancelCreateBtn,
                        confirmJoinBtn: !!confirmJoinBtn,
                        cancelJoinBtn: !!cancelJoinBtn
                    });
                    
                    if (!createBtn || !joinBtn || !confirmCreateBtn || !cancelCreateBtn || !confirmJoinBtn || !cancelJoinBtn) {
                        console.log('Some room buttons not found, waiting for DOM loading...');
                        console.log('Missing buttons:', {
                            createBtn: !createBtn,
                            joinBtn: !joinBtn, 
                            confirmCreateBtn: !confirmCreateBtn,
                            cancelCreateBtn: !cancelCreateBtn,
                            confirmJoinBtn: !confirmJoinBtn,
                            cancelJoinBtn: !cancelJoinBtn
                        });
                        setTimeout(bindEvents, 100);
                        return;
                    }
                    
                    console.log('‚úì All buttons found! Binding click events to room buttons...');
                    
                    // Create Room button (show form)
                    createBtn.addEventListener('click', (e) => {
                        console.log('Create Room button clicked!');
                        e.preventDefault();
                        this.showCreateRoomForm();
                    });
                
                    // Join Room button (show form)
                    joinBtn.addEventListener('click', (e) => {
                        console.log('Join Room button clicked!');
                        e.preventDefault();
                        this.showJoinRoomForm();
                    });
                    
                    // Confirm Create Room (actual room creation)
                    confirmCreateBtn.addEventListener('click', (e) => {
                        console.log('=== CREATE ROOM CONFIRM BUTTON CLICKED ===');
                        console.log('Room manager:', this);
                        console.log('Button element:', e.target);
                        e.preventDefault(); // Prevent form submission
                        this.createRoom();
                    });
                    
                    // Cancel Create Room
                    cancelCreateBtn.addEventListener('click', (e) => {
                        console.log('=== CANCEL CREATE ROOM BUTTON CLICKED ===');
                        console.log('Room manager:', this);
                        console.log('Button element:', e.target);
                        e.preventDefault(); // Prevent form submission
                        this.hideAllForms();
                    });
                    
                    // Confirm Join Room
                    confirmJoinBtn.addEventListener('click', (e) => {
                        console.log('=== JOIN ROOM CONFIRM BUTTON CLICKED ===');
                        e.preventDefault();
                        this.joinRoom();
                    });
                    
                    // Cancel Join Room
                    cancelJoinBtn.addEventListener('click', (e) => {
                        console.log('=== CANCEL JOIN ROOM BUTTON CLICKED ===');
                        e.preventDefault();
                        this.hideAllForms();
                    });
                    
                    console.log('‚úÖ ALL ROOM BUTTON EVENTS BOUND SUCCESSFULLY!');
                };
                
                // Start binding process
            // bindEvents(); // disabled to avoid duplicate upload init
                    
                    // Leave Room
                    document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                        this.leaveRoom();
                    });
                    
                    // Room Code input auto-uppercase
                    document.getElementById('roomCode').addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                    });
                    
                    // Room info expand/collapse
                    document.getElementById('toggleDetailsBtn').addEventListener('click', () => {
                        this.toggleRoomDetails();
                    });
                    
                    // CopyRoom Code
                    document.getElementById('copyRoomCode').addEventListener('click', () => {
                        this.copyRoomCode();
                    });
                    
                    // File selection and drag
                    this.initializeFileTransfer();
                    
                    console.log('Room UI event binding completed');
                };
                
                bindEvents();
            }
            
            // Initialize file transfer functionality (disabled - handled by global init)
            initializeFileTransfer() {
                // Prevent legacy/duplicate bindings in room UI layer
                return;
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const selectFilesBtn = document.getElementById('selectFilesBtn');
                
                if (!dropZone || !fileInput || !selectFilesBtn) {
                    console.log('File transfer elements not found, delayed initialization...');
                    setTimeout(() => this.initializeFileTransfer(), 100);
                    return;
                }
                
                // Prevent multiple event binding
                if (this.fileTransferInitialized) {
                    console.log('File transfer already initialized, skipping...');
                    return;
                }
                
                console.log('üîß Initializing file transfer functionality...');
                
            // Add single change event listener for file input
            fileInput.addEventListener('change', (e) => {
                console.log('üî• FILE INPUT CHANGE EVENT TRIGGERED!');
                console.log('üìÅ Files selected via input change:', e.target.files.length, 'files');
                console.log('üìÇ File details:', Array.from(e.target.files).map(f => ({name: f.name, size: f.size})));
                
                if (e.target.files.length > 0) {
                    console.log('‚ö° Calling handleFileInputChange...');
                    handleFileInputChange(e);
                } else {
                    console.log('‚ùå No files to process');
                }
            });
            
            // Mark as initialized to prevent multiple calls
            window.globalFileUploadInitialized = true;
            console.log('‚úÖ File upload initialization complete');
                
                // Drag functionality
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    console.log('üìÅ Files dropped:', e.dataTransfer.files.length, 'files');
                    this.handleFileSelection(e.dataTransfer.files);
                });
                
                this.fileTransferInitialized = true;
                console.log('‚úÖ File transfer functionality initialized successfully');
            }
            
            // Handle file selection
            handleFileSelection(files) {
                if (!this.isInRoom) {
                    alert('Please join a room first to upload files');
                    return;
                }
                
                if (files.length === 0) return;
                
                // Upload files directly to room
                this.uploadFilesToRoom(files);
            }
            
            // Upload files to room
            async uploadFilesToRoom(files) {
                console.log('Upload files to room:', files);
                
                for (const file of files) {
                    // Create file info
                    const fileInfo = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploader: this.getCurrentUserDisplayName(),
                        uploaderId: this.getCurrentUserId(),
                        uploadTime: Date.now(),
                        file: file, // Save file object for download
                        isAvailable: true // File availability status
                    };
                    
                    // Store to IndexedDB
                    await this.storeFileToIndexedDB(fileInfo);
                    
                    // Add to local shared list
                    this.addFileToSharedList(fileInfo);
                    
                    // Broadcast to other room members
                    this.broadcastFileToRoom(fileInfo);
                    
                    this.showToast(`File "${file.name}" uploaded to room`);
                }
            }
            
            // Get current user display name
            getCurrentUserDisplayName() {
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.textContent) {
                    const text = displayNameEl.textContent.trim();
                    console.log('Display name text:', text);
                    
                    // Extract the actual name from different possible formats:
                    // "You are called Orange Firefly" -> "Orange Firefly"
                    // "You are known as Orange Firefly" -> "Orange Firefly"
                    const calledMatch = text.match(/You are called (.+)$/i);
                    const knownMatch = text.match(/You are known as (.+)$/i);
                    
                    if (calledMatch) {
                        console.log('Found called format:', calledMatch[1]);
                        return calledMatch[1].trim();
                    } else if (knownMatch) {
                        console.log('Found known format:', knownMatch[1]);
                        return knownMatch[1].trim();
                    } else {
                        // Fallback: try to extract last two words (e.g., "Orange Firefly")
                        const words = text.split(/\s+/);
                        if (words.length >= 2) {
                            const lastName = words[words.length - 1];
                            const secondLastName = words[words.length - 2];
                            const result = `${secondLastName} ${lastName}`;
                            console.log('Fallback extraction:', result);
                            return result;
                        }
                        console.log('Using fallback Anonymous User');
                        return 'Anonymous User';
                    }
                }
                return 'Anonymous User';
            }
            
            // Add file to shared list
            addFileToSharedList(fileInfo) {
                const sharedFilesList = document.getElementById('sharedFilesList');
                const noFiles = sharedFilesList.querySelector('.no-shared-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.dataset.fileId = fileInfo.id;
                
                // Use unified display method
                this.updateFileItemDisplay(fileItem, fileInfo);
                
                sharedFilesList.appendChild(fileItem);
                this.updateFileCount();
            }
            
            // Get file icon
            getFileIcon(fileType) {
                if (!fileType) return 'üìÑ';
                
                if (fileType.startsWith('image/')) return 'üñºÔ∏è';
                if (fileType.startsWith('video/')) return 'üé•';
                if (fileType.startsWith('audio/')) return 'üéß';
                if (fileType.includes('pdf')) return 'üìÑ';
                if (fileType.includes('word')) return 'üìÑ';
                if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'üìà';
                if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'üìä';
                if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('archive')) return 'üóÑÔ∏è';
                return 'üìÅ';
            }
            
            // Update file count
            updateFileCount() {
                const fileCount = document.getElementById('fileCount');
                const fileItems = document.querySelectorAll('.shared-file-item');
                const count = fileItems.length;
                
                if (fileCount) {
                    fileCount.textContent = `${count}  files`;
                }
            }
            
            // Download shared file
            downloadSharedFile(fileId) {
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (!fileItem || !fileItem._fileData) {
                    this.showToast('File does not exist');
                    return;
                }
                
                const fileData = fileItem._fileData;
                
                // Check if file is available
                if (!fileData.file) {
                    if (fileData.isRemote) {
                        this.showToast('Cannot download: uploader needs to be online');
                    } else {
                        this.showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_file_unavailable') : 'File unavailable, uploader may be offline');
                    }
                    return;
                }
                
                if (fileData.isAvailable === false) {
                    this.showToast('File temporarily unavailable');
                    return;
                }
                
                try {
                    const url = URL.createObjectURL(fileData.file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast((window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_downloading') : 'Downloading') + ': ' + fileData.name);
                } catch (error) {
                    console.error('File download failed:', error);
                    this.showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_download_failed') : 'Download failed, please retry');
                }
            }
            
            // Remove shared file
            async removeSharedFile(fileId) {
                if (!confirm('Are you sure you want to delete this file?')) {
                    return;
                }
                
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // Delete from IndexedDB
                    await this.deleteFileFromIndexedDB(fileId);
                    
                    // Broadcasting file removal to other room members
                    this.broadcastFileRemoval(fileId);
                    
                    this.showToast('File deleted');
                }
                
                // Check if empty state needs to be shown
                const sharedFilesList = document.getElementById('sharedFilesList');
                const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                if (remainingFiles.length === 0) {
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                }
            }
            
            // Broadcasting file to other room members
            async broadcastFileToRoom(fileInfo) {
                console.log('Broadcasting file to room:', fileInfo.name);
                
                try {
                    // Convert file to transferable format
                    const fileData = await this.fileToBase64(fileInfo.file);
                    
                    // Broadcasting file info and data to other room members
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        },
                        fileData: fileData // Contains actual file data
                    });
                } catch (error) {
                    console.error('File broadcast failed:', error);
                    // If file too large, only send metadata
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        }
                    });
                }
            }
            
            // Convert file to Base64 format for transfer (with progress)
            async fileToBase64(file, onProgress = null) {
                // ÁßªÈô§Â§ßÂ∞èÈôêÂà∂ÔºåÊîØÊåÅ‰ªªÊÑèÂ§ßÂ∞èÊñá‰ª∂
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    // Ê∑ªÂä†ËøõÂ∫¶ÁõëÂê¨
                    if (onProgress && reader.addEventListener) {
                        reader.addEventListener('progress', (e) => {
                            if (e.lengthComputable) {
                                const progress = e.loaded / e.total;
                                onProgress(progress);
                            }
                        });
                    }
                    
                    reader.onload = () => {
                        if (onProgress) onProgress(1); // ÂÆåÊàê
                        resolve(reader.result);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // Restore file from Base64
            base64ToFile(dataUrl, fileName, fileType) {
                const arr = dataUrl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], fileName, { type: fileType });
            }
            
            // Broadcast file deletion
            broadcastFileRemoval(fileId) {
                this.sendMessage({
                    type: 'room-file-removed',
                    roomCode: this.currentRoom,
                    fileId: fileId
                });
            }
            
            // Initialize file storageÔºàIndexedDBÔºâ
            async initFileStorage() {
                try {
                    this.fileStorage = await this.openIndexedDB();
                    console.log('IndexedDB initialization successful');
                } catch (error) {
                    console.warn('IndexedDB initialization failed, using memory storage:', error);
                    this.fileStorage = null;
                }
            }
            
            // Open IndexedDB
            openIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('DropShareRoomFiles', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('roomCode', 'roomCode', { unique: false });
                        }
                    };
                });
            }
            
            // Store file to IndexedDB
            async storeFileToIndexedDB(fileInfo) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    
                    const fileData = {
                        id: fileInfo.id,
                        roomCode: this.currentRoom,
                        name: fileInfo.name,
                        size: fileInfo.size,
                        type: fileInfo.type,
                        uploader: fileInfo.uploader,
                        uploaderId: fileInfo.uploaderId,
                        uploadTime: fileInfo.uploadTime,
                        file: fileInfo.file // Store actual file
                    };
                    
                    await store.put(fileData);
                    console.log('File stored to IndexedDB:', fileInfo.name);
                } catch (error) {
                    console.error('File storage failed:', error);
                }
            }
            
            // Load room files from IndexedDB
            async loadRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return [];
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAll(roomCode);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('Failed to load room files:', error);
                    return [];
                }
            }
            
            // Delete from IndexedDBDocuments
            async deleteFileFromIndexedDB(fileId) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    await store.delete(fileId);
                    console.log('File deleted from IndexedDB:', fileId);
                } catch (error) {
                    console.error('File deletion failed:', error);
                }
            }
            
            // Clear room files (when leaving room)
            async clearRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAllKeys(roomCode);
                    
                    request.onsuccess = () => {
                        const keys = request.result;
                        keys.forEach(key => store.delete(key));
                        console.log(`Cleared all files from room`);
                    };
                } catch (error) {
                    console.error('Failed to clear room files:', error);
                }
            }
            
            // Format file size
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Get current user ID
            getCurrentUserId() {
                // Get current user ID from display name element, this ID is set during network connection
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.dataset.peerId) {
                    return displayNameEl.dataset.peerId;
                }
                // Backup method: get from network connection
                if (window.currentPeerId) {
                    return window.currentPeerId;
                }
                return null;
            }
            
            // Toggle room details display
            toggleRoomDetails() {
                const roomDetails = document.getElementById('roomDetails');
                const toggleIcon = document.querySelector('.toggle-icon');
                
                if (roomDetails.classList.contains('expanded')) {
                    roomDetails.classList.remove('expanded');
                    toggleIcon.classList.remove('rotated');
                } else {
                    roomDetails.classList.add('expanded');
                    toggleIcon.classList.add('rotated');
                }
            }
            
            // CopyRoom Code
            copyRoomCode() {
                const roomCodeText = document.getElementById('roomCodeDisplay').textContent;
                // Extract Room Code part (remove "Room Code: " prefix)
                const roomCode = roomCodeText.replace('Room Code: ', '');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(roomCode).then(() => {
                        this.showToast('Room Code copied to clipboard');
                    }).catch(err => {
                        console.error('Copy failed:', err);
                        this.fallbackCopyRoomCode(roomCode);
                    });
                } else {
                    this.fallbackCopyRoomCode(roomCode);
                }
            }
            
            // Backup copy method
            fallbackCopyRoomCode(roomCode) {
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('Room Code copied to clipboard');
                } catch (err) {
                    console.error('Copy failed:', err);
                    alert('Copy failed, Room Code: ' + roomCode);
                }
                document.body.removeChild(textArea);
            }
            
            // Show notification
            showToast(message) {
                // Create temporary notification element
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #374151;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 2000);
            }
            
            // Show Create Room form
            showCreateRoomForm() {
                this.hideAllForms();
                document.getElementById('createRoomForm').classList.add('active');
            }
            
            // Show Join Room form
            showJoinRoomForm() {
                this.hideAllForms();
                document.getElementById('joinRoomForm').classList.add('active');
            }
            
            // Hide all forms
            hideAllForms() {
                console.log('=== HIDE ALL FORMS CALLED ===');
                console.log('Form elements exist:', {
                    createRoomForm: !!document.getElementById('createRoomForm'),
                    joinRoomForm: !!document.getElementById('joinRoomForm'),
                    createRoomError: !!document.getElementById('createRoomError'),
                    joinRoomError: !!document.getElementById('joinRoomError')
                });
                
                document.getElementById('createRoomForm').classList.remove('active');
                document.getElementById('joinRoomForm').classList.remove('active');
                document.getElementById('createRoomError').style.display = 'none';
                document.getElementById('joinRoomError').style.display = 'none';
                
                console.log('Forms hidden successfully');
                
                // Clear form content to prevent browser auto-fill
                this.clearFormFields();
            }
            
            // Clear form fields
            clearFormFields() {
                document.getElementById('roomName').value = '';
                document.getElementById('roomPassword').value = '';
                document.getElementById('maxMembers').value = '10';
                document.getElementById('roomCode').value = '';
                document.getElementById('joinRoomPassword').value = '';
            }
            
            // Generate Room Code
            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            // Create Room
            createRoom() {
                console.log('=== CREATE ROOM FUNCTION CALLED ===');
                const roomName = document.getElementById('roomName').value.trim();
                const roomPassword = document.getElementById('roomPassword').value;
                const maxMembers = parseInt(document.getElementById('maxMembers').value);
                
                console.log('Form values:', { roomName, roomPassword, maxMembers });
                
                if (!roomName) {
                                         this.showError('createRoomError', 'Please enter Room Name');
                    return;
                }
                
                const roomCode = this.generateRoomCode();
                const roomSettings = {
                    code: roomCode,
                    name: roomName,
                    password: roomPassword,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                };
                
                console.log('Generated room settings:', roomSettings);
                
                // Send Create Room request to backend
                const message = {
                    type: 'create-room',
                    roomSettings: roomSettings
                };
                
                console.log('Sending create room message:', message);
                this.sendMessage(message);
            }
            
            // Join Room
            joinRoom() {
                const roomCode = document.getElementById('roomCode').value.trim();
                const password = document.getElementById('joinRoomPassword').value;
                
                if (!roomCode) {
                                         this.showError('joinRoomError', 'Please enter Room Code');
                    return;
                }
                
                // Send Join Room request to backend
                this.sendMessage({
                    type: 'join-room',
                    roomCode: roomCode,
                    password: password
                });
            }
            
            // Leave Room
            leaveRoom() {
                if (this.currentRoom) {
                    this.sendMessage({
                        type: 'leave-room',
                        roomCode: this.currentRoom
                    });
                }
            }
            
            // Show error message
            showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            // Send message to WebSocket
            sendMessage(message) {
                console.log('=== SEND MESSAGE DEBUG ===');
                console.log('Message:', message);
                console.log('Available objects:', {
                    'window.network': !!window.network,
                    'window.network.send': !!(window.network && window.network.send),
                    'window.network.isConnected': !!(window.network && window.network.isConnected),
                    'isConnected()': window.network ? window.network.isConnected() : 'N/A',
                    'window.serverConnection': !!window.serverConnection,
                    'window.serverConnection.send': !!(window.serverConnection && window.serverConnection.send)
                });
                
                // Check if network connection is available
                if (window.network && window.network.send && window.network.isConnected()) {
                    console.log('‚úì Using window.network.send()');
                    window.network.send(message);
                } else if (window.serverConnection && window.serverConnection.send) {
                    console.log('‚úì Using window.serverConnection.send()');
                    window.serverConnection.send(message);
                } else {
                    console.error('‚úó No available network connection');
                    console.warn('Network connection unavailable, message send failed:', message);
                    this.showError('createRoomError', 'Network connection unavailable, please try again later');
                }
            }
            
            // Handle room-related WebSocket messages
            handleRoomMessage(message) {
                console.log('=== ROOM MESSAGE RECEIVED ===', message);
                switch (message.type) {
                    case 'room-created':
                        console.log('Room created successfully:', message);
                        this.onRoomCreated(message);
                        break;
                    case 'room-joined':
                        console.log('Room joined successfully:', message);
                        this.onRoomJoined(message);
                        break;
                    case 'room-left':
                        console.log('Left room:', message);
                        this.onRoomLeft(message);
                        break;
                    case 'room-error':
                        console.log('Room error received:', message);
                        this.onRoomError(message);
                        break;
                    case 'room-member-joined':
                        console.log('Member joined room:', message);
                        this.onMemberJoined(message);
                        break;
                    case 'room-member-left':
                        console.log('Member left room:', message);
                        this.onMemberLeft(message);
                        break;
                    case 'room-disbanded':
                        console.log('Room disbanded:', message);
                        this.onRoomDisbanded(message);
                        break;
                    case 'room-file-shared':
                        console.log('File shared to room:', message);
                        this.onFileSharedToRoom(message);
                        break;
                    case 'room-file-removed':
                        console.log('File removed from room:', message);
                        this.onFileRemovedFromRoom(message);
                        break;
                    default:
                        console.log('Unknown room message type:', message.type);
                }
            }
            
            // Room created successfully
            async onRoomCreated(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = true;
                
                // Check if this is a reconnection
                if (this.waitingForReconnect) {
                    console.log('üéâ Successfully reconnected to room as host!');
                    showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_reconnect_success') : 'Successfully reconnected to room!');
                    this.waitingForReconnect = false;
                    this.savedStateForReconnect = null;
                }
                
                // Save room state to local storage
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: true,
                    password: message.room.password || ''
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // Initialize member list
                this.members.clear();
                this.members.set(message.hostInfo.id, message.hostInfo);
                this.updateMemberList([message.hostInfo]);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // Load previous files (if any)
                await this.loadPreviousRoomFiles();
                
                // Redistribute my files to other members (wait a bit after Create Room)
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // Join Room successful
            async onRoomJoined(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = false;
                
                // Check if this is a reconnection
                if (this.waitingForReconnect) {
                    console.log('üéâ Successfully reconnected to room!');
                    showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_reconnect_success') : 'Successfully reconnected to room!');
                    this.waitingForReconnect = false;
                    this.savedStateForReconnect = null;
                }
                
                // Save room state to local storage
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: false,
                    password: '' // Do not save password when joining
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // Initialize member list
                this.members.clear();
                message.members.forEach(member => {
                    this.members.set(member.id, member);
                });
                this.updateMemberList(message.members);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // Load previous files (if any)
                await this.loadPreviousRoomFiles();
                
                // Redistribute my files to other members (wait a bit after Join Room)
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // Leave room
            async onRoomLeft(message) {
                const roomCode = this.currentRoom;
                
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members.clear();
                
                // Clear room state from local storage
                this.clearRoomState();
                
                // Clear shared files list
                this.clearSharedFilesList();
                
                // Clear room files from IndexedDB
                if (roomCode) {
                    await this.clearRoomFilesFromIndexedDB(roomCode);
                }
                
                document.getElementById('roomInfo').classList.remove('active');
                this.hideAllForms();
                this.showRoomOptions();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                this.showBottomUserInfo();
                this.removeBeforeUnloadHandler();
            }
            
            // Hide bottom user info area
            hideBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                const userInfoBottomById = document.getElementById('userInfoBottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'none';
                    console.log('‚úÖ Bottom user info hidden (by class)');
                }
                if (userInfoBottomById) {
                    userInfoBottomById.style.display = 'none';
                    console.log('‚úÖ Bottom user info hidden (by ID)');
                }
            }
            
            // Show bottom user info area
            showBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'block';
                }
            }
            
            // Room error
            onRoomError(message) {
                // Check if this is a reconnection failure
                if (this.waitingForReconnect) {
                    console.log('üö´ Room reconnection failed:', message.error);
                    showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_reconnect_failed').replace('{error}', message.error) : 'Reconnection failed: ' + message.error);
                    this.waitingForReconnect = false;
                    this.savedStateForReconnect = null;
                    
                    // Clear invalid room state
                    this.clearRoomState();
                    
                    // Show room options so user can try again
                    this.showRoomOptions();
                    return;
                }
                
                const activeForm = document.querySelector('.room-form.active');
                if (activeForm) {
                    const errorId = activeForm.id === 'createRoomForm' ? 'createRoomError' : 'joinRoomError';
                    this.showError(errorId, message.error);
                } else {
                    console.log('Room error without active form:', message.error);
                    showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_room_error').replace('{error}', message.error) : 'Room error: ' + message.error);
                    this.showRoomOptions();
                    this.hideRoomInfo();
                    this.hideFileTransferArea();
                    this.hideRoomWarning();
                    this.showBottomUserInfo();
                    // Clear invalid room state
                    this.clearRoomState();
                }
            }
            
            // New member joined
            async onMemberJoined(message) {
                const memberId = message.member.id;
                const isMyself = memberId === this.getCurrentUserId();
                const isReconnect = message.isReconnect || false;
                
                // Check if already exists to avoid duplicate addition
                const wasAlreadyMember = this.members.has(memberId);
                
                // If duplicate member join event and not reconnection, ignore directly
                if (wasAlreadyMember && !isReconnect) {
                    console.log(`Ignore duplicate member join event: ${message.member.displayName} (${memberId})`);
                    return;
                }
                
                if (isReconnect) {
                    console.log(`Member reconnected: ${message.member.displayName} (${memberId})`);
                } else {
                    console.log(`New member joined: ${message.member.displayName} (${memberId})`);
                }
                
                this.members.set(memberId, message.member);
                this.updateMemberList(Array.from(this.members.values()));
                
                // Update the uploaded files status of this member to online and available
                this.updateUploaderStatus(memberId, true);
                
                // If I rejoined or reconnected, redistribute files
                if (isMyself) {
                    console.log('Detected self rejoin/reconnect room, redistributing files');
                    await this.redistributeMyFiles();
                }
            }
            
            // Redistribute my files to other room members
            async redistributeMyFiles() {
                try {
                    const myFiles = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    const myUploads = myFiles.filter(file => file.uploaderId === this.getCurrentUserId());
                    
                    for (const fileData of myUploads) {
                        if (fileData.file) {
                            console.log('Redistributing file:', fileData.name);
                            
                            // Re-broadcast file
                            const fileInfo = {
                                id: fileData.id,
                                name: fileData.name,
                                size: fileData.size,
                                type: fileData.type,
                                uploader: fileData.uploader,
                                uploaderId: fileData.uploaderId,
                                uploadTime: fileData.uploadTime,
                                file: fileData.file
                            };
                            
                            await this.broadcastFileToRoom(fileInfo);
                        }
                    }
                    
                    if (myUploads.length > 0) {
                        this.showToast(`Redistributed files to room members`);
                    }
                } catch (error) {
                    console.error('File redistribution failed:', error);
                }
            }
            
            // Member left
            onMemberLeft(message) {
                console.log(`Member left: ${message.memberId}, Reason: ${message.reason || 'unknown'}`);
                
                this.members.delete(message.memberId);
                this.updateMemberList(Array.from(this.members.values()));
                
                // If due to connection loss, set files to offline but keep them recoverable
                // If explicit exit, set as unavailable
                const isDisconnected = message.reason === 'disconnected';
                this.updateUploaderStatus(message.memberId, false, isDisconnected);
            }
            
            // Update uploader status
            updateUploaderStatus(uploaderId, isOnline, isDisconnected = false) {
                const fileItems = document.querySelectorAll('.shared-file-item');
                fileItems.forEach(item => {
                    const fileData = item._fileData;
                    if (fileData && fileData.uploaderId === uploaderId) {
                        // Update file data
                        fileData.uploaderOnline = isOnline;
                        
                        if (!isOnline) {
                            if (fileData.isRemote) {
                                fileData.isAvailable = false;
                                // If disconnected (not explicit exit), keep reconnectable status
                                fileData.canReconnect = isDisconnected;
                            }
                        } else if (isOnline && fileData.isRemote && fileData.file) {
                            fileData.isAvailable = true;
                            fileData.canReconnect = false;
                        }
                        
                        // Re-render this file item
                        this.updateFileItemDisplay(item, fileData);
                    }
                });
            }
            
            // Update single file item display
            updateFileItemDisplay(fileItem, fileData) {
                const fileIcon = this.getFileIcon(fileData.type);
                const uploadTime = new Date(fileData.uploadTime).toLocaleString();
                const isRestored = fileData.isRestored ? ' <span class="restored-tag">(' + (window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_restored') : 'Restored') + ')</span>' : '';
                const canDownload = fileData.file && fileData.isAvailable !== false;
                const isOwner = fileData.uploaderId === this.getCurrentUserId();
                
                // Determine file status display
                let statusHint = '';
                let itemClass = 'shared-file-item';
                
                if (!canDownload && !isOwner) {
                    if (fileData.isRemote) {
                        if (fileData.uploaderOnline === false) {
                            statusHint = '<span class="unavailable-hint">Uploader offline, cannot download</span>';
                            itemClass += ' file-offline';
                        } else if (!fileData.file) {
                            statusHint = '<span class="unavailable-hint">File too large, cannot download</span>';
                            itemClass += ' file-unavailable';
                        }
                    } else {
                        statusHint = '<span class="unavailable-hint">' + (window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_file_unavailable') : 'File unavailable') + '</span>';
                        itemClass += ' file-unavailable';
                    }
                }
                
                fileItem.className = itemClass;
                fileItem.innerHTML = `
                    <div class="shared-file-info">
                        <div class="shared-file-name">
                            <span class="file-icon">${fileIcon}</span>
                            ${fileData.name}${isRestored}
                        </div>
                        <div class="shared-file-details">
                            <span>${this.formatFileSize(fileData.size)}</span>
                            <span>Uploader: <span class="shared-file-uploader">${fileData.uploader}</span></span>
                            <span>${uploadTime}</span>
                            ${statusHint}
                        </div>
                    </div>
                    <div class="shared-file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadSharedFile('${fileData.id}')" ${!canDownload ? 'disabled' : ''}>${window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_download') : 'Download'}</button>
                        ${isOwner ? `<button class="action-btn btn-cancel" onclick="roomManager.removeSharedFile('${fileData.id}')">${window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_delete') : 'Delete'}</button>` : ''}
                    </div>
                `;
                
                // Update file data reference
                fileItem._fileData = fileData;
            }
            
            // Room disbanded
            onRoomDisbanded(message) {
                // Clear room state from local storage
                this.clearRoomState();
                // Clear shared files list
                this.clearSharedFilesList();
                alert('Room disbanded:  ' + message.reason);
                this.onRoomLeft();
            }
            
            // Show room info
            showRoomInfo(room) {
                // Update room info header
                document.getElementById('roomNameDisplay').textContent = room.name;
                document.getElementById('roomCodeDisplay').textContent = `Room Code: ${room.code}`;
                
                // Update current user name
                const currentUserName = this.getCurrentUserDisplayName();
                const currentUserNameEl = document.getElementById('currentUserName');
                if (currentUserNameEl) {
                    currentUserNameEl.textContent = currentUserName;
                }
                
                document.getElementById('roomInfo').classList.add('active');
            }
            
            // Update member list
            updateMemberList(members) {
                const memberList = document.getElementById('memberList');
                const memberCountNumber = document.getElementById('memberCountNumber');
                const memberNames = document.getElementById('memberNames');
                
                // Clear existing content
                if (memberList) memberList.innerHTML = '';
                if (memberNames) memberNames.innerHTML = '';
                
                // Sort members: host first, then others alphabetically
                const sortedMembers = members.sort((a, b) => {
                    if (a.isHost && !b.isHost) return -1;
                    if (!a.isHost && b.isHost) return 1;
                    return (a.displayName || a.name || 'Unknown').localeCompare(b.displayName || b.name || 'Unknown');
                });
                
                // Update detailed member list (in dropdown)
                sortedMembers.forEach(member => {
                    if (memberList) {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                        // ÂÆâÂÖ®Âú∞ÂàõÂª∫ÊàêÂëòÈ°πÂÜÖÂÆπ
                        const memberInfo = document.createElement('div');
                        memberInfo.className = 'member-info';
                        
                        const memberName = document.createElement('span');
                        memberName.className = 'member-name';
                        memberName.textContent = SecurityUtils.sanitizeDisplayName(member.displayName || member.name);
                        
                        const memberDevice = document.createElement('span');
                        memberDevice.className = 'member-device';
                        memberDevice.textContent = SecurityUtils.escapeHtml(member.deviceName || 'Unknown Device');
                        
                        memberInfo.appendChild(memberName);
                        memberInfo.appendChild(memberDevice);
                        
                        const memberRole = document.createElement('span');
                        memberRole.className = 'member-role';
                        memberRole.textContent = member.isHost ? 'üëë Host' : 'Member';
                        
                        memberItem.appendChild(memberInfo);
                        memberItem.appendChild(memberRole);
                    memberList.appendChild(memberItem);
                    }
                    this.members.set(member.id, member);
                });
                
                // Update compact member tags (main display)
                if (memberNames) {
                    sortedMembers.forEach(member => {
                        const memberTag = document.createElement('span');
                        memberTag.className = `member-tag ${member.isHost ? 'host' : ''}`;
                        
                        const displayName = SecurityUtils.sanitizeDisplayName(member.displayName || member.name);
                        if (member.isHost) {
                            const crown = document.createElement('span');
                            crown.className = 'host-crown';
                            crown.textContent = 'üëë';
                            memberTag.appendChild(crown);
                            memberTag.appendChild(document.createTextNode(displayName));
                        } else {
                            memberTag.textContent = displayName;
                        }
                        
                        memberNames.appendChild(memberTag);
                    });
                }
                
                // Update member count number
                if (memberCountNumber) {
                    memberCountNumber.textContent = members.length;
                }
                
                console.log(`üë• Updated member list: ${members.length} members`, sortedMembers.map(m => `${m.displayName || m.name}${m.isHost ? ' (Host)' : ''}`));
            }
            
            // Hide room option buttons
            hideRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: none !important;';
                }
            }
            
            // Hide room info
            hideRoomInfo() {
                const roomInfo = document.getElementById('roomInfo');
                if (roomInfo) {
                    roomInfo.classList.remove('active');
                }
            }
            
            // Show room option buttons
            showRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: flex !important;';
                }
            }
            
            // Ensure room options visible (only when not in room)
            ensureRoomOptionsVisible() {
                console.log('=== Ensure room options visible ===');
                
                // If already in room, should not show Create/Join buttons
                if (this.isInRoom) {
                    console.log('Already in room, not showing Create/Join buttons');
                    return;
                }
                
                // Hide all forms
                this.hideAllForms();
                
                // Hide room info and transfer area
                this.hideRoomInfo();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                
                // Clear shared files list
                this.clearSharedFilesList();
                
                // Show Create/Join buttons
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    console.log('Room option buttons displayed');
                    
                    // Check if buttons exist
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    console.log('Create button exists:', !!createBtn, 'Join button exists:', !!joinBtn);
                } else {
                    console.error('Cannot find .room-options element');
                }
                
                // Show bottom user info area
                this.showBottomUserInfo();
            }
            
            // Show file transfer area
            showFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.add('active');
                }
            }
            
            // Hide file transfer area
            hideFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.remove('active');
                }
            }
            
            // Handle room file sharing messages
            async onFileSharedToRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileInfo = message.fileInfo;
                // Only add files not uploaded by myself
                if (fileInfo.uploaderId !== this.getCurrentUserId()) {
                    try {
                        // If file data exists, restore file
                        if (message.fileData) {
                            fileInfo.file = this.base64ToFile(message.fileData, fileInfo.name, fileInfo.type);
                            fileInfo.isAvailable = true;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true;
                            
                            // Store received files to IndexedDB
                            await this.storeFileToIndexedDB(fileInfo);
                            
                            this.showToast(`${fileInfo.uploader} shared file: ${fileInfo.name}`);
                        } else {
                            // No file data, may be too large or uploader offline
                            fileInfo.file = null;
                            fileInfo.isAvailable = false;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true; // Assume online but file unavailable
                            
                            this.showToast(`${fileInfo.uploader} shared file: ${fileInfo.name} (File too large or unavailable)`);
                        }
                        
                        this.addFileToSharedList(fileInfo);
                    } catch (error) {
                        console.error('Failed to process received file:', error);
                        // If processing fails, at least show file info
                        fileInfo.file = null;
                        fileInfo.isAvailable = false;
                        fileInfo.isRemote = true;
                        fileInfo.uploaderOnline = true;
                        
                        this.addFileToSharedList(fileInfo);
                        this.showToast(`Error receiving file from ${fileInfo.uploader}`);
                    }
                }
            }
            
            // Handle room file deletion messages
            onFileRemovedFromRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileItem = document.querySelector(`[data-file-id="${message.fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // Check if empty state needs to be shown
                    const sharedFilesList = document.getElementById('sharedFilesList');
                    const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                    if (remainingFiles.length === 0) {
                        const noFiles = sharedFilesList.querySelector('.no-shared-files');
                        if (noFiles) {
                            noFiles.style.display = 'block';
                        }
                    }
                }
            }
            
            // Clear shared files list
            clearSharedFilesList() {
                const sharedFilesList = document.getElementById('sharedFilesList');
                if (sharedFilesList) {
                    // Remove all file items
                    const fileItems = sharedFilesList.querySelectorAll('.shared-file-item');
                    fileItems.forEach(item => item.remove());
                    
                    // Show empty state
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                    
                    this.updateFileCount();
                }
            }
            
            // Load previous room files
            async loadPreviousRoomFiles() {
                if (!this.currentRoom) return;
                
                try {
                    const files = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    console.log(`Loaded ${files.length} files from IndexedDB`);
                    
                    files.forEach(fileData => {
                        const fileInfo = {
                            id: fileData.id,
                            name: fileData.name,
                            size: fileData.size,
                            type: fileData.type,
                            uploader: fileData.uploader,
                            uploaderId: fileData.uploaderId,
                            uploadTime: fileData.uploadTime,
                            file: fileData.file,
                            isRestored: true, // Mark as restored file
                            isAvailable: fileData.file ? true : false // Set availability based on file existence
                        };
                        
                        this.addFileToSharedList(fileInfo);
                    });
                    
                    if (files.length > 0) {
                        this.showToast(`Restored ${files.length} previous files`);
                    }
                } catch (error) {
                    console.error('Failed to load previous files:', error);
                }
            }
            
            // Show room warning
            showRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                const warningTitle = document.getElementById('warningTitle');
                const warningMessage = document.getElementById('warningMessage');
                
                if (!roomWarning || !warningTitle || !warningMessage) return;
                
                if (this.isHost) {
                    warningTitle.textContent = 'Host Notice';
                    warningMessage.textContent = 'You are the host. Refreshing will auto-reconnect to the room. Only clicking "Leave Room" or closing the browser tab will disband the room.';
                } else {
                    warningTitle.textContent = 'Member Notice';
                    warningMessage.textContent = 'Refreshing will auto-reconnect to the room. Only clicking "Leave Room" or closing the browser tab will leave the room.';
                }
                
                roomWarning.classList.add('active');
            }
            
            // Hide room warning
            hideRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                if (roomWarning) {
                    roomWarning.classList.remove('active');
                }
            }
            
            // Setup before unload confirmation
            setupBeforeUnloadHandler() {
                // Track if it's a refresh operation
                this.isRefreshing = false;
                
                // Listen for keyboard shortcuts that indicate refresh
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')) {
                        this.isRefreshing = true;
                        console.log('üîÑ Ctrl+R refresh detected, marking as refresh operation');
                        setTimeout(() => this.isRefreshing = false, 1000); // Reset after 1 second
                    }
                    if (e.key === 'F5') {
                        this.isRefreshing = true;
                        console.log('üîÑ F5 refresh detected');
                        setTimeout(() => this.isRefreshing = false, 1000); // Reset after 1 second
                    }
                });
                
                // Track navigation type to detect back/forward vs close
                this.beforeUnloadHandler = (e) => {
                    if (this.isInRoom) {
                        if (this.isRefreshing) {
                            console.log('üîÑ Page refresh detected, keeping room state for reconnection');
                            // Don't clear room state for refresh - it will be used for reconnection
                            this.isRefreshing = false;
                            return; // Don't show confirmation for refresh
                        } else {
                            console.log('üö™ Page close/navigation detected, leaving room');
                            
                            // For immediate page close, send leave message synchronously
                            if (window.network && window.network.send) {
                                try {
                                    // Use navigator.sendBeacon for more reliable delivery during page unload
                                    const message = JSON.stringify({ type: 'leave-room' });
                                    if (navigator.sendBeacon) {
                                        // This is more reliable for page unload
                                        const blob = new Blob([message], { type: 'application/json' });
                                        navigator.sendBeacon(window.location.origin + '/leave-room', blob);
                                        console.log('üì§ Sent leave room message via sendBeacon');
                                    } else {
                                        // Fallback to regular send
                                        window.network.send({ type: 'leave-room' });
                                        console.log('üì§ Sent leave room message via WebSocket');
                                    }
                                } catch (error) {
                                    console.error('‚ùå Failed to send leave room message:', error);
                                }
                            }
                            
                            // Clear room state since user is leaving
                            this.clearRoomState();
                            
                            // Show confirmation for explicit close
                        const message = this.isHost 
                            ? 'Closing tab will disband the room! Are you sure you want to leave?' 
                            : 'Closing tab will leave the room! Are you sure you want to leave?';
                        
                        e.preventDefault();
                        e.returnValue = message;
                        return message;
                        }
                    }
                };
                
                window.addEventListener('beforeunload', this.beforeUnloadHandler);
            }
            
            // Remove before unload confirmation
            removeBeforeUnloadHandler() {
                if (this.beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', this.beforeUnloadHandler);
                    this.beforeUnloadHandler = null;
                }
            }
            
            // Ê∑ªÂä†ÂÜÖÂ≠òÊ∏ÖÁêÜÊñπÊ≥ï
            cleanup() {
                console.log('üßπ Cleaning up RoomManager resources...');
                
                // Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
                this.removeBeforeUnloadHandler();
                
                // Ê∏ÖÁêÜÊàêÂëòÊï∞ÊçÆ
                if (this.members) {
                    this.members.clear();
                }
                
                // Ê∏ÖÁêÜÊñá‰ª∂Êï∞ÊçÆ
                if (this.sharedFiles) {
                    this.sharedFiles.clear();
                }
                
                // Ê∏ÖÁêÜWebSocketËøûÊé•
                if (window.network && typeof window.network._disconnect === 'function') {
                    window.network._disconnect();
                }
                
                // Ê∏ÖÁêÜIndexedDBËøûÊé•
                if (this.fileStorage && typeof this.fileStorage.close === 'function') {
                    this.fileStorage.close();
                    this.fileStorage = null;
                }
                
                // ÈáçÁΩÆÁä∂ÊÄÅ
                this.isInRoom = false;
                this.isHost = false;
                this.currentRoom = null;
                
                console.log('‚úÖ RoomManager cleanup completed');
            }
            
            // Save room state to local storage
            saveRoomState(roomData) {
                try {
                    const roomState = {
                        ...roomData,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('dropshare_room_state', JSON.stringify(roomState));
                    console.log('Room state saved:', roomState);
                } catch (error) {
                    console.error('Failed to save room state:', error);
                }
            }
            
            // Load room state
            loadRoomState() {
                try {
                    const saved = localStorage.getItem('dropshare_room_state');
                    if (saved) {
                        const roomState = JSON.parse(saved);
                        // Check if state expired (24 hours)
                        const now = Date.now();
                        const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                        
                        if (now - roomState.timestamp < maxAge) {
                            console.log('Found saved room state:', roomState);
                            return roomState;
                        } else {
                            console.log('Room state expired, clearing');
                            this.clearRoomState();
                        }
                    }
                } catch (error) {
                    console.error('Failed to load room state:', error);
                    this.clearRoomState();
                }
                return null;
            }
            
            // Clear room state
            clearRoomState() {
                try {
                    localStorage.removeItem('dropshare_room_state');
                    console.log('Room state cleared');
                } catch (error) {
                    console.error('Failed to clear room state:', error);
                }
            }
            
            // Check and reconnect to room on page load
            checkAndReconnectRoom() {
                console.log('üîç Checking for saved room state...');
                
                const savedState = this.loadRoomState();
                if (savedState && savedState.roomCode) {
                    console.log('üì¶ Found saved room state, attempting to reconnect:', savedState);
                    
                    // Wait for network to be ready before attempting reconnection
                    this.waitForNetworkAndReconnect(savedState);
                } else {
                    console.log('üìù No saved room state found');
                }
            }
            
            // Wait for network and reconnect
            waitForNetworkAndReconnect(savedState) {
                const attemptReconnect = () => {
                    if (window.network && window.network.send) {
                        console.log('üåê Network ready, attempting to reconnect to room:', savedState.roomCode);
                        
                        // Send reconnect message to server
                        const reconnectMessage = {
                            type: 'join-room',
                            roomCode: savedState.roomCode,
                            password: savedState.password || ''
                        };
                        
                        console.log('üì§ Sending room reconnect message:', reconnectMessage);
                        window.network.send(reconnectMessage);
                        
                        // Show connecting message
                        showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_reconnecting') : 'Reconnecting to room...');
                        
                        // Set up one-time listener for reconnect success
                        this.waitingForReconnect = true;
                        this.savedStateForReconnect = savedState;
                        
                    } else {
                        console.log('‚è≥ Network not ready, retrying in 100ms...');
                        setTimeout(attemptReconnect, 100);
                    }
                };
                
                // Start attempting reconnection
                setTimeout(attemptReconnect, 500); // Wait a bit for everything to be initialized
            }
            
            // Setup file transfer event listeners
            setupFileEvents() {
                // Wait for Events system ready
                const setupEvents = () => {
                    if (!window.Events) {
                        setTimeout(setupEvents, 100);
                        return;
                    }
                    
                    // Listen for file received events
                    window.Events.on('file-received', (e) => {
                        this.handleFileReceived(e.detail);
                    });
                    
                    // Listen for file transfer progress events
                    window.Events.on('file-progress', (e) => {
                        this.handleFileProgress(e.detail);
                    });
                    
                    console.log('Room file transfer event listeners setup');
                };
                
                setupEvents();
            }
            
            // Handle file received
            handleFileReceived(fileData) {
                if (!this.isInRoom) return;
                
                console.log('File received in room:', fileData);
                
                // Show receive confirmation dialog (like snapdrop)
                this.showReceiveDialog(fileData);
            }
            
            // Show receive confirmation dialog
            showReceiveDialog(fileData) {
                const receiveDialog = document.getElementById('receiveDialog');
                const fileName = document.getElementById('fileName');
                const fileSize = document.getElementById('fileSize');
                const downloadBtn = document.getElementById('download');
                
                if (!receiveDialog || !fileName || !fileSize || !downloadBtn) {
                    console.error('Receive dialog elements not found');
                    // Fallback: directly download
                    this.downloadReceivedFile(fileData);
                    return;
                }
                
                // Set file information
                fileName.textContent = fileData.name;
                fileSize.textContent = this.formatFileSize(fileData.size || 0);
                
                // Set up download handler
                downloadBtn.onclick = () => {
                    this.downloadReceivedFile(fileData);
                    receiveDialog.close();
                };
                
                // Show the dialog
                receiveDialog.show();
                
                console.log('üì• Showing receive confirmation dialog for:', fileData.name);
            }
            
            // Download received file
            downloadReceivedFile(fileData) {
                try {
                    // Create download link
                    const link = document.createElement('a');
                    link.download = fileData.name;
                    
                    if (fileData.blob) {
                        // If we have blob data
                        link.href = URL.createObjectURL(fileData.blob);
                    } else {
                        console.error('No blob data available for file:', fileData.name);
                        showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_download_failed_no_data') : 'File download failed: no data');
                        return;
                    }
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up blob URL
                    if (fileData.blob) {
                        URL.revokeObjectURL(link.href);
                    }
                
                // Add to received files list
                this.addToReceivedFilesList(fileData);
                
                    // Show success notification
                    showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_file_saved').replace('{filename}', fileData.name) : `File saved: ${fileData.name}`);
                    
                    console.log('‚úÖ File downloaded:', fileData.name);
                } catch (error) {
                    console.error('‚ùå Download failed:', error);
                    showToast(window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_download_failed') : 'File download failed');
                }
            }
            
            // Format file size for display
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Handle file transfer progress
            handleFileProgress(progressData) {
                if (!this.isInRoom) return;
                
                // Update progress bar in transfer list
                this.updateTransferProgress(progressData.sender, progressData.progress);
            }
            
            // Add to received files list
            addToReceivedFilesList(fileData) {
                const receivedFilesList = document.getElementById('receivedFilesList');
                const noFiles = receivedFilesList.querySelector('.no-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-details">
                            ${this.formatFileSize(fileData.size)} ‚Ä¢ ${fileData.mime || 'Unknown type'}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadFile('${fileData.name}', this)">${window.DROPSHARE_I18N ? window.DROPSHARE_I18N.translate('share_download') : 'Download'}</button>
                    </div>
                `;
                
                // Store file data for download
                fileItem._fileData = fileData;
                
                receivedFilesList.appendChild(fileItem);
            }
            
            // Download file
            downloadFile(fileName, buttonElement) {
                const fileItem = buttonElement.closest('.file-item');
                const fileData = fileItem._fileData;
                
                if (fileData && fileData.blob) {
                    const url = URL.createObjectURL(fileData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('File download started');
                } else {
                    this.showToast('File download failed');
                }
            }
            
            // Update transfer progress
            updateTransferProgress(senderId, progress) {
                const transferItems = document.querySelectorAll('.transfer-item');
                transferItems.forEach(item => {
                    const progressBar = item.querySelector('.progress-fill');
                    if (progressBar) {
                        progressBar.style.width = `${Math.round(progress * 100)}%`;
                    }
                });
            }
            
            // Check and reconnect room
            checkAndReconnectRoom() {
                // Only try to reconnect in room mode
                if (window.location.hash !== '#rooms') {
                    return;
                }
                
                const roomState = this.loadRoomState();
                if (!roomState) {
                    console.log('No saved room state, keep showing room options');
                    return; // Do nothing, keep current state
                }
                
                console.log('Found saved room state, attempting reconnect:', roomState.roomCode);
                
                // Wait for network connection ready
                const attemptReconnect = () => {
                    if (!window.network || !window.network.isConnected()) {
                        console.log('Waiting for network connection...');
                        setTimeout(attemptReconnect, 300);
                        return;
                    }
                    
                    console.log('Network ready, starting room reconnection:', roomState.roomCode);
                    this.showToast('Reconnecting to room...');
                    
                    if (roomState.isHost) {
                        this.sendMessage({
                            type: 'create-room',
                            roomSettings: {
                                code: roomState.roomCode,
                                name: roomState.roomName,
                                password: roomState.password,
                                maxMembers: 50,
                                isPrivate: !!roomState.password
                            }
                        });
                    } else {
                        this.sendMessage({
                            type: 'join-room',
                            roomCode: roomState.roomCode,
                            password: roomState.password
                        });
                    }
                };
                
                setTimeout(attemptReconnect, 500);
            }
        }
        
        // Initialize room manager
        let roomManager;
        
        // Initialize language selector - EXACT COPY from main site
        function initializeLanguageSelector() {
            const languageSelector = document.getElementById('language-selector');
            const navbarLanguageSelector = document.getElementById('navbar-language-selector');
            
            if (languageSelector && window.DROPSHARE_I18N) {
                // Set current language
                const currentLang = window.DROPSHARE_I18N.getCurrentLanguage();
                languageSelector.value = currentLang;
                
                // Add change event listener
                languageSelector.addEventListener('change', function(e) {
                    const newLang = e.target.value;
                    console.log('Language changed to:', newLang);
                    
                    // Change language using unified system
                    if (window.DROPSHARE_I18N) {
                        window.DROPSHARE_I18N.changeLanguage(newLang);
                        translatePage();
                    }
                });
                
                console.log('Language selector initialized with language:', currentLang);
            }
            
            if (navbarLanguageSelector && window.DROPSHARE_I18N) {
                // Set current language
                const currentLang = window.DROPSHARE_I18N.getCurrentLanguage();
                navbarLanguageSelector.value = currentLang;
                
                // Add change event listener
                navbarLanguageSelector.addEventListener('change', function(e) {
                    const newLang = e.target.value;
                    console.log('Navbar language changed to:', newLang);
                    
                    // Change language using unified system
                    if (window.DROPSHARE_I18N) {
                        window.DROPSHARE_I18N.changeLanguage(newLang);
                        translatePage();
                    }
                });
                
                console.log('Navbar language selector initialized with language:', currentLang);
            }
        }
        
        // Sync language selector with current language - EXACT COPY from main site
        function syncLanguageSelector() {
            const languageSelector = document.getElementById('language-selector');
            const navbarLanguageSelector = document.getElementById('navbar-language-selector');
            
            if (languageSelector && window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.getCurrentLanguage === 'function') {
                const currentLang = window.DROPSHARE_I18N.getCurrentLanguage();
                languageSelector.value = currentLang;
                console.log('Language selector synced to:', currentLang);
            }
            
            if (navbarLanguageSelector && window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.getCurrentLanguage === 'function') {
                const currentLang = window.DROPSHARE_I18N.getCurrentLanguage();
                navbarLanguageSelector.value = currentLang;
                console.log('Navbar language selector synced to:', currentLang);
            }
        }
        
        // Translation function - same as homepage
        function translatePage() {
            console.log('translatePage called');
            if (typeof window.DROPSHARE_I18N === 'undefined') {
                console.log('Translation system not loaded yet');
                return;
            }
            
            const elements = document.querySelectorAll('[data-i18n]');
            console.log('Found', elements.length, 'elements to translate');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                const translation = window.DROPSHARE_I18N.t(key);
                
                if (translation && translation !== key) {
                    if (element.tagName === 'INPUT' && element.type === 'button') {
                        element.value = translation;
                    } else if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'password')) {
                        element.placeholder = translation;
                    } else {
                        element.textContent = translation;
                    }
                    console.log('Translated', key, 'to', translation);
                }
            });
        }
        
        // DEBUG: Add debug function to manually test room manager
        window.debugRoomManager = function() {
            console.log('=== MANUAL DEBUG OF ROOM MANAGER ===');
            console.log('Available objects:', {
                network: !!window.network,
                serverConnection: !!window.serverConnection,
                Events: !!window.Events,
                roomManager: !!window.roomManager
            });
            
            if (!window.roomManager && window.network) {
                console.log('Creating RoomManager manually...');
                try {
                    window.roomManager = new RoomManager();
                    console.log('‚úÖ RoomManager created successfully!');
                } catch (error) {
                    console.error('‚ùå Failed to create RoomManager:', error);
                }
            }
            
            // Test button binding manually
                    if (window.roomManager) {
                const confirmBtn = document.getElementById('confirmCreateRoom');
                const cancelBtn = document.getElementById('cancelCreateRoom');
                
                if (confirmBtn && cancelBtn) {
                    console.log('Manually binding buttons...');
                    confirmBtn.onclick = () => {
                        console.log('=== MANUAL CREATE BUTTON CLICKED ===');
                        window.roomManager.createRoom();
                    };
                    cancelBtn.onclick = () => {
                        console.log('=== MANUAL CANCEL BUTTON CLICKED ===');
                        window.roomManager.hideAllForms();
                    };
                    console.log('‚úÖ Buttons manually bound!');
            } else {
                    console.log('‚ùå Buttons not found');
                }
            }
        };
        
        // DEBUG: Test functions for the buttons
        window.testCreateRoom = function() {
            console.log('üîµ === CREATE ROOM BUTTON CLICKED (DIRECT) ===');
            console.log('Form values:', {
                roomName: document.getElementById('roomName').value,
                roomPassword: document.getElementById('roomPassword').value,
                maxMembers: document.getElementById('maxMembers').value
            });
            
            // Check if roomManager exists
            if (window.roomManager) {
                console.log('‚úÖ RoomManager exists, calling createRoom()');
                window.roomManager.createRoom();
            } else {
                console.log('‚ùå RoomManager not found, creating manually...');
                if (window.network) {
                try {
                    window.roomManager = new RoomManager();
                        console.log('‚úÖ RoomManager created, calling createRoom()');
                        window.roomManager.createRoom();
                } catch (error) {
                        console.error('‚ùå Failed to create RoomManager:', error);
                        
                        // Manual room creation
                        console.log('üîß Attempting manual room creation...');
                        const roomName = document.getElementById('roomName').value.trim();
                        if (!roomName) {
                            alert('Please enter Room Name');
                            return;
                        }
                        
                        const message = {
                            type: 'create-room',
                            roomSettings: {
                                code: Math.random().toString(36).substr(2, 8).toUpperCase(),
                                name: roomName,
                                password: document.getElementById('roomPassword').value,
                                maxMembers: parseInt(document.getElementById('maxMembers').value),
                                isPrivate: !!document.getElementById('roomPassword').value
                            }
                        };
                        
                        console.log('üì§ Sending manual room creation message:', message);
                        if (window.network && window.network.send) {
                            window.network.send(message);
            } else {
                            console.error('‚ùå No network connection available');
                        }
                    }
                } else {
                    console.error('‚ùå No network available');
                }
            }
        };
        
        window.testCancelRoom = function() {
            console.log('üî¥ === CANCEL ROOM BUTTON CLICKED (DIRECT) ===');
            
            // Check if roomManager exists
                    if (window.roomManager) {
                console.log('‚úÖ RoomManager exists, calling hideAllForms()');
                window.roomManager.hideAllForms();
            } else {
                console.log('‚ùå RoomManager not found, hiding forms manually...');
                // Manual form hiding
                const createForm = document.getElementById('createRoomForm');
                const joinForm = document.getElementById('joinRoomForm');
                
                if (createForm) {
                    createForm.classList.remove('active');
                    console.log('‚úÖ Create form hidden manually');
                }
                if (joinForm) {
                    joinForm.classList.remove('active');
                    console.log('‚úÖ Join form hidden manually');
                }
                
                // Clear form fields
                document.getElementById('roomName').value = '';
                document.getElementById('roomPassword').value = '';
                document.getElementById('maxMembers').value = '10';
                console.log('‚úÖ Form fields cleared manually');
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DOMContentLoaded EVENT TRIGGERED ===');
            console.log('Document ready state:', document.readyState);
            
            // Initialize translations - EXACT COPY from main site
            setTimeout(() => {
                console.log('Starting translation initialization...');
                
                // Initialize language selector first
                initializeLanguageSelector();
                
                // Then translate the page
                if (typeof translatePage === 'function') {
                    translatePage();
                }
                
                // Sync language selector with current language
                setTimeout(() => {
                    syncLanguageSelector();
                }, 100);
            }, 100);
            
            // Initialize room manager after language setup
            const initRoomManager = () => {
                console.log('=== ATTEMPTING TO INITIALIZE ROOM MANAGER ===');
                
                // Check if network is ready before initializing room manager
                if (!window.network && !window.serverConnection) {
                    console.log('Network not ready, waiting...');
                    console.log('Available objects:', {
                        network: !!window.network,
                        serverConnection: !!window.serverConnection,
                        Events: !!window.Events
                    });
                    setTimeout(initRoomManager, 100);
                    return;
                }
                
                // Force initialize RoomManager regardless of DOM state
                if (!window.roomManager) {
                    console.log('Creating room manager...');
                    console.log('Network status:', {
                        network: !!window.network,
                        serverConnection: !!window.serverConnection,
                        Events: !!window.Events
                    });
                    
                    try {
                        window.roomManager = new RoomManager();
                        roomManager = window.roomManager;
                        console.log('‚úÖ Room manager initialization completed successfully');
                    } catch (error) {
                        console.error('‚ùå Failed to initialize room manager:', error);
                        // Retry after a delay
                        setTimeout(initRoomManager, 200);
                    }
                } else {
                    console.log('Room manager already exists');
                }
            };
            
            // Initialize immediately
            console.log('Calling initRoomManager...');
            initRoomManager();
        });
        
        // Additional checks after page fully loaded
        window.addEventListener('load', function() {
            console.log('Page fully loaded, checking room status');
            console.log('Current hash:', window.location.hash);
            
            // Ensure RoomManager is initialized
            if (!window.roomManager) {
                console.log('RoomManager not found on page load, force initializing...');
                try {
                    window.roomManager = new RoomManager();
                    console.log('RoomManager force initialized on page load');
                } catch (error) {
                    console.error('Failed to force initialize RoomManager:', error);
                }
            }
            
            // Initialize navigation bar function links
            initNavbarFunctionLinks();
            
            // Ensure room mode is properly activated
            if (window.location.hash === '#rooms') {
                console.log('Hash is #rooms, ensuring room container is visible');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer && peerContainer) {
                    // Force show room container
                    roomContainer.style.display = 'flex';
                    roomContainer.classList.add('active');
                    
                    // Force hide peer container
                    peerContainer.style.display = 'none';
                    
                    console.log('Room container display forced to flex, peer container hidden');
                    
                    // If room manager exists, trigger room options
                    if (window.roomManager) {
                        setTimeout(() => {
                            if (!window.roomManager.isInRoom) {
                                window.roomManager.ensureRoomOptionsVisible();
                            }
                        }, 100);
                    }
                }
            }
            
            // Initialize navigation bar function links
            initNavbarFunctionLinks();
        });
        


        // Initialize navigation bar function links
        function initNavbarFunctionLinks() {
            // Multi-user Rooms link
            const roomsLink = document.querySelector('a[href="/share.html#rooms"]');
            if (roomsLink) {
                roomsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '#rooms';
                    console.log('Switching to Rooms mode');
                    updateNavActiveState();
                });
            }

            // Transfer link  
            const transferLink = document.querySelector('a[href="/share.html"]');
            if (transferLink) {
                transferLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    console.log('Switching to Transfer mode');
                    updateNavActiveState();
                });
            }

            // Initial state
            updateNavActiveState();
            
            // Transfer link (back to main page)
            const transferLink = document.querySelector('a[href="/"]');
            if (transferLink) {
                transferLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    console.log('Switching to Transfer mode');
                });
            }
            
            // Add file type filter function entry
            const imageLink = document.querySelector('a[href="#images"]');
            const audioLink = document.querySelector('a[href="#audio"]'); 
            const videoLink = document.querySelector('a[href="#video"]');
            const filesLink = document.querySelector('a[href="#files"]');
            
            [imageLink, audioLink, videoLink, filesLink].forEach(link => {
                if (link) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const type = this.getAttribute('href').substring(1);
                        showFileTypeFilter(type);
                    });
                }
            });
        }
        
        // Show file type filter (temporary notification, can expand functionality later)
        function showFileTypeFilter(type) {
            const typeNames = {
                'images': 'Images',
                'audio': 'Audio', 
                'video': 'Video',
                'files': 'Documents'
            };
            
            if (window.roomManager) {
                window.roomManager.showToast(`${typeNames[type]} functionality is in development`);
            } else {
                alert(`${typeNames[type]} functionality is in development`);
            }
            
            console.log(`Switching to ${typeNames[type]} mode`);
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="scripts/firebase-analytics.js"></script>
    
    
    <!-- Sounds -->
    <audio id="blop" autobuffer="true">
        <source src="/sounds/blop.mp3" type="audio/mpeg">
        <source src="/sounds/blop.ogg" type="audio/ogg">
    </audio>
    <!-- no script -->
    <noscript>
        <x-noscript class="full center column">
            <h1 data-i18n="share_enable_javascript">Enable JavaScript</h1>
            <h3 data-i18n="share_javascript_required">DropShare works only with JavaScript</h3>
        </x-noscript>
        <style>
        x-noscript {
            background: #599cfc;
            color: white;
            z-index: 2;
        }

        a[href="#info"] {
            color: white;
        }
        </style>
    </noscript>
</body>

</html>