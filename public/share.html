<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <!-- Web App Config -->
    <title>DropShare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3367d6">
    <meta name="color-scheme" content="dark light">
    <meta name="apple-mobile-web-app-capable" content="no">
    <meta name="apple-mobile-web-app-title" content="DropShare">
    <!-- Descriptions -->
    <meta name="description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="keywords" content="File, Transfer, Share, Peer2Peer">
    <meta name="author" content="RobinLinus">
    <meta property="og:title" content="DropShare">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://snapdrop.net/">
    <meta property="og:author" content="https://facebook.com/RobinLinus">
    <meta name="twitter:author" content="@RobinLinus">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <meta name="og:description" content="Instantly share images, videos, PDFs, and links with people nearby. Peer2Peer and Open Source. No Setup, No Signup.">
    <!-- Icons -->
    <link rel="icon" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="shortcut icon" href="images/favicon-96x96.png">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <meta name="msapplication-TileImage" content="images/mstile-150x150.png">
    <link rel="fluid-icon" type="image/png" href="images/android-chrome-192x192.png">
    <meta name="twitter:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <meta property="og:image" content="https://snapdrop.net/images/twitter-stream.jpg">
    <!-- Resources -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <style>
        /* Override styles.css layout for centered sharing page */
        body {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: flex-start !important;
            min-height: 100vh !important;
            overflow-y: auto !important;
        }
        
        /* Main page container */
        .page-container {
            display: flex;
            flex-direction: column;
            width: 100%;
            min-height: 100vh;
            position: relative;
            padding-top: 80px;
        }
        
        /* Message area in the center */
        .center-message {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }
        
        /* User info at bottom */
        .user-info-bottom {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            z-index: 100;
        }
        
        /* Style the peer area */
        x-peers {
            display: flex !important;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        /* Center the no-peers message */
        x-no-peers {
            margin: 20px 0;
        }
        
        /* Center footer content */
        footer {
            position: static !important;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        
        /* Hide instructions container that interferes */
        .instructions-container {
            display: none;
        }
        
        /* éšè—è¿”å›é¦–é¡µæŒ‰é’® */
        .back-home-btn {
            display: none !important;
        }
        
        /* æˆ¿é—´åŠŸèƒ½æ ·å¼ */
        .room-container {
            display: none;
            flex-direction: column;
            gap: 24px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .room-container.active {
            display: flex !important;
        }
        
        .room-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .room-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
        }
        
        .room-subtitle {
            font-size: 1.125rem;
            color: #64748b;
            margin: 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-options {
            display: flex !important;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .room-forms-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
            width: 100%;
            padding: 0 20px; /* å¢åŠ å·¦å³å†…è¾¹è·ï¼Œç¡®ä¿åœ¨å°å±å¹•ä¸Šä¹Ÿæœ‰é—´è· */
            box-sizing: border-box;
        }
        
        .room-btn {
            padding: 14px 28px;
            background: #3367d6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .room-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        
        .room-btn.secondary {
            background: transparent;
            color: #3367d6;
            border: 2px solid #3367d6;
        }
        
        .room-btn.secondary:hover {
            background: #3367d6;
            color: white;
        }
        
        .room-form {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 0 auto; /* æ°´å¹³å±…ä¸­ */
            position: relative;
            z-index: 1050; /* ç¡®ä¿åœ¨å¯¼èˆªæ ä¹‹ä¸Š */
            box-sizing: border-box; /* ç¡®ä¿paddingåŒ…å«åœ¨widthå†… */
        }
        
        .room-form.active {
            display: block;
        }
        
        .room-form h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box; /* ç¡®ä¿paddingå’ŒborderåŒ…å«åœ¨widthå†… */
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3367d6;
        }
        
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .form-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-sizing: border-box; /* ç¡®ä¿paddingåŒ…å«åœ¨widthå†… */
        }
        
        .btn-primary {
            background: #3367d6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .btn-cancel:hover {
            background: #e5e7eb;
        }
        
        .room-info {
            display: none;
            background: #f0f9ff;
            border-radius: 12px;
            border-left: 4px solid #3367d6;
            margin-bottom: 24px;
            overflow: hidden;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .room-info.active {
            display: block;
        }
        
        .room-info-header {
            padding: 16px 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .room-info-header:hover {
            background: #f1f5f9;
        }
        
        .room-summary {
            display: flex;
            flex-direction: column;
            gap: 4px;
            align-items: flex-start;
        }
        
        .room-name-display {
            font-weight: 600;
            color: #1e293b;
            font-size: 16px;
        }
        
        .room-code-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .room-code-display {
            font-family: monospace;
            color: #3367d6;
            font-weight: 600;
            font-size: 14px;
        }
        
        .copy-btn-small {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            transition: background 0.2s;
        }
        
        .copy-btn-small:hover {
            background: #f1f5f9;
        }
        
        .member-count {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-info {
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 4px 0;
        }
        
        .current-user-label {
            font-size: 12px;
            color: #64748b;
        }
        
        .current-user-name {
            font-size: 12px;
            color: #3367d6;
            font-weight: 600;
            background: #f0f9ff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #bfdbfe;
        }
        
        .toggle-details-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .toggle-details-btn:hover {
            background: #e2e8f0;
        }
        
        .toggle-icon {
            transition: transform 0.2s;
            color: #64748b;
        }
        
        .toggle-icon.rotated {
            transform: rotate(180deg);
        }
        
        .room-details {
            padding: 0 20px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        
        .room-details.expanded {
            max-height: 200px;
            padding: 16px 20px;
        }
        
        .room-members-section {
            font-size: 14px;
        }
        
        .room-members-section strong {
            display: block;
            margin-bottom: 12px;
            color: #374151;
        }
        
        .room-actions {
            padding: 16px 20px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
            text-align: center;
        }
        
        .btn-leave-room {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-leave-room:hover {
            background: #dc2626;
        }
        
        /* æˆ¿é—´è­¦å‘Šæç¤ºæ ·å¼ */
        .room-warning {
            display: none;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            margin-bottom: 24px;
            padding: 16px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .room-warning.active {
            display: block;
        }
        
        .warning-content {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }
        
        .warning-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .warning-text {
            flex: 1;
        }
        
        .warning-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 4px;
            font-size: 14px;
        }
        
        .warning-message {
            color: #92400e;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .room-members {
            margin-top: 20px;
        }
        
        .member-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: stretch;
        }
        
        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }
        
        .member-name {
            font-weight: 500;
        }
        
        .member-role {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
        }
        
        .error-message {
            color: #ef4444;
            background: #fef2f2;
            padding: 12px;
            border-radius: 6px;
            margin-top: 12px;
            text-align: center;
        }
        
        /* æˆ¿é—´æ–‡ä»¶å…±äº«åŒºåŸŸæ ·å¼ */
        .file-transfer-area {
            display: none;
            width: 100%;
            margin-top: 24px;
        }
        
        .room-file-sharing {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        .file-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .file-transfer-area.active {
            display: block;
        }
        
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .shared-files-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }
        
        .upload-section h3, .shared-files-section h3 {
            margin: 0 0 16px 0;
            color: #374151;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .shared-files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .file-count {
            color: #6b7280;
            font-size: 14px;
            background: #f3f4f6;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .upload-hint {
            color: #6b7280;
            font-size: 14px;
            margin: 4px 0 12px 0;
        }
        
        .drop-zone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3367d6;
            background: #f0f9ff;
        }
        
        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .upload-icon {
            color: #9ca3af;
            margin-bottom: 8px;
        }
        
        .drop-zone p {
            color: #6b7280;
            margin: 0;
            font-size: 16px;
        }
        
        .select-files-btn {
            background: #3367d6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .select-files-btn:hover {
            background: #2563eb;
        }
        
        .shared-files-list {
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .no-shared-files {
            text-align: center;
            color: #9ca3af;
            padding: 40px 20px;
        }
        
        .no-shared-files p {
            margin: 8px 0;
        }
        
        .no-shared-files .hint {
            font-size: 14px;
            color: #6b7280;
        }
        
        .shared-file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            background: #fafafa;
            transition: all 0.2s;
        }
        
        .shared-file-item:hover {
            background: #f0f9ff;
            border-color: #3367d6;
        }
        
        .shared-file-info {
            flex: 1;
        }
        
        .shared-file-name {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-icon {
            font-size: 16px;
        }
        
        .shared-file-details {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            gap: 16px;
        }
        
        .shared-file-uploader {
            color: #3367d6;
            font-weight: 500;
        }
        
        .restored-tag {
            color: #f59e0b;
            font-size: 12px;
            font-weight: normal;
        }
        
        .unavailable-hint {
            color: #ef4444;
            font-size: 12px;
            font-style: italic;
        }
        
        .action-btn:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* æ–‡ä»¶çŠ¶æ€æ ·å¼ */
        .shared-file-item.file-offline {
            opacity: 0.6;
            background: #f8f9fa;
            border-color: #e9ecef;
        }
        
        .shared-file-item.file-offline .shared-file-name {
            color: #6c757d;
        }
        
        .shared-file-item.file-unavailable {
            opacity: 0.7;
            background: #fdf2f2;
            border-color: #fecaca;
        }
        
        .shared-file-item.file-unavailable .shared-file-name {
            color: #991b1b;
        }
        
        .file-status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            vertical-align: middle;
        }
        
        .status-online {
            background: #10b981;
        }
        
        .status-offline {
            background: #ef4444;
        }
        
        .status-unavailable {
            background: #f59e0b;
        }
        
        .shared-file-actions {
            display: flex;
            gap: 8px;
        }
        
        .transfer-item, .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #fafafa;
        }
        
        .transfer-info, .file-info {
            flex: 1;
        }
        
        .transfer-name, .file-name {
            font-weight: 500;
            color: #374151;
            margin-bottom: 4px;
        }
        
        .transfer-details, .file-details {
            font-size: 12px;
            color: #6b7280;
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            margin: 8px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3367d6;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .transfer-actions, .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
        }
        
        .btn-download {
            background: #10b981;
            color: white;
        }
        
        .btn-download:hover {
            background: #059669;
        }
        
        .btn-cancel {
            background: #ef4444;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #dc2626;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .room-file-sharing {
                gap: 16px;
            }
            
            .upload-section, .shared-files-section {
                padding: 20px;
            }
            
            .room-container {
                max-width: 800px;
                padding: 20px;
            }
            
            .room-info {
                max-width: 100%;
            }
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .back-home-btn {
                top: 16px;
                left: 16px;
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .room-container {
                max-width: 100%;
                padding: 16px;
                gap: 20px;
            }
            
            .room-options {
                flex-direction: column;
                gap: 12px;
            }
            
            .room-btn {
                width: 100%;
                padding: 16px;
            }
            
            .room-form {
                padding: 20px;
            }
            
            .shared-file-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            
            .shared-file-actions {
                justify-content: center;
            }
            
            .drop-zone {
                padding: 30px 20px;
            }
            
            .upload-section h3, 
            .transfer-list-section h3, 
            .received-files-section h3 {
                font-size: 16px;
            }
            
            .room-title {
                font-size: 1.875rem;
            }
            
            .room-subtitle {
                font-size: 1rem;
            }
            
            .room-header {
                margin-bottom: 24px;
            }
        }
        
        /* å¤§å±å¹•ä¼˜åŒ– */
        @media (min-width: 1400px) {
            .room-container {
                max-width: 1400px;
            }
            
            .file-transfer-grid {
                gap: 32px;
            }
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ æ ·å¼ */
        .top-navbar {
            background: #fff;
            border-bottom: 1px solid #e5e7eb;
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 60px;
        }
        
        .navbar-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            padding: 0 20px;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #3367d6;
            font-size: 24px;
            font-weight: 600;
        }
        
        .navbar-brand .brand-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            fill: currentColor;
        }
        
        .navbar-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .nav-item {
            margin: 0;
        }
        
        .nav-link {
            padding: 8px 16px;
            text-decoration: none;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        .nav-link:hover {
            color: #3367d6;
            background: #f3f4f6;
        }

        .nav-link.active {
            color: #3367d6;
            background: #e3f2fd;
            font-weight: 600;
        }
        
        .language-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .language-selector select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* è°ƒæ•´é¡µé¢å†…å®¹ï¼Œä¸ºå›ºå®šå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        body {
            padding-top: 60px !important;
        }
        
        .page-container {
            padding-top: 20px; /* å‡å°‘åŸæœ‰çš„top padding */
        }
        
        /* å“åº”å¼å¯¼èˆªæ  */
        @media (max-width: 768px) {
            .navbar-container {
                padding: 0 16px;
            }
            
            .navbar-brand {
                font-size: 20px;
            }
            
            .navbar-brand .brand-icon {
                width: 28px;
                height: 28px;
                margin-right: 8px;
            }
            
            .navbar-nav {
                gap: 4px;
            }
            
            .nav-link {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .language-selector select {
                padding: 4px 8px;
                font-size: 13px;
            }
        }
    </style>
</head>

<body translate="no">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="top-navbar">
        <div class="navbar-container">
            <!-- å“ç‰ŒLOGO -->
            <a href="/" class="navbar-brand">
                <svg class="brand-icon" viewBox="0 0 24 24">
                    <use xlink:href="#wifi-tethering" />
                </svg>
                DropShare
            </a>
            
            <!-- å¯¼èˆªèœå• -->
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="/share.html" class="nav-link active" data-i18n="nav_transfer">ä¼ é€</a>
                </li>
                <li class="nav-item">
                    <a href="/share.html#rooms" class="nav-link" data-i18n="nav_rooms">å¤šäººæˆ¿é—´</a>
                </li>
                <li class="nav-item">
                    <a href="image-tools.html" class="nav-link" data-i18n="nav_images">å›¾ç‰‡</a>
                </li>
                <li class="nav-item">
                    <a href="audio-tools.html" class="nav-link" data-i18n="nav_audio">éŸ³é¢‘</a>
                </li>
                <li class="nav-item">
                    <a href="video-tools.html" class="nav-link" data-i18n="nav_video">è§†é¢‘</a>
                </li>
                <li class="nav-item">
                    <a href="document-tools.html" class="nav-link" data-i18n="nav_files">æ–‡ä»¶</a>
                </li>
                <li class="nav-item language-selector">
                    <select id="navbar-language-selector" title="Select Language">
                        <option value="en">English</option>
                        <option value="zh">ä¸­æ–‡ç®€ä½“</option>
                        <option value="zh-tw">ä¸­æ–‡ç¹é«”</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="ko">í•œêµ­ì–´</option>
                    </select>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- æ·»åŠ èƒŒæ™¯åŠ¨ç”» -->
    <div class="background-animation"></div>
    
    <!-- è¿”å›é¦–é¡µæŒ‰é’®å·²éšè— -->
    
    <header class="row-reverse">
        <a href="#about" class="icon-button" title="About DropShare" style="display: none;">
            <svg class="icon">
                <use xlink:href="#info-outline" />
            </svg>
        </a>
        <a href="#" id="theme" class="icon-button" title="Switch Darkmode/Lightmode" >
            <svg class="icon">
                <use xlink:href="#icon-theme" />
            </svg>
        </a>
        <a href="#" id="notification" class="icon-button" title="Enable Notifications" hidden>
            <svg class="icon">
                <use xlink:href="#notifications" />
            </svg>
        </a>
        <a href="#" id="install" class="icon-button" title="Install Snapdrop" hidden>
            <svg class="icon">
                <use xlink:href="#homescreen" />
            </svg>
        </a>
        <div class="lang-selector">
            <select id="language-selector" title="Select Language">
                <option value="en">English</option>
                <option value="zh">ä¸­æ–‡ç®€ä½“</option>
                <option value="zh-tw">ä¸­æ–‡ç¹é«”</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="fr">FranÃ§ais</option>
                <option value="es">EspaÃ±ol</option>
                <option value="de">Deutsch</option>
                <option value="pt">PortuguÃªs</option>
                <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
        </div>
    </header>
    
    <!-- Main page container -->
    <div class="page-container">
        <!-- Center message area -->
        <div class="center-message">
            <!-- æˆ¿é—´åŠŸèƒ½å®¹å™¨ -->
            <div id="roomContainer" class="room-container">
                <div class="room-header">
                    <h1 class="room-title" data-i18n="room_title">å¤šäººå…±äº«æˆ¿é—´</h1>
                    <p class="room-subtitle" data-i18n="room_subtitle">ä¸åŒç½‘ç»œç”¨æˆ·æˆ–é€šè¿‡æˆ¿é—´ç ä¸è¿œç¨‹ç”¨æˆ·å¿«é€Ÿå…±äº«æ–‡ä»¶</p>
                </div>
                
                <!-- æˆ¿é—´é€‰é¡¹æŒ‰é’® -->
                <div class="room-options">
                    <button id="createRoomBtn" class="room-btn" data-i18n="create_room_btn">åˆ›å»ºæˆ¿é—´</button>
                    <button id="joinRoomBtn" class="room-btn secondary" data-i18n="join_room_btn">åŠ å…¥æˆ¿é—´</button>
                </div>
                
                <!-- è¡¨å•å®¹å™¨ï¼Œç”¨äºå±…ä¸­ -->
                <div class="room-forms-container">
                    <!-- åˆ›å»ºæˆ¿é—´è¡¨å• -->
                    <div id="createRoomForm" class="room-form">
                        <h3 data-i18n="create_new_room">åˆ›å»ºæ–°æˆ¿é—´</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label" data-i18n="room_name_label">æˆ¿é—´åç§°</label>
                                <input type="text" id="roomName" name="room-name" class="form-input" data-i18n-placeholder="room_name_placeholder" placeholder="è¾“å…¥æˆ¿é—´åç§°" maxlength="20" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label" data-i18n="room_password_label">æˆ¿é—´å¯†ç  (å¯é€‰)</label>
                                <input type="password" id="roomPassword" name="room-password" class="form-input" placeholder="è®¾ç½®æˆ¿é—´å¯†ç " maxlength="16" autocomplete="new-password">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æœ€å¤§æˆå‘˜æ•°</label>
                                <input type="number" id="maxMembers" name="max-members" class="form-input" value="10" min="2" max="50" autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmCreateRoom" class="btn-primary">åˆ›å»ºæˆ¿é—´</button>
                                <button type="button" id="cancelCreateRoom" class="btn-cancel">å–æ¶ˆ</button>
                            </div>
                        </form>
                        <div id="createRoomError" class="error-message" style="display: none;"></div>
                    </div>
                    
                    <!-- åŠ å…¥æˆ¿é—´è¡¨å• -->
                    <div id="joinRoomForm" class="room-form">
                        <h3>åŠ å…¥æˆ¿é—´</h3>
                        <form autocomplete="off">
                            <div class="form-group">
                                <label class="form-label">æˆ¿é—´ç </label>
                                <input type="text" id="roomCode" name="room-code" class="form-input" placeholder="è¾“å…¥æˆ¿é—´ç " maxlength="10" style="text-transform: uppercase;" autocomplete="off">
                            </div>
                            <div class="form-group">
                                <label class="form-label">æˆ¿é—´å¯†ç  (å¦‚æœéœ€è¦)</label>
                                <input type="password" id="joinRoomPassword" name="join-password" class="form-input" placeholder="è¾“å…¥æˆ¿é—´å¯†ç " autocomplete="off">
                            </div>
                            <div class="form-actions">
                                <button type="button" id="confirmJoinRoom" class="btn-primary">åŠ å…¥æˆ¿é—´</button>
                                <button type="button" id="cancelJoinRoom" class="btn-cancel">å–æ¶ˆ</button>
                            </div>
                        </form>
                        <div id="joinRoomError" class="error-message" style="display: none;"></div>
                    </div>
                </div>
                
                <!-- æˆ¿é—´ä¿¡æ¯æ˜¾ç¤º -->
                <div id="roomInfo" class="room-info">
                    <!-- æˆ¿é—´ä¿¡æ¯å¤´éƒ¨ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
                    <div class="room-info-header" id="roomInfoHeader">
                        <div class="room-summary">
                            <span class="room-name-display" id="roomNameDisplay"></span>
                            <div class="room-code-row">
                                <span class="room-code-display" id="roomCodeDisplay"></span>
                                <button id="copyRoomCode" class="copy-btn-small" title="å¤åˆ¶æˆ¿é—´ç ">ğŸ“‹</button>
                            </div>
                            <div class="current-user-info">
                                <span class="current-user-label">æ‚¨çš„åç§°ï¼š</span>
                                <span class="current-user-name" id="currentUserName"></span>
                            </div>
                            <span class="member-count" id="memberCount">2äººåœ¨çº¿</span>
                        </div>
                        <button class="toggle-details-btn" id="toggleDetailsBtn">
                            <svg class="toggle-icon" viewBox="0 0 24 24" width="16" height="16">
                                <path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- æˆ¿é—´è¯¦ç»†ä¿¡æ¯ï¼ˆå¯æŠ˜å ï¼‰ -->
                    <div class="room-details" id="roomDetails">
                        <div class="room-members-section">
                            <strong>æˆ¿é—´æˆå‘˜:</strong>
                            <div id="memberList" class="member-list"></div>
                        </div>
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="room-actions">
                        <button id="leaveRoomBtn" class="btn-leave-room">é€€å‡ºæˆ¿é—´</button>
                    </div>
                </div>
                
                <!-- æˆ¿é—´è­¦å‘Šæç¤º -->
                <div id="roomWarning" class="room-warning">
                    <div class="warning-content">
                        <div class="warning-icon">âš ï¸</div>
                        <div class="warning-text">
                            <div id="warningTitle" class="warning-title"></div>
                            <div id="warningMessage" class="warning-message"></div>
                        </div>
                    </div>
                </div>
                
                <!-- æˆ¿é—´æ–‡ä»¶å…±äº«åŒºåŸŸ -->
                <div id="fileTransferArea" class="file-transfer-area">
                    <div class="room-file-sharing">
                        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
                        <div class="upload-section">
                            <h3>ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ°æˆ¿é—´</h3>
                            <div id="dropZone" class="drop-zone">
                                <div class="drop-zone-content">
                                    <svg class="upload-icon" viewBox="0 0 24 24" width="48" height="48">
                                        <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                    </svg>
                                    <p>æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œæˆ–ç‚¹å‡»ä¸Šä¼ </p>
                                    <p class="upload-hint">æ–‡ä»¶å°†å…±äº«ç»™æˆ¿é—´å†…çš„æ‰€æœ‰æˆå‘˜</p>
                                    <input type="file" id="fileInput" multiple hidden>
                                    <button id="selectFilesBtn" class="select-files-btn">é€‰æ‹©æ–‡ä»¶ä¸Šä¼ </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æˆ¿é—´å…±äº«æ–‡ä»¶åˆ—è¡¨ -->
                        <div class="shared-files-section">
                            <div class="shared-files-header">
                                <h3>ğŸ“ æˆ¿é—´å…±äº«æ–‡ä»¶</h3>
                                <span class="file-count" id="fileCount">0 ä¸ªæ–‡ä»¶</span>
                            </div>
                            <div id="sharedFilesList" class="shared-files-list">
                                <div class="no-shared-files">
                                    <p>æˆ¿é—´å†…æš‚æ— å…±äº«æ–‡ä»¶</p>
                                    <p class="hint">ä¸Šä¼ æ–‡ä»¶åï¼Œæˆ¿é—´å†…æ‰€æœ‰æˆå‘˜éƒ½å¯ä»¥ä¸‹è½½</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- åŸæœ‰çš„è®¾å¤‡å‘ç°ç•Œé¢ -->
            <div id="peerContainer" style="display: block;">
                <x-peers class="center"></x-peers>
                <x-no-peers>
                    <h2 data-i18n="open_snapdrop">åœ¨å…¶ä»–è®¾å¤‡ä¸Šæ‰“å¼€DropShareä»¥å‘é€æ–‡ä»¶</h2>
                </x-no-peers>
            </div>
        </div>
        
        <!-- User info at bottom -->
        <div class="user-info-bottom">
            <footer>
                <div class="logo-container">
                    <svg class="icon logo">
                        <use xlink:href="#wifi-tethering" />
                    </svg>
                </div>
                <div class="text-container">
                    <div id="displayName" class="text-line"></div>
                    <div class="font-body2 text-line" data-i18n="you_discovered">æ‚¨å¯è¢«æ­¤ç½‘ç»œä¸Šçš„æ‰€æœ‰äººå‘ç°</div>
                </div>
            </footer>
        </div>
    </div>
    <!-- Receive Dialog -->
    <x-dialog id="receiveDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="file_received">File Received</h3>
                <div class="font-subheading" id="fileName" data-i18n=""></div>
                <div class="font-body2" id="fileSize"></div>
                <div class='preview' style="visibility: hidden;">
                    <img id='img-preview' src="">
                </div>
                <div class="row">
                    <label for="autoDownload" class="grow" data-i18n="ask_save_files">Ask to save each file before downloading</label>
                    <input type="checkbox" id="autoDownload" checked="">
                </div>
                <div class="row-reverse">
                    <a class="button" close id="download" title="Download File" autofocus data-i18n="save">Save</a>
                    <button class="button" close data-i18n="ignore">Ignore</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Send Text Dialog -->
    <x-dialog id="sendTextDialog">
        <form action="#">
            <x-background class="full center">
                <x-paper shadow="2">
                    <h3 data-i18n="send_message">Send a Message</h3>
                    <div id="textInput" class="textarea" role="textbox" data-placeholder="Send a message" autocomplete="off" autofocus contenteditable></div>
                    <div class="row-reverse">
                        <button class="button" type="submit" close data-i18n="send">Send</button>
                        <a class="button" close data-i18n="cancel">Cancel</a>
                    </div>
                </x-paper>
            </x-background>
        </form>
    </x-dialog>
    <!-- Receive Text Dialog -->
    <x-dialog id="receiveTextDialog">
        <x-background class="full center">
            <x-paper shadow="2">
                <h3 data-i18n="message_received">Message Received</h3>
                <div class="font-subheading" id="text"></div>
                <div class="row-reverse">
                    <button class="button" id="copy" close autofocus data-i18n="copy">Copy</button>
                    <button class="button" close data-i18n="close">Close</button>
                </div>
            </x-paper>
        </x-background>
    </x-dialog>
    <!-- Toast -->
    <div class="toast-container full center">
        <x-toast class="row" shadow="1" id="toast">
            <span id="toast-text" data-i18n="file_transfer_completed">File Transfer Completed</span>
        </x-toast>
    </div>
    <!-- About Page -->
    <x-about id="about" class="full center column" style="display: none;">
        <section class="center column fade-in">
            <header class="row-reverse">
                <a href="#" class="close icon-button">
                    <svg class="icon">
                        <use xlink:href="#close" />
                    </svg>
                </a>
            </header>
            <svg class="icon logo">
                <use xlink:href="#wifi-tethering" />
            </svg>
            <h1>DropShare</h1>
            <div class="font-subheading"><span data-i18n="easiest_way">The easiest way to transfer files across devices</span><div style="font-size:10px;"><span data-i18n="modified_by">Modified version by</span> <a href="#" target="_blank">YourNameHere</a></div></div>
            <div class="row">
                <a class="icon-button" target="_blank" href="#" title="DropShare on Github" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#github" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Help cover the server costs!" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#monetarization" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Tweet about DropShare" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#twitter" />
                    </svg>
                </a>
                <a class="icon-button" target="_blank" href="#" title="Frequently asked questions" rel="noreferrer">
                    <svg class="icon">
                        <use xlink:href="#help-outline" />
                    </svg>
                </a>
            </div>
        </section>
        <x-background></x-background>
    </x-about>
    <!-- SVG Icon Library -->
    <svg style="display: none;">
        <symbol id="wifi-tethering" viewBox="0 0 24 24">
            <path d="M12 11c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm6 2c0-3.31-2.69-6-6-6s-6 2.69-6 6c0 2.22 1.21 4.15 3 5.19l1-1.74c-1.19-.7-2-1.97-2-3.45 0-2.21 1.79-4 4-4s4 1.79 4 4c0 1.48-.81 2.75-2 3.45l1 1.74c1.79-1.04 3-2.97 3-5.19zM12 3C6.48 3 2 7.48 2 13c0 3.7 2.01 6.92 4.99 8.65l1-1.73C5.61 18.53 4 15.96 4 13c0-4.42 3.58-8 8-8s8 3.58 8 8c0 2.96-1.61 5.53-4 6.92l1 1.73c2.99-1.73 5-4.95 5-8.65 0-5.52-4.48-10-10-10z"></path>
        </symbol>
        <symbol id="desktop-mac" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="windows-desktop" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z M4 7h4v4H4z M10 7h4v4h-4z M4 13h4v2H4z M10 13h4v2h-4z M16 7h4v4h-4z M16 13h4v2h-4z"></path>
        </symbol>
        <symbol id="desktop-linux" viewBox="0 0 24 24">
            <path d="M21 2H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h7l-2 3v1h8v-1l-2-3h7c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 12H3V4h18v10z"></path>
        </symbol>
        <symbol id="phone-iphone" viewBox="0 0 24 24">
            <path d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1zm-4 21c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5-4H7V4h9v14z"></path>
        </symbol>
        <symbol id="phone-android" viewBox="0 0 24 24">
            <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3.25-3H6.75V4h10.5v14z"></path>
        </symbol>
        <symbol id="tablet-mac" viewBox="0 0 24 24">
            <path d="M18.5 0h-14C3.12 0 2 1.12 2 2.5v19C2 22.88 3.12 24 4.5 24h14c1.38 0 2.5-1.12 2.5-2.5v-19C21 1.12 19.88 0 18.5 0zm-7 23c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm7.5-4H4V3h15v16z"></path>
        </symbol>
        <symbol id="tablet-android" viewBox="0 0 24 24">
            <path d="M18 0H6C4.34 0 3 1.34 3 3v18c0 1.66 1.34 3 3 3h12c1.66 0 3-1.34 3-3V3c0-1.66-1.34-3-3-3zm-4 22h-4v-1h4v1zm5.25-3H4.75V3h14.5v16z"></path>
        </symbol>
        <symbol id="info-outline" viewBox="0 0 24 24">
            <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="close" viewBox="0 0 24 24">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </symbol>
        <symbol id="help-outline" viewBox="0 0 24 24">
            <path d="M11 18h2v-2h-2v2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4z"></path>
        </symbol>
        <symbol id="twitter">
            <path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z" />
        </symbol>
        <symbol id="github">
            <path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12" />
        </symbol>
        <g id="notifications">
            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z" />
        </g>
        <symbol id="homescreen" viewBox="0 0 24 24">
            <path d="M18 1.01L8 1c-1.1 0-2 .9-2 2v3h2V5h10v14H8v-1H6v3c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM10 15h2V8H5v2h3.59L3 15.59 4.41 17 10 11.41z" />
            <path d="M0 0h24v24H0V0z" fill="none" />
        </symbol>
        <symbol id="icon-theme" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36c-0.98,1.37-2.58,2.26-4.4,2.26 c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></symbol>
        
        <!-- Add the sun icon for light mode -->
        <symbol id="icon-sun" viewBox="0 0 24 24"><rect fill="none" height="24" width="24"/><path d="M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0 c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2 c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1 S11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0 s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06 c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41 c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36 c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z" /></symbol>
    </svg>
    <!-- Scripts -->
    <!-- Load the language loader first -->
    <script src="scripts/i18n/languages.js"></script>
    <!-- Load other scripts -->
    <script src="scripts/network.js"></script>
    <script src="scripts/ui.js"></script>
    <script src="scripts/theme.js" async></script>
    <script src="scripts/clipboard.js" async></script>

    <!-- æˆ¿é—´åŠŸèƒ½JavaScript -->
    <script>
        // æˆ¿é—´åŠŸèƒ½ç®¡ç†
        class RoomManager {
            constructor() {
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members = new Map();
                this.ws = null;
                this.fileStorage = null;
                
                console.log('RoomManageræ„é€ å‡½æ•°å¼€å§‹');
                
                // åˆå§‹åŒ–æ–‡ä»¶å­˜å‚¨
                this.initFileStorage();
                
                // ç«‹å³åˆå§‹åŒ–UI
                this.initializeRoomUI();
                
                // ç«‹å³æ£€æŸ¥æˆ¿é—´æ¨¡å¼
                this.checkForRoomsMode();
                
                // è®¾ç½®æ–‡ä»¶äº‹ä»¶
                this.setupFileEvents();
                
                console.log('RoomManageræ„é€ å‡½æ•°å®Œæˆ');
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æˆ¿é—´æ¨¡å¼
            checkForRoomsMode() {
                console.log('checkForRoomsMode - å½“å‰URL hash:', window.location.hash);
                
                // ç«‹å³æ£€æŸ¥å¹¶æ˜¾ç¤º
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOMå…ƒç´ æœªæ‰¾åˆ°ï¼Œç¨åé‡è¯•');
                    setTimeout(() => this.checkForRoomsMode(), 100);
                    return;
                }
                
                if (window.location.hash === '#rooms') {
                    console.log('æˆ¿é—´æ¨¡å¼ - ç«‹å³æ˜¾ç¤ºæˆ¿é—´å®¹å™¨');
                    this.showRoomContainer();
                } else {
                    console.log('æ™®é€šæ¨¡å¼ - æ˜¾ç¤ºè®¾å¤‡å‘ç°å®¹å™¨');
                    this.showPeerContainer();
                }
                
                // åªæ·»åŠ ä¸€æ¬¡äº‹ä»¶ç›‘å¬å™¨
                if (!this.hashChangeListenerAdded) {
                    window.addEventListener('hashchange', () => {
                        console.log('URL hashæ”¹å˜:', window.location.hash);
                        if (window.location.hash === '#rooms') {
                            this.showRoomContainer();
                        } else {
                            this.showPeerContainer();
                        }
                    });
                    this.hashChangeListenerAdded = true;
                }
            }
            
            // æ˜¾ç¤ºæˆ¿é—´å®¹å™¨
            showRoomContainer() {
                console.log('showRoomContainer å¼€å§‹æ‰§è¡Œ');
                
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.error('æ‰¾ä¸åˆ°å®¹å™¨å…ƒç´ ');
                    return;
                }
                
                // ç«‹å³æ˜¾ç¤ºæˆ¿é—´å®¹å™¨
                roomContainer.classList.add('active');
                roomContainer.style.display = 'flex';
                roomContainer.style.visibility = 'visible';
                roomContainer.style.opacity = '1';
                
                // éšè—è®¾å¤‡å®¹å™¨
                peerContainer.style.display = 'none';
                
                // éšè—åº•éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸï¼ˆè®¾å¤‡å‘ç°ä¿¡æ¯ï¼‰
                this.hideBottomUserInfo();
                
                console.log('æˆ¿é—´å®¹å™¨å·²è®¾ç½®ä¸ºæ˜¾ç¤º');
                
                // æ ¹æ®æˆ¿é—´çŠ¶æ€å†³å®šæ˜¾ç¤ºä»€ä¹ˆ
                setTimeout(() => {
                    if (!this.isInRoom) {
                        this.ensureRoomOptionsVisible();
                    }
                }, 10);
                
                // å»¶è¿Ÿæ£€æŸ¥é‡è¿
                setTimeout(() => {
                    this.checkAndReconnectRoom();
                }, 2000);
            }
            
            // æ˜¾ç¤ºè®¾å¤‡å‘ç°å®¹å™¨
            showPeerContainer() {
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (roomContainer && peerContainer) {
                    roomContainer.classList.remove('active');
                    roomContainer.style.display = 'none';
                    roomContainer.style.visibility = 'hidden';
                    roomContainer.style.opacity = '0';
                    peerContainer.style.display = 'block';
                    
                    // æ˜¾ç¤ºåº•éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
                    this.showBottomUserInfo();
                    
                    console.log('åˆ‡æ¢åˆ°è®¾å¤‡å‘ç°æ¨¡å¼ - è®¾å¤‡å®¹å™¨æ˜¾ç¤º');
                } else {
                    console.error('æ‰¾ä¸åˆ°æˆ¿é—´å®¹å™¨æˆ–è®¾å¤‡å®¹å™¨');
                }
            }
            
            // åˆå§‹åŒ–æˆ¿é—´UIäº‹ä»¶
            initializeRoomUI() {
                // ç­‰å¾…DOMå®Œå…¨åŠ è½½åå†ç»‘å®šäº‹ä»¶
                const bindEvents = () => {
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    
                    if (!createBtn || !joinBtn) {
                        console.log('æˆ¿é—´æŒ‰é’®æœªæ‰¾åˆ°ï¼Œç­‰å¾…DOMåŠ è½½...');
                        setTimeout(bindEvents, 100);
                        return;
                    }
                    
                    // åˆ›å»ºæˆ¿é—´æŒ‰é’®
                    createBtn.addEventListener('click', () => {
                        this.showCreateRoomForm();
                    });
                
                    // åŠ å…¥æˆ¿é—´æŒ‰é’®
                    joinBtn.addEventListener('click', () => {
                        this.showJoinRoomForm();
                    });
                    
                    // ç¡®è®¤åˆ›å»ºæˆ¿é—´
                    document.getElementById('confirmCreateRoom').addEventListener('click', () => {
                        this.createRoom();
                    });
                    
                    // å–æ¶ˆåˆ›å»ºæˆ¿é—´
                    document.getElementById('cancelCreateRoom').addEventListener('click', () => {
                        this.hideAllForms();
                    });
                    
                    // ç¡®è®¤åŠ å…¥æˆ¿é—´
                    document.getElementById('confirmJoinRoom').addEventListener('click', () => {
                        this.joinRoom();
                    });
                    
                    // å–æ¶ˆåŠ å…¥æˆ¿é—´
                    document.getElementById('cancelJoinRoom').addEventListener('click', () => {
                        this.hideAllForms();
                    });
                    
                    // é€€å‡ºæˆ¿é—´
                    document.getElementById('leaveRoomBtn').addEventListener('click', () => {
                        this.leaveRoom();
                    });
                    
                    // æˆ¿é—´ç è¾“å…¥è‡ªåŠ¨è½¬å¤§å†™
                    document.getElementById('roomCode').addEventListener('input', (e) => {
                        e.target.value = e.target.value.toUpperCase();
                    });
                    
                    // æˆ¿é—´ä¿¡æ¯å±•å¼€/æ”¶èµ·
                    document.getElementById('toggleDetailsBtn').addEventListener('click', () => {
                        this.toggleRoomDetails();
                    });
                    
                    // å¤åˆ¶æˆ¿é—´ç 
                    document.getElementById('copyRoomCode').addEventListener('click', () => {
                        this.copyRoomCode();
                    });
                    
                    // æ–‡ä»¶é€‰æ‹©å’Œæ‹–æ‹½
                    this.initializeFileTransfer();
                    
                    console.log('æˆ¿é—´UIäº‹ä»¶ç»‘å®šå®Œæˆ');
                };
                
                bindEvents();
            }
            
            // åˆå§‹åŒ–æ–‡ä»¶ä¼ è¾“åŠŸèƒ½
            initializeFileTransfer() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const selectFilesBtn = document.getElementById('selectFilesBtn');
                
                if (!dropZone || !fileInput || !selectFilesBtn) {
                    console.log('æ–‡ä»¶ä¼ è¾“å…ƒç´ æœªæ‰¾åˆ°ï¼Œå»¶è¿Ÿåˆå§‹åŒ–...');
                    setTimeout(() => this.initializeFileTransfer(), 100);
                    return;
                }
                
                // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
                selectFilesBtn.addEventListener('click', () => {
                    fileInput.click();
                });
                
                dropZone.addEventListener('click', () => {
                    fileInput.click();
                });
                
                // æ–‡ä»¶é€‰æ‹©
                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                    // æ¸…ç©ºæ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡å¤ä¸Šä¼ åŒä¸€æ–‡ä»¶
                    e.target.value = '';
                });
                
                // æ‹–æ‹½åŠŸèƒ½
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('dragover');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    this.handleFileSelection(e.dataTransfer.files);
                });
            }
            
            // å¤„ç†æ–‡ä»¶é€‰æ‹©
            handleFileSelection(files) {
                if (!this.isInRoom) {
                    alert('è¯·å…ˆåŠ å…¥æˆ¿é—´æ‰èƒ½ä¸Šä¼ æ–‡ä»¶');
                    return;
                }
                
                if (files.length === 0) return;
                
                // ç›´æ¥ä¸Šä¼ æ–‡ä»¶åˆ°æˆ¿é—´
                this.uploadFilesToRoom(files);
            }
            
            // ä¸Šä¼ æ–‡ä»¶åˆ°æˆ¿é—´
            async uploadFilesToRoom(files) {
                console.log('ä¸Šä¼ æ–‡ä»¶åˆ°æˆ¿é—´:', files);
                
                for (const file of files) {
                    // åˆ›å»ºæ–‡ä»¶ä¿¡æ¯
                    const fileInfo = {
                        id: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploader: this.getCurrentUserDisplayName(),
                        uploaderId: this.getCurrentUserId(),
                        uploadTime: Date.now(),
                        file: file, // ä¿å­˜æ–‡ä»¶å¯¹è±¡ç”¨äºä¸‹è½½
                        isAvailable: true // æ–‡ä»¶å¯ç”¨çŠ¶æ€
                    };
                    
                    // å­˜å‚¨åˆ° IndexedDB
                    await this.storeFileToIndexedDB(fileInfo);
                    
                    // æ·»åŠ åˆ°æœ¬åœ°å…±äº«åˆ—è¡¨
                    this.addFileToSharedList(fileInfo);
                    
                    // å¹¿æ’­ç»™æˆ¿é—´å†…å…¶ä»–æˆå‘˜
                    this.broadcastFileToRoom(fileInfo);
                    
                    this.showToast(`æ–‡ä»¶ "${file.name}" å·²ä¸Šä¼ åˆ°æˆ¿é—´`);
                }
            }
            
            // è·å–å½“å‰ç”¨æˆ·æ˜¾ç¤ºåç§°
            getCurrentUserDisplayName() {
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.textContent) {
                    // æå–æ˜¾ç¤ºåç§°ï¼ˆç§»é™¤"æ‚¨è¢«ç§°ä¸º"ç­‰å‰ç¼€ï¼‰
                    const text = displayNameEl.textContent;
                    const match = text.match(/\s(.+)$/);
                    return match ? match[1] : 'åŒ åç”¨æˆ·';
                }
                return 'åŒ åç”¨æˆ·';
            }
            
            // æ·»åŠ æ–‡ä»¶åˆ°å…±äº«åˆ—è¡¨
            addFileToSharedList(fileInfo) {
                const sharedFilesList = document.getElementById('sharedFilesList');
                const noFiles = sharedFilesList.querySelector('.no-shared-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.dataset.fileId = fileInfo.id;
                
                // ä½¿ç”¨ç»Ÿä¸€çš„æ˜¾ç¤ºæ–¹æ³•
                this.updateFileItemDisplay(fileItem, fileInfo);
                
                sharedFilesList.appendChild(fileItem);
                this.updateFileCount();
            }
            
            // è·å–æ–‡ä»¶å›¾æ ‡
            getFileIcon(fileType) {
                if (!fileType) return 'ğŸ“„';
                
                if (fileType.startsWith('image/')) return 'ğŸ–¼ï¸';
                if (fileType.startsWith('video/')) return 'ğŸ¥';
                if (fileType.startsWith('audio/')) return 'ğŸ§';
                if (fileType.includes('pdf')) return 'ğŸ“„';
                if (fileType.includes('word')) return 'ğŸ“„';
                if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'ğŸ“ˆ';
                if (fileType.includes('powerpoint') || fileType.includes('presentation')) return 'ğŸ“Š';
                if (fileType.includes('zip') || fileType.includes('rar') || fileType.includes('archive')) return 'ğŸ—„ï¸';
                return 'ğŸ“';
            }
            
            // æ›´æ–°æ–‡ä»¶è®¡æ•°
            updateFileCount() {
                const fileCount = document.getElementById('fileCount');
                const fileItems = document.querySelectorAll('.shared-file-item');
                const count = fileItems.length;
                
                if (fileCount) {
                    fileCount.textContent = `${count} ä¸ªæ–‡ä»¶`;
                }
            }
            
            // ä¸‹è½½å…±äº«æ–‡ä»¶
            downloadSharedFile(fileId) {
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (!fileItem || !fileItem._fileData) {
                    this.showToast('æ–‡ä»¶ä¸å­˜åœ¨');
                    return;
                }
                
                const fileData = fileItem._fileData;
                
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å¯ç”¨
                if (!fileData.file) {
                    if (fileData.isRemote) {
                        this.showToast('æ— æ³•ä¸‹è½½ï¼šéœ€è¦ä¸Šä¼ è€…åœ¨çº¿');
                    } else {
                        this.showToast('æ–‡ä»¶ä¸å¯ç”¨ï¼Œä¸Šä¼ è€…å¯èƒ½å·²ç¦»çº¿');
                    }
                    return;
                }
                
                if (fileData.isAvailable === false) {
                    this.showToast('æ–‡ä»¶æš‚æ—¶ä¸å¯ç”¨');
                    return;
                }
                
                try {
                    const url = URL.createObjectURL(fileData.file);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast(`æ­£åœ¨ä¸‹è½½: ${fileData.name}`);
                } catch (error) {
                    console.error('ä¸‹è½½æ–‡ä»¶å¤±è´¥:', error);
                    this.showToast('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
            
            // ç§»é™¤å…±äº«æ–‡ä»¶
            async removeSharedFile(fileId) {
                if (!confirm('ç¡®è®¤è¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    return;
                }
                
                const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // ä» IndexedDB åˆ é™¤
                    await this.deleteFileFromIndexedDB(fileId);
                    
                    // å¹¿æ’­åˆ é™¤æ¶ˆæ¯ç»™æˆ¿é—´å†…å…¶ä»–æˆå‘˜
                    this.broadcastFileRemoval(fileId);
                    
                    this.showToast('æ–‡ä»¶å·²åˆ é™¤');
                }
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç©ºçŠ¶æ€
                const sharedFilesList = document.getElementById('sharedFilesList');
                const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                if (remainingFiles.length === 0) {
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                }
            }
            
            // å¹¿æ’­æ–‡ä»¶åˆ°æˆ¿é—´å†…å…¶ä»–æˆå‘˜
            async broadcastFileToRoom(fileInfo) {
                console.log('å¹¿æ’­æ–‡ä»¶åˆ°æˆ¿é—´:', fileInfo.name);
                
                try {
                    // å°†æ–‡ä»¶è½¬æ¢ä¸ºå¯ä¼ è¾“çš„æ ¼å¼
                    const fileData = await this.fileToBase64(fileInfo.file);
                    
                    // å¹¿æ’­æ–‡ä»¶ä¿¡æ¯å’Œæ•°æ®ç»™æˆ¿é—´å†…å…¶ä»–æˆå‘˜
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        },
                        fileData: fileData // åŒ…å«å®é™…æ–‡ä»¶æ•°æ®
                    });
                } catch (error) {
                    console.error('æ–‡ä»¶å¹¿æ’­å¤±è´¥:', error);
                    // å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼Œåªå‘é€å…ƒä¿¡æ¯
                    this.sendMessage({
                        type: 'room-file-shared',
                        roomCode: this.currentRoom,
                        fileInfo: {
                            id: fileInfo.id,
                            name: fileInfo.name,
                            size: fileInfo.size,
                            type: fileInfo.type,
                            uploader: fileInfo.uploader,
                            uploaderId: fileInfo.uploaderId,
                            uploadTime: fileInfo.uploadTime
                        }
                    });
                }
            }
            
            // å°†æ–‡ä»¶è½¬æ¢ä¸ºBase64æ ¼å¼ç”¨äºä¼ è¾“
            async fileToBase64(file) {
                // é™åˆ¶æ–‡ä»¶å¤§å°ï¼Œé¿å…ä¼ è¾“è¿‡å¤§çš„æ–‡ä»¶
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    throw new Error('æ–‡ä»¶å¤ªå¤§ï¼Œæ— æ³•åˆ†å‘');
                }
                
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            
            // ä»Base64æ¢å¤æ–‡ä»¶
            base64ToFile(dataUrl, fileName, fileType) {
                const arr = dataUrl.split(',');
                const mime = arr[0].match(/:(.*?);/)[1];
                const bstr = atob(arr[1]);
                let n = bstr.length;
                const u8arr = new Uint8Array(n);
                while (n--) {
                    u8arr[n] = bstr.charCodeAt(n);
                }
                return new File([u8arr], fileName, { type: fileType });
            }
            
            // å¹¿æ’­æ–‡ä»¶åˆ é™¤
            broadcastFileRemoval(fileId) {
                this.sendMessage({
                    type: 'room-file-removed',
                    roomCode: this.currentRoom,
                    fileId: fileId
                });
            }
            
            // åˆå§‹åŒ–æ–‡ä»¶å­˜å‚¨ï¼ˆIndexedDBï¼‰
            async initFileStorage() {
                try {
                    this.fileStorage = await this.openIndexedDB();
                    console.log('IndexedDB åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.warn('IndexedDB åˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨:', error);
                    this.fileStorage = null;
                }
            }
            
            // æ‰“å¼€IndexedDB
            openIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('DropShareRoomFiles', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            const store = db.createObjectStore('files', { keyPath: 'id' });
                            store.createIndex('roomCode', 'roomCode', { unique: false });
                        }
                    };
                });
            }
            
            // å­˜å‚¨æ–‡ä»¶åˆ°IndexedDB
            async storeFileToIndexedDB(fileInfo) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    
                    const fileData = {
                        id: fileInfo.id,
                        roomCode: this.currentRoom,
                        name: fileInfo.name,
                        size: fileInfo.size,
                        type: fileInfo.type,
                        uploader: fileInfo.uploader,
                        uploaderId: fileInfo.uploaderId,
                        uploadTime: fileInfo.uploadTime,
                        file: fileInfo.file // å­˜å‚¨å®é™…æ–‡ä»¶
                    };
                    
                    await store.put(fileData);
                    console.log('æ–‡ä»¶å·²å­˜å‚¨åˆ°IndexedDB:', fileInfo.name);
                } catch (error) {
                    console.error('å­˜å‚¨æ–‡ä»¶å¤±è´¥:', error);
                }
            }
            
            // ä» IndexedDB åŠ è½½æˆ¿é—´æ–‡ä»¶
            async loadRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return [];
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAll(roomCode);
                    
                    return new Promise((resolve, reject) => {
                        request.onsuccess = () => resolve(request.result || []);
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.error('åŠ è½½æˆ¿é—´æ–‡ä»¶å¤±è´¥:', error);
                    return [];
                }
            }
            
            // ä» IndexedDB åˆ é™¤æ–‡ä»¶
            async deleteFileFromIndexedDB(fileId) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    await store.delete(fileId);
                    console.log('æ–‡ä»¶å·²ä» IndexedDB åˆ é™¤:', fileId);
                } catch (error) {
                    console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                }
            }
            
            // æ¸…ç©ºæˆ¿é—´æ–‡ä»¶ï¼ˆç¦»å¼€æˆ¿é—´æ—¶ï¼‰
            async clearRoomFilesFromIndexedDB(roomCode) {
                if (!this.fileStorage) return;
                
                try {
                    const transaction = this.fileStorage.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const index = store.index('roomCode');
                    const request = index.getAllKeys(roomCode);
                    
                    request.onsuccess = () => {
                        const keys = request.result;
                        keys.forEach(key => store.delete(key));
                        console.log(`å·²æ¸…ç©ºæˆ¿é—´ ${roomCode} çš„æ‰€æœ‰æ–‡ä»¶`);
                    };
                } catch (error) {
                    console.error('æ¸…ç©ºæˆ¿é—´æ–‡ä»¶å¤±è´¥:', error);
                }
            }
            
            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // è·å–å½“å‰ç”¨æˆ·ID
            getCurrentUserId() {
                // ä»æ˜¾ç¤ºåç§°å…ƒç´ è·å–å½“å‰ç”¨æˆ·IDï¼Œè¿™ä¸ªIDæ˜¯åœ¨ç½‘ç»œè¿æ¥æ—¶è®¾ç½®çš„
                const displayNameEl = document.getElementById('displayName');
                if (displayNameEl && displayNameEl.dataset.peerId) {
                    return displayNameEl.dataset.peerId;
                }
                // å¤‡ç”¨æ–¹æ³•ï¼šä»ç½‘ç»œè¿æ¥è·å–
                if (window.currentPeerId) {
                    return window.currentPeerId;
                }
                return null;
            }
            
            // åˆ‡æ¢æˆ¿é—´è¯¦æƒ…æ˜¾ç¤º
            toggleRoomDetails() {
                const roomDetails = document.getElementById('roomDetails');
                const toggleIcon = document.querySelector('.toggle-icon');
                
                if (roomDetails.classList.contains('expanded')) {
                    roomDetails.classList.remove('expanded');
                    toggleIcon.classList.remove('rotated');
                } else {
                    roomDetails.classList.add('expanded');
                    toggleIcon.classList.add('rotated');
                }
            }
            
            // å¤åˆ¶æˆ¿é—´ç 
            copyRoomCode() {
                const roomCodeText = document.getElementById('roomCodeDisplay').textContent;
                // æå–æˆ¿é—´ç éƒ¨åˆ†ï¼ˆå»æ‰"æˆ¿é—´ç : "å‰ç¼€ï¼‰
                const roomCode = roomCodeText.replace('æˆ¿é—´ç : ', '');
                
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(roomCode).then(() => {
                        this.showToast('æˆ¿é—´ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        this.fallbackCopyRoomCode(roomCode);
                    });
                } else {
                    this.fallbackCopyRoomCode(roomCode);
                }
            }
            
            // å¤‡ç”¨å¤åˆ¶æ–¹æ³•
            fallbackCopyRoomCode(roomCode) {
                const textArea = document.createElement('textarea');
                textArea.value = roomCode;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    this.showToast('æˆ¿é—´ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                } catch (err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œæˆ¿é—´ç ï¼š' + roomCode);
                }
                document.body.removeChild(textArea);
            }
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showToast(message) {
                // åˆ›å»ºä¸´æ—¶æç¤ºå…ƒç´ 
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: #374151;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 10000;
                    font-size: 14px;
                `;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 2000);
            }
            
            // æ˜¾ç¤ºåˆ›å»ºæˆ¿é—´è¡¨å•
            showCreateRoomForm() {
                this.hideAllForms();
                document.getElementById('createRoomForm').classList.add('active');
            }
            
            // æ˜¾ç¤ºåŠ å…¥æˆ¿é—´è¡¨å•
            showJoinRoomForm() {
                this.hideAllForms();
                document.getElementById('joinRoomForm').classList.add('active');
            }
            
            // éšè—æ‰€æœ‰è¡¨å•
            hideAllForms() {
                document.getElementById('createRoomForm').classList.remove('active');
                document.getElementById('joinRoomForm').classList.remove('active');
                document.getElementById('createRoomError').style.display = 'none';
                document.getElementById('joinRoomError').style.display = 'none';
                
                // æ¸…ç©ºè¡¨å•å†…å®¹ï¼Œé˜²æ­¢æµè§ˆå™¨è‡ªåŠ¨å¡«å……
                this.clearFormFields();
            }
            
            // æ¸…ç©ºè¡¨å•å­—æ®µ
            clearFormFields() {
                document.getElementById('roomName').value = '';
                document.getElementById('roomPassword').value = '';
                document.getElementById('maxMembers').value = '10';
                document.getElementById('roomCode').value = '';
                document.getElementById('joinRoomPassword').value = '';
            }
            
            // ç”Ÿæˆæˆ¿é—´ç 
            generateRoomCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }
            
            // åˆ›å»ºæˆ¿é—´
            createRoom() {
                const roomName = document.getElementById('roomName').value.trim();
                const roomPassword = document.getElementById('roomPassword').value;
                const maxMembers = parseInt(document.getElementById('maxMembers').value);
                
                if (!roomName) {
                    this.showError('createRoomError', 'è¯·è¾“å…¥æˆ¿é—´åç§°');
                    return;
                }
                
                const roomCode = this.generateRoomCode();
                const roomSettings = {
                    code: roomCode,
                    name: roomName,
                    password: roomPassword,
                    maxMembers: maxMembers,
                    isPrivate: !!roomPassword
                };
                
                // å‘é€åˆ›å»ºæˆ¿é—´è¯·æ±‚åˆ°åç«¯
                this.sendMessage({
                    type: 'create-room',
                    roomSettings: roomSettings
                });
            }
            
            // åŠ å…¥æˆ¿é—´
            joinRoom() {
                const roomCode = document.getElementById('roomCode').value.trim();
                const password = document.getElementById('joinRoomPassword').value;
                
                if (!roomCode) {
                    this.showError('joinRoomError', 'è¯·è¾“å…¥æˆ¿é—´ç ');
                    return;
                }
                
                // å‘é€åŠ å…¥æˆ¿é—´è¯·æ±‚åˆ°åç«¯
                this.sendMessage({
                    type: 'join-room',
                    roomCode: roomCode,
                    password: password
                });
            }
            
            // é€€å‡ºæˆ¿é—´
            leaveRoom() {
                if (this.currentRoom) {
                    this.sendMessage({
                        type: 'leave-room',
                        roomCode: this.currentRoom
                    });
                }
            }
            
            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            // å‘é€æ¶ˆæ¯åˆ°WebSocket
            sendMessage(message) {
                // æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦å¯ç”¨
                if (window.network && window.network.send && window.network.isConnected()) {
                    window.network.send(message);
                } else {
                    console.warn('ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥:', message);
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¯•é€»è¾‘æˆ–è€…é”™è¯¯æç¤º
                    this.showError('createRoomError', 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');
                }
            }
            
            // å¤„ç†æˆ¿é—´ç›¸å…³çš„WebSocketæ¶ˆæ¯
            handleRoomMessage(message) {
                switch (message.type) {
                    case 'room-created':
                        this.onRoomCreated(message);
                        break;
                    case 'room-joined':
                        this.onRoomJoined(message);
                        break;
                    case 'room-left':
                        this.onRoomLeft(message);
                        break;
                    case 'room-error':
                        this.onRoomError(message);
                        break;
                    case 'room-member-joined':
                        this.onMemberJoined(message);
                        break;
                    case 'room-member-left':
                        this.onMemberLeft(message);
                        break;
                    case 'room-disbanded':
                        this.onRoomDisbanded(message);
                        break;
                    case 'room-file-shared':
                        this.onFileSharedToRoom(message);
                        break;
                    case 'room-file-removed':
                        this.onFileRemovedFromRoom(message);
                        break;
                }
            }
            
            // æˆ¿é—´åˆ›å»ºæˆåŠŸ
            async onRoomCreated(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = true;
                
                // ä¿å­˜æˆ¿é—´çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: true,
                    password: message.room.password || ''
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // åˆå§‹åŒ–æˆå‘˜åˆ—è¡¨
                this.members.clear();
                this.members.set(message.hostInfo.id, message.hostInfo);
                this.updateMemberList([message.hostInfo]);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // åŠ è½½ä¹‹å‰çš„æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
                await this.loadPreviousRoomFiles();
                
                // é‡æ–°åˆ†å‘æˆ‘çš„æ–‡ä»¶ç»™å…¶ä»–æˆå‘˜ï¼ˆåˆ›å»ºæˆ¿é—´åç¨ç­‰ä¸€ä¸‹ï¼‰
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // åŠ å…¥æˆ¿é—´æˆåŠŸ
            async onRoomJoined(message) {
                this.currentRoom = message.room.code;
                this.isInRoom = true;
                this.isHost = false;
                
                // ä¿å­˜æˆ¿é—´çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
                this.saveRoomState({
                    roomCode: message.room.code,
                    roomName: message.room.name,
                    isHost: false,
                    password: '' // åŠ å…¥æ—¶ä¸ä¿å­˜å¯†ç 
                });
                
                this.hideAllForms();
                this.hideRoomOptions();
                this.showRoomInfo(message.room);
                
                // åˆå§‹åŒ–æˆå‘˜åˆ—è¡¨
                this.members.clear();
                message.members.forEach(member => {
                    this.members.set(member.id, member);
                });
                this.updateMemberList(message.members);
                
                this.showFileTransferArea();
                this.showRoomWarning();
                this.hideBottomUserInfo();
                this.setupBeforeUnloadHandler();
                
                // åŠ è½½ä¹‹å‰çš„æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
                await this.loadPreviousRoomFiles();
                
                // é‡æ–°åˆ†å‘æˆ‘çš„æ–‡ä»¶ç»™å…¶ä»–æˆå‘˜ï¼ˆåŠ å…¥æˆ¿é—´åç¨ç­‰ä¸€ä¸‹ï¼‰
                setTimeout(() => this.redistributeMyFiles(), 1000);
            }
            
            // ç¦»å¼€æˆ¿é—´
            async onRoomLeft(message) {
                const roomCode = this.currentRoom;
                
                this.currentRoom = null;
                this.isInRoom = false;
                this.isHost = false;
                this.members.clear();
                
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æˆ¿é—´çŠ¶æ€
                this.clearRoomState();
                
                // æ¸…ç©ºå…±äº«æ–‡ä»¶åˆ—è¡¨
                this.clearSharedFilesList();
                
                // æ¸…ç©º IndexedDB ä¸­çš„æˆ¿é—´æ–‡ä»¶
                if (roomCode) {
                    await this.clearRoomFilesFromIndexedDB(roomCode);
                }
                
                document.getElementById('roomInfo').classList.remove('active');
                this.hideAllForms();
                this.showRoomOptions();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                this.showBottomUserInfo();
                this.removeBeforeUnloadHandler();
            }
            
            // éšè—åº•éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
            hideBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'none';
                }
            }
            
            // æ˜¾ç¤ºåº•éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
            showBottomUserInfo() {
                const userInfoBottom = document.querySelector('.user-info-bottom');
                if (userInfoBottom) {
                    userInfoBottom.style.display = 'block';
                }
            }
            
            // æˆ¿é—´é”™è¯¯
            onRoomError(message) {
                const activeForm = document.querySelector('.room-form.active');
                if (activeForm) {
                    const errorId = activeForm.id === 'createRoomForm' ? 'createRoomError' : 'joinRoomError';
                    this.showError(errorId, message.error);
                } else {
                    // å¦‚æœæ˜¯é‡è¿å¤±è´¥ï¼Œæ˜¾ç¤ºæˆ¿é—´é€‰é¡¹
                    console.log('æˆ¿é—´é‡è¿å¤±è´¥:', message.error);
                    this.showToast('æˆ¿é—´è¿æ¥å¤±è´¥: ' + message.error);
                    this.showRoomOptions();
                    this.hideRoomInfo();
                    this.hideFileTransferArea();
                    this.hideRoomWarning();
                    this.showBottomUserInfo();
                    // æ¸…é™¤æ— æ•ˆçš„æˆ¿é—´çŠ¶æ€
                    this.clearRoomState();
                }
            }
            
            // æ–°æˆå‘˜åŠ å…¥
            async onMemberJoined(message) {
                const memberId = message.member.id;
                const isMyself = memberId === this.getCurrentUserId();
                const isReconnect = message.isReconnect || false;
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œé¿å…é‡å¤æ·»åŠ 
                const wasAlreadyMember = this.members.has(memberId);
                
                // å¦‚æœæ˜¯é‡å¤çš„æˆå‘˜åŠ å…¥äº‹ä»¶ä¸”ä¸æ˜¯é‡è¿ï¼Œç›´æ¥å¿½ç•¥
                if (wasAlreadyMember && !isReconnect) {
                    console.log(`å¿½ç•¥é‡å¤çš„æˆå‘˜åŠ å…¥äº‹ä»¶: ${message.member.displayName} (${memberId})`);
                    return;
                }
                
                if (isReconnect) {
                    console.log(`æˆå‘˜é‡è¿: ${message.member.displayName} (${memberId})`);
                } else {
                    console.log(`æ–°æˆå‘˜åŠ å…¥: ${message.member.displayName} (${memberId})`);
                }
                
                this.members.set(memberId, message.member);
                this.updateMemberList(Array.from(this.members.values()));
                
                // æ›´æ–°è¯¥æˆå‘˜ä¸Šä¼ çš„æ–‡ä»¶çŠ¶æ€ä¸ºåœ¨çº¿å¯ç”¨
                this.updateUploaderStatus(memberId, true);
                
                // å¦‚æœæ˜¯æˆ‘è‡ªå·±é‡æ–°åŠ å…¥æˆ–é‡è¿ï¼Œé‡æ–°åˆ†å‘æ–‡ä»¶
                if (isMyself) {
                    console.log('æ£€æµ‹åˆ°è‡ªå·±é‡æ–°åŠ å…¥/é‡è¿æˆ¿é—´ï¼Œé‡æ–°åˆ†å‘æ–‡ä»¶');
                    await this.redistributeMyFiles();
                }
            }
            
            // é‡æ–°åˆ†å‘æˆ‘çš„æ–‡ä»¶ç»™æˆ¿é—´å†…å…¶ä»–æˆå‘˜
            async redistributeMyFiles() {
                try {
                    const myFiles = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    const myUploads = myFiles.filter(file => file.uploaderId === this.getCurrentUserId());
                    
                    for (const fileData of myUploads) {
                        if (fileData.file) {
                            console.log('é‡æ–°åˆ†å‘æ–‡ä»¶:', fileData.name);
                            
                            // é‡æ–°å¹¿æ’­æ–‡ä»¶
                            const fileInfo = {
                                id: fileData.id,
                                name: fileData.name,
                                size: fileData.size,
                                type: fileData.type,
                                uploader: fileData.uploader,
                                uploaderId: fileData.uploaderId,
                                uploadTime: fileData.uploadTime,
                                file: fileData.file
                            };
                            
                            await this.broadcastFileToRoom(fileInfo);
                        }
                    }
                    
                    if (myUploads.length > 0) {
                        this.showToast(`å·²é‡æ–°åˆ†å‘ ${myUploads.length} ä¸ªæ–‡ä»¶ç»™æˆ¿é—´æˆå‘˜`);
                    }
                } catch (error) {
                    console.error('é‡æ–°åˆ†å‘æ–‡ä»¶å¤±è´¥:', error);
                }
            }
            
            // æˆå‘˜ç¦»å¼€
            onMemberLeft(message) {
                console.log(`æˆå‘˜ç¦»å¼€: ${message.memberId}, åŸå› : ${message.reason || 'unknown'}`);
                
                this.members.delete(message.memberId);
                this.updateMemberList(Array.from(this.members.values()));
                
                // å¦‚æœæ˜¯å› ä¸ºè¿æ¥æ–­å¼€ï¼Œæˆ‘ä»¬è®¾ç½®æ–‡ä»¶ä¸ºç¦»çº¿çŠ¶æ€ä½†ä¿æŒå…¶å¯æ¢å¤æ€§
                // å¦‚æœæ˜¯æ˜ç¡®é€€å‡ºï¼Œåˆ™è®¾ç½®ä¸ºä¸å¯ç”¨
                const isDisconnected = message.reason === 'disconnected';
                this.updateUploaderStatus(message.memberId, false, isDisconnected);
            }
            
            // æ›´æ–°ä¸Šä¼ è€…çŠ¶æ€
            updateUploaderStatus(uploaderId, isOnline, isDisconnected = false) {
                const fileItems = document.querySelectorAll('.shared-file-item');
                fileItems.forEach(item => {
                    const fileData = item._fileData;
                    if (fileData && fileData.uploaderId === uploaderId) {
                        // æ›´æ–°æ–‡ä»¶æ•°æ®
                        fileData.uploaderOnline = isOnline;
                        
                        if (!isOnline) {
                            if (fileData.isRemote) {
                                fileData.isAvailable = false;
                                // å¦‚æœæ˜¯æ–­å¼€è¿æ¥ï¼ˆè€Œä¸æ˜¯æ˜ç¡®é€€å‡ºï¼‰ï¼Œä¿æŒreconnectableçŠ¶æ€
                                fileData.canReconnect = isDisconnected;
                            }
                        } else if (isOnline && fileData.isRemote && fileData.file) {
                            fileData.isAvailable = true;
                            fileData.canReconnect = false;
                        }
                        
                        // é‡æ–°æ¸²æŸ“è¿™ä¸ªæ–‡ä»¶é¡¹
                        this.updateFileItemDisplay(item, fileData);
                    }
                });
            }
            
            // æ›´æ–°å•ä¸ªæ–‡ä»¶é¡¹çš„æ˜¾ç¤º
            updateFileItemDisplay(fileItem, fileData) {
                const fileIcon = this.getFileIcon(fileData.type);
                const uploadTime = new Date(fileData.uploadTime).toLocaleString();
                const isRestored = fileData.isRestored ? ' <span class="restored-tag">(æ¢å¤)</span>' : '';
                const canDownload = fileData.file && fileData.isAvailable !== false;
                const isOwner = fileData.uploaderId === this.getCurrentUserId();
                
                // ç¡®å®šæ–‡ä»¶çŠ¶æ€æ˜¾ç¤º
                let statusHint = '';
                let itemClass = 'shared-file-item';
                
                if (!canDownload && !isOwner) {
                    if (fileData.isRemote) {
                        if (fileData.uploaderOnline === false) {
                            statusHint = '<span class="unavailable-hint">ä¸Šä¼ è€…ç¦»çº¿ï¼Œæ— æ³•ä¸‹è½½</span>';
                            itemClass += ' file-offline';
                        } else if (!fileData.file) {
                            statusHint = '<span class="unavailable-hint">æ–‡ä»¶å¤ªå¤§ï¼Œæ— æ³•ä¸‹è½½</span>';
                            itemClass += ' file-unavailable';
                        }
                    } else {
                        statusHint = '<span class="unavailable-hint">æ–‡ä»¶ä¸å¯ç”¨</span>';
                        itemClass += ' file-unavailable';
                    }
                }
                
                fileItem.className = itemClass;
                fileItem.innerHTML = `
                    <div class="shared-file-info">
                        <div class="shared-file-name">
                            <span class="file-icon">${fileIcon}</span>
                            ${fileData.name}${isRestored}
                        </div>
                        <div class="shared-file-details">
                            <span>${this.formatFileSize(fileData.size)}</span>
                            <span>ä¸Šä¼ è€…: <span class="shared-file-uploader">${fileData.uploader}</span></span>
                            <span>${uploadTime}</span>
                            ${statusHint}
                        </div>
                    </div>
                    <div class="shared-file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadSharedFile('${fileData.id}')" ${!canDownload ? 'disabled' : ''}>ä¸‹è½½</button>
                        ${isOwner ? `<button class="action-btn btn-cancel" onclick="roomManager.removeSharedFile('${fileData.id}')">åˆ é™¤</button>` : ''}
                    </div>
                `;
                
                // æ›´æ–°æ–‡ä»¶æ•°æ®å¼•ç”¨
                fileItem._fileData = fileData;
            }
            
            // æˆ¿é—´è§£æ•£
            onRoomDisbanded(message) {
                // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„æˆ¿é—´çŠ¶æ€
                this.clearRoomState();
                // æ¸…ç©ºå…±äº«æ–‡ä»¶åˆ—è¡¨
                this.clearSharedFilesList();
                alert('æˆ¿é—´å·²è§£æ•£: ' + message.reason);
                this.onRoomLeft();
            }
            
            // æ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
            showRoomInfo(room) {
                // æ›´æ–°æˆ¿é—´ä¿¡æ¯å¤´éƒ¨
                document.getElementById('roomNameDisplay').textContent = room.name;
                document.getElementById('roomCodeDisplay').textContent = `æˆ¿é—´ç : ${room.code}`;
                
                // æ›´æ–°å½“å‰ç”¨æˆ·åç§°
                const currentUserName = this.getCurrentUserDisplayName();
                const currentUserNameEl = document.getElementById('currentUserName');
                if (currentUserNameEl) {
                    currentUserNameEl.textContent = currentUserName;
                }
                
                document.getElementById('roomInfo').classList.add('active');
            }
            
            // æ›´æ–°æˆå‘˜åˆ—è¡¨
            updateMemberList(members) {
                const memberList = document.getElementById('memberList');
                const memberCount = document.getElementById('memberCount');
                
                memberList.innerHTML = '';
                
                members.forEach(member => {
                    const memberItem = document.createElement('div');
                    memberItem.className = 'member-item';
                    memberItem.innerHTML = `
                        <span class="member-name">${member.displayName}</span>
                        <span class="member-role">${member.isHost ? 'æˆ¿ä¸»' : 'æˆå‘˜'}</span>
                    `;
                    memberList.appendChild(memberItem);
                    this.members.set(member.id, member);
                });
                
                // æ›´æ–°æˆå‘˜è®¡æ•°
                memberCount.textContent = `${members.length}äººåœ¨çº¿`;
            }
            
            // éšè—æˆ¿é—´é€‰é¡¹æŒ‰é’®
            hideRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.display = 'none';
                }
            }
            
            // éšè—æˆ¿é—´ä¿¡æ¯
            hideRoomInfo() {
                const roomInfo = document.getElementById('roomInfo');
                if (roomInfo) {
                    roomInfo.classList.remove('active');
                }
            }
            
            // æ˜¾ç¤ºæˆ¿é—´é€‰é¡¹æŒ‰é’®
            showRoomOptions() {
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.display = 'flex';
                }
            }
            
            // ç¡®ä¿æˆ¿é—´é€‰é¡¹å¯è§ï¼ˆä»…åœ¨ä¸åœ¨æˆ¿é—´æ—¶ï¼‰
            ensureRoomOptionsVisible() {
                console.log('=== ç¡®ä¿æˆ¿é—´é€‰é¡¹å¯è§ ===');
                
                // å¦‚æœå·²ç»åœ¨æˆ¿é—´ä¸­ï¼Œä¸åº”è¯¥æ˜¾ç¤ºåˆ›å»º/åŠ å…¥æŒ‰é’®
                if (this.isInRoom) {
                    console.log('å·²åœ¨æˆ¿é—´ä¸­ï¼Œä¸æ˜¾ç¤ºåˆ›å»º/åŠ å…¥æŒ‰é’®');
                    return;
                }
                
                // éšè—æ‰€æœ‰è¡¨å•
                this.hideAllForms();
                
                // éšè—æˆ¿é—´ä¿¡æ¯å’Œä¼ è¾“åŒºåŸŸ
                this.hideRoomInfo();
                this.hideFileTransferArea();
                this.hideRoomWarning();
                
                // æ¸…ç©ºå…±äº«æ–‡ä»¶åˆ—è¡¨
                this.clearSharedFilesList();
                
                // æ˜¾ç¤ºåˆ›å»º/åŠ å…¥æŒ‰é’®
                const roomOptions = document.querySelector('.room-options');
                if (roomOptions) {
                    roomOptions.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                    console.log('æˆ¿é—´é€‰é¡¹æŒ‰é’®å·²æ˜¾ç¤º');
                    
                    // æ£€æŸ¥æŒ‰é’®æ˜¯å¦å­˜åœ¨
                    const createBtn = document.getElementById('createRoomBtn');
                    const joinBtn = document.getElementById('joinRoomBtn');
                    console.log('åˆ›å»ºæŒ‰é’®å­˜åœ¨:', !!createBtn, 'åŠ å…¥æŒ‰é’®å­˜åœ¨:', !!joinBtn);
                } else {
                    console.error('æ‰¾ä¸åˆ°.room-optionså…ƒç´ ');
                }
                
                // æ˜¾ç¤ºåº•éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
                this.showBottomUserInfo();
            }
            
            // æ˜¾ç¤ºæ–‡ä»¶ä¼ è¾“åŒºåŸŸ
            showFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.add('active');
                }
            }
            
            // éšè—æ–‡ä»¶ä¼ è¾“åŒºåŸŸ
            hideFileTransferArea() {
                const fileTransferArea = document.getElementById('fileTransferArea');
                if (fileTransferArea) {
                    fileTransferArea.classList.remove('active');
                }
            }
            
            // å¤„ç†æˆ¿é—´æ–‡ä»¶å…±äº«æ¶ˆæ¯
            async onFileSharedToRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileInfo = message.fileInfo;
                // åªæ·»åŠ ä¸æ˜¯è‡ªå·±ä¸Šä¼ çš„æ–‡ä»¶
                if (fileInfo.uploaderId !== this.getCurrentUserId()) {
                    try {
                        // å¦‚æœæœ‰æ–‡ä»¶æ•°æ®ï¼Œæ¢å¤æ–‡ä»¶
                        if (message.fileData) {
                            fileInfo.file = this.base64ToFile(message.fileData, fileInfo.name, fileInfo.type);
                            fileInfo.isAvailable = true;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true;
                            
                            // å°†æ¥æ”¶åˆ°çš„æ–‡ä»¶ä¹Ÿå­˜å‚¨åˆ°IndexedDB
                            await this.storeFileToIndexedDB(fileInfo);
                            
                            this.showToast(`${fileInfo.uploader} åˆ†äº«äº†æ–‡ä»¶: ${fileInfo.name}`);
                        } else {
                            // æ²¡æœ‰æ–‡ä»¶æ•°æ®ï¼Œå¯èƒ½æ–‡ä»¶å¤ªå¤§æˆ–ä¸Šä¼ è€…ç¦»çº¿
                            fileInfo.file = null;
                            fileInfo.isAvailable = false;
                            fileInfo.isRemote = true;
                            fileInfo.uploaderOnline = true; // å‡è®¾åœ¨çº¿ï¼Œä½†æ–‡ä»¶ä¸å¯ç”¨
                            
                            this.showToast(`${fileInfo.uploader} åˆ†äº«äº†æ–‡ä»¶: ${fileInfo.name} (æ–‡ä»¶å¤ªå¤§æˆ–æš‚ä¸å¯ä¸‹è½½)`);
                        }
                        
                        this.addFileToSharedList(fileInfo);
                    } catch (error) {
                        console.error('å¤„ç†æ¥æ”¶æ–‡ä»¶å¤±è´¥:', error);
                        // å¦‚æœå¤„ç†å¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
                        fileInfo.file = null;
                        fileInfo.isAvailable = false;
                        fileInfo.isRemote = true;
                        fileInfo.uploaderOnline = true;
                        
                        this.addFileToSharedList(fileInfo);
                        this.showToast(`æ¥æ”¶ ${fileInfo.uploader} çš„æ–‡ä»¶æ—¶å‡ºé”™`);
                    }
                }
            }
            
            // å¤„ç†æˆ¿é—´æ–‡ä»¶åˆ é™¤æ¶ˆæ¯
            onFileRemovedFromRoom(message) {
                if (message.roomCode !== this.currentRoom) return;
                
                const fileItem = document.querySelector(`[data-file-id="${message.fileId}"]`);
                if (fileItem) {
                    fileItem.remove();
                    this.updateFileCount();
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤ºç©ºçŠ¶æ€
                    const sharedFilesList = document.getElementById('sharedFilesList');
                    const remainingFiles = sharedFilesList.querySelectorAll('.shared-file-item');
                    if (remainingFiles.length === 0) {
                        const noFiles = sharedFilesList.querySelector('.no-shared-files');
                        if (noFiles) {
                            noFiles.style.display = 'block';
                        }
                    }
                }
            }
            
            // æ¸…ç©ºå…±äº«æ–‡ä»¶åˆ—è¡¨
            clearSharedFilesList() {
                const sharedFilesList = document.getElementById('sharedFilesList');
                if (sharedFilesList) {
                    // ç§»é™¤æ‰€æœ‰æ–‡ä»¶é¡¹
                    const fileItems = sharedFilesList.querySelectorAll('.shared-file-item');
                    fileItems.forEach(item => item.remove());
                    
                    // æ˜¾ç¤ºç©ºçŠ¶æ€
                    const noFiles = sharedFilesList.querySelector('.no-shared-files');
                    if (noFiles) {
                        noFiles.style.display = 'block';
                    }
                    
                    this.updateFileCount();
                }
            }
            
            // åŠ è½½ä¹‹å‰çš„æˆ¿é—´æ–‡ä»¶
            async loadPreviousRoomFiles() {
                if (!this.currentRoom) return;
                
                try {
                    const files = await this.loadRoomFilesFromIndexedDB(this.currentRoom);
                    console.log(`ä» IndexedDB åŠ è½½åˆ° ${files.length} ä¸ªæ–‡ä»¶`);
                    
                    files.forEach(fileData => {
                        const fileInfo = {
                            id: fileData.id,
                            name: fileData.name,
                            size: fileData.size,
                            type: fileData.type,
                            uploader: fileData.uploader,
                            uploaderId: fileData.uploaderId,
                            uploadTime: fileData.uploadTime,
                            file: fileData.file,
                            isRestored: true, // æ ‡è®°ä¸ºæ¢å¤çš„æ–‡ä»¶
                            isAvailable: fileData.file ? true : false // æ ¹æ®æ–‡ä»¶æ˜¯å¦å­˜åœ¨è®¾ç½®å¯ç”¨æ€§
                        };
                        
                        this.addFileToSharedList(fileInfo);
                    });
                    
                    if (files.length > 0) {
                        this.showToast(`å·²æ¢å¤ ${files.length} ä¸ªä¹‹å‰çš„æ–‡ä»¶`);
                    }
                } catch (error) {
                    console.error('åŠ è½½ä¹‹å‰çš„æ–‡ä»¶å¤±è´¥:', error);
                }
            }
            
            // æ˜¾ç¤ºæˆ¿é—´è­¦å‘Šæç¤º
            showRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                const warningTitle = document.getElementById('warningTitle');
                const warningMessage = document.getElementById('warningMessage');
                
                if (!roomWarning || !warningTitle || !warningMessage) return;
                
                if (this.isHost) {
                    warningTitle.textContent = 'æˆ¿ä¸»æé†’';
                    warningMessage.textContent = 'æ‚¨æ˜¯æˆ¿ä¸»ï¼Œåˆ·æ–°é¡µé¢ä¼šè‡ªåŠ¨é‡æ–°è¿æ¥æˆ¿é—´ã€‚åªæœ‰ç‚¹å‡»"é€€å‡ºæˆ¿é—´"æˆ–å…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µæ‰ä¼šè§£æ•£æˆ¿é—´ã€‚';
                } else {
                    warningTitle.textContent = 'æˆå‘˜æé†’';
                    warningMessage.textContent = 'åˆ·æ–°é¡µé¢ä¼šè‡ªåŠ¨é‡æ–°è¿æ¥æˆ¿é—´ã€‚åªæœ‰ç‚¹å‡»"é€€å‡ºæˆ¿é—´"æˆ–å…³é—­æµè§ˆå™¨æ ‡ç­¾é¡µæ‰ä¼šé€€å‡ºæˆ¿é—´ã€‚';
                }
                
                roomWarning.classList.add('active');
            }
            
            // éšè—æˆ¿é—´è­¦å‘Šæç¤º
            hideRoomWarning() {
                const roomWarning = document.getElementById('roomWarning');
                if (roomWarning) {
                    roomWarning.classList.remove('active');
                }
            }
            
            // è®¾ç½®é¡µé¢åˆ·æ–°å‰ç¡®è®¤
            setupBeforeUnloadHandler() {
                this.beforeUnloadHandler = (e) => {
                    if (this.isInRoom) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯åˆ·æ–°æ“ä½œï¼ˆè¿™ä¸ªæ£€æŸ¥ä¸æ˜¯100%å‡†ç¡®ï¼Œä½†å¯ä»¥å°è¯•ï¼‰
                        // å¦‚æœç”¨æˆ·æ˜ç¡®è¦å…³é—­æ ‡ç­¾é¡µ/çª—å£ï¼Œè¿˜æ˜¯åº”è¯¥è­¦å‘Š
                        const message = this.isHost 
                            ? 'å…³é—­æ ‡ç­¾é¡µå°†è§£æ•£æˆ¿é—´ï¼ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ' 
                            : 'å…³é—­æ ‡ç­¾é¡µå°†é€€å‡ºæˆ¿é—´ï¼ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                        
                        e.preventDefault();
                        e.returnValue = message;
                        return message;
                    }
                };
                
                window.addEventListener('beforeunload', this.beforeUnloadHandler);
            }
            
            // ç§»é™¤é¡µé¢åˆ·æ–°å‰ç¡®è®¤
            removeBeforeUnloadHandler() {
                if (this.beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', this.beforeUnloadHandler);
                    this.beforeUnloadHandler = null;
                }
            }
            
            // ä¿å­˜æˆ¿é—´çŠ¶æ€åˆ°æœ¬åœ°å­˜å‚¨
            saveRoomState(roomData) {
                try {
                    const roomState = {
                        ...roomData,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('dropshare_room_state', JSON.stringify(roomState));
                    console.log('æˆ¿é—´çŠ¶æ€å·²ä¿å­˜:', roomState);
                } catch (error) {
                    console.error('ä¿å­˜æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            // åŠ è½½æˆ¿é—´çŠ¶æ€
            loadRoomState() {
                try {
                    const saved = localStorage.getItem('dropshare_room_state');
                    if (saved) {
                        const roomState = JSON.parse(saved);
                        // æ£€æŸ¥çŠ¶æ€æ˜¯å¦è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰
                        const now = Date.now();
                        const maxAge = 24 * 60 * 60 * 1000; // 24å°æ—¶
                        
                        if (now - roomState.timestamp < maxAge) {
                            console.log('æ‰¾åˆ°ä¿å­˜çš„æˆ¿é—´çŠ¶æ€:', roomState);
                            return roomState;
                        } else {
                            console.log('æˆ¿é—´çŠ¶æ€å·²è¿‡æœŸï¼Œæ¸…é™¤');
                            this.clearRoomState();
                        }
                    }
                } catch (error) {
                    console.error('åŠ è½½æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
                    this.clearRoomState();
                }
                return null;
            }
            
            // æ¸…é™¤æˆ¿é—´çŠ¶æ€
            clearRoomState() {
                try {
                    localStorage.removeItem('dropshare_room_state');
                    console.log('æˆ¿é—´çŠ¶æ€å·²æ¸…é™¤');
                } catch (error) {
                    console.error('æ¸…é™¤æˆ¿é—´çŠ¶æ€å¤±è´¥:', error);
                }
            }
            
            // è®¾ç½®æ–‡ä»¶ä¼ è¾“äº‹ä»¶ç›‘å¬
            setupFileEvents() {
                // ç­‰å¾…Eventsç³»ç»Ÿå°±ç»ª
                const setupEvents = () => {
                    if (!window.Events) {
                        setTimeout(setupEvents, 100);
                        return;
                    }
                    
                    // ç›‘å¬æ–‡ä»¶æ¥æ”¶äº‹ä»¶
                    window.Events.on('file-received', (e) => {
                        this.handleFileReceived(e.detail);
                    });
                    
                    // ç›‘å¬æ–‡ä»¶ä¼ è¾“è¿›åº¦äº‹ä»¶
                    window.Events.on('file-progress', (e) => {
                        this.handleFileProgress(e.detail);
                    });
                    
                    console.log('æˆ¿é—´æ–‡ä»¶ä¼ è¾“äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
                };
                
                setupEvents();
            }
            
            // å¤„ç†æ–‡ä»¶æ¥æ”¶
            handleFileReceived(fileData) {
                if (!this.isInRoom) return;
                
                console.log('æˆ¿é—´å†…æ¥æ”¶åˆ°æ–‡ä»¶:', fileData);
                
                // æ·»åŠ åˆ°æ¥æ”¶æ–‡ä»¶åˆ—è¡¨
                this.addToReceivedFilesList(fileData);
                
                // æ˜¾ç¤ºé€šçŸ¥
                this.showToast(`æ¥æ”¶åˆ°æ–‡ä»¶: ${fileData.name}`);
            }
            
            // å¤„ç†æ–‡ä»¶ä¼ è¾“è¿›åº¦
            handleFileProgress(progressData) {
                if (!this.isInRoom) return;
                
                // æ›´æ–°ä¼ è¾“åˆ—è¡¨ä¸­çš„è¿›åº¦æ¡
                this.updateTransferProgress(progressData.sender, progressData.progress);
            }
            
            // æ·»åŠ åˆ°æ¥æ”¶æ–‡ä»¶åˆ—è¡¨
            addToReceivedFilesList(fileData) {
                const receivedFilesList = document.getElementById('receivedFilesList');
                const noFiles = receivedFilesList.querySelector('.no-files');
                
                if (noFiles) {
                    noFiles.style.display = 'none';
                }
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-name">${fileData.name}</div>
                        <div class="file-details">
                            ${this.formatFileSize(fileData.size)} â€¢ ${fileData.mime || 'Unknown type'}
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn btn-download" onclick="roomManager.downloadFile('${fileData.name}', this)">ä¸‹è½½</button>
                    </div>
                `;
                
                // å­˜å‚¨æ–‡ä»¶æ•°æ®ç”¨äºä¸‹è½½
                fileItem._fileData = fileData;
                
                receivedFilesList.appendChild(fileItem);
            }
            
            // ä¸‹è½½æ–‡ä»¶
            downloadFile(fileName, buttonElement) {
                const fileItem = buttonElement.closest('.file-item');
                const fileData = fileItem._fileData;
                
                if (fileData && fileData.blob) {
                    const url = URL.createObjectURL(fileData.blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileData.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹');
                } else {
                    this.showToast('æ–‡ä»¶ä¸‹è½½å¤±è´¥');
                }
            }
            
            // æ›´æ–°ä¼ è¾“è¿›åº¦
            updateTransferProgress(senderId, progress) {
                const transferItems = document.querySelectorAll('.transfer-item');
                transferItems.forEach(item => {
                    const progressBar = item.querySelector('.progress-fill');
                    if (progressBar) {
                        progressBar.style.width = `${Math.round(progress * 100)}%`;
                    }
                });
            }
            
            // æ£€æŸ¥å¹¶é‡æ–°è¿æ¥æˆ¿é—´
            checkAndReconnectRoom() {
                // åªæœ‰åœ¨æˆ¿é—´æ¨¡å¼ä¸‹æ‰å°è¯•é‡è¿
                if (window.location.hash !== '#rooms') {
                    return;
                }
                
                const roomState = this.loadRoomState();
                if (!roomState) {
                    console.log('æ²¡æœ‰ä¿å­˜çš„æˆ¿é—´çŠ¶æ€ï¼Œä¿æŒæ˜¾ç¤ºæˆ¿é—´é€‰é¡¹');
                    return; // ä¸åšä»»ä½•æ“ä½œï¼Œä¿æŒå½“å‰çŠ¶æ€
                }
                
                console.log('æ‰¾åˆ°ä¿å­˜çš„æˆ¿é—´çŠ¶æ€ï¼Œå°è¯•é‡è¿:', roomState.roomCode);
                
                // ç­‰å¾…ç½‘ç»œè¿æ¥å°±ç»ª
                const attemptReconnect = () => {
                    if (!window.network || !window.network.isConnected()) {
                        console.log('ç­‰å¾…ç½‘ç»œè¿æ¥...');
                        setTimeout(attemptReconnect, 300);
                        return;
                    }
                    
                    console.log('ç½‘ç»œå°±ç»ªï¼Œå¼€å§‹é‡è¿æˆ¿é—´:', roomState.roomCode);
                    this.showToast('æ­£åœ¨é‡æ–°è¿æ¥æˆ¿é—´...');
                    
                    if (roomState.isHost) {
                        this.sendMessage({
                            type: 'create-room',
                            roomSettings: {
                                code: roomState.roomCode,
                                name: roomState.roomName,
                                password: roomState.password,
                                maxMembers: 50,
                                isPrivate: !!roomState.password
                            }
                        });
                    } else {
                        this.sendMessage({
                            type: 'join-room',
                            roomCode: roomState.roomCode,
                            password: roomState.password
                        });
                    }
                };
                
                setTimeout(attemptReconnect, 500);
            }
        }
        
        // åˆå§‹åŒ–æˆ¿é—´ç®¡ç†å™¨
        let roomManager;
        
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–å¤šè¯­è¨€æ”¯æŒ
            if (window.DROPSHARE_I18N) {
                window.DROPSHARE_I18N.init();
            }
            
            // ç«‹å³åˆå§‹åŒ–æˆ¿é—´ç®¡ç†å™¨ï¼Œä¸ç­‰å¾…ç½‘ç»œ
            const initRoomManager = () => {
                console.log('åˆå§‹åŒ–æˆ¿é—´ç®¡ç†å™¨...');
                
                // æ£€æŸ¥DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
                const roomContainer = document.getElementById('roomContainer');
                const peerContainer = document.getElementById('peerContainer');
                
                if (!roomContainer || !peerContainer) {
                    console.log('DOMå…ƒç´ æœªå°±ç»ªï¼Œç­‰å¾…é‡è¯•...');
                    setTimeout(initRoomManager, 50);
                    return;
                }
                
                console.log('DOMå…ƒç´ å°±ç»ªï¼Œåˆ›å»ºæˆ¿é—´ç®¡ç†å™¨');
                roomManager = new RoomManager();
                window.roomManager = roomManager;
                console.log('æˆ¿é—´ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
            };
            
            // ç«‹å³åˆå§‹åŒ–
            initRoomManager();
        });
        
        // é¡µé¢å®Œå…¨åŠ è½½åçš„è¡¥å……æ£€æŸ¥
        window.addEventListener('load', function() {
            console.log('é¡µé¢å®Œå…¨åŠ è½½ï¼Œæ£€æŸ¥æˆ¿é—´çŠ¶æ€');
            if (window.roomManager && window.location.hash === '#rooms') {
                // åªåœ¨ä¸åœ¨æˆ¿é—´æ—¶æ‰æ˜¾ç¤ºé€‰é¡¹æŒ‰é’®
                setTimeout(() => {
                    if (!window.roomManager.isInRoom) {
                        window.roomManager.ensureRoomOptionsVisible();
                    }
                }, 100);
            }
            
            // åˆå§‹åŒ–é¡¶éƒ¨å¯¼èˆªæ è¯­è¨€é€‰æ‹©å™¨
            initNavbarLanguageSelector();
        });
        
        // åˆå§‹åŒ–é¡¶éƒ¨å¯¼èˆªæ è¯­è¨€é€‰æ‹©å™¨
        function initNavbarLanguageSelector() {
            const navbarLangSelector = document.getElementById('navbar-language-selector');
            const headerLangSelector = document.getElementById('language-selector');
            
            if (navbarLangSelector && headerLangSelector) {
                // åŒæ­¥ä¸¤ä¸ªé€‰æ‹©å™¨çš„å€¼
                const savedLang = localStorage.getItem('preferred_language') || 'en';
                navbarLangSelector.value = savedLang;
                headerLangSelector.value = savedLang;
                
                // ç›‘å¬é¡¶éƒ¨å¯¼èˆªæ çš„è¯­è¨€é€‰æ‹©å˜åŒ–
                navbarLangSelector.addEventListener('change', function() {
                    const selectedLang = this.value;
                    // åŒæ­¥åˆ°headerçš„è¯­è¨€é€‰æ‹©å™¨
                    headerLangSelector.value = selectedLang;
                    
                    // ä¿å­˜è¯­è¨€åå¥½
                    localStorage.setItem('preferred_language', selectedLang);
                    
                    // è§¦å‘è¯­è¨€åˆ‡æ¢
                    if (window.DROPSHARE_I18N && typeof window.DROPSHARE_I18N.changeLanguage === 'function') {
                        window.DROPSHARE_I18N.changeLanguage(selectedLang);
                        console.log('Language changed to:', selectedLang);
                    }
                });
                
                // ç›‘å¬headerè¯­è¨€é€‰æ‹©å™¨çš„å˜åŒ–ï¼ŒåŒæ­¥åˆ°é¡¶éƒ¨å¯¼èˆªæ 
                headerLangSelector.addEventListener('change', function() {
                    navbarLangSelector.value = this.value;
                });
            }
            
            // åˆå§‹åŒ–å¯¼èˆªæ åŠŸèƒ½é“¾æ¥
            initNavbarFunctionLinks();
        }
        
        // åˆå§‹åŒ–å¯¼èˆªæ åŠŸèƒ½é“¾æ¥
        function initNavbarFunctionLinks() {
            // å¤šäººæˆ¿é—´é“¾æ¥
            const roomsLink = document.querySelector('a[href="/share.html#rooms"]');
            if (roomsLink) {
                roomsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '#rooms';
                    console.log('åˆ‡æ¢åˆ°å¤šäººæˆ¿é—´æ¨¡å¼');
                });
            }
            
            // ä¼ é€é“¾æ¥ï¼ˆå›åˆ°ä¸»é¡µï¼‰
            const transferLink = document.querySelector('a[href="/"]');
            if (transferLink) {
                transferLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.hash = '';
                    console.log('åˆ‡æ¢åˆ°ä¼ é€æ¨¡å¼');
                });
            }
            
            // æ·»åŠ æ–‡ä»¶ç±»å‹è¿‡æ»¤åŠŸèƒ½å…¥å£
            const imageLink = document.querySelector('a[href="#images"]');
            const audioLink = document.querySelector('a[href="#audio"]'); 
            const videoLink = document.querySelector('a[href="#video"]');
            const filesLink = document.querySelector('a[href="#files"]');
            
            [imageLink, audioLink, videoLink, filesLink].forEach(link => {
                if (link) {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const type = this.getAttribute('href').substring(1);
                        showFileTypeFilter(type);
                    });
                }
            });
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ç±»å‹è¿‡æ»¤ï¼ˆæš‚æ—¶æ˜¾ç¤ºæç¤ºï¼Œä»¥åå¯ä»¥æ‰©å±•åŠŸèƒ½ï¼‰
        function showFileTypeFilter(type) {
            const typeNames = {
                'images': 'å›¾ç‰‡',
                'audio': 'éŸ³é¢‘', 
                'video': 'è§†é¢‘',
                'files': 'æ–‡ä»¶'
            };
            
            if (window.roomManager) {
                window.roomManager.showToast(`${typeNames[type]}åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­`);
            } else {
                alert(`${typeNames[type]}åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­`);
            }
            
            console.log(`åˆ‡æ¢åˆ°${typeNames[type]}æ¨¡å¼`);
        }
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="scripts/firebase-analytics.js"></script>
    
    <!-- Sounds -->
    <audio id="blop" autobuffer="true">
        <source src="/sounds/blop.mp3" type="audio/mpeg">
        <source src="/sounds/blop.ogg" type="audio/ogg">
    </audio>
    <!-- no script -->
    <noscript>
        <x-noscript class="full center column">
            <h1 data-i18n="enable_js">Enable JavaScript</h1>
            <h3 data-i18n="snapdrop_js_only">DropShare works only with JavaScript</h3>
        </x-noscript>
        <style>
        x-noscript {
            background: #599cfc;
            color: white;
            z-index: 2;
        }

        a[href="#info"] {
            color: white;
        }
        </style>
    </noscript>
</body>

</html>