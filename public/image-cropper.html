<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="image_cropper_title">å›¾ç‰‡è£å‰ªå™¨ - DropShare</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <style>
        body {
            padding: 20px;
            background: var(--bg-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .header-buttons {
            display: flex;
            gap: 12px;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            color: var(--primary-color);
            text-decoration: none;
            border: 1px solid var(--primary-color);
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .back-button:hover {
            background: var(--primary-color);
            color: white;
        }
        
        .cropper-container {
            max-width: 1000px;
            margin: 0 auto;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow-sm);
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover, .upload-area.dragover {
            border-color: var(--primary-color);
            background: var(--bg-color-secondary);
        }
        
        .crop-workspace {
            display: none;
        }
        
        .crop-tools {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-color-secondary);
            border-radius: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .tool-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tool-group label {
            font-weight: 500;
            margin-bottom: 0;
        }
        
        .aspect-ratio-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--surface-color);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .aspect-ratio-btn:hover, .aspect-ratio-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .crop-canvas-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: #f0f0f0;
            max-width: 100%;
        }
        
        #cropCanvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: crosshair;
        }
        
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.5);
        }
        
        .crop-selection {
            position: absolute;
            border: 2px solid #3367d6;
            background: rgba(51, 103, 214, 0.1);
            pointer-events: all;
            cursor: move;
        }
        
        .crop-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3367d6;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .crop-handle.nw { top: -4px; left: -4px; cursor: nw-resize; }
        .crop-handle.ne { top: -4px; right: -4px; cursor: ne-resize; }
        .crop-handle.sw { bottom: -4px; left: -4px; cursor: sw-resize; }
        .crop-handle.se { bottom: -4px; right: -4px; cursor: se-resize; }
        .crop-handle.n { top: -4px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .crop-handle.s { bottom: -4px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .crop-handle.w { top: 50%; left: -4px; transform: translateY(-50%); cursor: w-resize; }
        .crop-handle.e { top: 50%; right: -4px; transform: translateY(-50%); cursor: e-resize; }
        
        .crop-info {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            padding: 10px;
            background: var(--bg-color-secondary);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .crop-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-hover);
        }
        
        .btn-secondary {
            background: var(--border-color);
            color: var(--text-color);
        }
        
        .btn-secondary:hover {
            background: var(--text-secondary);
            color: white;
        }
        
        .preview-section {
            display: none;
            margin-top: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color-secondary);
        }
        
        .preview-images {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .preview-item {
            text-align: center;
            flex: 1;
            min-width: 200px;
        }
        
        .preview-item h4 {
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .preview-item img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .preview-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            text-align: center;
        }
        
        .stat-item {
            flex: 1;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--text-color);
        }
        
        @media (max-width: 768px) {
            .cropper-container {
                padding: 20px;
            }
            
            .crop-tools {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .tool-group {
                justify-content: space-between;
                flex-wrap: wrap;
            }
            
            .crop-actions {
                flex-direction: column;
            }
            
            .crop-actions .btn {
                width: 100%;
            }
            
            .preview-images {
                flex-direction: column;
            }
        }

        /* Language selector styles */
        .control-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .lang-selector select {
            padding: 6px 12px;
            border: 1px solid var(--border-color, #ddd);
            border-radius: 6px;
            background: var(--surface-color, white);
            color: var(--text-color, #333);
            font-size: 14px;
            cursor: pointer;
        }
        
        .lang-selector select:hover {
            border-color: var(--primary-color, #007bff);
        }
    </style>
</head>
<body>
    <div class="page-header">
        <h1 data-i18n="image_cropper_heading">âœ‚ï¸ å›¾ç‰‡è£å‰ªå™¨</h1>
        <div class="header-buttons">
            <div class="control-buttons">
                <div class="lang-selector">
                    <select id="language-selector" title="Select Language" data-i18n="title_select_language">
                        <option value="en">English</option>
                        <option value="zh">ä¸­æ–‡ç®€ä½“</option>
                        <option value="zh-tw">ä¸­æ–‡ç¹é«”</option>
                        <option value="ja">æ—¥æœ¬èª</option>
                        <option value="fr">FranÃ§ais</option>
                        <option value="es">EspaÃ±ol</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">PortuguÃªs</option>
                        <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="ko">í•œêµ­ì–´</option>
                    </select>
                </div>
            </div>
            <a href="image-tools.html" class="back-button" data-i18n="back_to_image_tools">â† å›¾ç‰‡å·¥å…·</a>
            <a href="index.html" class="back-button" data-i18n="btn_home">ğŸ  é¦–é¡µ</a>
        </div>
    </div>
    
    <div class="cropper-container">
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 3em; margin-bottom: 15px;">âœ‚ï¸</div>
            <h3 data-i18n="drop_images_here">æ‹–æ‹½å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;" data-i18n="supported_formats_image">æ”¯æŒ JPG, PNG, GIF, WebP ç­‰æ ¼å¼</p>
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">é€‰æ‹©å›¾ç‰‡</button>
        </div>
        
        <div class="crop-workspace" id="cropWorkspace">
            <div class="crop-tools">
                <div class="tool-group">
                    <label>å®½é«˜æ¯”:</label>
                    <button class="aspect-ratio-btn active" data-ratio="free">è‡ªç”±</button>
                    <button class="aspect-ratio-btn" data-ratio="1:1">1:1</button>
                    <button class="aspect-ratio-btn" data-ratio="4:3">4:3</button>
                    <button class="aspect-ratio-btn" data-ratio="16:9">16:9</button>
                    <button class="aspect-ratio-btn" data-ratio="3:2">3:2</button>
                </div>
                
                <div class="tool-group">
                    <label>è¾“å‡ºå°ºå¯¸:</label>
                    <input type="number" id="outputWidth" placeholder="å®½åº¦" min="1" style="width: 80px;">
                    <span>Ã—</span>
                    <input type="number" id="outputHeight" placeholder="é«˜åº¦" min="1" style="width: 80px;">
                    <span>px</span>
                </div>
                
                <div class="tool-group">
                    <label>
                        <input type="checkbox" id="maintainQuality" checked>
                        ä¿æŒåŸå§‹è´¨é‡
                    </label>
                </div>
            </div>
            
            <div class="crop-canvas-container" id="canvasContainer">
                <canvas id="cropCanvas"></canvas>
                <div class="crop-overlay" id="cropOverlay"></div>
                <div class="crop-selection" id="cropSelection" style="display: none;">
                    <div class="crop-handle nw"></div>
                    <div class="crop-handle ne"></div>
                    <div class="crop-handle sw"></div>
                    <div class="crop-handle se"></div>
                    <div class="crop-handle n"></div>
                    <div class="crop-handle s"></div>
                    <div class="crop-handle w"></div>
                    <div class="crop-handle e"></div>
                </div>
            </div>
            
            <div class="crop-info" id="cropInfo">
                <span>é€‰æ‹©åŒºåŸŸ: <strong id="selectionInfo">æœªé€‰æ‹©</strong></span>
                <span>åŸå§‹å°ºå¯¸: <strong id="originalSize">-</strong></span>
                <span>è£å‰ªå°ºå¯¸: <strong id="cropSize">-</strong></span>
            </div>
            
            <div class="crop-actions">
                <button class="btn btn-primary" id="cropBtn" disabled>è£å‰ªå›¾ç‰‡</button>
                <button class="btn btn-secondary" id="resetBtn">é‡ç½®é€‰æ‹©</button>
                <button class="btn btn-secondary" id="rotateBtn">æ—‹è½¬90Â°</button>
                <button class="btn btn-secondary" id="flipHBtn">æ°´å¹³ç¿»è½¬</button>
                <button class="btn btn-secondary" id="flipVBtn">å‚ç›´ç¿»è½¬</button>
                <button class="btn btn-secondary" id="newImageBtn">é€‰æ‹©æ–°å›¾ç‰‡</button>
            </div>
        </div>
        
        <div class="preview-section" id="previewSection">
            <h3>è£å‰ªé¢„è§ˆ</h3>
            <div class="preview-images">
                <div class="preview-item">
                    <h4>åŸå§‹å›¾ç‰‡</h4>
                    <img id="originalPreview" src="" alt="åŸå§‹å›¾ç‰‡">
                    <div class="preview-stats">
                        <div class="stat-item">
                            <span class="stat-label">å°ºå¯¸</span>
                            <span class="stat-value" id="originalDimensions">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å¤§å°</span>
                            <span class="stat-value" id="originalFileSize">-</span>
                        </div>
                    </div>
                </div>
                
                <div class="preview-item">
                    <h4>è£å‰ªç»“æœ</h4>
                    <img id="croppedPreview" src="" alt="è£å‰ªç»“æœ">
                    <div class="preview-stats">
                        <div class="stat-item">
                            <span class="stat-label">å°ºå¯¸</span>
                            <span class="stat-value" id="croppedDimensions">-</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å¤§å°</span>
                            <span class="stat-value" id="croppedFileSize">-</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="crop-actions">
                <button class="btn btn-primary" id="downloadBtn">ä¸‹è½½å›¾ç‰‡</button>
                <button class="btn btn-primary" id="shareBtn">åˆ†äº«å›¾ç‰‡</button>
                <button class="btn btn-secondary" id="cropAnotherBtn">ç»§ç»­è£å‰ª</button>
            </div>
        </div>
    </div>

    <script>
        class ImageCropper {
            constructor() {
                this.originalImage = null;
                this.canvas = null;
                this.ctx = null;
                this.isSelecting = false;
                this.isDragging = false;
                this.isResizing = false;
                this.resizeHandle = null;
                this.selection = { x: 0, y: 0, width: 0, height: 0 };
                this.aspectRatio = null;
                this.scale = 1;
                this.rotation = 0;
                this.flipH = false;
                this.flipV = false;
                
                this.init();
            }
            
            init() {
                this.canvas = document.getElementById('cropCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.bindEvents();
            }
            
            bindEvents() {
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');
                
                // æ‹–æ‹½ä¸Šä¼ 
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.loadImage(files[0]);
                    }
                });
                
                // æ–‡ä»¶é€‰æ‹©
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.loadImage(e.target.files[0]);
                    }
                });
                
                // å®½é«˜æ¯”æŒ‰é’®
                document.querySelectorAll('.aspect-ratio-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.aspect-ratio-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        const ratio = btn.dataset.ratio;
                        this.setAspectRatio(ratio);
                    });
                });
                
                // ç”»å¸ƒäº‹ä»¶
                this.canvas.addEventListener('mousedown', this.handleMouseDown.bind(this));
                this.canvas.addEventListener('mousemove', this.handleMouseMove.bind(this));
                this.canvas.addEventListener('mouseup', this.handleMouseUp.bind(this));
                
                // æ§åˆ¶æŒ‰é’®
                document.getElementById('cropBtn').addEventListener('click', () => this.cropImage());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetSelection());
                document.getElementById('rotateBtn').addEventListener('click', () => this.rotateImage());
                document.getElementById('flipHBtn').addEventListener('click', () => this.flipImage(true, false));
                document.getElementById('flipVBtn').addEventListener('click', () => this.flipImage(false, true));
                document.getElementById('newImageBtn').addEventListener('click', () => this.selectNewImage());
                
                // é¢„è§ˆæŒ‰é’®
                document.getElementById('downloadBtn').addEventListener('click', () => this.downloadImage());
                document.getElementById('shareBtn').addEventListener('click', () => this.shareImage());
                document.getElementById('cropAnotherBtn').addEventListener('click', () => this.cropAnother());
                
                // è¾“å‡ºå°ºå¯¸è¾“å…¥
                document.getElementById('outputWidth').addEventListener('input', this.updateOutputSize.bind(this));
                document.getElementById('outputHeight').addEventListener('input', this.updateOutputSize.bind(this));
            }
            
            loadImage(file) {
                if (!file.type.startsWith('image/')) {
                    alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                    return;
                }
                
                this.originalFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        this.originalImage = img;
                        this.setupCanvas();
                        this.showWorkspace();
                        this.updateInfo();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            setupCanvas() {
                const container = document.getElementById('canvasContainer');
                const maxWidth = Math.min(800, container.offsetWidth - 40);
                const maxHeight = 600;
                
                let canvasWidth = this.originalImage.width;
                let canvasHeight = this.originalImage.height;
                
                if (canvasWidth > maxWidth || canvasHeight > maxHeight) {
                    const widthRatio = maxWidth / canvasWidth;
                    const heightRatio = maxHeight / canvasHeight;
                    this.scale = Math.min(widthRatio, heightRatio);
                    
                    canvasWidth *= this.scale;
                    canvasHeight *= this.scale;
                }
                
                this.canvas.width = canvasWidth;
                this.canvas.height = canvasHeight;
                this.canvas.style.width = canvasWidth + 'px';
                this.canvas.style.height = canvasHeight + 'px';
                
                this.drawImage();
                this.initSelection();
            }
            
            drawImage() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                this.ctx.save();
                
                // åº”ç”¨å˜æ¢
                this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);
                this.ctx.rotate(this.rotation * Math.PI / 180);
                this.ctx.scale(this.flipH ? -1 : 1, this.flipV ? -1 : 1);
                
                const drawWidth = this.originalImage.width * this.scale;
                const drawHeight = this.originalImage.height * this.scale;
                
                this.ctx.drawImage(
                    this.originalImage,
                    -drawWidth / 2,
                    -drawHeight / 2,
                    drawWidth,
                    drawHeight
                );
                
                this.ctx.restore();
            }
            
            initSelection() {
                const padding = 50;
                this.selection = {
                    x: padding,
                    y: padding,
                    width: this.canvas.width - padding * 2,
                    height: this.canvas.height - padding * 2
                };
                this.updateSelection();
                this.updateCropInfo();
            }
            
            updateSelection() {
                const selection = document.getElementById('cropSelection');
                selection.style.display = 'block';
                selection.style.left = this.selection.x + 'px';
                selection.style.top = this.selection.y + 'px';
                selection.style.width = this.selection.width + 'px';
                selection.style.height = this.selection.height + 'px';
                
                // æ›´æ–°é®ç½©
                this.updateOverlay();
                
                // å¯ç”¨è£å‰ªæŒ‰é’®
                document.getElementById('cropBtn').disabled = false;
            }
            
            updateOverlay() {
                const overlay = document.getElementById('cropOverlay');
                overlay.style.width = this.canvas.width + 'px';
                overlay.style.height = this.canvas.height + 'px';
                
                const clipPath = `polygon(
                    0% 0%,
                    0% 100%,
                    ${(this.selection.x / this.canvas.width * 100).toFixed(2)}% 100%,
                    ${(this.selection.x / this.canvas.width * 100).toFixed(2)}% ${(this.selection.y / this.canvas.height * 100).toFixed(2)}%,
                    ${((this.selection.x + this.selection.width) / this.canvas.width * 100).toFixed(2)}% ${(this.selection.y / this.canvas.height * 100).toFixed(2)}%,
                    ${((this.selection.x + this.selection.width) / this.canvas.width * 100).toFixed(2)}% ${((this.selection.y + this.selection.height) / this.canvas.height * 100).toFixed(2)}%,
                    ${(this.selection.x / this.canvas.width * 100).toFixed(2)}% ${((this.selection.y + this.selection.height) / this.canvas.height * 100).toFixed(2)}%,
                    ${(this.selection.x / this.canvas.width * 100).toFixed(2)}% 100%,
                    100% 100%,
                    100% 0%
                )`;
                overlay.style.clipPath = clipPath;
            }
            
            handleMouseDown(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†é€‰æ‹©åŒºåŸŸ
                if (this.isInsideSelection(x, y)) {
                    this.isDragging = true;
                    this.dragStart = { x: x - this.selection.x, y: y - this.selection.y };
                } else {
                    // å¼€å§‹æ–°çš„é€‰æ‹©
                    this.isSelecting = true;
                    this.selection = { x, y, width: 0, height: 0 };
                }
            }
            
            handleMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                if (this.isDragging) {
                    this.dragSelection(x, y);
                } else if (this.isSelecting) {
                    this.updateSelectionSize(x, y);
                } else {
                    // æ›´æ–°é¼ æ ‡æ ·å¼
                    if (this.isInsideSelection(x, y)) {
                        this.canvas.style.cursor = 'move';
                    } else {
                        this.canvas.style.cursor = 'crosshair';
                    }
                }
            }
            
            handleMouseUp() {
                this.isSelecting = false;
                this.isDragging = false;
                this.canvas.style.cursor = 'crosshair';
                
                if (this.selection.width > 0 && this.selection.height > 0) {
                    this.updateSelection();
                    this.updateCropInfo();
                }
            }
            
            dragSelection(x, y) {
                const newX = x - this.dragStart.x;
                const newY = y - this.dragStart.y;
                
                // è¾¹ç•Œæ£€æŸ¥
                this.selection.x = Math.max(0, Math.min(newX, this.canvas.width - this.selection.width));
                this.selection.y = Math.max(0, Math.min(newY, this.canvas.height - this.selection.height));
                
                this.updateSelection();
                this.updateCropInfo();
            }
            
            updateSelectionSize(x, y) {
                const startX = Math.min(this.selection.x, x);
                const startY = Math.min(this.selection.y, y);
                const width = Math.abs(x - this.selection.x);
                const height = Math.abs(y - this.selection.y);
                
                // åº”ç”¨å®½é«˜æ¯”
                if (this.aspectRatio) {
                    const newHeight = width / this.aspectRatio;
                    if (newHeight <= this.canvas.height - startY) {
                        this.selection = { x: startX, y: startY, width, height: newHeight };
                    } else {
                        const newWidth = (this.canvas.height - startY) * this.aspectRatio;
                        this.selection = { x: startX, y: startY, width: newWidth, height: this.canvas.height - startY };
                    }
                } else {
                    this.selection = { x: startX, y: startY, width, height };
                }
                
                this.updateSelection();
                this.updateCropInfo();
            }
            
            setAspectRatio(ratio) {
                if (ratio === 'free') {
                    this.aspectRatio = null;
                } else {
                    const [w, h] = ratio.split(':').map(Number);
                    this.aspectRatio = w / h;
                    
                    // è°ƒæ•´å½“å‰é€‰æ‹©ä»¥é€‚åº”æ–°çš„å®½é«˜æ¯”
                    if (this.selection.width > 0 && this.selection.height > 0) {
                        const newHeight = this.selection.width / this.aspectRatio;
                        if (newHeight <= this.canvas.height - this.selection.y) {
                            this.selection.height = newHeight;
                        } else {
                            this.selection.width = (this.canvas.height - this.selection.y) * this.aspectRatio;
                        }
                        this.updateSelection();
                        this.updateCropInfo();
                    }
                }
            }
            
            cropImage() {
                if (this.selection.width === 0 || this.selection.height === 0) {
                    alert('è¯·å…ˆé€‰æ‹©è£å‰ªåŒºåŸŸï¼');
                    return;
                }
                
                // åˆ›å»ºæ–°ç”»å¸ƒè¿›è¡Œè£å‰ª
                const cropCanvas = document.createElement('canvas');
                const cropCtx = cropCanvas.getContext('2d');
                
                // è®¡ç®—å®é™…è£å‰ªåŒºåŸŸï¼ˆè€ƒè™‘ç¼©æ”¾ï¼‰
                const actualX = this.selection.x / this.scale;
                const actualY = this.selection.y / this.scale;
                const actualWidth = this.selection.width / this.scale;
                const actualHeight = this.selection.height / this.scale;
                
                // è®¾ç½®è¾“å‡ºå°ºå¯¸
                const outputWidth = document.getElementById('outputWidth').value || this.selection.width;
                const outputHeight = document.getElementById('outputHeight').value || this.selection.height;
                
                cropCanvas.width = outputWidth;
                cropCanvas.height = outputHeight;
                
                // è£å‰ªå¹¶ç»˜åˆ¶
                cropCtx.drawImage(
                    this.originalImage,
                    actualX, actualY, actualWidth, actualHeight,
                    0, 0, outputWidth, outputHeight
                );
                
                // è½¬æ¢ä¸ºBlob
                cropCanvas.toBlob((blob) => {
                    this.croppedBlob = blob;
                    this.showPreview(cropCanvas.toDataURL());
                }, 'image/png');
            }
            
            showPreview(croppedDataUrl) {
                const previewSection = document.getElementById('previewSection');
                const originalPreview = document.getElementById('originalPreview');
                const croppedPreview = document.getElementById('croppedPreview');
                
                // æ˜¾ç¤ºåŸå§‹å›¾ç‰‡
                originalPreview.src = URL.createObjectURL(this.originalFile);
                
                // æ˜¾ç¤ºè£å‰ªç»“æœ
                croppedPreview.src = croppedDataUrl;
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('originalDimensions').textContent = 
                    `${this.originalImage.width} Ã— ${this.originalImage.height}`;
                document.getElementById('originalFileSize').textContent = 
                    this.formatFileSize(this.originalFile.size);
                
                const outputWidth = document.getElementById('outputWidth').value || this.selection.width;
                const outputHeight = document.getElementById('outputHeight').value || this.selection.height;
                
                document.getElementById('croppedDimensions').textContent = 
                    `${outputWidth} Ã— ${outputHeight}`;
                document.getElementById('croppedFileSize').textContent = 
                    this.formatFileSize(this.croppedBlob.size);
                
                previewSection.style.display = 'block';
                previewSection.scrollIntoView({ behavior: 'smooth' });
            }
            
            downloadImage() {
                if (!this.croppedBlob) return;
                
                const url = URL.createObjectURL(this.croppedBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cropped_${this.originalFile.name}`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            shareImage() {
                if (!this.croppedBlob) return;
                
                const file = new File([this.croppedBlob], `cropped_${this.originalFile.name}`, { type: 'image/png' });
                
                if (window.ui && window.ui.filesQueue) {
                    window.ui.filesQueue.push(file);
                    alert('è£å‰ªåçš„å›¾ç‰‡å·²æ·»åŠ åˆ°åˆ†äº«åˆ—è¡¨ï¼');
                } else {
                    alert('åˆ†äº«åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·å…ˆè¿”å›åˆ†äº«é¡µé¢');
                }
            }
            
            // è¾…åŠ©æ–¹æ³•
            showWorkspace() {
                document.getElementById('uploadArea').style.display = 'none';
                document.getElementById('cropWorkspace').style.display = 'block';
            }
            
            updateInfo() {
                document.getElementById('originalSize').textContent = 
                    `${this.originalImage.width} Ã— ${this.originalImage.height}`;
            }
            
            updateCropInfo() {
                const selectionInfo = `${Math.round(this.selection.x)}, ${Math.round(this.selection.y)}`;
                const cropSize = `${Math.round(this.selection.width)} Ã— ${Math.round(this.selection.height)}`;
                
                document.getElementById('selectionInfo').textContent = selectionInfo;
                document.getElementById('cropSize').textContent = cropSize;
            }
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            isInsideSelection(x, y) {
                return x >= this.selection.x && x <= this.selection.x + this.selection.width &&
                       y >= this.selection.y && y <= this.selection.y + this.selection.height;
            }
            
            rotateImage() {
                this.rotation = (this.rotation + 90) % 360;
                this.drawImage();
            }
            
            flipImage(horizontal, vertical) {
                if (horizontal) this.flipH = !this.flipH;
                if (vertical) this.flipV = !this.flipV;
                this.drawImage();
            }
            
            resetSelection() {
                this.initSelection();
            }
            
            selectNewImage() {
                document.getElementById('fileInput').click();
            }
            
            cropAnother() {
                document.getElementById('previewSection').style.display = 'none';
                this.resetSelection();
            }
            
            updateOutputSize() {
                // å®æ—¶æ›´æ–°è¾“å‡ºå°ºå¯¸ä¿¡æ¯
                const width = document.getElementById('outputWidth').value;
                const height = document.getElementById('outputHeight').value;
                
                if (width && height) {
                    // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®æ—¶é¢„è§ˆé€»è¾‘
                }
            }
        }
        
        // åˆå§‹åŒ–
        let imageCropper;
        document.addEventListener('DOMContentLoaded', () => {
            imageCropper = new ImageCropper();
            // Initialize i18n after image cropper
            if (typeof initializeI18n === 'function') {
                initializeI18n();
            }
        });
    </script>

    <!-- Load i18n system -->
    <script src="scripts/i18n/languages.js"></script>
    <script>
        // Initialize the i18n system
        function initializeI18n() {
            // Get user language preference
            const userLanguage = getUserLanguage();
            
            // Set initial language
            setLanguage(userLanguage);
            
            // Update language selector
            const languageSelector = document.getElementById('language-selector');
            if (languageSelector) {
                languageSelector.value = userLanguage;
                languageSelector.addEventListener('change', (e) => {
                    setLanguage(e.target.value);
                });
            }
        }
    </script>
</body>
</html>