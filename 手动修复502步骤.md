# 手动修复502错误步骤

由于SSH自动连接可能有问题，请按照以下步骤手动操作：

## 方法1: 直接SSH连接到服务器

```bash
# 1. 连接到服务器（使用您自己的SSH方式）
ssh novcat@107.174.250.34
# 或
ssh dokploy@107.174.250.34

# 2. 进入项目目录
cd /var/www/dropshare

# 3. 检查当前状态
docker-compose ps
docker logs dropshare-app
```

## 方法2: 修复步骤（在服务器上执行）

```bash
# 1. 进入项目目录
cd /var/www/dropshare

# 2. 停止容器
docker-compose down

# 3. 创建/更新.env文件
cat > .env << 'EOF'
PRIMARY_DOMAIN=107.174.250.34
SECONDARY_DOMAIN=107.174.250.34
NODE_ENV=production
PORT=3000
MAX_FILE_SIZE=100MB
UPLOAD_PATH=./uploads
LOG_LEVEL=info
LOG_PATH=./logs
EOF

# 4. 确保docker-compose.yml中的环境变量正确
# 检查docker-compose.yml中是否有：
# environment:
#   - PORT=3000

# 5. 启动容器
docker-compose up -d --build

# 6. 等待10秒
sleep 10

# 7. 检查状态
docker-compose ps

# 8. 查看日志
docker logs dropshare-app

# 9. 测试连接
curl http://localhost:3000

# 10. 检查端口监听
netstat -tlnp | grep 3000
# 或
ss -tlnp | grep 3000
```

## 方法3: 检查docker-compose.yml配置

确保 `docker-compose.yml` 中的环境变量正确传递：

```yaml
services:
  dropshare-app:
    environment:
      - NODE_ENV=production
      - PORT=3000  # 确保这个存在
    ports:
      - "3000:3000"  # 确保端口映射正确
```

## 常见问题排查

### 问题1: 容器启动后立即退出

```bash
# 查看详细日志
docker logs dropshare-app

# 检查是否有错误信息
# 常见错误：
# - "Port 3000 is already in use" → 端口被占用
# - "Cannot find module" → 依赖缺失
```

### 问题2: 端口3000未监听

```bash
# 检查应用实际监听的端口
docker exec dropshare-app netstat -tlnp

# 如果监听8080而不是3000，说明环境变量未传递
# 检查环境变量
docker exec dropshare-app env | grep PORT
```

### 问题3: 应用无法启动

```bash
# 查看完整启动日志
docker logs dropshare-app

# 尝试手动启动（用于调试）
docker-compose run --rm dropshare-app node index.js
```

## 验证修复

修复后验证：

```bash
# 1. 检查容器状态
docker-compose ps
# 应该显示 "Up"

# 2. 检查端口监听
netstat -tlnp | grep 3000
# 应该显示监听状态

# 3. 测试本地连接
curl -I http://localhost:3000
# 应该返回 200 OK

# 4. 测试外部访问
curl -I http://107.174.250.34:3000
# 应该返回 200 OK（不再是502）
```

## 如果仍有问题

请提供以下信息：

1. **容器状态**: `docker-compose ps`
2. **容器日志**: `docker logs dropshare-app` (最后50行)
3. **端口监听**: `netstat -tlnp | grep 3000`
4. **环境变量**: `docker exec dropshare-app env | grep PORT`
5. **测试结果**: `curl -v http://localhost:3000`

