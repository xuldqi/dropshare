# 502 Bad Gateway 错误解决方案

## 问题分析

502 Bad Gateway 错误通常表示：
- **Nginx/反向代理无法连接到后端应用**
- **应用没有正常运行**
- **端口配置不匹配**

## 常见原因

### 1. Docker容器未运行
```bash
# 检查容器状态
docker ps -a | grep dropshare

# 如果容器未运行，启动它
cd /var/www/dropshare
docker-compose up -d
```

### 2. 端口配置不匹配

**问题**: `index.js` 默认使用端口 `8080`，但 `docker-compose.yml` 配置的是 `3000`

**检查**:
```bash
# 查看应用实际监听的端口
docker exec dropshare-app netstat -tlnp | grep LISTEN
# 或
docker exec dropshare-app ss -tlnp | grep LISTEN
```

**解决方案**:
- 确保环境变量 `PORT=3000` 正确传递到容器
- 检查 `.env` 文件中的 `PORT` 设置
- 检查 `docker-compose.yml` 中的环境变量

### 3. 应用启动失败

**检查日志**:
```bash
# 查看容器日志
docker logs dropshare-app

# 实时查看日志
docker logs -f dropshare-app
```

**常见启动失败原因**:
- 依赖未安装
- 端口已被占用
- 环境变量缺失
- 代码错误

### 4. Nginx配置问题

**检查Nginx配置**:
```bash
# 测试配置
sudo nginx -t

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

**Nginx配置应该指向正确的端口**:
```nginx
location / {
    proxy_pass http://localhost:3000;  # 确保端口正确
    # ...
}
```

## 快速诊断步骤

### 方法1: 使用诊断脚本（推荐）

```bash
# 运行诊断脚本
./诊断502错误.sh
```

### 方法2: 手动检查

```bash
# 1. 检查容器状态
ssh -i ~/.ssh/dropshare_server_key novcat@107.174.250.34
cd /var/www/dropshare
docker-compose ps

# 2. 检查容器日志
docker logs dropshare-app

# 3. 测试本地连接
curl http://localhost:3000

# 4. 检查端口监听
netstat -tlnp | grep 3000
```

## 自动修复

### 使用修复脚本

```bash
# 运行自动修复脚本
./修复502错误.sh
```

这个脚本会：
1. ✅ 检查并重启Docker容器
2. ✅ 验证环境变量配置
3. ✅ 检查端口监听状态
4. ✅ 测试应用连接
5. ✅ 检查Nginx配置（如果使用）

## 手动修复步骤

### 步骤1: 检查容器状态

```bash
ssh -i ~/.ssh/dropshare_server_key novcat@107.174.250.34
cd /var/www/dropshare

# 查看容器状态
docker-compose ps

# 如果容器未运行
docker-compose up -d
```

### 步骤2: 检查环境变量

```bash
# 检查.env文件
cat .env

# 确保包含：
# PORT=3000
# NODE_ENV=production
```

### 步骤3: 检查应用日志

```bash
# 查看完整日志
docker logs dropshare-app

# 查看最后50行
docker logs --tail 50 dropshare-app
```

### 步骤4: 验证端口监听

```bash
# 在容器内检查
docker exec dropshare-app netstat -tlnp

# 在宿主机检查
netstat -tlnp | grep 3000
```

### 步骤5: 测试应用

```bash
# 测试本地连接
curl http://localhost:3000

# 应该返回HTML内容或200状态码
```

### 步骤6: 检查Nginx（如果使用）

```bash
# 测试配置
sudo nginx -t

# 查看错误日志
sudo tail -20 /var/log/nginx/error.log

# 重启Nginx
sudo systemctl restart nginx
```

## 常见问题排查

### 问题1: 容器启动后立即退出

**原因**: 应用启动失败

**解决**:
```bash
# 查看详细日志
docker logs dropshare-app

# 检查是否有错误信息
# 常见错误：
# - 端口被占用
# - 依赖缺失
# - 环境变量错误
```

### 问题2: 端口3000未监听

**原因**: 应用可能监听在8080端口

**解决**:
```bash
# 检查应用实际监听的端口
docker exec dropshare-app netstat -tlnp

# 如果监听8080，检查环境变量
docker exec dropshare-app env | grep PORT

# 修复：确保.env文件中有 PORT=3000
```

### 问题3: Nginx无法连接后端

**原因**: 
- 后端应用未运行
- 端口配置错误
- 防火墙阻止

**解决**:
```bash
# 检查后端是否运行
curl http://localhost:3000

# 检查Nginx配置中的proxy_pass地址
sudo cat /etc/nginx/conf.d/dropshare.tech.conf | grep proxy_pass

# 应该指向: http://localhost:3000 或 http://127.0.0.1:3000
```

### 问题4: 环境变量未传递

**原因**: Docker Compose环境变量配置错误

**解决**:
```bash
# 检查docker-compose.yml
cat docker-compose.yml | grep -A 5 environment

# 确保包含：
# - PORT=3000

# 重新构建并启动
docker-compose down
docker-compose up -d --build
```

## 验证修复

修复后，验证服务是否正常：

```bash
# 1. 检查容器运行状态
docker-compose ps
# 应该显示 "Up"

# 2. 检查端口监听
netstat -tlnp | grep 3000
# 应该显示监听状态

# 3. 测试本地连接
curl -I http://localhost:3000
# 应该返回 200 OK

# 4. 测试外部访问（如果配置了Nginx）
curl -I http://107.174.250.34
# 应该返回 200 OK（不再是502）

# 5. 测试WebSocket连接
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" \
     -H "Sec-WebSocket-Version: 13" \
     -H "Sec-WebSocket-Key: test" \
     http://localhost:3000/server/webrtc
```

## 预防措施

1. **确保环境变量正确**:
   - 在 `.env` 文件中设置 `PORT=3000`
   - 在 `docker-compose.yml` 中传递环境变量

2. **监控容器状态**:
   ```bash
   # 设置自动重启
   # docker-compose.yml 中已有: restart: unless-stopped
   ```

3. **定期检查日志**:
   ```bash
   # 设置日志轮转
   docker logs --tail 100 dropshare-app
   ```

4. **健康检查**:
   ```bash
   # 可以添加健康检查脚本
   # 定期检查 http://localhost:3000 是否响应
   ```

## 联系支持

如果以上方法都无法解决问题，请提供：
1. 容器日志: `docker logs dropshare-app`
2. Nginx错误日志: `sudo tail -50 /var/log/nginx/error.log`
3. 端口监听状态: `netstat -tlnp | grep -E "3000|80|443"`
4. 容器状态: `docker-compose ps`


