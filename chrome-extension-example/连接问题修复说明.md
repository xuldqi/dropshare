# WebSocket连接问题修复说明

## 问题分析

### 问题1: ERR_CONNECTION_REFUSED
**错误**: `WebSocket connection to 'ws://localhost:8080/server/webrtc' failed: Error in connection establishment: net::ERR_CONNECTION_REFUSED`

**原因**: 本地服务器没有运行

**解决方案**:
1. 启动本地服务器：`node index.js`
2. 或者使用线上服务器：`wss://dropshare.tech/server/webrtc`

### 问题2: 301重定向错误
**错误**: `WebSocket connection to 'ws://dropshare.tech/server/webrtc' failed: Error during WebSocket handshake: Unexpected response code: 301`

**原因**: 
- 服务器强制使用HTTPS（安全连接）
- WebSocket连接必须使用WSS（WebSocket Secure），而不是WS
- 301重定向是HTTP到HTTPS的重定向，但WebSocket无法处理重定向

**解决方案**:
- 使用 `wss://dropshare.tech/server/webrtc` 而不是 `ws://dropshare.tech/server/webrtc`

## 修复内容

### 1. 自动协议检测
- 扩展现在会自动检测网站协议
- HTTPS网站 → 使用WSS
- HTTP网站 → 使用WS
- 本地服务器（localhost）→ 使用WS

### 2. 智能错误处理
- 检测301错误，自动提示使用WSS
- 检测连接拒绝，提示启动本地服务器
- 提供清晰的错误消息

### 3. 自动协议切换
- 如果WS连接失败且返回301，自动尝试WSS
- 更新服务器地址配置

### 4. 默认服务器地址
- 默认使用 `wss://dropshare.tech/server/webrtc`（WSS，安全连接）
- 而不是 `ws://localhost:8080`（需要本地服务器运行）

## 协议选择指南

### 使用WSS（安全连接）的情况：
- ✅ 线上服务器（如 dropshare.tech）
- ✅ HTTPS网站
- ✅ 生产环境
- ✅ 需要安全连接的场景

### 使用WS（非安全连接）的情况：
- ✅ 本地开发（localhost）
- ✅ 内网服务器
- ✅ HTTP网站
- ✅ 测试环境

## 配置服务器地址

### 方法1: 自动检测（推荐）
1. 打开DropShare网站
2. 打开扩展设置
3. 点击"自动检测"
4. 扩展会自动使用正确的协议（WSS或WS）

### 方法2: 手动配置
1. 打开扩展设置
2. 输入服务器地址：
   - 线上服务器：`wss://dropshare.tech/server/webrtc`
   - 本地服务器：`ws://localhost:8080/server/webrtc`
3. 点击保存

## 常见问题

### Q: 为什么线上服务器必须使用WSS？
A: 
- 现代浏览器和服务器通常强制使用HTTPS
- HTTPS网站必须使用WSS（安全WebSocket）
- WS连接会被301重定向，但WebSocket无法处理重定向

### Q: 本地服务器可以使用WSS吗？
A: 
- 可以，但需要配置SSL证书
- 对于本地开发，使用WS即可
- 生产环境建议使用WSS

### Q: 如何知道应该使用WS还是WSS？
A: 
- 查看网站地址栏的协议：
  - `https://` → 使用 `wss://`
  - `http://` → 使用 `ws://`
- 或者使用自动检测功能

### Q: 连接失败怎么办？
A: 
1. **检查服务器地址**
   - 线上服务器：确保使用 `wss://`
   - 本地服务器：确保服务器正在运行

2. **检查网络连接**
   - 确保可以访问服务器
   - 检查防火墙设置

3. **查看错误消息**
   - 扩展会显示详细的错误消息
   - 查看Service Worker日志获取更多信息

4. **尝试自动检测**
   - 打开DropShare网站
   - 使用自动检测功能

## 测试步骤

### 测试线上服务器：
1. 配置服务器地址：`wss://dropshare.tech/server/webrtc`
2. 保存设置
3. 查看连接状态，应该显示"已连接到服务器"

### 测试本地服务器：
1. 启动本地服务器：`node index.js`
2. 配置服务器地址：`ws://localhost:8080/server/webrtc`
3. 保存设置
4. 查看连接状态，应该显示"已连接到服务器"

## 更新日志

### v1.1.0 (当前版本)
- ✅ 自动协议检测（HTTPS → WSS, HTTP → WS）
- ✅ 智能错误处理
- ✅ 自动协议切换（WS失败时尝试WSS）
- ✅ 改进的错误消息
- ✅ 默认使用WSS线上服务器

### v1.0.0
- 初始版本
- 基本WebSocket连接
- 手动配置服务器地址


